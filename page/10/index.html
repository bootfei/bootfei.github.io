<!DOCTYPE html>
<html lang="en,cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"8.0.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>

  <meta name="description" content="learn more, forget more; practice more, get more.">
<meta property="og:type" content="website">
<meta property="og:title" content="BootFei&#39;s Blog">
<meta property="og:url" content="http://example.com/page/10/index.html">
<meta property="og:site_name" content="BootFei&#39;s Blog">
<meta property="og:description" content="learn more, forget more; practice more, get more.">
<meta property="og:locale">
<meta property="article:author" content="Fei Qi">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/10/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en,cn'
  };
</script>

  <title>BootFei's Blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">BootFei's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">敬畏耶和华是智慧的开端，认识至圣者就是聪明</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Fei Qi</p>
  <div class="site-description" itemprop="description">learn more, forget more; practice more, get more.</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">215</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">
      

      
    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81/shiro%E5%BA%94%E7%94%A8-02-%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81/shiro%E5%BA%94%E7%94%A8-02-%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">shiro应用-02-权限配置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-05-07 09:17:57" itemprop="dateCreated datePublished" datetime="2021-05-07T09:17:57+08:00">2021-05-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-11-07 13:00:50" itemprop="dateModified" datetime="2021-11-07T13:00:50+08:00">2021-11-07</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="配置位置"><a href="#配置位置" class="headerlink" title="配置位置"></a>配置位置</h3><p>认证和授权的存储和交互都在AuthorizingReaml中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Lazy</span> 延迟注入，不然redis注解会因为注入顺序问题失效</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Lazy</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 授权</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> principals</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">        User user = (User) principals.fromRealm(<span class="keyword">this</span>.getClass().getName()).iterator().next();</span><br><span class="line">        List&lt;String&gt; permissionList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        List&lt;String&gt; roleNameList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        Set&lt;Role&gt; roleSet = user.getRoles();</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(roleSet)) &#123;</span><br><span class="line">            <span class="keyword">for</span>(Role role : roleSet) &#123;</span><br><span class="line">                roleNameList.add(role.getName());</span><br><span class="line">                Set&lt;Permission&gt; permissionSet = role.getPermissions();</span><br><span class="line">                <span class="keyword">if</span> (CollectionUtils.isNotEmpty(permissionSet)) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (Permission permission : permissionSet) &#123;</span><br><span class="line">                        permissionList.add(permission.getName());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        SimpleAuthorizationInfo info = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line">        info.addStringPermissions(permissionList);</span><br><span class="line">        info.addRoles(roleNameList);</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 认证登录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> AuthenticationException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        UsernamePasswordToken usernamePasswordToken = (UsernamePasswordToken) token;</span><br><span class="line">        String username = usernamePasswordToken.getUsername();</span><br><span class="line">        User user = userService.findByUsername(username);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(user, user.getPassword(), <span class="keyword">this</span>.getClass().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="执行位置"><a href="#执行位置" class="headerlink" title="执行位置"></a>执行位置</h3><p>shiro 中的AuthorizingRealm有2个方法doGetAuthorizationInfo()和doGetAuthenticationInfo(),一般实际开发中继承AuthorizingRealm类然后重写doGetAuthorizationInfo和doGetAuthenticationInfo。     </p>
<ul>
<li>doGetAuthenticationInfo方法是在用户登录的时候调用的也就是执SecurityUtils.getSubject().login（）的时候调用，即登录验证</li>
<li>doGetAuthorizationInfo方法是调用SecurityUtils.getSubject().isPermitted（）这个方法时会调用doGetAuthorizationInfo（），<ul>
<li>@RequiresPermissions这个注解起始就是在执行SecurityUtils.getSubject().isPermitted（）。</li>
<li>某个方法上加上@RequiresPermissions，那么访问这个方法就会自动调用SecurityUtils.getSubject().isPermitted（），从而区调用doGetAuthorizationInfo</li>
</ul>
</li>
</ul>
<h4 id="踩的坑"><a href="#踩的坑" class="headerlink" title="踩的坑"></a>踩的坑</h4><p>调用链：isPermitted -&gt; getAuhtorizationInfo -&gt; doGetAuthorizationInfo</p>
<p>但是，如果不做单点登录，一个账号被多个用户登录，那么账户信息会被cache保存，在getAuhtorizationInfo会判断，如果账户信息被cache了，就不执行doGetAuthorizationInfo</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81/shiro-spring%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-04-%E6%9D%83%E9%99%90%E6%B3%A8%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81/shiro-spring%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-04-%E6%9D%83%E9%99%90%E6%B3%A8%E8%A7%A3/" class="post-title-link" itemprop="url">shiro源码解析-04-权限注解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-05-07 09:13:54" itemprop="dateCreated datePublished" datetime="2021-05-07T09:13:54+08:00">2021-05-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-11-07 13:00:50" itemprop="dateModified" datetime="2021-11-07T13:00:50+08:00">2021-11-07</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>前不久学习了Shiro 1.4.0提供的权限注解实现权限拦截。最开始猜测实现方式是基于AspectJ方式，即基于<code>@Apsect</code>配合<code>@Pointcut和@After,@AfterReturning,@AfterThrowing,@Around,@Before</code>实现。具体Spring基于Aspect，AOP实现类可以查看<code>AnnotationAwareAspectJAutoProxyCreator</code>。在此提供该类的UML图：</p>
<p><a target="_blank" rel="noopener" href="https://img-blog.csdnimg.cn/20190915155105740.JPG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ExNjkzODg4NDI=,size_16,color_FFFFFF,t_70"><img src="https://img-blog.csdnimg.cn/20190915155105740.JPG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ExNjkzODg4NDI=,size_16,color_FFFFFF,t_70" alt="Spring基于AspectJ实现的AOP实现类UML图"></a></p>
<p><a target="_blank" rel="noopener" href="https://img-blog.csdnimg.cn/20190915155105740.JPG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ExNjkzODg4NDI=,size_16,color_FFFFFF,t_70">Spring基于AspectJ实现的AOP实现类UML图</a></p>
<p>你可以看到Spring AOP实现继承类大致为ProxyConfig-&gt;ProxyProcessorSupport-&gt;AbstractAutoProxyCreator</p>
<p>-&gt;AbstractAdvisorAutoProxyCreator这条路线。其中Spring常见AOP实现类有3个。</p>
<ul>
<li><code>DefaultAdvisorAutoProxyCreator</code>：寻找当前BeanFactory中所有的候选<code>Advisor(有一个切点和一个通知构成)</code>，将这些Advisor应用到所有符合切点的Bean中。基于Advisor 匹配规则。</li>
<li><code>BeanNameAutoProxyCreator</code>：基于Bean配置名规则</li>
<li><code>AnnotationAwareAspectJAutoProxyCreator</code>：基于Bean中@AspectJ注解匹配规则。</li>
</ul>
<p>而Shiro权限注解实现原理是基于<code>DefaultAdvisorAutoProxyCreator</code>实现的。其权限注解处理Advisor实现类是<code>AuthorizationAttributeSourceAdvisor</code>。该类继承了<code>StaticMethodMatcherPointcutAdvisor</code>，内部只对Shiro提供的5个权限注解标注的方法或者类进行切面增强。<code>StaticMethodMatcherPointcutAdvisor</code>是静态方法切点基类，默认匹配所有的的类。<code>StaticMethodMatcherPointcut</code>包括两个主要的子类分别是</p>
<p><code>JdkRegexpMethodPointcut</code>和<code>NameMatchMethodPointcut</code>。前者提供正则表达式匹配方法切面，而后者<strong>作为正则表达式的替代，不处理重载方法，默认实现检测xxx*, *xxx 和*xxx*</strong>。</p>
<h3 id="AuthorizationAttributeSourceAdvisor"><a href="#AuthorizationAttributeSourceAdvisor" class="headerlink" title="AuthorizationAttributeSourceAdvisor"></a>AuthorizationAttributeSourceAdvisor</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">public class AuthorizationAttributeSourceAdvisor extends StaticMethodMatcherPointcutAdvisor &#123;</span><br><span class="line"></span><br><span class="line">    private static final Class&lt;? extends Annotation&gt;[] AUTHZ_ANNOTATION_CLASSES &#x3D;</span><br><span class="line">            new Class[] &#123;</span><br><span class="line">                    RequiresPermissions.class, RequiresRoles.class,</span><br><span class="line">                    RequiresUser.class, RequiresGuest.class, RequiresAuthentication.class</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">    protected SecurityManager securityManager &#x3D; null;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Create a new AuthorizationAttributeSourceAdvisor.</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public AuthorizationAttributeSourceAdvisor() &#123;</span><br><span class="line">        setAdvice(new AopAllianceAnnotationsAuthorizingMethodInterceptor());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public SecurityManager getSecurityManager() &#123;</span><br><span class="line">        return securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setSecurityManager(org.apache.shiro.mgt.SecurityManager securityManager) &#123;</span><br><span class="line">        this.securityManager &#x3D; securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean matches(Method method, Class targetClass) &#123;</span><br><span class="line">        Method m &#x3D; method;</span><br><span class="line"></span><br><span class="line">        if ( isAuthzAnnotationPresent(m) ) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;The &#39;method&#39; parameter could be from an interface that doesn&#39;t have the annotation.</span><br><span class="line">        &#x2F;&#x2F;Check to see if the implementation has it.</span><br><span class="line">        if ( targetClass !&#x3D; null) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                m &#x3D; targetClass.getMethod(m.getName(), m.getParameterTypes());</span><br><span class="line">                return isAuthzAnnotationPresent(m) || isAuthzAnnotationPresent(targetClass);</span><br><span class="line">            &#125; catch (NoSuchMethodException ignored) &#123;</span><br><span class="line">                &#x2F;&#x2F;default return value is false.  If we can&#39;t find the method, then obviously</span><br><span class="line">                &#x2F;&#x2F;there is no annotation, so just use the default return value.</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 检测类上是否存在权限验证注解</span><br><span class="line">    private boolean isAuthzAnnotationPresent(Class&lt;?&gt; targetClazz) &#123;</span><br><span class="line">        for( Class&lt;? extends Annotation&gt; annClass : AUTHZ_ANNOTATION_CLASSES ) &#123;</span><br><span class="line">            Annotation a &#x3D; AnnotationUtils.findAnnotation(targetClazz, annClass);</span><br><span class="line">            if ( a !&#x3D; null ) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 检测方法上是否存在权限验证注解</span><br><span class="line">    private boolean isAuthzAnnotationPresent(Method method) &#123;</span><br><span class="line">        for( Class&lt;? extends Annotation&gt; annClass : AUTHZ_ANNOTATION_CLASSES ) &#123;</span><br><span class="line">            Annotation a &#x3D; AnnotationUtils.findAnnotation(method, annClass);</span><br><span class="line">            if ( a !&#x3D; null ) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Shiro注解权限验证MethodInterceptor"><a href="#Shiro注解权限验证MethodInterceptor" class="headerlink" title="Shiro注解权限验证MethodInterceptor"></a>Shiro注解权限验证MethodInterceptor</h3><p>该类是Shiro权限注解拦截器。初始化时，<code>interceptors</code>添加了5个方法拦截器，分别对5种权限验证方法进行拦截。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public class AopAllianceAnnotationsAuthorizingMethodInterceptor</span><br><span class="line">        extends AnnotationsAuthorizingMethodInterceptor implements MethodInterceptor &#123;</span><br><span class="line"></span><br><span class="line">    public AopAllianceAnnotationsAuthorizingMethodInterceptor() &#123;</span><br><span class="line">        List&lt;AuthorizingAnnotationMethodInterceptor&gt; interceptors &#x3D;</span><br><span class="line">                new ArrayList&lt;AuthorizingAnnotationMethodInterceptor&gt;(5);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;use a Spring-specific Annotation resolver - Spring&#39;s AnnotationUtils is nicer than the</span><br><span class="line">        &#x2F;&#x2F;raw JDK resolution process.</span><br><span class="line">        AnnotationResolver resolver &#x3D; new SpringAnnotationResolver();</span><br><span class="line">        &#x2F;&#x2F;we can re-use the same resolver instance - it does not retain state:</span><br><span class="line">        interceptors.add(new RoleAnnotationMethodInterceptor(resolver));</span><br><span class="line">        interceptors.add(new PermissionAnnotationMethodInterceptor(resolver));</span><br><span class="line">        interceptors.add(new AuthenticatedAnnotationMethodInterceptor(resolver));</span><br><span class="line">        interceptors.add(new UserAnnotationMethodInterceptor(resolver));</span><br><span class="line">        interceptors.add(new GuestAnnotationMethodInterceptor(resolver));</span><br><span class="line"></span><br><span class="line">        setMethodInterceptors(interceptors);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    public Object invoke(MethodInvocation methodInvocation) throws Throwable &#123;</span><br><span class="line">        org.apache.shiro.aop.MethodInvocation mi &#x3D; createMethodInvocation(methodInvocation);</span><br><span class="line">        return super.invoke(mi);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该类通过调用invoke方法，进而调用超级父类<code>AuthorizingMethodInterceptor</code>的invoke方法，在该方法中会先执行<code>assertAuthorized</code>方法，进行权限校验，校验不通过抛出<code>AuthorizationException</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public abstract class AuthorizingMethodInterceptor extends MethodInterceptorSupport &#123;</span><br><span class="line"></span><br><span class="line">    public Object invoke(MethodInvocation methodInvocation) throws Throwable &#123;</span><br><span class="line">        assertAuthorized(methodInvocation);</span><br><span class="line">        return methodInvocation.proceed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected abstract void assertAuthorized(MethodInvocation methodInvocation) throws AuthorizationException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>assertAuthorized</code>方法最终执行还是<code>AnnotationsAuthorizingMethodInterceptor</code>。而<code>AuthorizingMethodInterceptor</code>有5个具体的实现类。如下：</p>
<ul>
<li>RoleAnnotationMethodInterceptor</li>
<li>PermissionAnnotationMethodInterceptor</li>
<li>AuthenticatedAnnotationMethodInterceptor</li>
<li>UserAnnotationMethodInterceptor</li>
<li>GuestAnnotationMethodInterceptor</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public abstract class AnnotationsAuthorizingMethodInterceptor extends AuthorizingMethodInterceptor &#123;</span><br><span class="line">   </span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">    protected void assertAuthorized(MethodInvocation methodInvocation) throws AuthorizationException &#123;</span><br><span class="line">        &#x2F;&#x2F;default implementation just ensures no deny votes are cast:</span><br><span class="line">        Collection&lt;AuthorizingAnnotationMethodInterceptor&gt; aamis &#x3D; getMethodInterceptors();</span><br><span class="line">        if (aamis !&#x3D; null &amp;&amp; !aamis.isEmpty()) &#123;</span><br><span class="line">            for (AuthorizingAnnotationMethodInterceptor aami : aamis) &#123;</span><br><span class="line">                if (aami.supports(methodInvocation)) &#123;</span><br><span class="line">                    aami.assertAuthorized(methodInvocation);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AuthorizingAnnotationMethodInterceptor</code>首先从子类获取<code>AuthorizingAnnotationHandler</code>，再调用该实现类的<code>assertAuthorized</code>方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public abstract class AuthorizingAnnotationMethodInterceptor extends AnnotationMethodInterceptor</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    public AuthorizingAnnotationMethodInterceptor( AuthorizingAnnotationHandler handler ) &#123;</span><br><span class="line">        super(handler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public AuthorizingAnnotationMethodInterceptor( AuthorizingAnnotationHandler handler,</span><br><span class="line">                                                   AnnotationResolver resolver) &#123;</span><br><span class="line">        super(handler, resolver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Object invoke(MethodInvocation methodInvocation) throws Throwable &#123;</span><br><span class="line">        assertAuthorized(methodInvocation);</span><br><span class="line">        return methodInvocation.proceed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void assertAuthorized(MethodInvocation mi) throws AuthorizationException &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            ((AuthorizingAnnotationHandler)getHandler()).assertAuthorized(getAnnotation(mi));</span><br><span class="line">        &#125;</span><br><span class="line">        catch(AuthorizationException ae) &#123;</span><br><span class="line">            &#x2F;&#x2F; Annotation handler doesn&#39;t know why it was called, so add the information here if possible. </span><br><span class="line">            &#x2F;&#x2F; Don&#39;t wrap the exception here since we don&#39;t want to mask the specific exception, such as </span><br><span class="line">            &#x2F;&#x2F; UnauthenticatedException etc. </span><br><span class="line">            if (ae.getCause() &#x3D;&#x3D; null) ae.initCause(new AuthorizationException(&quot;Not authorized to invoke method: &quot; + mi.getMethod()));</span><br><span class="line">            throw ae;</span><br><span class="line">        &#125;         </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RoleAnnotationMethodInterceptor"><a href="#RoleAnnotationMethodInterceptor" class="headerlink" title="RoleAnnotationMethodInterceptor"></a>RoleAnnotationMethodInterceptor</h3><p>下面分析一下RoleAnnotationMethodInterceptor。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class RoleAnnotationMethodInterceptor extends AuthorizingAnnotationMethodInterceptor &#123;</span><br><span class="line"></span><br><span class="line">    public RoleAnnotationMethodInterceptor() &#123;</span><br><span class="line">        super( new RoleAnnotationHandler() );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; 具体校验逻辑交给RoleAnnotationHandler</span><br><span class="line">    public RoleAnnotationMethodInterceptor(AnnotationResolver resolver) &#123;</span><br><span class="line">        super(new RoleAnnotationHandler(), resolver);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RoleAnnotationHandler</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public class RoleAnnotationHandler extends AuthorizingAnnotationHandler &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">   </span><br><span class="line">    public void assertAuthorized(Annotation a) throws AuthorizationException &#123;</span><br><span class="line">        if (!(a instanceof RequiresRoles)) return;</span><br><span class="line"></span><br><span class="line">        RequiresRoles rrAnnotation &#x3D; (RequiresRoles) a;</span><br><span class="line">        String[] roles &#x3D; rrAnnotation.value();</span><br><span class="line"></span><br><span class="line">        if (roles.length &#x3D;&#x3D; 1) &#123;</span><br><span class="line">            getSubject().checkRole(roles[0]);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (Logical.AND.equals(rrAnnotation.logical())) &#123;</span><br><span class="line">            getSubject().checkRoles(Arrays.asList(roles));</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        if (Logical.OR.equals(rrAnnotation.logical())) &#123;</span><br><span class="line">            &#x2F;&#x2F; Avoid processing exceptions unnecessarily - &quot;delay&quot; throwing the exception by calling hasRole first</span><br><span class="line">            boolean hasAtLeastOneRole &#x3D; false;</span><br><span class="line">            for (String role : roles) if (getSubject().hasRole(role)) hasAtLeastOneRole &#x3D; true;</span><br><span class="line">            &#x2F;&#x2F; Cause the exception if none of the role match, note that the exception message will be a bit misleading</span><br><span class="line">            if (!hasAtLeastOneRole) getSubject().checkRole(roles[0]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现类似编程式AOP"><a href="#实现类似编程式AOP" class="headerlink" title="实现类似编程式AOP"></a>实现类似编程式AOP</h2><ol>
<li>定义一个注解<code>LogPrinter</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Target(&#123;ElementType.METHOD&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">public @interface LogPrinter &#123;</span><br><span class="line">    String value() default &quot;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>继承StaticMethodMatcherPointcutAdvisor</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public class LogPrinterAdvisor extends StaticMethodMatcherPointcutAdvisor &#123;</span><br><span class="line"></span><br><span class="line">    public LogPrinterAdvisor() &#123;</span><br><span class="line">        setAdvice(new LogPrinterMethodInterceptor());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean matches(@NonNull Method method, Class&lt;?&gt; targetClass) &#123;</span><br><span class="line">        Method m &#x3D; method;</span><br><span class="line">        if (isAnnotationPresent(m)) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (targetClass !&#x3D; null) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                m &#x3D; targetClass.getMethod(m.getName(), m.getParameterTypes());</span><br><span class="line">                return isAnnotationPresent(m);</span><br><span class="line">            &#125; catch (NoSuchMethodException ignored) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private boolean isAnnotationPresent(Method method) &#123;</span><br><span class="line">        Annotation a &#x3D; AnnotationUtils.findAnnotation(method, LogPrinter.class);</span><br><span class="line">        return a !&#x3D; null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>实现<code>MethodInterceptor</code>接口，定义切面处理逻辑</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class LogPrinterMethodInterceptor implements MethodInterceptor &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public Object invoke(MethodInvocation invocation) throws Throwable &#123;</span><br><span class="line">        LogPrinter logPrinter &#x3D; invocation.getMethod().getAnnotation(LogPrinter.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;log printer: &quot;+logPrinter.value());</span><br><span class="line">        return invocation.proceed();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>定义测试类，并添加LogPrinter注解</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class HelloWorld &#123;</span><br><span class="line"></span><br><span class="line">    @LogPrinter(&quot;hello world&quot;)</span><br><span class="line">    public void hello() &#123;</span><br><span class="line">        System.out.println(&quot;Hello&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>启动类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogAdvisorApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultAdvisorAutoProxyCreator <span class="title">defaultAdvisorAutoProxyCreator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultAdvisorAutoProxyCreator defaultAdvisorAutoProxyCreator = <span class="keyword">new</span> DefaultAdvisorAutoProxyCreator();</span><br><span class="line">        defaultAdvisorAutoProxyCreator.setProxyTargetClass(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> defaultAdvisorAutoProxyCreator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LogPrinterAdvisor <span class="title">logPrinterAdvisor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LogPrinterAdvisor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext context = SpringApplication.run(LogAdvisorApplication.class, args);</span><br><span class="line">        HelloWorld helloWorld = context.getBean(HelloWorld.class);</span><br><span class="line">        helloWorld.hello();</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结与思考"><a href="#总结与思考" class="headerlink" title="总结与思考"></a>总结与思考</h2><p>Shiro的注解式权限，核心配置是一个<code>DefaultAdvisorAutoProxyCreator</code>和继承静态方法顾问<code>StaticMethodMatcherPointcutAdvisor</code>。其中5种权限注解，使用了统一的代码架构，用到了模板</p>
<p>设计模式。在架构实现上要好于<code>AspectJ注解实现</code>。</p>
<p><a target="_blank" rel="noopener" href="https://img-blog.csdnimg.cn/20190915155201485.JPG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ExNjkzODg4NDI=,size_16,color_FFFFFF,t_70"><img src="https://img-blog.csdnimg.cn/20190915155201485.JPG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ExNjkzODg4NDI=,size_16,color_FFFFFF,t_70" alt="Shiro角色权限注解UML示意图"></a></p>
<p><a target="_blank" rel="noopener" href="https://img-blog.csdnimg.cn/20190915155201485.JPG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ExNjkzODg4NDI=,size_16,color_FFFFFF,t_70">Shiro角色权限注解UML示意图</a></p>
<p><a target="_blank" rel="noopener" href="https://img-blog.csdnimg.cn/20190915155130196.JPG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ExNjkzODg4NDI=,size_16,color_FFFFFF,t_70"><img src="https://img-blog.csdnimg.cn/20190915155130196.JPG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ExNjkzODg4NDI=,size_16,color_FFFFFF,t_70" alt="Shiro权限注解AOP实现类UML图"></a></p>
<p><a target="_blank" rel="noopener" href="https://img-blog.csdnimg.cn/20190915155130196.JPG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ExNjkzODg4NDI=,size_16,color_FFFFFF,t_70">Shiro权限注解AOP实现类UML图</a></p>
<p><strong>文章作者:</strong> <a href="mailto:undefined">知源</a></p>
<p><strong>文章链接:</strong> <a target="_blank" rel="noopener" href="https://crazyblitz.github.io/2019/09/15/Shiro%E6%9D%83%E9%99%90%E6%B3%A8%E8%A7%A3AOP%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">https://crazyblitz.github.io/2019/09/15/Shiro权限注解AOP实现原理分析/</a></p>
<p><strong>版权声明:</strong> 本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a target="_blank" rel="noopener" href="https://crazyblitz.github.io/">知源博客</a>！</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81/shiro%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-01/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81/shiro%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-01/" class="post-title-link" itemprop="url">shiro源码解析-01</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-05-07 09:12:23" itemprop="dateCreated datePublished" datetime="2021-05-07T09:12:23+08:00">2021-05-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-11-07 13:00:50" itemprop="dateModified" datetime="2021-11-07T13:00:50+08:00">2021-11-07</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>目录</p>
<ol>
<li><a target="_blank" rel="noopener" href="http://my.oschina.net/huangyong/blog/209339">Shiro 之 入口：EnvironmentLoaderListener</a>【由 黄勇 分享】</li>
<li><a target="_blank" rel="noopener" href="http://my.oschina.net/huangyong/blog/210438">Shiro 之 Filter（上）：ShiroFilter</a>【由 黄勇 分享】</li>
<li>Shiro 之 Filter（下）</li>
<li><a target="_blank" rel="noopener" href="http://my.oschina.net/snakerflow/blog/219860">Shiro 之 Realm</a>【由 Dead_knight 分享】</li>
<li>Shiro 之 SessionManager</li>
<li><a target="_blank" rel="noopener" href="http://my.oschina.net/snakerflow/blog/219859">Shiro 之 SecurityManager</a>【由 Dead_knight 分享】</li>
<li>Shiro 之 加密与解密</li>
<li>Shiro 之 JSP Tag</li>
<li>Shiro 之 Cache</li>
<li>Shiro 之 与 Spring 集成</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/06/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/jvm/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/06/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/jvm/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">类加载机制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-05-06 23:44:42" itemprop="dateCreated datePublished" datetime="2021-05-06T23:44:42+08:00">2021-05-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-05-07 08:37:32" itemprop="dateModified" datetime="2021-05-07T08:37:32+08:00">2021-05-07</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="双亲委派是什么"><a href="#双亲委派是什么" class="headerlink" title="双亲委派是什么"></a>双亲委派是什么</h3><p>如果一个类加载器收到了类加载的请求，他首先会从自己缓存里查找是否之前加载过这个class，加载过直接返回，没加载过的话他不会自己亲自去加载，他会把这个请求委派给父类加载器去完成，每一层都是如此，类似递归，一直递归到顶层父类。</p>
<p>也就是<code>Bootstrap ClassLoader</code>，只要加载完成就会返回结果，如果顶层父类加载器无法加载此class，则会返回去交给子类加载器去尝试加载，若最底层的子类加载器也没找到，则会抛出<code>ClassNotFoundException</code>。</p>
<p>源码在<code>java.lang.ClassLoader#loadClass(java.lang.String, boolean)</code></p>
<h3 id="为什么需要破坏双亲委派模型"><a href="#为什么需要破坏双亲委派模型" class="headerlink" title="为什么需要破坏双亲委派模型"></a>为什么需要破坏双亲委派模型</h3><blockquote>
<p>Jdbc</p>
</blockquote>
<p>Jdbc为什么要破坏双亲委派模型？</p>
<p>以前的用法是未破坏双亲委派模型的，比如<code>Class.forName(&quot;com.mysql.cj.jdbc.Driver&quot;);</code></p>
<p>而在JDBC4.0以后，开始支持使用spi的方式来注册这个Driver，具体做法就是在mysql的jar包中的<code>META-INF/services/java.sql.Driver</code>文件中指明当前使用的Driver是哪个，然后使用的时候就不需要我们手动的去加载驱动了，我们只需要直接获取连接就可以了。<code>Connection con = DriverManager.getConnection(url, username, password );</code></p>
<p>首先，理解一下为什么JDBC需要破坏双亲委派模式，原因是原生的JDBC中Driver驱动本身只是一个接口，并没有具体的实现，具体的实现是由不同数据库类型去实现的。例如，MySQL的<code>mysql-connector-*.jar</code>中的Driver类具体实现的。</p>
<p>原生的JDBC中的类是放在<code>rt.jar</code>包的，是由Bootstrap加载器进行类加载的，在JDBC中的Driver类中需要动态去加载不同数据库类型的Driver类，而<code>mysql-connector-*.jar</code>中的Driver类是用户自己写的代码，那Bootstrap类加载器肯定是不能进行加载的，既然是自己编写的代码，那就需要由Application类加载器去进行类加载。</p>
<p>这个时候就引入线程上下文件类加载器(<code>Thread Context ClassLoader</code>)，通过这个东西程序就可以把原本需要由Bootstrap类加载器进行加载的类由Application类加载器去进行加载了。</p>
<blockquote>
<p>Tomcat</p>
</blockquote>
<p>Tomcat为什么要破坏双亲委派模型？</p>
<p>因为一个Tomcat可以部署N个web应用，但是每个web应用都有自己的classloader，互不干扰。比如web1里面有<code>com.test.A.class</code>，web2里面也有<code>com.test.A.class</code>，如果没打破双亲委派模型的话，那么web1加载完后，web2在加载的话会冲突。</p>
<p>因为只有一套classloader，却出现了两个重复的类路径，所以tomcat打破了双亲委派。Tomcat线程级别的，不同web应用是不同的classloader。</p>
<ul>
<li>Java spi 方式，比如jdbc4.0开始就是其中之一。</li>
<li>热部署的场景会破坏，否则实现不了热部署。</li>
</ul>
<h3 id="如何破坏双亲委派模型"><a href="#如何破坏双亲委派模型" class="headerlink" title="如何破坏双亲委派模型"></a>如何破坏双亲委派模型</h3><p>重写<code>loadClass</code>方法，别重写<code>findClass</code>方法，因为<code>loadClass</code>是核心入口，将其重写成自定义逻辑即可破坏双亲委派模型。</p>
<h3 id="如何自定义一个类加载器"><a href="#如何自定义一个类加载器" class="headerlink" title="如何自定义一个类加载器"></a>如何自定义一个类加载器</h3><p>只需要继承<code>java.lang.Classloader</code>类，然后覆盖他的<code>findClass(String name)</code>方法即可，该方法根据参数指定的类名称，返回对应 的Class对象的引用。</p>
<h3 id="热部署原理"><a href="#热部署原理" class="headerlink" title="热部署原理"></a>热部署原理</h3><p>采取破坏双亲委派模型的手段来实现热部署，默认的<code>loadClass()</code>方法先找缓存，你改了class字节码也不会热加载，所以自定义ClassLoader，去掉找缓存那部分，直接就去加载，也就是每次都重新加载。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/06/database/redis/redis%E8%B0%83%E4%BC%98%E5%92%8C%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7/Redis-%E7%BA%BF%E4%B8%8A%E9%AB%98%E5%BB%B6%E8%BF%9F%E6%8E%92%E6%9F%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/06/database/redis/redis%E8%B0%83%E4%BC%98%E5%92%8C%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7/Redis-%E7%BA%BF%E4%B8%8A%E9%AB%98%E5%BB%B6%E8%BF%9F%E6%8E%92%E6%9F%A5/" class="post-title-link" itemprop="url">Redis-线上高延迟排查</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-05-06 12:04:04 / Modified: 13:22:05" itemprop="dateCreated datePublished" datetime="2021-05-06T12:04:04+08:00">2021-05-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="一条命令执行过程"><a href="#一条命令执行过程" class="headerlink" title="一条命令执行过程"></a>一条命令执行过程</h3><p>在本文场景下，延迟 (latency) 是指从客户端发送命令到客户端接收到命令返回值的时间间隔。</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/9QbuglRCMtdhic9zTZh5xCllEzgLWRcOXQoemRPGek07hlpV6XpJsFTsnZuTyeVWg7Gymsd7yU84UOhwXMUSe3A/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image"></p>
<p>上图是 Redis 客户端发送一条命令的执行过程示意图，绿色的是执行步骤，而蓝色的则是可能出现的导致高延迟的原因。</p>
<h4 id="网络连接限制、网络传输速率和CPU性能等是所有服务端都可能产生的性能问题"><a href="#网络连接限制、网络传输速率和CPU性能等是所有服务端都可能产生的性能问题" class="headerlink" title="网络连接限制、网络传输速率和CPU性能等是所有服务端都可能产生的性能问题"></a>网络连接限制、网络传输速率和CPU性能等是所有服务端都可能产生的性能问题</h4><h4 id="Redis-自己可能导致高延迟"><a href="#Redis-自己可能导致高延迟" class="headerlink" title="Redis 自己可能导致高延迟"></a>Redis 自己可能导致高延迟</h4><ul>
<li>命令或者数据结构误用、持久化阻塞和内存交换。</li>
<li>而且，Redis 采用<a href="">单线程</a>和<a href="">事件驱动的机制</a>来处理网络请求，分别有对应的<a href="">连接应答处理器</a>，<a href="">命令请求处理器</a>和<a href="">命令回复处理器</a>来处理客户端的网络请求事件，处理完一个事件就继续处理队列中的下一个。一条命令处理出现了高延迟会影响接下来处于排队状态的其他命令。</li>
</ul>
<img src="https://mmbiz.qpic.cn/mmbiz_png/9QbuglRCMtdhic9zTZh5xCllEzgLWRcOXscLk1bRExg5BlLia5K6hRZQz1gUakMksxtLjkl7ibMDMz8m9ib2evyEYg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image" style="zoom:50%;" />

<h3 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h3><p>对于高延迟，Redis 原生提供慢查询统计功能，执行 slowlog get {n} 命令可以获取最近的 n 条慢查询命令，默认对于执行超过10毫秒(可配置)的命令都会记录到一个定长队列中，线上实例建议设置为1毫秒便于及时发现毫秒级以上的命令。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 超过 slowlog-log-slower-than 阈值的命令都会被记录到慢查询队列中</span><br><span class="line"># 队列最大长度为 slowlog-max-lenslowlog-log-slower-than 10000s lowlog-max-len 128</span><br></pre></td></tr></table></figure>

<p>如果命令执行时间在毫秒级，则实例实际OPS只有1000左右。慢查询队列长度默认128，可适当调大。慢查询本身只记录了命令执行时间，不包括数据网络传输时间和命令排队时间，因此客户端发生阻塞异常 后，可能不是当前命令缓慢，而是在等待其他命令执行。需要重点比对异常和慢查询发生的时间点，确认是否有慢查询造成的命令阻塞排队。</p>
<h4 id="不合理的命令或者数据结构"><a href="#不合理的命令或者数据结构" class="headerlink" title="不合理的命令或者数据结构"></a>不合理的命令或者数据结构</h4><p>比如对一个包含上万个元素的 hash 结构执行 hgetall 操作，由于数据量比较大且命令算法复杂度是 O(n)，这条命令执行速度必然很慢。</p>
<p>这个问题就是典型的不合理使用命令和数据结构。对于高并发的场景我们应该尽量避免在大对象上执行算法复杂度超过 O(n) 的命令。对于键值较多的 hash 结构可以使用 scan 系列命令来逐步遍历，而不是直接使用 hgetall 来全部获取。</p>
<p>Redis 本身提供发现大对象的工具，对应命令：redis-cli-h {ip} -p {port} bigkeys。这条命令会使用 scan 从指定的 Redis DB 中持续采样，实时输出当时得到的 value 占用空间最大的 key 值，并在最后给出各种数据结构的 biggest key 的总结报告。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; redis-cli -h host -p 12345 --bigkeys</span><br></pre></td></tr></table></figure>

<h4 id="持久化阻塞"><a href="#持久化阻塞" class="headerlink" title="持久化阻塞"></a>持久化阻塞</h4><p>对于开启了持久化功能的Redis节点，需要排查是否是持久化导致的阻塞。持久化引起主线程阻塞的操作主要有：fork 阻塞、AOF刷盘阻塞。</p>
<p>fork 操作发生在 RDB 和 AOF 重写时，Redis 主线程调用 fork 操作产生共享内存的子进程，由子进程完成对应的持久化工作。如果 fork 操作本身耗时过长，必然会导致主线程的阻塞。</p>
<img src="https://mmbiz.qpic.cn/mmbiz_png/9QbuglRCMtdhic9zTZh5xCllEzgLWRcOXA2v2rmicbJ08REVFIiaYfMbvnJtMTqCV27OtND6ZCkibB9ia69ZWlmr3rw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image" style="zoom:67%;" />

<p>Redis 执行 fork 操作产生的子进程内存占用量表现为与父进程相同，理论上需要一倍的物理内存来完成相应的操作。但是 Linux 具有写时复制技术 (copy-on-write)，父子进程会共享相同的物理内存页，当父进程处理写请求时会对需要修改的页复制出一份副本完成写操作，而子进程依然读取 fork 时整个父进程的内存快照。所以，一般来说，fork 不会消耗过多时间。</p>
<p>可以执行 <code>info stats</code>命令获取到 latestforkusec 指标，表示 Redis 最近一次 fork 操作耗时，如果耗时很大，比如超过1秒，则需要做出优化调整。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; redis-cli -c -p 7000 info | grep -w latest_fork_useclatest_fork_usec:315</span><br></pre></td></tr></table></figure>

<p>当我们开启AOF持久化功能时，文件刷盘的方式一般采用每秒一次，后台线程每秒对AOF文件做 fsync 操作。当硬盘压力过大时，fsync 操作需要等待，直到写入完成。如果主线程发现距离上一次的 fsync 成功超过2秒，为了数据安全性它会阻塞直到后台线程执行 fsync 操作完成。这种阻塞行为主要是硬盘压力引起，可以查看 Redis日志识别出这种情况，当发生这种阻塞行为时，会打印如下日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Asynchronous AOF fsync is taking too long (disk is busy). \Writing the AOF buffer without waiting for fsync to complete, \this may slow down Redis.</span><br></pre></td></tr></table></figure>

<p>也可以查看 info persistence 统计中的 aofdelayedfsync 指标，每次发生 fdatasync 阻塞主线程时会累加。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;info persistenceloading:0aof_pending_bio_fsync:0aof_delayed_fsync:0</span><br></pre></td></tr></table></figure>

<h4 id="内存交换"><a href="#内存交换" class="headerlink" title="内存交换"></a>内存交换</h4><p>内存交换（swap）对于 Redis 来说是非常致命的，Redis 保证高性能的一个重要前提是所有的数据在内存中。如果操作系统把 Redis 使用的部分内存换出到硬盘，由于内存与硬盘读写速度差几个数量级，会导致发生交换后的 Redis 性能急剧下降。识别 Redis 内存交换的检查方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;redis-cli -p 6383 info server | grep process_id # 查询 redis 进程号</span><br><span class="line">&gt;cat &#x2F;proc&#x2F;4476&#x2F;smaps | grep Swap # 查询内存交换大小Swap: 0 kBSwap: 4 kBSwap: 0 kBSwap: 0 kB</span><br></pre></td></tr></table></figure>

<p>如果交换量都是0KB或者个别的是4KB，则是正常现象，说明Redis进程内存没有被交换。</p>
<p>有很多方法可以避免内存交换的发生。比如说：</p>
<ul>
<li>保证机器充足的可用内存</li>
<li>确保所有Redis实例设置最大可用内存(maxmemory)，防止极端情况下 Redis 内存不可控的增长。</li>
<li>降低系统使用swap优先级，如 <code>echo 10&gt;/proc/sys/vm/swappiness</code>。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/05/database/redis/redis%E8%B0%83%E4%BC%98%E5%92%8C%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7/Redis-%E7%BA%BF%E4%B8%8ACPU%E9%A3%99%E5%8D%87%E6%8E%92%E6%9F%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/05/database/redis/redis%E8%B0%83%E4%BC%98%E5%92%8C%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7/Redis-%E7%BA%BF%E4%B8%8ACPU%E9%A3%99%E5%8D%87%E6%8E%92%E6%9F%A5/" class="post-title-link" itemprop="url">Redis-线上CPU飙升排查</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-05-05 23:10:13" itemprop="dateCreated datePublished" datetime="2021-05-05T23:10:13+08:00">2021-05-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-06-15 08:20:54" itemprop="dateModified" datetime="2021-06-15T08:20:54+08:00">2021-06-15</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Redis调用时间严重超时，这样高速的缓存反而变成了短板，由于数据一直没有返回，导致了请求响应变慢。</p>
<h2 id="网页监控"><a href="#网页监控" class="headerlink" title="网页监控"></a>网页监控</h2><p>通过阿里的 Grafana 监控，服务器的 CPU 负载、内存、网络输入输出都挺正常的，所以肯定是 Redis 出现了问题。</p>
<p>使用的是单节点的 32M 16GB 的阿里云 Redis，登录网页监控看性能监控，发现 CPU 使用情况飙升到100%</p>
<p>QPS 虽然从 1000 多升到 6000，但是远远低于极限值，连接数量从 0 升到 3000，也是远远低于极限值（可能用户刚上班，开始有请求，然后响应延迟，导致命令队列数量过多，打开很多连接）。</p>
<hr>
<h2 id="服务器命令监控"><a href="#服务器命令监控" class="headerlink" title="服务器命令监控"></a>服务器命令监控</h2><p>登录 Redis-cli，通过 info 命令查看服务器状态和命令统计，总结了两点异常点：</p>
<ul>
<li><p>查询 redis 慢指令 slowlog，排行前十的指令均为<code>keys _</code>，并且耗时严重，在当前业务流量下执行<code>keys _</code>，一定会阻塞业务，导致查询慢，cpu 高的。值得注意的是应用层面没有开放 <code>keys *</code> 接口，不排查有后台人为或后台程序触发该指令。</p>
<ul>
<li><p>通过 slowlog 命令查看慢命令（默认超过 10ms 就会被记录到日志，只会记录其命令执行的时间，不包含 IO 往返操作，也不记录单由网络延迟引起的响应慢）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">xxxxx&gt; slowlog get 10</span><br><span class="line"> 3) 1) (integer) 411           </span><br><span class="line">    2) (integer) 1545386469     </span><br><span class="line">    3) (integer) 232663          </span><br><span class="line">    4) 1) &quot;keys&quot;              </span><br><span class="line">       2) &quot;mecury:*&quot;</span><br></pre></td></tr></table></figure>

<p>图中各字段表示的是：</p>
<ul>
<li>1=日志的唯一标识符</li>
<li>2=命令的执行时间点，以UNIX时间戳表示</li>
<li>3=查询命令执行时间，以微妙为单位，中的是230ms</li>
<li>4=执行的命令，以数组的形式排列。完整的命令是 keys mucury:*</li>
</ul>
</li>
<li><p>所以通过这些参数，基本可以确定，是突然有大量的<code>keys *</code>命令导致CPU负载升高，导致响应延迟，问题我们应用中没有开放<code>keys *</code>命令。最后将这些统计结果和慢命令发到研发群，发现是别的应用配置配成了我们的Redis，然后他们有个业务场景是爬数据，突然涌入大量的调用，不断的keys *，导致我们的Redis不堪重负，于是将配置修改正确，不再调用我们的Redis。</p>
</li>
</ul>
</li>
<li><p>查看 redis 指令执行情况，排除 ‘exec’,’flushall’ 等指令，业务使用指令中，耗时严重的有 setnx 有7.5千万次调用平均耗时 6s，setex 有8.4千万次调用平均耗时7.33s，del 有2.6亿次调用平均耗时69s，hmset 有1亿次调用平均耗时 64s，hmget 有6.8千万次调用平均耗时 9s，hgetall 有14亿次调用平均耗时 205s，keys 有2千万次调用平均耗时 3740s。</p>
<ul>
<li><p>通常而言，这些指令耗时与 value 大小呈正比，所以可以排查这些指令相关的数据近期有没有较大增长。或者近期有没有业务改造，会频繁使用上述指令，也会造成 cpu 高。</p>
</li>
<li><p>通过 info commandstats 可以查看 Redis 命令统计信息，其中命令格式是<br>调用次数、耗费CPU时间、每个命令平均耗费CPU(单位为微秒）</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmdstat_XXX: calls&#x3D;XXX,usec&#x3D;XXX,usec_per_call&#x3D;XXX</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>Redis 抖动可以先看网页监控</li>
<li>通过命令查看 Redis 指令状态和慢命令的情况</li>
<li>考虑优化 Redis 在代码中的使用情况</li>
<li>如果流量继续上升，需要考虑一下升级了</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/05/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/java%E9%9D%A2%E8%AF%95%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/05/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/java%E9%9D%A2%E8%AF%95%E9%A2%98/" class="post-title-link" itemprop="url">解决Jar包依赖冲突</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-05-05 19:10:53" itemprop="dateCreated datePublished" datetime="2021-05-05T19:10:53+08:00">2021-05-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2023-03-23 17:49:06" itemprop="dateModified" datetime="2023-03-23T17:49:06+08:00">2023-03-23</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Java的多线程同步运行"><a href="#Java的多线程同步运行" class="headerlink" title="Java的多线程同步运行"></a>Java的多线程同步运行</h2><h3 id="2个线程轮流打印AB-gt-AB"><a href="#2个线程轮流打印AB-gt-AB" class="headerlink" title="2个线程轮流打印AB-&gt;AB"></a>2个线程轮流打印AB-&gt;AB</h3><h4 id="方法1：使用wait和notify"><a href="#方法1：使用wait和notify" class="headerlink" title="方法1：使用wait和notify"></a>方法1：使用wait和notify</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       System.out.println( <span class="string">&quot;Hello World!&quot;</span> );</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">final</span> Object lockObj = <span class="keyword">new</span> Object();</span><br><span class="line">       <span class="comment">//A是否已经执行</span></span><br><span class="line">       AtomicBoolean aExecuted = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line">      </span><br><span class="line">       <span class="keyword">final</span> Thread a = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">           <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">               <span class="keyword">synchronized</span> (lockObj) &#123;</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       Thread.sleep(<span class="number">500</span>);</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       Thread.sleep(<span class="number">500</span>);</span><br><span class="line">                       <span class="keyword">while</span> (aExecuted.get())</span><br><span class="line">                           lockObj.wait();</span><br><span class="line">                       System.out.println(<span class="string">&quot;Hello from a!&quot;</span>);</span><br><span class="line">                       aExecuted.set(<span class="keyword">true</span>);</span><br><span class="line">                       lockObj.notifyAll();</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> Thread b = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">           <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">               <span class="keyword">synchronized</span> (lockObj) &#123;</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       Thread.sleep(<span class="number">1_000</span>);</span><br><span class="line">                       <span class="keyword">while</span> (!aExecuted.get())</span><br><span class="line">                           lockObj.wait();</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">                   &#125;</span><br><span class="line">                   lockObj.notifyAll();</span><br><span class="line">                   System.out.println(<span class="string">&quot;Hello from b!&quot;</span>);</span><br><span class="line">                   aExecuted.set(<span class="keyword">false</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line"></span><br><span class="line">       a.start();</span><br><span class="line">       b.start();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="方法2-：使用ReentractLock"><a href="#方法2-：使用ReentractLock" class="headerlink" title="方法2 ：使用ReentractLock"></a>方法2 ：使用ReentractLock</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ReentrantLock lockObj = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">        <span class="comment">//A是否已经执行</span></span><br><span class="line">        <span class="keyword">final</span> AtomicBoolean aExecuted = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">final</span> Condition aCondition = lockObj.newCondition();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Thread a = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                lockObj.lock();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">500</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">500</span>);</span><br><span class="line">                        <span class="keyword">while</span> (aExecuted.get())</span><br><span class="line">                            aCondition.await();</span><br><span class="line">                        System.out.println(<span class="string">&quot;Hello from a!&quot;</span>);</span><br><span class="line">                        aExecuted.set(<span class="keyword">true</span>);</span><br><span class="line">                        aCondition.signalAll();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                lockObj.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Thread b = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                lockObj.lock();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">1_000</span>);</span><br><span class="line">                        <span class="keyword">while</span> (!aExecuted.get())</span><br><span class="line">                            aCondition.await();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                    aCondition.signalAll();</span><br><span class="line">                    System.out.println(<span class="string">&quot;Hello from b!&quot;</span>);</span><br><span class="line">                    aExecuted.set(<span class="keyword">false</span>);</span><br><span class="line">                lockObj.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        a.start();</span><br><span class="line">        b.start();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>使用</p>
<h2 id="Spring问题"><a href="#Spring问题" class="headerlink" title="Spring问题"></a>Spring问题</h2><h3 id="spring为什么使用三级缓存而不是两级？"><a href="#spring为什么使用三级缓存而不是两级？" class="headerlink" title="spring为什么使用三级缓存而不是两级？"></a>spring为什么使用三级缓存而不是两级？</h3><p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/445446018">https://www.zhihu.com/question/445446018</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">简单来讲，就是通过第三级缓存（不是三级共同作用）的延迟初始化来达到循环依赖**一级缓存：** 存放初始化完全的 bean 实例缓存（用于查找，没有循环依赖一级缓存足够使用）</span><br><span class="line"></span><br><span class="line">**三级缓存：** bean 在实例化之后，会放入的未初始化的 bean 工厂方法来延迟初始化</span><br><span class="line">本质是调用&#96;org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#getEarlyBeanReference&#96;方法的 bean 工厂匿名类</span><br><span class="line"></span><br><span class="line">**二级缓存：** 延迟初始化后（本质调用 getEarlyBeanReference 包装了 原先的 bean 实例）</span><br><span class="line">earlySingletonObjects.put(getEarlyBeanReference 返回的实例)</span><br><span class="line">singletonFactories.remove(bean 工厂实例)</span><br><span class="line">本质是防止&#96;getEarlyBeanReference&#96;bean 方法由于每次延迟初始化返回不同实例而导致注入的 bean 不是同一个</span><br><span class="line">例如&#96;() -&gt; getEarlyBeanReference(beanName, mbd, bean)&#96;会调用到构建代理的组件</span><br><span class="line">&#96;org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator#getEarlyBeanReference&#96;</span><br><span class="line">如果没有二级缓存，会重复创建代理的实例的问题</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/05/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/%E8%A7%A3%E5%86%B3Jar%E5%8C%85%E4%BE%9D%E8%B5%96%E5%86%B2%E7%AA%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/05/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/%E8%A7%A3%E5%86%B3Jar%E5%8C%85%E4%BE%9D%E8%B5%96%E5%86%B2%E7%AA%81/" class="post-title-link" itemprop="url">解决Jar包依赖冲突</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-05-05 19:10:53" itemprop="dateCreated datePublished" datetime="2021-05-05T19:10:53+08:00">2021-05-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-11-16 13:30:17" itemprop="dateModified" datetime="2021-11-16T13:30:17+08:00">2021-11-16</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://www.sevenyuan.cn/">https://www.sevenyuan.cn/</a></p>
<h2 id="报错原因"><a href="#报错原因" class="headerlink" title="报错原因"></a>报错原因</h2><p>应用突然无法启动，查看 tomcat 报错原因，发现是 <strong>类转换失败 <code>ClassCastException</code></strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Class path contains multiple SLF4J binding</span><br><span class="line">23-May-2019 16:04:25.300 INFO [localhost-startStop-1] org.apache.jasper.servlet.TldScanner.scanJars At least one JAR was scanned for TLDs yet contained no TLDs. Enable debug logging for this logger for a complete list of JARs that were scanned but no TLDs were found in them. Skipping unneeded JARs during scanning can improve startup time and JSP compilation time.</span><br><span class="line">SLF4J: Class path contains multiple SLF4J bindings.</span><br><span class="line">SLF4J: Found binding in [jar:file:/home/admin/xxx/WEB-INF/lib/slf4j-log4j12-1.6.1.jar!/org/slf4j/impl/StaticLoggerBinder.class]</span><br><span class="line">SLF4J: Found binding in [jar:file:/home/admin/xxx/WEB-INF/lib/logback-classic-1.1.3.jar!/org/slf4j/impl/StaticLoggerBinder.class]</span><br><span class="line">SLF4J: See http://www.slf4j.org/codes.html#multiple_bindings for an explanation.</span><br><span class="line">SLF4J: Actual binding is of type [org.slf4j.impl.Log4jLoggerFactory]</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">org.slf4j.impl.Log4jLoggerFactory cannot be cast to ch.qos.logback.classic.LoggerContext</span><br><span class="line">org.springframework.beans.factory.BeanCreationException: Error creating bean with name &#x27;cn.com.xxx.framework.log.integration.LogbackInitializer#0&#x27; defined in class path resource [spring/spring-log-init.xml]: Invocation of init method failed; nested exception is java.lang.ClassCastException: org.slf4j.impl.Log4jLoggerFactory cannot be cast to ch.qos.logback.classic.LoggerContext</span><br><span class="line">    ...    </span><br><span class="line">Caused by: java.lang.ClassCastException: org.slf4j.impl.Log4jLoggerFactory cannot be cast to ch.qos.logback.classic.LoggerContext</span><br><span class="line">    # 出问题的加载地方</span><br><span class="line"> at ch.qos.logback.ext.spring.LogbackConfigurer.initLogging(LogbackConfigurer.java:72)</span><br><span class="line"> at cn.com.xxx.framework.log.integration.LogbackInitializer.init(LogbackInitializer.java:49)</span><br><span class="line"> at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line"> at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line"> at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line"> at java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class="line"> at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeCustomInitMethod(AbstractAutowireCapableBeanFactory.java:1706)</span><br><span class="line"> at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeInitMethods(AbstractAutowireCapableBeanFactory.java:1645)</span><br><span class="line"> at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1574)</span><br><span class="line"> ... 26 more</span><br><span class="line">23-May-2019 15:59:12.398 SEVERE [localhost-startStop-1] org.apache.catalina.core.StandardContext.startInternal One or more listeners failed to start. Full details will be found in the appropriate container log file</span><br></pre></td></tr></table></figure>

<h3 id="查看报错代码"><a href="#查看报错代码" class="headerlink" title="查看报错代码"></a>查看报错代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initLogging</span><span class="params">(String location)</span> <span class="keyword">throws</span> FileNotFoundException, JoranException </span>&#123;</span><br><span class="line">   String resolvedLocation = SystemPropertyUtils.resolvePlaceholders(location);</span><br><span class="line">   URL url = ResourceUtils.getURL(resolvedLocation);</span><br><span class="line">   LoggerContext loggerContext = (LoggerContext)StaticLoggerBinder.getSingleton().getLoggerFactory();</span><br><span class="line">   loggerContext.reset();</span><br><span class="line">   <span class="keyword">new</span> ContextInitializer(loggerContext).configureByResource(url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，通过 <code>StaticLoggerBinder.getSingleton().getLoggerFactory()</code> 获取 logger 上下文这段代码报错了，通过仔细定位，发现了有两个 <code>StaticLoggerBinder</code> 类</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/eQPyBffYbucAM1dSp7ycZAXYI5C2Do953p5wHIylj4Owbjn4dxhRFlKac8xbQ1JU4GYfMnqAibw68ulsq2W0ggQ/640" alt="Image"></p>
<p><strong>更重要的是，他们两兄弟竟然虽然不是同一个 jar 包，但是包路径和名称都一模一样！！！</strong></p>
<p>由于我们需要的是 <code>logback</code> 包，而不是 <code>slf4j-log4j12</code> 包，所以需要排除掉 <code>slf4j-log4j12</code> 依赖。</p>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a><strong>解决方法</strong></h2><p>① 通过 POM 文件排查包冲突</p>
<p>② 安装 IDEA 的插件 <code>Maven Helper</code></p>
<p>③ 定位到编译 WAR 包的 POM 文件（我们框架定义的在 Deploy 模块中）</p>
<p>④ 在搜索框中，输入搜索内容，点击右键可以看到选项框</p>
<ul>
<li>Jump To Source（跳转到源文件处）</li>
<li>Exclude（排除掉）</li>
</ul>
<p>例如我点击了 <code>Exclude</code> ，就能看到 pom 文件中，这个依赖就被排除掉了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;cn.com.xxx&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;framework-conf-client&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;xqy.framework.version&#125;&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;exclusions&gt;</span><br><span class="line">        &lt;exclusion&gt;</span><br><span class="line">            &lt;artifactId&gt;slf4j-log4j12&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;groupId&gt;org.slf4j&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;&#x2F;exclusion&gt;</span><br><span class="line">    &lt;&#x2F;exclusions&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a><strong>思考</strong></h2><p>包冲突解决是简单的，通过 maven 插件可以精确找到依赖，然后进行 Exclude，可是在本地开发、测试环境都没有出现的问题，却在预发环境出现了，所以排除了业务逻辑代码的原因，简单考虑了几个因素和原因：</p>
<ul>
<li>jdk 版本</li>
<li>tomcat 版本</li>
<li>类加载机制</li>
<li>第三方 jar 互相依赖</li>
</ul>
<p>由于 jdk 和 tomcat 这两者没有明显的报错原因，所以先去排查类的加载机制</p>
<hr>
<h3 id="类加载机制"><a href="#类加载机制" class="headerlink" title="类加载机制"></a>类加载机制</h3><p>我们写的 Java 应用代码，一般是通过 <code>App ClassLoader</code> 应用加载器进行加载，它不会自己先去加载它，而是通过 <code>Extension ClassLoader</code> 扩展类加载器进行加载（其中扩展类加载器又会去找 <code>Bootstrap ClassLoader</code> 启动类加载器进行加载），只有父加载器无法加载情况下，才会让下级加载器进行加载。</p>
<hr>
<h3 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h3><p>Java 使用的是双亲委派加载机制，通过查看 <code>ClassLoader</code> 类，可以对此有所了解。</p>
<p>类被成功加载后，将被放入到JVM Heap中存放 Class 实例对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">protected Class&lt;?&gt; loadClass(String name, boolean resolve)</span><br><span class="line">    throws ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    synchronized (getClassLoadingLock(name)) &#123;</span><br><span class="line">        &#x2F;&#x2F; First, check if the class has already been loaded</span><br><span class="line">        &#x2F;&#x2F; 首先，检查 class 是否已经被加载</span><br><span class="line">        Class&lt;?&gt; c &#x3D; findLoadedClass(name);</span><br><span class="line">        if (c &#x3D;&#x3D; null) &#123;</span><br><span class="line">            &#x2F;&#x2F; 如果没有被加载</span><br><span class="line">            long t0 &#x3D; System.nanoTime();</span><br><span class="line">            try &#123;</span><br><span class="line">                if (parent !&#x3D; null) &#123;</span><br><span class="line">                    &#x2F;&#x2F; 寻找 parent 加载器</span><br><span class="line">                    c &#x3D; parent.loadClass(name, false);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    &#x2F;&#x2F; 如果父加载器不存在，则委托给启动类加载器加载</span><br><span class="line">                    c &#x3D; findBootstrapClassOrNull(name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">                &#x2F;&#x2F; ClassNotFoundException thrown if class not found</span><br><span class="line">                &#x2F;&#x2F; from the non-null parent class loader</span><br><span class="line">            &#125;</span><br><span class="line">            if (c &#x3D;&#x3D; null) &#123;</span><br><span class="line">                &#x2F;&#x2F; If still not found, then invoke findClass in order</span><br><span class="line">                &#x2F;&#x2F; to find the class.</span><br><span class="line">                &#x2F;&#x2F; 如果仍然无法加载，才会尝试自身加载</span><br><span class="line">                long t1 &#x3D; System.nanoTime();</span><br><span class="line">                c &#x3D; findClass(name);</span><br><span class="line">                &#x2F;&#x2F; this is the defining class loader; record the stats</span><br><span class="line">                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br><span class="line">                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class="line">                sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (resolve) &#123;</span><br><span class="line">            resolveClass(c);</span><br><span class="line">        &#125;</span><br><span class="line">        return c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="类加载顺序"><a href="#类加载顺序" class="headerlink" title="类加载顺序"></a>类加载顺序</h3><p>从代码中了解到，如果某个名字的类 <!--名字 = 类路径+类名称--> 被加载后，类加载器是不会再重新加载，所以我们的问题根本原因可以是出现在：</p>
<p><strong>先加载了 <code>org.slf4j</code> 包的 <code>org.slf4j.impl.StaticLoggerBinder</code>，同名的 <code>ch.qos.logback</code> 包下的 <code>StaticLoggerBinder</code> 类没有被加载</strong></p>
<blockquote>
<p>跟JAR文件的文件名有关。按照字母的顺序加载JAR文件。有了这个类以后，后面的类则不会加载了。</p>
<p>jvm 加载包名和类名相同的类时，先加载classpath中jar路径放在前面的，包名类名都相同，那jvm没法区分了，如果使用ide一般情况下是会提示发生冲突而报错，若不报错，只有第一个包被引入（在classpath路径下排在前面的包），第二个包会在classloader加载类时判断重复而忽略。</p>
</blockquote>
<hr>
<h3 id="查看加载顺序"><a href="#查看加载顺序" class="headerlink" title="查看加载顺序"></a>查看加载顺序</h3><p>在 jvm 启动脚本中，添加 <code>-verbose</code> 参数或者 <code>-XX:+TraceClassLoading</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Loaded java.lang.CloneNotSupportedException from &#x2F;Users&#x2F;jingqi&#x2F;.jrebel&#x2F;bootcache&#x2F;jrebel-bootstrap-89f567048120ef32b965233b5ba2f7ca.jar]</span><br><span class="line">[Loaded java.lang.Thread$State from &#x2F;Users&#x2F;jingqi&#x2F;.jrebel&#x2F;bootcache&#x2F;jrebel-bootstrap-89f567048120ef32b965233b5ba2f7ca.jar]</span><br><span class="line">[Loaded java.util.TreeMap$NavigableSubMap from &#x2F;Users&#x2F;jingqi&#x2F;.jrebel&#x2F;bootcache&#x2F;jrebel-bootstrap-89f567048120ef32b965233b5ba2f7ca.jar]</span><br><span class="line">[Loaded java.util.TreeMap$AscendingSubMap from &#x2F;Users&#x2F;jingqi&#x2F;.jrebel&#x2F;bootcache&#x2F;jrebel-bootstrap-89f567048120ef32b965233b5ba2f7ca.jar]</span><br><span class="line">[Loaded java.util.TreeMap$NavigableSubMap$EntrySetView from &#x2F;Users&#x2F;jingqi&#x2F;.jrebel&#x2F;bootcache&#x2F;jrebel-bootstrap-89f567048120ef32b965233b5ba2f7ca.jar]</span><br><span class="line">[Loaded java.util.TreeMap$AscendingSubMap$AscendingEntrySetView from &#x2F;Users&#x2F;jingqi&#x2F;.jrebel&#x2F;bootcache&#x2F;jrebel-bootstrap-89f567048120ef32b965233b5ba2f7ca.jar]</span><br><span class="line">[Loaded java.util.TreeMap$NavigableSubMap$SubMapIterator from &#x2F;Users&#x2F;jingqi&#x2F;.jrebel&#x2F;bootcache&#x2F;jrebel-bootstrap-89f567048120ef32b965233b5ba2f7ca.jar]</span><br><span class="line">[Loaded java.util.TreeMap$NavigableSubMap$SubMapEntryIterator from &#x2F;Users&#x2F;jingqi&#x2F;.jrebel&#x2F;bootcache&#x2F;jrebel-bootstrap-89f567048120ef32b965233b5ba2f7ca.jar]</span><br></pre></td></tr></table></figure>

<p>之前在本地开发中，IDEA 优化先加载了 <code>ch.qos.logback</code> 的 <code>StaticLoggerBinder</code> 类，然后后面的 <code>org.slf4j</code> 包下的同名类就没有被加载。</p>
<p>但这样也有个不明白，按理说加载顺序按照<strong>字母顺序</strong>加载，预发环境还是能够跟本地开发一样，加载到我们需要的类。实际上，加载器加载到的是另一个类，导致应用无法启动。</p>
<blockquote>
<p>问题就是jar的加载顺序问题，而这个顺序实际上是由文件系统决定的，linux内部是用inode来指示文件的。</p>
<p>这种储存文件元信息的区域就叫做inode，中文译名为”索引节点”。每一个文件都有对应的inode，里面包含了与该文件有关的一些信息。</p>
<p>Unix/linux系统内部不使用文件名，而使用inode号码来识别文件。对于系统来说，文件名只是inode号码便于识别的别称或者绰号。</p>
</blockquote>
<p>为了验证 <code>inode</code> 是否是问题的原因，我做了以下测试：</p>
<hr>
<h3 id="inode-测试加载顺序"><a href="#inode-测试加载顺序" class="headerlink" title="inode 测试加载顺序"></a>inode 测试加载顺序</h3><h4 id="本地-Tomcat8-测试（正常启动）"><a href="#本地-Tomcat8-测试（正常启动）" class="headerlink" title="本地 Tomcat8 测试（正常启动）"></a>本地 Tomcat8 测试（正常启动）</h4><p>将之前在 uat 环境有问题的代码版本重新打包，不使用 idea 工具，直接用 tomcat8 启动，并且在 <code>catalina.sh</code> 脚本中加入类加载打印参数 <code>-XX:+TraceClassLoading</code></p>
<p>catalina.sh</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Register custom URL handlers</span><br><span class="line"># Do this here so custom URL handles (specifically &#39;war:...&#39;) can be used in the security policy</span><br><span class="line">JAVA_OPTS&#x3D;&quot;$JAVA_OPTS -XX:+TraceClassLoading&quot;</span><br></pre></td></tr></table></figure>

<p>查看 <code>catalina.out</code> 输入日志，发现先加载的是 logback 包中 <code>StaticLoggerBinder</code></p>
<p>在 <code>WEB-INF/lib</code> 下比较 inode 大小（正常解压和启动 logback &lt; slf4j)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ll -i logback-classic-1.1.3.jar slf4j-log4j12-1.6.1.jar</span><br><span class="line">34153162 -rw-r-----  1 jingqi  staff   274K  8  1  2018 logback-classic-1.1.3.jar</span><br><span class="line">34153180 -rw-r-----  1 jingqi  staff   9.5K 10 17  2018 slf4j-log4j12-1.6.1.jar</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="本地-Tomcat8-测试（删包，先添加-slf4j，后添加-logback）"><a href="#本地-Tomcat8-测试（删包，先添加-slf4j，后添加-logback）" class="headerlink" title="本地 Tomcat8 测试（删包，先添加 slf4j，后添加 logback）"></a>本地 Tomcat8 测试（删包，先添加 slf4j，后添加 logback）</h4><ul>
<li>清理掉 catalina.out</li>
<li>重新上传包</li>
<li>比较 inode 大小</li>
<li>重新启动，查看类加载日志</li>
</ul>
<p><strong>比较 inode 大小（发现 slf4j &lt; logback)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># ll -i logback-classic-1.1.3.jar slf4j-log4j12-1.6.1.jar</span><br><span class="line">34162396 -rw-r--r--  1 jingqi  staff   274K  8  1  2018 logback-classic-1.1.3.jar</span><br><span class="line">34162361 -rw-r--r--  1 jingqi  staff   9.5K 10 17  2018 slf4j-log4j12-1.6.1.jar</span><br></pre></td></tr></table></figure>

<p>重新启动后，查看 <code>catalina.out</code> 日志，发现类加载顺序与之前的一致，应用也能正常启动，所以本地开发无法复现 =-=</p>
<hr>
<h4 id="在-uat-环境服务器测试"><a href="#在-uat-环境服务器测试" class="headerlink" title="在 uat 环境服务器测试"></a>在 uat 环境服务器测试</h4><p>在 <code>WEB-INF/lib</code> 路径下，先将这两个包删掉，尝试有不同的上传顺序，模拟 tomcat 解压 war 包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[admin@uat-96-0-248 lib]$ rm logback-classic-1.1.3.jar  slf4j-log4j12-1.6.1.jar</span><br><span class="line">[admin@uat-96-0-248 lib]$ rz</span><br><span class="line">[admin@uat-96-0-248 lib]$ # Received &#x2F;Users&#x2F;jingqi&#x2F;Downloads&#x2F;slf4j-log4j12-1.6.1.jar</span><br><span class="line">[admin@uat-96-0-248 lib]$ rz</span><br><span class="line">[admin@uat-96-0-248 lib]$ # Received &#x2F;Users&#x2F;jingqi&#x2F;Downloads&#x2F;logback-classic-1.1.3.jar</span><br><span class="line"># 第一次上传顺序 1、slf4j-log4j12-1.6.1.jar 2、logback-classic-1.1.3.jar</span><br><span class="line"># inode 比较：slf4j &lt; logback</span><br><span class="line">[admin@uat-96-0-248 lib]$ ll -i logback-classic-1.1.3.jar slf4j-log4j12-1.6.1.jar</span><br><span class="line">396731 -rw-r--r-- 1 admin admin 280928 8月   1 2018 logback-classic-1.1.3.jar</span><br><span class="line">394075 -rw-r--r-- 1 admin admin   9753 10月 17 2018 slf4j-log4j12-1.6.1.jar</span><br><span class="line">[admin@uat-96-0-248 lib]$ rm logback-classic-1.1.3.jar  slf4j-log4j12-1.6.1.jar</span><br><span class="line">[admin@uat-96-0-248 lib]$ rz</span><br><span class="line">[admin@uat-96-0-248 lib]$ # Received &#x2F;Users&#x2F;jingqi&#x2F;Downloads&#x2F;logback-classic-1.1.3.jar</span><br><span class="line">[admin@uat-96-0-248 lib]$ rz</span><br><span class="line">[admin@uat-96-0-248 lib]$ # Received &#x2F;Users&#x2F;jingqi&#x2F;Downloads&#x2F;slf4j-log4j12-1.6.1.jar</span><br><span class="line"># 第二次上传顺序 1、logback-classic-1.1.3.jar 2、slf4j-log4j12-1.6.1.jar</span><br><span class="line"># inode 比较：logback &lt; slf4j</span><br><span class="line">[admin@uat-96-0-248 lib]$ ll -i logback-classic-1.1.3.jar slf4j-log4j12-1.6.1.jar</span><br><span class="line">394075 -rw-r--r-- 1 admin admin 280928 8月   1 2018 logback-classic-1.1.3.jar</span><br><span class="line">396731 -rw-r--r-- 1 admin admin   9753 10月 17 2018 slf4j-log4j12-1.6.1.jar</span><br></pre></td></tr></table></figure>

<p>分别测试了两种场景，发现只要这两个包都存在的情况下，无论 <code>inode</code> 两者的大小，都是先加载了 <code>slf4j</code> 包的类，导致启动报错</p>
<p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="Image"></p>
<hr>
<h3 id="测试结束"><a href="#测试结束" class="headerlink" title="测试结束"></a>测试结束</h3><p>通过多种测试场景，发现本地开发、测试环境都无法复现的问题，在 uat 环境下，只要这两个包同时存在，都会启动报错</p>
<p>最后在官方文档发现这个：</p>
<blockquote>
<p>The order in which the JAR files in a directory are enumerated in the expanded class path is not specified and may vary from platform to platform and even from moment to moment on the same machine. A well-constructed application should not depend upon any particular order. If a specific order is required, then the JAR files can be enumerated explicitly in the class path.</p>
</blockquote>
<p>大意为：同一个目录下，jvm加载jar包顺序是无法保证的，每个系统的都不一样，甚至同一个系统不同的时刻加载都不一样。</p>
<p>于是乎，我也不纠结某台服务器上的类加载顺序，在开发阶段就先将这个包冲突的情况，给提前解决掉~</p>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h2><h3 id="冲突提示信息"><a href="#冲突提示信息" class="headerlink" title="冲突提示信息"></a>冲突提示信息</h3><ul>
<li><strong>java.lang.ClassNotFoundException</strong>：类型转换错误，这个报错跟我这次遇到的一样，本应该引入的是 <code>logback</code> 包的类，但是实际引入的是 <code>slf4j</code> 下的同名类，导致类型转换错误</li>
<li><strong>java.lang.NoSuchMethodError</strong>：找不到特定方法，如果有两个同名的包但是不同版本，例如 xxx-1.1和 xxx-1.2包同时存在，先加载了 1.1 版本的类，但是 1.2 版本中才提供了新方法，导致提示找不到特定方法</li>
<li><strong>java.lang.NoClassDefFoundError，java.lang.LinkageError</strong></li>
</ul>
<h3 id="排查思路"><a href="#排查思路" class="headerlink" title="排查思路"></a>排查思路</h3><p>1、查看 <code>catalina.sh</code> 堆栈信息，找到有问题的类</p>
<p>2、通过 IDEA ，在打包的 POM 文件中，使用 <code>Maven Helper</code> 插件找出冲突的依赖，确定项目需要的 jar 包，<code>Exclude</code> 掉不需要的依赖。</p>
<h3 id="提前预防"><a href="#提前预防" class="headerlink" title="提前预防"></a>提前预防</h3><p><strong>1、使用工具检查依赖冲突</strong></p>
<p>冲突检测插件 ：<code>maven-enforcer-plugin</code></p>
<p>引用新的第三方依赖（工具包或者框架包），通过 Maven 插件检查一下 conflict 依赖，提前进行 Exclude</p>
<p><strong>2、统一服务器版本</strong></p>
<p>在测试阶段，准备好和生产环境一样的服务器，提前进行测试，避免依赖冲突的 <code>WAR</code> 包上传到生产环境，例如我们有一台 UAT 服务器，与生产环境一样配置，提前测试</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/28/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/%E5%88%86%E5%B8%83%E5%BC%8F-%E4%BA%8B%E5%8A%A1/%E5%B9%82%E7%AD%89%E6%80%A7-01-%E9%98%B2%E9%87%8D%E6%96%B9%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/28/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/%E5%88%86%E5%B8%83%E5%BC%8F-%E4%BA%8B%E5%8A%A1/%E5%B9%82%E7%AD%89%E6%80%A7-01-%E9%98%B2%E9%87%8D%E6%96%B9%E5%BC%8F/" class="post-title-link" itemprop="url">高并发下保证接口的幂等性</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-04-28 12:12:34" itemprop="dateCreated datePublished" datetime="2021-04-28T12:12:34+08:00">2021-04-28</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-09-02 13:52:45" itemprop="dateModified" datetime="2021-09-02T13:52:45+08:00">2021-09-02</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="保证幂等的手段"><a href="#保证幂等的手段" class="headerlink" title="保证幂等的手段"></a><strong>保证幂等的手段</strong></h2><p>保证幂等需要理清楚两件事情：幂等条件和期望结果。</p>
<ul>
<li><p>保证幂等的手段有<a href="">token令牌</a>、<a href="">分布式锁</a>、<a href="">去重表</a>、<a href="">数据库唯一索引</a>等，这些所谓的幂等手段实际上防重手段。防重本质是防止一个相同的请求被当成多个不同的请求来处理。</p>
</li>
<li><p>幂等的条件是知道这是一个相同的请求。防重和幂等本质上是两个不同的阶段。</p>
</li>
</ul>
<h2 id="使用幂等的场景"><a href="#使用幂等的场景" class="headerlink" title="使用幂等的场景"></a>使用幂等的场景</h2><h3 id="前端重复提交"><a href="#前端重复提交" class="headerlink" title="前端重复提交"></a>前端重复提交</h3><p>用户注册，用户创建商品等操作，前端都会提交一些数据给后台服务，后台需要根据用户提交的数据在数据库中创建记录。如果用户不小心多点了几次，后端收到了好几次提交，这时就会在数据库中重复创建了多条记录。这就是接口没有幂等性带来的 bug。</p>
<h3 id="接口超时重试"><a href="#接口超时重试" class="headerlink" title="接口超时重试"></a>接口超时重试</h3><p>对于给第三方调用的接口，有可能会因为网络原因而调用失败，这时，一般在设计的时候会对接口调用加上失败重试的机制。如果第一次调用已经执行了一半时，发生了网络异常。这时再次调用时就会因为脏数据的存在而出现调用异常。</p>
<h3 id="消息重复消费"><a href="#消息重复消费" class="headerlink" title="消息重复消费"></a>消息重复消费</h3><p>在使用消息中间件来处理消息队列，且手动 ack 确认消息被正常消费时。如果消费者突然断开连接，那么已经执行了一半的消息会重新放回队列。</p>
<p>当消息被其他消费者重新消费时，如果没有幂等性，就会导致消息重复消费时结果异常，如数据库重复数据，数据库数据冲突，资源重复等。</p>
<h2 id="防重手段实现幂等"><a href="#防重手段实现幂等" class="headerlink" title="防重手段实现幂等"></a>防重手段实现幂等</h2><h3 id="借助数据库"><a href="#借助数据库" class="headerlink" title="借助数据库"></a>借助数据库</h3><h4 id="先select再update-insert使用悲观锁"><a href="#先select再update-insert使用悲观锁" class="headerlink" title="先select再update/insert使用悲观锁"></a>先select再update/insert使用悲观锁</h4><p>使用悲观锁实现幂等性，一般是配合事务一起来实现，在没有使用悲观锁时，我们通常的执行过程是这样的，首先来判断数据的状态，执行 SQL 如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">第一步：select status from table_name where id&#x3D;&#39;xxx&#39;;</span><br><span class="line"></span><br><span class="line">第二步：insert into table_name (id) values (&#39;xxx&#39;);</span><br><span class="line">		或者update table_name set status&#x3D;&#39;xxx&#39;;</span><br></pre></td></tr></table></figure>

<p><a href="">但这种情况因为是非原子操作，所以在高并发环境下可能会造成一个业务被执行两次的问题</a>，当一个程序在执行中时，而另一个程序也开始状态判断的操作。因为第一个程序还未来得及更改状态，所以第二个程序也能执行成功，这就导致一个业务被执行了两次。</p>
<ul>
<li>使用事务实现悲观锁，从而保证原子性  <!--这种方法感觉有问题，select操作在RR事务隔离级别下，可能读到的是过期版本的数据--></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;  <span class="comment"># 1.开始事务</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> table_name <span class="keyword">where</span> <span class="keyword">id</span>=<span class="string">&#x27;xxx&#x27;</span> <span class="keyword">for</span> <span class="keyword">update</span>; <span class="comment"># 2.查询状态</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. insert或者update</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> table_name (<span class="keyword">id</span>) <span class="keyword">values</span> (<span class="string">&#x27;xxx&#x27;</span>); </span><br><span class="line">或者 <span class="keyword">update</span> table_name <span class="keyword">set</span> <span class="keyword">status</span>=<span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">commit</span>; <span class="comment"># 4.提交事务</span></span><br></pre></td></tr></table></figure>

<ul>
<li>使用select … for update ,这种和 synchronized 锁住先查再insert or update一样,但要避免死锁,效率也较差。针对单体 请求并发不大 可以推荐使用</li>
</ul>
<blockquote>
<p>在实现的过程中需要注意以下两个问题：</p>
<ul>
<li>如果使用的是 MySQL 数据库，必须选用 innodb 存储引擎，因为 innodb 支持事务；</li>
<li>id 字段一定要是主键或者是唯一索引，不然会锁表，影响其他业务执行。</li>
</ul>
</blockquote>
<h4 id="update使用多版本控制（乐观锁）"><a href="#update使用多版本控制（乐观锁）" class="headerlink" title="update使用多版本控制（乐观锁）"></a>update使用多版本控制（乐观锁）</h4><p>需要在表中增加一个<code>timestamp</code>或者<code>version</code>字段，这里以<code>version</code>字段为例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update user set amount&#x3D;amount+100,version&#x3D;version+1where id&#x3D;123 and version&#x3D;1;</span><br></pre></td></tr></table></figure>



<h4 id="insert使用唯一索引"><a href="#insert使用唯一索引" class="headerlink" title="insert使用唯一索引"></a>insert使用唯一索引</h4><p>我们可以创建一个唯一索引的表来实现幂等性，在每次执行业务之前，先执行插入操作，因为唯一字段就是业务的 ID，因此如果重复插入的话会触发唯一约束而导致插入失败。在这种情况下（插入失败）我们就可以判定它为重复提交的请求。</p>
<p>虽说抛异常对数据来说没有影响，不会造成错误数据。但是为了保证接口幂等性，我们需要对该异常进行捕获，然后返回成功。</p>
<p>如果是<code>java</code>程序需要捕获：<code>DuplicateKeyException</code>异常，如果使用了<code>spring</code>框架还需要捕获：<code>MySQLIntegrityConstraintViolationException</code>异常。</p>
<h3 id="借助web-api入口"><a href="#借助web-api入口" class="headerlink" title="借助web api入口"></a>借助web api入口</h3><h4 id="使用Redis实现分布式锁"><a href="#使用Redis实现分布式锁" class="headerlink" title="使用Redis实现分布式锁"></a>使用Redis实现分布式锁</h4><p>由于<code>数据库分布式锁</code>的性能不太好，我们可以改用：<code>redis</code>或<code>zookeeper</code>。</p>
<p>鉴于现在很多公司分布式配置中心改用<code>apollo</code>或<code>nacos</code>，已经很少用<code>zookeeper</code>了，我们以<code>redis</code>为例介绍分布式锁。</p>
<p>目前主要有三种方式实现redis的分布式锁：</p>
<ol>
<li>setNx命令</li>
<li>set命令</li>
<li>Redission框架</li>
</ol>
<blockquote>
<p>需要特别注意的是：分布式锁一定要设置一个合理的过期时间，如果设置过短，无法有效的防止重复请求。如果设置过长，可能会浪费<code>redis</code>的存储空间，需要根据实际业务情况而定。</p>
</blockquote>
<h4 id="获取token"><a href="#获取token" class="headerlink" title="获取token"></a>获取token</h4><p>通过token 机制实现接口的幂等性,这是一种比较通用性的实现方法。</p>
<p>示意图如下：</p>
<img src="https://filescdn.proginn.com/863953bbd02d158b7d726d78b269339e/47e6218040f85184d170ef253514ca59.webp" alt="img" style="zoom:67%;" />

<p>具体流程步骤：</p>
<ol>
<li>客户端会先发送一个请求去获取 token，服务端会生成一个全局唯一的 ID 作为 token 保存在 redis 中，同时把这个 ID 返回给客户端</li>
<li>客户端第二次调用业务请求的时候必须携带这个 token</li>
<li>服务端会校验这个 token，如果校验成功，则执行业务，并删除 redis 中的 token</li>
<li>如果校验失败，说明 redis 中已经没有对应的 token，则表示重复操作，直接返回指定的结果给客户端</li>
</ol>
<blockquote>
<p>注意：</p>
<ol>
<li>对 redis 中是否存在 token 以及删除的代码逻辑建议用 Lua 脚本实现，保证原子性</li>
<li>全局唯一 ID 可以用百度的 uid-generator、美团的 Leaf 去生成</li>
</ol>
</blockquote>
<p>这种思路存在漏洞，如下图所示：<br><a target="_blank" rel="noopener" href="https://tallate.top/imgs/%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E2%80%94%E2%80%94%E5%B9%82%E7%AD%89/%E5%B9%82%E7%AD%89%E6%A3%80%E6%9F%A5%E5%92%8C%E6%8E%A5%E5%8F%A3%E9%87%8D%E8%AF%95%E4%B9%8B%E9%97%B4%E7%9A%84%E5%86%B2%E7%AA%81.png"><img src="https://tallate.top/imgs/%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E2%80%94%E2%80%94%E5%B9%82%E7%AD%89/%E5%B9%82%E7%AD%89%E6%A3%80%E6%9F%A5%E5%92%8C%E6%8E%A5%E5%8F%A3%E9%87%8D%E8%AF%95%E4%B9%8B%E9%97%B4%E7%9A%84%E5%86%B2%E7%AA%81.png" alt="幂等检查和接口重试之间的冲突"></a></p>
<p><a target="_blank" rel="noopener" href="https://tallate.top/imgs/%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E2%80%94%E2%80%94%E5%B9%82%E7%AD%89/%E5%B9%82%E7%AD%89%E6%A3%80%E6%9F%A5%E5%92%8C%E6%8E%A5%E5%8F%A3%E9%87%8D%E8%AF%95%E4%B9%8B%E9%97%B4%E7%9A%84%E5%86%B2%E7%AA%81.png">幂等检查和接口重试之间的冲突</a></p>
<p>token 是只有在幂等检查结束后才会被保存下来的，如果下游服务还没执行完毕，触发上游 RPC 的超时重试机制，就会重新再发一次请求，这时如果上一次请求，仍然没有执行完毕，就会导致请求被执行了两次。<br>这里的漏洞是：进入下游 API 入口处的幂等检查逻辑，会经过查 <code>token -&gt; 保存 token -&gt; 设置超时时间</code>这个过程，可能会因为网络抖动而花费特别长的时间。如果超时是因此而导致的，幂等性检查就起不到作用了。<br>解决的办法是保证幂等检查的<strong>原子性</strong>，并且还需要注意存储的<strong>隔离性</strong>，这在一般的存储设计中是必须要考虑的。</p>
<blockquote>
<p>在这里吐槽一下我公司的实现，采用的是<code>setnx + expire</code>的方式，如果<code>setnx</code>后、<code>expire</code>前出错了，之后对该接口的重试也会直接被拦截了，也就是说幂等检查组件影响了正常的业务执行流程。</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/23/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81/shiro%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-02-shiro%E5%85%A5%E5%8F%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/23/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81/shiro%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-02-shiro%E5%85%A5%E5%8F%A3/" class="post-title-link" itemprop="url">shiro框架</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-04-23 08:04:48" itemprop="dateCreated datePublished" datetime="2021-04-23T08:04:48+08:00">2021-04-23</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-11-07 13:00:50" itemprop="dateModified" datetime="2021-11-07T13:00:50+08:00">2021-11-07</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><h3 id="shiro入口"><a href="#shiro入口" class="headerlink" title="shiro入口"></a>shiro入口</h3><p>我们打算将 Shiro 放在 Web 应用中使用，只需在 web.xml 中做如下配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;3.0&quot;</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.apache.shiro.web.env.EnvironmentLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>ShiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.apache.shiro.web.servlet.ShiroFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>ShiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p> web.xml 才是整个 Web 应用的核心所在，Web 容器（例如：Tomcat）会提供一些监听器，用于监听 Web 应用的生命周期事件，有两个重要的点可以监听，一个是出生，另一个是死亡，具备这类特性的监听器就是 ServletContextListener。</p>
<p>Shiro 的 EnvironmentLoaderListener 就是一个典型的 ServletContextListener，它也是整个 Shiro Web 应用的入口，不妨先来看看它的静态结构吧：</p>
<p><img src="http://static.oschina.net/uploads/space/2014/0318/162859_TEXh_223750.png" alt="img"></p>
<ol>
<li><p>EventListener 是一个标志接口，里面没有任何的方法，Servlet 容器中所有的 Listener 都要继承这个接口<!--这是 Servlet 规范--></p>
</li>
<li><p>ServletContextListener 是一个 ServletContext 的监听器，用于监听容器的启动与关闭事件，包括如下两个方法：<br>  - void contextInitialized(ServletContextEvent sce); // 当容器启动时调用<br>  - void contextDestroyed(ServletContextEvent sce); // 当容器关闭时调用<br>  可以从 ServletContextEvent 中直接获取 ServletContext 对象。</p>
</li>
<li><p>EnvironmentLoaderListener 不仅实现了 ServletContextListener 接口，也扩展了 EnvironmentLoader 类，是为了在 Servlet 容器中调用 EnvironmentLoader 对象的生命周期方法。</p>
</li>
</ol>
<h4 id="EnvironmentLoader"><a href="#EnvironmentLoader" class="headerlink" title="EnvironmentLoader"></a>EnvironmentLoader</h4><p>EnvironmentLoaderListener 开始：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class EnvironmentLoaderListener extends EnvironmentLoader implements ServletContextListener &#123;</span><br><span class="line"> </span><br><span class="line">    &#x2F;&#x2F; 容器启动时调用</span><br><span class="line">    public void contextInitialized(ServletContextEvent sce) &#123;</span><br><span class="line">        initEnvironment(sce.getServletContext());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    &#x2F;&#x2F; 当容器关闭时调用</span><br><span class="line">    public void contextDestroyed(ServletContextEvent sce) &#123;</span><br><span class="line">        destroyEnvironment(sce.getServletContext());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看来 EnvironmentLoaderListener 只是一个空架子而已，真正干活的人是它“爹”（EnvironmentLoader）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnvironmentLoader</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 可在 web.xml 的 context-param 中定义 WebEnvironment 接口的实现类（默认为 IniWebEnvironment）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ENVIRONMENT_CLASS_PARAM = <span class="string">&quot;shiroEnvironmentClass&quot;</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 可在 web.xml 的 context-param 中定义 Shiro 配置文件的位置</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONFIG_LOCATIONS_PARAM = <span class="string">&quot;shiroConfigLocations&quot;</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 在 ServletContext 中存放 WebEnvironment 的 key</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ENVIRONMENT_ATTRIBUTE_KEY = EnvironmentLoader.class.getName() + <span class="string">&quot;.ENVIRONMENT_ATTRIBUTE_KEY&quot;</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 从 ServletContext 中获取相关信息，并创建 WebEnvironment 实例</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WebEnvironment <span class="title">initEnvironment</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line">        <span class="comment">// 确保 WebEnvironment 只能创建一次</span></span><br><span class="line">        <span class="keyword">if</span> (servletContext.getAttribute(ENVIRONMENT_ATTRIBUTE_KEY) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建 WebEnvironment 实例</span></span><br><span class="line">            WebEnvironment environment = createEnvironment(servletContext);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 将 WebEnvironment 实例放入 ServletContext 中</span></span><br><span class="line">            servletContext.setAttribute(ENVIRONMENT_ATTRIBUTE_KEY, environment);</span><br><span class="line">            <span class="keyword">return</span> environment;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">            <span class="comment">// 将异常对象放入 ServletContext 中</span></span><br><span class="line">            servletContext.setAttribute(ENVIRONMENT_ATTRIBUTE_KEY, ex);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Error err) &#123;</span><br><span class="line">            <span class="comment">// 将错误对象放入 ServletContext 中</span></span><br><span class="line">            servletContext.setAttribute(ENVIRONMENT_ATTRIBUTE_KEY, err);</span><br><span class="line">            <span class="keyword">throw</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> WebEnvironment <span class="title">createEnvironment</span><span class="params">(ServletContext sc)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 确定 WebEnvironment 接口的实现类</span></span><br><span class="line">        Class&lt;?&gt; clazz = determineWebEnvironmentClass(sc);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 确保该实现类实现了 MutableWebEnvironment 接口</span></span><br><span class="line">        <span class="keyword">if</span> (!MutableWebEnvironment.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 从 ServletContext 中获取 Shiro 配置文件的位置参数，并判断该参数是否已定义</span></span><br><span class="line">        String configLocations = sc.getInitParameter(CONFIG_LOCATIONS_PARAM);</span><br><span class="line">        <span class="keyword">boolean</span> configSpecified = StringUtils.hasText(configLocations);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 若配置文件位置参数已定义，则需确保该实现类实现了 ResourceConfigurable 接口</span></span><br><span class="line">        <span class="keyword">if</span> (configSpecified &amp;&amp; !(ResourceConfigurable.class.isAssignableFrom(clazz))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 通过反射创建 WebEnvironment 实例，将其转型为 MutableWebEnvironment 类型，并将 ServletContext 放入该实例中</span></span><br><span class="line">        MutableWebEnvironment environment = (MutableWebEnvironment) ClassUtils.newInstance(clazz);</span><br><span class="line">        environment.setServletContext(sc);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 若配置文件位置参数已定义，且该实例是 ResourceConfigurable 接口的实例（实现了该接口），则将此参数放入该实例中</span></span><br><span class="line">        <span class="keyword">if</span> (configSpecified &amp;&amp; (environment <span class="keyword">instanceof</span> ResourceConfigurable)) &#123;</span><br><span class="line">            ((ResourceConfigurable) environment).setConfigLocations(configLocations);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 可进一步定制 WebEnvironment 实例（在子类中扩展）</span></span><br><span class="line">        customizeEnvironment(environment);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 调用 WebEnvironment 实例的 init 方法</span></span><br><span class="line">        LifecycleUtils.init(environment);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 返回 WebEnvironment 实例</span></span><br><span class="line">        <span class="keyword">return</span> environment;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; determineWebEnvironmentClass(ServletContext servletContext) &#123;</span><br><span class="line">        <span class="comment">// 从初始化参数（context-param）中获取 WebEnvironment 接口的实现类</span></span><br><span class="line">        String className = servletContext.getInitParameter(ENVIRONMENT_CLASS_PARAM);</span><br><span class="line">        <span class="comment">// 若该参数已定义，则加载该实现类</span></span><br><span class="line">        <span class="keyword">if</span> (className != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> ClassUtils.forName(className);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnknownClassException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException(ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 否则使用默认的实现类</span></span><br><span class="line">            <span class="keyword">return</span> IniWebEnvironment.class;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">customizeEnvironment</span><span class="params">(WebEnvironment environment)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 销毁 WebEnvironment 实例</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroyEnvironment</span><span class="params">(ServletContext servletContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 从 ServletContext 中获取 WebEnvironment 实例</span></span><br><span class="line">            Object environment = servletContext.getAttribute(ENVIRONMENT_ATTRIBUTE_KEY);</span><br><span class="line">            <span class="comment">// 调用 WebEnvironment 实例的 destroy 方法</span></span><br><span class="line">            LifecycleUtils.destroy(environment);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 移除 ServletContext 中存放的 WebEnvironment 实例</span></span><br><span class="line">            servletContext.removeAttribute(ENVIRONMENT_ATTRIBUTE_KEY);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看来 EnvironmentLoader 就是为了：</p>
<ol>
<li><p>当容器启动时，读取 web.xml 文件，从中获取 WebEnvironment 接口的实现类（默认是 IniWebEnvironment），初始化该实例，并将其加载到 ServletContext 中。</p>
</li>
<li><p>当容器关闭时，销毁 WebEnvironment 实例，并从 ServletContext 将其移除。</p>
</li>
</ol>
<p>这里有两个配置项可以在 web.xml 中进行配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>shiroEnvironmentClass<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>WebEnvironment 接口的实现类<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>shiroConfigLocations<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>shiro.ini 配置文件的位置<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 EnvironmentLoader 中仅用于创建 WebEnvironment 接口的实现类，随后将由这个实现类来加载并解析 shiro.ini 配置文件。</p>
<h4 id="WebEnvironment"><a href="#WebEnvironment" class="headerlink" title="WebEnvironment"></a>WebEnvironment</h4><p>既然 WebEnvironment 如此重要，那么很有必要了解一下它的静态结构：</p>
<p><img src="http://static.oschina.net/uploads/space/2014/0318/163231_w73G_223750.png" alt="img"></p>
<ol>
<li><p>最底层的 IniWebEnvironment 是 WebEnvironment 接口的默认实现类，它将读取 ini 配置文件，并创建 WebEnvironment 实例。</p>
</li>
<li><p>可以断言，如果需要将 Shiro 配置定义在 XML 或 Properties 配置文件中，那就需要自定义一些WebEnvironment 实现类了。</p>
</li>
<li><p>WebEnvironment 的实现类不仅需要实现最顶层的 Environment 接口，还需要实现具有生命周期功能的 Initializable 与 Destroyable 接口。</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IniWebEnvironment</span> <span class="keyword">extends</span> <span class="title">ResourceBasedWebEnvironment</span> <span class="keyword">implements</span> <span class="title">Initializable</span>, <span class="title">Destroyable</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 默认 shiro.ini 路径</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_WEB_INI_RESOURCE_PATH = <span class="string">&quot;/WEB-INF/shiro.ini&quot;</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 定义一个 Ini 对象，用于封装 ini 配置项</span></span><br><span class="line">    <span class="keyword">private</span> Ini ini;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Ini <span class="title">getIni</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.ini;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIni</span><span class="params">(Ini ini)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.ini = ini;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 当初始化时调用</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 从成员变量中获取 Ini 对象</span></span><br><span class="line">        Ini ini = getIni();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 从 web.xml 中获取配置文件位置（在 EnvironmentLoader 中已设置）</span></span><br><span class="line">        String[] configLocations = getConfigLocations();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 若成员变量中不存在，则从已定义的配置文件位置获取</span></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(ini)) &#123;</span><br><span class="line">            ini = getSpecifiedIni(configLocations);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 若已定义的配置文件中仍然不存在，则从默认的位置获取</span></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(ini)) &#123;</span><br><span class="line">            ini = getDefaultIni();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 若还不存在，则抛出异常</span></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(ini)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 初始化成员变量</span></span><br><span class="line">        setIni(ini);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 解析配置文件，完成初始化工作</span></span><br><span class="line">        configure();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Ini <span class="title">getSpecifiedIni</span><span class="params">(String[] configLocations)</span> <span class="keyword">throws</span> ConfigurationException </span>&#123;</span><br><span class="line">        Ini ini = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (configLocations != <span class="keyword">null</span> &amp;&amp; configLocations.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 只能通过第一个配置文件的位置来创建 Ini 对象，且必须有一个配置文件，否则就会报错</span></span><br><span class="line">            ini = createIni(configLocations[<span class="number">0</span>], <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ini;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Ini <span class="title">createIni</span><span class="params">(String configLocation, <span class="keyword">boolean</span> required)</span> <span class="keyword">throws</span> ConfigurationException </span>&#123;</span><br><span class="line">        Ini ini = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (configLocation != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 从指定路径下读取配置文件</span></span><br><span class="line">            ini = convertPathToIni(configLocation, required);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (required &amp;&amp; CollectionUtils.isEmpty(ini)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ini;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> Ini <span class="title">convertPathToIni</span><span class="params">(String path, <span class="keyword">boolean</span> required)</span> </span>&#123;</span><br><span class="line">        Ini ini = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(path)) &#123;</span><br><span class="line">            InputStream is = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">// 若路径不包括资源前缀（classpath:、url:、file:），则从 ServletContext 中读取，否则从这些资源路径下读取</span></span><br><span class="line">            <span class="keyword">if</span> (!ResourceUtils.hasResourcePrefix(path)) &#123;</span><br><span class="line">                is = getServletContextResourceStream(path);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    is = ResourceUtils.getInputStreamForPath(path);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (required) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将流中的数据加载到 Ini 对象中</span></span><br><span class="line">            <span class="keyword">if</span> (is != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ini = <span class="keyword">new</span> Ini();</span><br><span class="line">                ini.load(is);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (required) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ini;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> InputStream <span class="title">getServletContextResourceStream</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        InputStream is = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 需要将路径进行标准化</span></span><br><span class="line">        path = WebUtils.normalize(path);</span><br><span class="line">        ServletContext sc = getServletContext();</span><br><span class="line">        <span class="keyword">if</span> (sc != <span class="keyword">null</span>) &#123;</span><br><span class="line">            is = sc.getResourceAsStream(path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> is;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Ini <span class="title">getDefaultIni</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Ini ini = <span class="keyword">null</span>;</span><br><span class="line">        String[] configLocations = getDefaultConfigLocations();</span><br><span class="line">        <span class="keyword">if</span> (configLocations != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 先找到的先使用，后面的无需使用</span></span><br><span class="line">            <span class="keyword">for</span> (String location : configLocations) &#123;</span><br><span class="line">                ini = createIni(location, <span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">if</span> (!CollectionUtils.isEmpty(ini)) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ini;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">protected</span> String[] getDefaultConfigLocations() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[]&#123;</span><br><span class="line">            DEFAULT_WEB_INI_RESOURCE_PATH,              <span class="comment">// /WEB-INF/shiro.ini</span></span><br><span class="line">            IniFactorySupport.DEFAULT_INI_RESOURCE_PATH <span class="comment">// classpath:shiro.ini</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 清空这个 Bean 容器（一个 Map&lt;String, Object&gt; 对象，在 DefaultEnvironment 中定义）</span></span><br><span class="line">        <span class="keyword">this</span>.objects.clear();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 创建基于 Web 的 SecurityManager 对象（WebSecurityManager）</span></span><br><span class="line">        WebSecurityManager securityManager = createWebSecurityManager();</span><br><span class="line">        setWebSecurityManager(securityManager);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 初始化 Filter Chain 解析器（用于解析 Filter 规则）</span></span><br><span class="line">        FilterChainResolver resolver = createFilterChainResolver();</span><br><span class="line">        <span class="keyword">if</span> (resolver != <span class="keyword">null</span>) &#123;</span><br><span class="line">            setFilterChainResolver(resolver);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> WebSecurityManager <span class="title">createWebSecurityManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 通过工厂对象来创建 WebSecurityManager 实例</span></span><br><span class="line">        WebIniSecurityManagerFactory factory;</span><br><span class="line">        Ini ini = getIni();</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(ini)) &#123;</span><br><span class="line">            factory = <span class="keyword">new</span> WebIniSecurityManagerFactory();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            factory = <span class="keyword">new</span> WebIniSecurityManagerFactory(ini);</span><br><span class="line">        &#125;</span><br><span class="line">        WebSecurityManager wsm = (WebSecurityManager) factory.getInstance();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 从工厂中获取 Bean Map 并将其放入 Bean 容器中</span></span><br><span class="line">        Map&lt;String, ?&gt; beans = factory.getBeans();</span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(beans)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.objects.putAll(beans);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> wsm;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> FilterChainResolver <span class="title">createFilterChainResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        FilterChainResolver resolver = <span class="keyword">null</span>;</span><br><span class="line">        Ini ini = getIni();</span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(ini)) &#123;</span><br><span class="line">            <span class="comment">// Filter 可以从 [urls] 或 [filters] 片段中读取</span></span><br><span class="line">            Ini.Section urls = ini.getSection(IniFilterChainResolverFactory.URLS);</span><br><span class="line">            Ini.Section filters = ini.getSection(IniFilterChainResolverFactory.FILTERS);</span><br><span class="line">            <span class="keyword">if</span> (!CollectionUtils.isEmpty(urls) || !CollectionUtils.isEmpty(filters)) &#123;</span><br><span class="line">                <span class="comment">// 通过工厂对象创建 FilterChainResolver 实例</span></span><br><span class="line">                IniFilterChainResolverFactory factory = <span class="keyword">new</span> IniFilterChainResolverFactory(ini, <span class="keyword">this</span>.objects);</span><br><span class="line">                resolver = factory.getInstance();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resolver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看来 IniWebEnvironment 就是为了：</p>
<ol>
<li><p>查找并加载 shiro.ini 配置文件，首先从自身成员变量里查找，然后从 web.xml 中查找，然后从 /WEB-INF 下查找，然后从 classpath 下查找，若均未找到，则直接报错。</p>
</li>
<li><p>当找到了 ini 配置文件后就开始解析，此时构造了一个 Bean 容器（相当于一个轻量级的 IOC 容器），最终的目标是为了创建 WebSecurityManager 对象与 FilterChainResolver 对象，创建过程使用了 Abstract Factory 模式</p>
</li>
</ol>
<h4 id="Abstract-Factory"><a href="#Abstract-Factory" class="headerlink" title="Abstract Factory"></a>Abstract Factory</h4><p><img src="http://static.oschina.net/uploads/space/2014/0318/163354_8Zjs_223750.png" alt="img"></p>
<p>其中有两个 Factory 需要关注：<br>- WebIniSecurityManagerFactory 用于创建 WebSecurityManager。<br>- IniFilterChainResolverFactory 用于创建 FilterChainResolver。</p>
<p>通过以上分析，相信 EnvironmentLoaderListener 已经不再神秘了，无非就是在容器启动时创建 WebEnvironment 对象，并由该对象来读取 Shiro 配置文件，创建WebSecurityManager 与 FilterChainResolver 对象，它们都在后面将要出现的 ShiroFilter 中起到了重要作用。</p>
<p>从 web.xml 中同样可以得知，ShiroFilter 是整个 Shiro 框架的门面，因为它拦截了所有的请求，后面是需要 Authentication（认证）还是需要 Authorization（授权）都由它说了算。</p>
<h3 id="shiro-filter"><a href="#shiro-filter" class="headerlink" title="shiro filter"></a>shiro filter</h3><p>在上一篇中，我们分析了 Shiro Web 应用的入口 —— EnvironmentLoaderListener，它是一个 ServletContextListener，在 Web 容器启动的时候，它为我们创建了两个非常重要的对象：</p>
<ul>
<li><p>WebSecurityManager：它是用于 Web 环境的 SecurityManager 对象，通过读取 shiro.ini 中 [main] 片段生成的，我们可以通过 SecurityUtils.getSecurityManager 方法获取该对象。</p>
</li>
<li><p>FilterChainResolver：它是 shiro.ini 中 [urls] 片段所配置的 Filter Chain 的解析器，可对一个 URL 配置一个或多个 Filter（用逗号分隔），Shiro 也为我们提供了几个默认的 Filter。</p>
<p>Shiro Web 的第二个核心对象 —— ShiroFilter，它是在整个 Shiro Web 应用中请求的门户，也就是说，所有的请求都会被 ShiroFilter 拦截并进行相应的链式处理。</p>
</li>
</ul>
<p><img src="http://static.oschina.net/uploads/space/2014/0321/154813_mpy9_223750.png" alt="img"></p>
<h4 id="filter接口"><a href="#filter接口" class="headerlink" title="filter接口"></a>filter接口</h4><p>上图可见，ShiroFilter 往上竟然有五层，最上层是 Filter（即 javax.servlet.Filter），它是 Servlet 规范中的 Filter 接口，代码如下：<!--只有实现的sevlet的filter接口，才能被web容器识别和加载为filter--></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public interface Filter &#123;</span><br><span class="line"></span><br><span class="line">    void init(FilterConfig filterConfig) throws ServletException;</span><br><span class="line"></span><br><span class="line">    void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException;</span><br><span class="line"></span><br><span class="line">    void destroy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Filter 接口中的三个方法分别在 Filter 生命周期的三个时期内由 Web 容器来调用，分别是：初始化、执行、销毁。</p>
<p>但与 Filter 接口同一级别下竟然还有一个名为 ServletContextSupport 的类，它又是起什么作用的呢？</p>
<h4 id="封装ServletContext"><a href="#封装ServletContext" class="headerlink" title="封装ServletContext"></a>封装ServletContext</h4><p>打开 ServletContextSupport 的源码便知，它是 Shiro 为了封装 ServletContext 的而提供的一个类，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 封装 ServletContext</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class ServletContextSupport &#123;</span><br><span class="line"></span><br><span class="line">    private ServletContext servletContext;</span><br><span class="line"></span><br><span class="line">    public ServletContext getServletContext() &#123;</span><br><span class="line">        return servletContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setServletContext(ServletContext servletContext) &#123;</span><br><span class="line">        this.servletContext &#x3D; servletContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(&#123;&quot;UnusedDeclaration&quot;&#125;)</span><br><span class="line">    protected String getContextInitParam(String paramName) &#123;</span><br><span class="line">        return getServletContext().getInitParameter(paramName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private ServletContext getRequiredServletContext() &#123;</span><br><span class="line">        ServletContext servletContext &#x3D; getServletContext();</span><br><span class="line">        if (servletContext &#x3D;&#x3D; null) &#123;</span><br><span class="line">            throw new IllegalStateException();</span><br><span class="line">        &#125;</span><br><span class="line">        return servletContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(&#123;&quot;UnusedDeclaration&quot;&#125;)</span><br><span class="line">    protected void setContextAttribute(String key, Object value) &#123;</span><br><span class="line">        if (value &#x3D;&#x3D; null) &#123;</span><br><span class="line">            removeContextAttribute(key);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            getRequiredServletContext().setAttribute(key, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(&#123;&quot;UnusedDeclaration&quot;&#125;)</span><br><span class="line">    protected Object getContextAttribute(String key) &#123;</span><br><span class="line">        return getRequiredServletContext().getAttribute(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void removeContextAttribute(String key) &#123;</span><br><span class="line">        getRequiredServletContext().removeAttribute(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return toStringBuilder().toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected StringBuilder toStringBuilder() &#123;</span><br><span class="line">        return new StringBuilder(super.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>通过这个类，我们可以方便的操纵 ServletContext 对象（使用其中的属性），那么这个 ServletContext 对象又是如何来初始化的呢？</p>
<p>不妨看看 Filter 与 ServletContextSupport 的子类 AbstractFilter 吧，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 初始化 ServletContext 并封装 FilterConfig</span><br><span class="line"> *&#x2F;</span><br><span class="line">public abstract class AbstractFilter extends ServletContextSupport implements Filter &#123;</span><br><span class="line"></span><br><span class="line">    protected FilterConfig filterConfig;</span><br><span class="line"></span><br><span class="line">    public FilterConfig getFilterConfig() &#123;</span><br><span class="line">        return filterConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setFilterConfig(FilterConfig filterConfig) &#123;</span><br><span class="line">        &#x2F;&#x2F; 初始化 FilterConfig 与 ServletContext</span><br><span class="line">        this.filterConfig &#x3D; filterConfig;</span><br><span class="line">        setServletContext(filterConfig.getServletContext());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected String getInitParam(String paramName) &#123;</span><br><span class="line">        &#x2F;&#x2F; 从 FilterConfig 中获取初始参数</span><br><span class="line">        FilterConfig config &#x3D; getFilterConfig();</span><br><span class="line">        if (config !&#x3D; null) &#123;</span><br><span class="line">            return StringUtils.clean(config.getInitParameter(paramName));</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final void init(FilterConfig filterConfig) throws ServletException &#123;</span><br><span class="line">        &#x2F;&#x2F; 初始化 FilterConfig</span><br><span class="line">        setFilterConfig(filterConfig);</span><br><span class="line">        try &#123;</span><br><span class="line">            &#x2F;&#x2F; 在子类中实现该模板方法</span><br><span class="line">            onFilterConfigSet();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            if (e instanceof ServletException) &#123;</span><br><span class="line">                throw (ServletException) e;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                throw new ServletException(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void onFilterConfigSet() throws Exception &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void destroy() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>看到这个类的第一感觉就是，它对 FilterConfig 进行了封装，为什么要封装 FilterConfig 呢？就是想通过它来获取 ServletContext。可见，在 init 方法中完成了 FilterConfig 的初始化，并提供了一个名为 onFilterConfigSet 的模板方法，让它的子类去实现其中的细节。</p>
<p>在阅读 AbstractFilter 的子类 NameableFilter 的源码之前，不妨先看看 NameableFilter 实现了一个很有意思的接口 Nameable，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 确保实现该接口的类可进行命名（具有唯一的名称）</span><br><span class="line"> *&#x2F;</span><br><span class="line">public interface Nameable &#123;</span><br><span class="line"></span><br><span class="line">    void setName(String name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>仅提供了一个 setName 的方法，目的就是为了让其子类能够提供一个唯一的 Filter Name，如果子类不提供怎么办呢？</p>
<p>相信 Nameable 的实现类也就是 AbstractFilter 的子类 NameableFilter 会告诉我们想要的答案，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 提供 Filter Name 的 get&#x2F;set 方法</span><br><span class="line"> *&#x2F;</span><br><span class="line">public abstract class NameableFilter extends AbstractFilter implements Nameable &#123;</span><br><span class="line"></span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">    protected String getName() &#123;</span><br><span class="line">        &#x2F;&#x2F; 若成员变量 name 为空，则从 FilterConfig 中获取 Filter Name</span><br><span class="line">        if (this.name &#x3D;&#x3D; null) &#123;</span><br><span class="line">            FilterConfig config &#x3D; getFilterConfig();</span><br><span class="line">            if (config !&#x3D; null) &#123;</span><br><span class="line">                this.name &#x3D; config.getFilterName();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return this.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setName(String name) &#123;</span><br><span class="line">        this.name &#x3D; name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected StringBuilder toStringBuilder() &#123;</span><br><span class="line">        String name &#x3D; getName();</span><br><span class="line">        if (name &#x3D;&#x3D; null) &#123;</span><br><span class="line">            return super.toStringBuilder();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            StringBuilder sb &#x3D; new StringBuilder();</span><br><span class="line">            sb.append(name);</span><br><span class="line">            return sb;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>看到了 NameableFilter 中的 getName 方法，我们应该清楚了，每个 Filter 必须有一个名字，可通过 setName 方法设置的，如果不设置就取该 Filter 默认的名字，也就是在 web.xml 中配置的 filter-name 了。此外，这里还通过一个 toStringBuilder 方法完成了类似 toString 方法，不过暂时还没什么用途，可能以后会有用。</p>
<p>以上这一切都是为了让每个 Filter 有一个名字，而且这个名字最好是唯一的（这一点在 Shiro 源码中没有得到控制）。此外，在 shiro.ini 的 [urls] 片段的配置满足一定规则的，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[urls]</span><br><span class="line">&#x2F;foo &#x3D; ssl, authc</span><br></pre></td></tr></table></figure>



<p>等号左边的是 URL，右边的是 Filter Chian，一个或多个 Filter，每个 Filter 用逗号进行分隔。</p>
<p>对于 /foo 这个 URL 而言，可先后通过 ssl 与 authc 这两个 Filter。如果我们同时配置了两个 ssl，这个 URL 会被 ssl 拦截两次吗？答案是否定的，因为 Shiro 为我们提供了一个“一次性 Filter”的原则，也就是保证了每个请求只能被同一个 Filter 拦截一次，而且仅此一次。</p>
<p>这样的机制是如何实现的呢？我们不妨看看 NameableFilter 的子类 OncePerRequestFilter 吧，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 确保每个请求只能被 Filter 过滤一次</span><br><span class="line"> *&#x2F;</span><br><span class="line">public abstract class OncePerRequestFilter extends NameableFilter &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 已过滤属性的后缀名</span><br><span class="line">    public static final String ALREADY_FILTERED_SUFFIX &#x3D; &quot;.FILTERED&quot;;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 是否开启过滤功能</span><br><span class="line">    private boolean enabled &#x3D; true;</span><br><span class="line"></span><br><span class="line">    public boolean isEnabled() &#123;</span><br><span class="line">        return enabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setEnabled(boolean enabled) &#123;</span><br><span class="line">        this.enabled &#x3D; enabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final void doFilter(ServletRequest request, ServletResponse response, FilterChain filterChain) throws ServletException, IOException &#123;</span><br><span class="line">        &#x2F;&#x2F; 获取 Filter 已过滤的属性名</span><br><span class="line">        String alreadyFilteredAttributeName &#x3D; getAlreadyFilteredAttributeName();</span><br><span class="line">        &#x2F;&#x2F; 判断是否已过滤</span><br><span class="line">        if (request.getAttribute(alreadyFilteredAttributeName) !&#x3D; null) &#123;</span><br><span class="line">            &#x2F;&#x2F; 若已过滤，则进入 FilterChain 中下一个 Filter</span><br><span class="line">            filterChain.doFilter(request, response);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            &#x2F;&#x2F; 若未过滤，则判断是否未开启过滤功能（其中 shouldNotFilter 方法将被废弃，由 isEnabled 方法取代）</span><br><span class="line">            if (!isEnabled(request, response) || shouldNotFilter(request)) &#123;</span><br><span class="line">                &#x2F;&#x2F; 若未开启，则进入 FilterChain 中下一个 Filter</span><br><span class="line">                filterChain.doFilter(request, response);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                &#x2F;&#x2F; 若已开启，则将已过滤属性设置为 true（只要保证 Request 中有这个属性即可）</span><br><span class="line">                request.setAttribute(alreadyFilteredAttributeName, Boolean.TRUE);</span><br><span class="line">                try &#123;</span><br><span class="line">                    &#x2F;&#x2F; 在子类中执行具体的过滤操作</span><br><span class="line">                    doFilterInternal(request, response, filterChain);</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    &#x2F;&#x2F; 当前 Filter 执行结束需移除 Request 中的已过滤属性</span><br><span class="line">                    request.removeAttribute(alreadyFilteredAttributeName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected String getAlreadyFilteredAttributeName() &#123;</span><br><span class="line">        String name &#x3D; getName();</span><br><span class="line">        if (name &#x3D;&#x3D; null) &#123;</span><br><span class="line">            name &#x3D; getClass().getName();</span><br><span class="line">        &#125;</span><br><span class="line">        return name + ALREADY_FILTERED_SUFFIX;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(&#123;&quot;UnusedParameters&quot;&#125;)</span><br><span class="line">    protected boolean isEnabled(ServletRequest request, ServletResponse response) throws ServletException, IOException &#123;</span><br><span class="line">        return isEnabled();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Deprecated</span><br><span class="line">    @SuppressWarnings(&#123;&quot;UnusedDeclaration&quot;&#125;)</span><br><span class="line">    protected boolean shouldNotFilter(ServletRequest request) throws ServletException &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected abstract void doFilterInternal(ServletRequest request, ServletResponse response, FilterChain chain) throws ServletException, IOException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>如何确保每个请求只会被同一个 Filter 拦截一次呢？Shiro 提供了一个超简单的解决方案：在 Requet 中放置一个后缀为 .FILTERED 的属性，在执行具体拦截操作（即 doFilterInternal 方法）之前放入该属性，执行完毕后移除该属性。</p>
<p>在 Shiro 的 Filter Chian 配置中，如果我们想禁用某个 Filter，如何实现呢？OncePerRequestFilter 也为我们提供了一个 enabled 的属性，方便我们可以在 shiro.ini 中随时禁用某个 Filter，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[main]</span><br><span class="line">ssl.enabled &#x3D; false</span><br><span class="line"></span><br><span class="line">[urls]</span><br><span class="line">&#x2F;foo &#x3D; ssl, authc</span><br></pre></td></tr></table></figure>



<p>这样一来 ssl 这个 Filter 就被我们给禁用了，以后想开启 ssl 的话，完全不需要在 urls 配置中一个个手工来添加，只需把 ssl.enabled 设置为 true，或注释掉该行，或直接删除该行即可。</p>
<p>可见，OncePerRequestFilter 给我们提供了一个模板方法 doFilterInternal，在其子类中我们需要实现该方法的具体细节，那么谁来实现呢？不妨继续看下面的 AbstractShiroFilter 吧，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 确保可通过 SecurityUtils 获取 SecurityManager，并执行过滤器操作</span><br><span class="line"> *&#x2F;</span><br><span class="line">public abstract class AbstractShiroFilter extends OncePerRequestFilter &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 是否可以通过 SecurityUtils 获取 SecurityManager</span><br><span class="line">    private static final String STATIC_INIT_PARAM_NAME &#x3D; &quot;staticSecurityManagerEnabled&quot;;</span><br><span class="line"></span><br><span class="line">    private WebSecurityManager securityManager;</span><br><span class="line">    private FilterChainResolver filterChainResolver;</span><br><span class="line">    private boolean staticSecurityManagerEnabled;</span><br><span class="line"></span><br><span class="line">    protected AbstractShiroFilter() &#123;</span><br><span class="line">        this.staticSecurityManagerEnabled &#x3D; false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public WebSecurityManager getSecurityManager() &#123;</span><br><span class="line">        return securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setSecurityManager(WebSecurityManager sm) &#123;</span><br><span class="line">        this.securityManager &#x3D; sm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public FilterChainResolver getFilterChainResolver() &#123;</span><br><span class="line">        return filterChainResolver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setFilterChainResolver(FilterChainResolver filterChainResolver) &#123;</span><br><span class="line">        this.filterChainResolver &#x3D; filterChainResolver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean isStaticSecurityManagerEnabled() &#123;</span><br><span class="line">        return staticSecurityManagerEnabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setStaticSecurityManagerEnabled(boolean staticSecurityManagerEnabled) &#123;</span><br><span class="line">        this.staticSecurityManagerEnabled &#x3D; staticSecurityManagerEnabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 这是 AbstractFilter 提供的在 init 时需要执行的方法</span><br><span class="line">    protected final void onFilterConfigSet() throws Exception &#123;</span><br><span class="line">        &#x2F;&#x2F; 从 web.xml 中读取 staticSecurityManagerEnabled 参数（默认为 false）</span><br><span class="line">        applyStaticSecurityManagerEnabledConfig();</span><br><span class="line">        &#x2F;&#x2F; 初始化（在子类中实现）</span><br><span class="line">        init();</span><br><span class="line">        &#x2F;&#x2F; 确保 SecurityManager 必须存在</span><br><span class="line">        ensureSecurityManager();</span><br><span class="line">        &#x2F;&#x2F; 若已开启 static 标志，则将当前的 SecurityManager 放入 SecurityUtils 中，以后可以随时获取</span><br><span class="line">        if (isStaticSecurityManagerEnabled()) &#123;</span><br><span class="line">            SecurityUtils.setSecurityManager(getSecurityManager());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void applyStaticSecurityManagerEnabledConfig() &#123;</span><br><span class="line">        String value &#x3D; getInitParam(STATIC_INIT_PARAM_NAME);</span><br><span class="line">        if (value !&#x3D; null) &#123;</span><br><span class="line">            Boolean b &#x3D; Boolean.valueOf(value);</span><br><span class="line">            if (b !&#x3D; null) &#123;</span><br><span class="line">                setStaticSecurityManagerEnabled(b);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void init() throws Exception &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void ensureSecurityManager() &#123;</span><br><span class="line">        &#x2F;&#x2F; 首先获取当前的 SecurityManager，若不存在，则创建默认的 SecurityManager（即 DefaultWebSecurityManager）</span><br><span class="line">        WebSecurityManager securityManager &#x3D; getSecurityManager();</span><br><span class="line">        if (securityManager &#x3D;&#x3D; null) &#123;</span><br><span class="line">            securityManager &#x3D; createDefaultSecurityManager();</span><br><span class="line">            setSecurityManager(securityManager);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected WebSecurityManager createDefaultSecurityManager() &#123;</span><br><span class="line">        return new DefaultWebSecurityManager();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 这是 OncePerRequestFilter 提供的在 doFilter 时需要执行的方法</span><br><span class="line">    protected void doFilterInternal(ServletRequest servletRequest, ServletResponse servletResponse, final FilterChain chain) throws ServletException, IOException &#123;</span><br><span class="line">        Throwable t &#x3D; null;</span><br><span class="line">        try &#123;</span><br><span class="line">            &#x2F;&#x2F; 返回被 Shiro 包装过的 Request 与 Response 对象</span><br><span class="line">            final ServletRequest request &#x3D; prepareServletRequest(servletRequest, servletResponse, chain);</span><br><span class="line">            final ServletResponse response &#x3D; prepareServletResponse(request, servletResponse, chain);</span><br><span class="line">            &#x2F;&#x2F; 创建 Shiro 的 Subject 对象</span><br><span class="line">            final Subject subject &#x3D; createSubject(request, response);</span><br><span class="line">            &#x2F;&#x2F; 使用异步的方式执行相关操作</span><br><span class="line">            subject.execute(new Callable() &#123;</span><br><span class="line">                public Object call() throws Exception &#123;</span><br><span class="line">                    &#x2F;&#x2F; 更新 Session 的最后访问时间</span><br><span class="line">                    updateSessionLastAccessTime(request, response);</span><br><span class="line">                    &#x2F;&#x2F; 执行 Shiro 的 Filter Chain</span><br><span class="line">                    executeChain(request, response, chain);</span><br><span class="line">                    return null;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; catch (ExecutionException ex) &#123;</span><br><span class="line">            t &#x3D; ex.getCause();</span><br><span class="line">        &#125; catch (Throwable throwable) &#123;</span><br><span class="line">            t &#x3D; throwable;</span><br><span class="line">        &#125;</span><br><span class="line">        if (t !&#x3D; null) &#123;</span><br><span class="line">            if (t instanceof ServletException) &#123;</span><br><span class="line">                throw (ServletException) t;</span><br><span class="line">            &#125;</span><br><span class="line">            if (t instanceof IOException) &#123;</span><br><span class="line">                throw (IOException) t;</span><br><span class="line">            &#125;</span><br><span class="line">            throw new ServletException(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(&#123;&quot;UnusedDeclaration&quot;&#125;)</span><br><span class="line">    protected ServletRequest prepareServletRequest(ServletRequest request, ServletResponse response, FilterChain chain) &#123;</span><br><span class="line">        ServletRequest toUse &#x3D; request;</span><br><span class="line">        if (request instanceof HttpServletRequest) &#123;</span><br><span class="line">            &#x2F;&#x2F; 获取包装后的 Request 对象（使用 ShiroHttpServletRequest 进行包装）</span><br><span class="line">            HttpServletRequest http &#x3D; (HttpServletRequest) request;</span><br><span class="line">            toUse &#x3D; wrapServletRequest(http);</span><br><span class="line">        &#125;</span><br><span class="line">        return toUse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected ServletRequest wrapServletRequest(HttpServletRequest orig) &#123;</span><br><span class="line">        return new ShiroHttpServletRequest(orig, getServletContext(), isHttpSessions());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected boolean isHttpSessions() &#123;</span><br><span class="line">        return getSecurityManager().isHttpSessionMode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(&#123;&quot;UnusedDeclaration&quot;&#125;)</span><br><span class="line">    protected ServletResponse prepareServletResponse(ServletRequest request, ServletResponse response, FilterChain chain) &#123;</span><br><span class="line">        ServletResponse toUse &#x3D; response;</span><br><span class="line">        if (!isHttpSessions() &amp;&amp; (request instanceof ShiroHttpServletRequest) &amp;&amp; (response instanceof HttpServletResponse)) &#123;</span><br><span class="line">            &#x2F;&#x2F; 获取包装后的 Response 对象（使用 ShiroHttpServletResponse 进行包装）</span><br><span class="line">            toUse &#x3D; wrapServletResponse((HttpServletResponse) response, (ShiroHttpServletRequest) request);</span><br><span class="line">        &#125;</span><br><span class="line">        return toUse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected ServletResponse wrapServletResponse(HttpServletResponse orig, ShiroHttpServletRequest request) &#123;</span><br><span class="line">        return new ShiroHttpServletResponse(orig, getServletContext(), request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected WebSubject createSubject(ServletRequest request, ServletResponse response) &#123;</span><br><span class="line">        return new WebSubject.Builder(getSecurityManager(), request, response).buildWebSubject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(&#123;&quot;UnusedDeclaration&quot;&#125;)</span><br><span class="line">    protected void updateSessionLastAccessTime(ServletRequest request, ServletResponse response) &#123;</span><br><span class="line">        &#x2F;&#x2F; 仅对本地 Session 做如下操作</span><br><span class="line">        if (!isHttpSessions()) &#123;</span><br><span class="line">            &#x2F;&#x2F; 获取 Subject（实际上是从 ThreadLocal 中获取的）</span><br><span class="line">            Subject subject &#x3D; SecurityUtils.getSubject();</span><br><span class="line">            if (subject !&#x3D; null) &#123;</span><br><span class="line">                &#x2F;&#x2F; 从 Subject 中获取 Session</span><br><span class="line">                Session session &#x3D; subject.getSession(false);</span><br><span class="line">                if (session !&#x3D; null) &#123;</span><br><span class="line">                    &#x2F;&#x2F; 更新 Session 对象的 lastAccessTime 属性</span><br><span class="line">                    session.touch();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void executeChain(ServletRequest request, ServletResponse response, FilterChain origChain) throws IOException, ServletException &#123;</span><br><span class="line">        &#x2F;&#x2F; 获取 Shiro 代理后的 FilterChain 对象，并进行链式处理</span><br><span class="line">        FilterChain chain &#x3D; getExecutionChain(request, response, origChain);</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected FilterChain getExecutionChain(ServletRequest request, ServletResponse response, FilterChain origChain) &#123;</span><br><span class="line">        FilterChain chain &#x3D; origChain;</span><br><span class="line">        &#x2F;&#x2F; 获取 FilterChainResolver，若不存在，则返回原始的 FilterChain</span><br><span class="line">        FilterChainResolver resolver &#x3D; getFilterChainResolver();</span><br><span class="line">        if (resolver &#x3D;&#x3D; null) &#123;</span><br><span class="line">            return origChain;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 通过 FilterChainResolver 获取 ProxiedFilterChain</span><br><span class="line">        FilterChain resolved &#x3D; resolver.getChain(request, response, origChain);</span><br><span class="line">        if (resolved !&#x3D; null) &#123;</span><br><span class="line">            chain &#x3D; resolved;</span><br><span class="line">        &#125;</span><br><span class="line">        return chain;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这个 AbstractShiroFilter 类代码稍微有点长，因为它干了许多的事情，主要实现了两个模板方法：onFilterConfigSet 与 doFilterInternal，以上代码中均已对它们做了详细的注释。</p>
<p>其中，在 onFilterConfigSet 中实际上提供了一个框架，只是将 SecurityManager 放入 SecurityUtils 这个工具类中，至于具体行为还是放在子类的 init 方法中去实现，而这个子类就是 ShiroFilter，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 初始化过滤器</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class ShiroFilter extends AbstractShiroFilter &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void init() throws Exception &#123;</span><br><span class="line">        &#x2F;&#x2F; 从 ServletContext 中获取 WebEnvironment（该对象已通过 EnvironmentLoader 创建）</span><br><span class="line">        WebEnvironment env &#x3D; WebUtils.getRequiredWebEnvironment(getServletContext());</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 将 WebEnvironment 中的 WebSecurityManager 放入 AbstractShiroFilter 中</span><br><span class="line">        setSecurityManager(env.getWebSecurityManager());</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 将 WebEnvironment 中的 FilterChainResolver 放入 AbstractShiroFilter 中</span><br><span class="line">        FilterChainResolver resolver &#x3D; env.getFilterChainResolver();</span><br><span class="line">        if (resolver !&#x3D; null) &#123;</span><br><span class="line">            setFilterChainResolver(resolver);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在 ShiroFilter 中只用做初始化的行为，就是从 WebEnvironment 中分别获取 WebSecurityManager 与 FilterChainResolver，其它的事情都由它的父类去实现了。</p>
<p>到此为止，ShiroFilter 的源码已基本分析完毕，当然还有些非常有意思的代码，这里没有进行分析，例如：</p>
<ul>
<li>通过 ShiroHttpServletRequest 来包装 Request</li>
<li>通过 ShiroHttpServletResponse 来包装 Response</li>
<li>通过 Session 来代理 HttpSession</li>
<li>提供 FilterChain 的代理机制</li>
<li>使用 ThreadContext 来保证线程安全</li>
</ul>
<p>这些有意思的代码，我就不继续分析了，留点滋味让大家去慢慢品尝吧！</p>
<p>最后需要补充说明的是，Shiro 的 Filter 架构体系是非常庞大的，这里仅对 ShiroFilter 进行了分析，整个 Filter 静态结构看起来是这样的：</p>
<p><img src="http://static.oschina.net/uploads/space/2014/0321/172903_VINL_223750.png" alt="img"></p>
<p>可见，在 OncePerRequestFilter 下有两个分支，本文只分析了 ShiroFilter 这个分支，另外还有一个 AdviceFilter 分支，它提供了 AOP 功能的 Filter，这些 Filter 就是 Shiro 为我们提供的默认 Filter：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>类名</th>
</tr>
</thead>
<tbody><tr>
<td>anon</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authc/AnonymousFilter.html">org.apache.shiro.web.filter.authc.AnonymousFilter</a></td>
</tr>
<tr>
<td>authc</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authc/FormAuthenticationFilter.html">org.apache.shiro.web.filter.authc.FormAuthenticationFilter</a></td>
</tr>
<tr>
<td>authcBasic</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authc/BasicHttpAuthenticationFilter.html">org.apache.shiro.web.filter.authc.BasicHttpAuthenticationFilter</a></td>
</tr>
<tr>
<td>logout</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authc/LogoutFilter.html">org.apache.shiro.web.filter.authc.LogoutFilter</a></td>
</tr>
<tr>
<td>noSessionCreation</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/session/NoSessionCreationFilter.html">org.apache.shiro.web.filter.session.NoSessionCreationFilter</a></td>
</tr>
<tr>
<td>perms</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authz/PermissionsAuthorizationFilter.html">org.apache.shiro.web.filter.authz.PermissionsAuthorizationFilter</a></td>
</tr>
<tr>
<td>port</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authz/PortFilter.html">org.apache.shiro.web.filter.authz.PortFilter</a></td>
</tr>
<tr>
<td>rest</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authz/HttpMethodPermissionFilter.html">org.apache.shiro.web.filter.authz.HttpMethodPermissionFilter</a></td>
</tr>
<tr>
<td>roles</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authz/RolesAuthorizationFilter.html">org.apache.shiro.web.filter.authz.RolesAuthorizationFilter</a></td>
</tr>
<tr>
<td>ssl</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authz/SslFilter.html">org.apache.shiro.web.filter.authz.SslFilter</a></td>
</tr>
<tr>
<td>user</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authc/UserFilter.html">org.apache.shiro.web.filter.authc.UserFilter</a></td>
</tr>
</tbody></table>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><h3 id="前后端分离"><a href="#前后端分离" class="headerlink" title="前后端分离"></a>前后端分离</h3><p>to determine the identity of the user is through the sessionId, and the sessionId is stored in the cookie, we can return the sessionId as the response header to the front end after login, each request is accompanied by this information, then we customize a SessionManager, overwrite His getSessionId method can be:<br>Return the sessionId to the frontend after logging in:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(<span class="string">&quot;login&quot;</span>)</span><br><span class="line">@Responebody</span><br><span class="line">    public Result login(<span class="built_in">String</span> username, <span class="built_in">String</span> password, HttpServletResponse response)&#123;</span><br><span class="line">        Result result = <span class="literal">null</span>;</span><br><span class="line">        UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(username,password);</span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            subject.login(token);</span><br><span class="line">            Serializable id = subject.getSession().getId();</span><br><span class="line">            response.setHeader(<span class="string">&quot;token&quot;</span>,id.toString());<span class="regexp">/ /</span> Get the state <span class="keyword">of</span> the sessionId, <span class="keyword">return</span> to the front end</span><br><span class="line">            result = ResultGenerator.getSuucessResult();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            result = ResultGenerator.getFailResult(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Custom sessionManager, the way to get the sessionId is no longer a heavy cookie but in the requsetHeader:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MyWebSessionManager</span> <span class="keyword">extends</span> <span class="title">DefaultWebSessionManager</span> </span>&#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected Serializable getSessionId(ServletRequest request, ServletResponse response) &#123;</span><br><span class="line">        HttpServletRequest httpServletRequest = WebUtils.toHttp(request);</span><br><span class="line">        <span class="built_in">String</span> token = httpServletRequest.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;token：&quot;</span>+token);</span><br><span class="line">        request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID_SOURCE, <span class="string">&quot;token&quot;</span>);</span><br><span class="line">        request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID, token);</span><br><span class="line">        request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID_IS_VALID, <span class="built_in">Boolean</span>.TRUE);</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Set to use the change sessionManager, generic can also use ioc injection without new:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">    public DefaultWebSecurityManager webSecurityManager(MyRealm myRealm)&#123;</span><br><span class="line">        DefaultWebSecurityManager webSecurityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">        MyWebSessionManager webSessionManager = <span class="keyword">new</span> MyWebSessionManager();<span class="regexp">/ /</span> Use a custom sessionManager</span><br><span class="line">        webSessionManager.setGlobalSessionTimeout(<span class="number">360000</span>l);<span class="regexp">/ /</span> <span class="built_in">Set</span> the session expiration time <span class="number">1</span> hour</span><br><span class="line">        webSecurityManager.setSessionManager(webSessionManager);</span><br><span class="line">        webSecurityManager.setRealm(myRealm);</span><br><span class="line">        <span class="keyword">return</span> webSecurityManager;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>With such a simple configuration, most of the rights management of shiro can be realized by separating the front and back ends.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/9/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/22/">22</a><a class="extend next" rel="next" href="/page/11/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Fei Qi</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  


















  








  

  

</body>
</html>
