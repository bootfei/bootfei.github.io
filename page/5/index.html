<!DOCTYPE html>
<html lang="en,cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Mist","version":"8.0.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>

  <meta name="description" content="learn more, forget more; practice more, get more.">
<meta property="og:type" content="website">
<meta property="og:title" content="BootFei&#39;s Blog">
<meta property="og:url" content="http://example.com/page/5/index.html">
<meta property="og:site_name" content="BootFei&#39;s Blog">
<meta property="og:description" content="learn more, forget more; practice more, get more.">
<meta property="og:locale">
<meta property="article:author" content="Fei Qi">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/5/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en,cn'
  };
</script>

  <title>BootFei's Blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">BootFei's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">敬畏耶和华是智慧的开端，认识至圣者就是聪明</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Fei Qi</p>
  <div class="site-description" itemprop="description">learn more, forget more; practice more, get more.</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">177</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">
      

      
    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/08/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E7%BC%93%E5%AD%98/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E5%9C%A8%E7%BC%93%E5%AD%98%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/08/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E7%BC%93%E5%AD%98/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E5%9C%A8%E7%BC%93%E5%AD%98%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/" class="post-title-link" itemprop="url">布隆过滤器在缓存中的应用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-04-08 09:05:41" itemprop="dateCreated datePublished" datetime="2021-04-08T09:05:41+08:00">2021-04-08</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-04-20 12:49:22" itemprop="dateModified" datetime="2021-04-20T12:49:22+08:00">2021-04-20</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="bitmap和布隆过滤器"><a href="#bitmap和布隆过滤器" class="headerlink" title="bitmap和布隆过滤器"></a>bitmap和布隆过滤器</h2><h3 id="海量整数中是否存在某个值–bitmap"><a href="#海量整数中是否存在某个值–bitmap" class="headerlink" title="海量整数中是否存在某个值–bitmap"></a><strong>海量整数中是否存在某个值–bitmap</strong></h3><p>在一个程序中，经常有让我们判断一个集合中是否存在某个数的case；大多数情况下，只需要用map或是list这样简单的数据结构。如果这是一个十分庞大的集合（给这个庞大一个具体的值吧，一个亿），简单的一个hash map，不考虑链表所需的指针内存空间，一亿个int类型的整数，就需要380多M（4byte × 10 ^8），十亿的话就是4个G。<!--存储大量数据，会占用大量内存，使用bitMap来记录该整数是否存在--></p>
<p>bitmap则使用位数代表数的大小，bit中存储的0或者1来标识该整数是否存在，具体模型如下：</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/eQPyBffYbufmAhxIclpyoY9iaVZD7j1g9ZZZQYgiajric8MeN9uK3v5QUdAQHcfLLXgmHbticWeibgqmJavOEkPcszg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image">这是一个能标识0-9的“bitmap”，其中4、3、2、1这四个数存在</p>
<p>计算一下bitmap的内存开销，如果是1亿以内的数据查找，我们只需要1亿个bit = 12MB左右的内存空间，就可以完成海量数据查找了，是不是极其诱人的一个内存缩减，以下为Java实现的bitmap代码：</p>
<!--注意：作者使用的是byte数组，不是bit数组，我猜测是为了减少数组的长度，1个byte=8个bit。所以，计算的时候，要除以8以获取byte数组的index,然后。如下图所示，bit[4]=1，转换为byte[0]=0001_0000 -->

<table>
<thead>
<tr>
<th></th>
<th>4</th>
<th>3</th>
<th>2</th>
<th>1</th>
<th>0</th>
</tr>
</thead>
<tbody><tr>
<td>Bit[]</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>Byte[]</td>
<td>0000_0000</td>
<td>0000_0000</td>
<td>0000_0000</td>
<td>0000_0000</td>
<td>0001_0000</td>
</tr>
</tbody></table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public class MyBitMap &#123;</span><br><span class="line"> </span><br><span class="line">    private byte[] bytes;</span><br><span class="line">    private int initSize;</span><br><span class="line"> </span><br><span class="line">    public MyBitMap(int size) &#123;</span><br><span class="line">        if (size &lt;&#x3D; 0) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        initSize &#x3D; size &#x2F; (8) + 1;</span><br><span class="line">        bytes &#x3D; new byte[initSize];</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public void set(int number) &#123;</span><br><span class="line">        &#x2F;&#x2F;相当于对一个数字进行右移动3位，相当于除以8</span><br><span class="line">        int index &#x3D; number &gt;&gt; 3;</span><br><span class="line">        &#x2F;&#x2F;相当于 number % 8 获取到byte[index]的位置</span><br><span class="line">        int position &#x3D; number &amp; 0x07;</span><br><span class="line">        &#x2F;&#x2F;进行|或运算  参加运算的两个对象只要有一个为1，其值为1。</span><br><span class="line">        bytes[index] |&#x3D; 1 &lt;&lt; position;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    public boolean contain(int number) &#123;</span><br><span class="line">        int index &#x3D; number &gt;&gt; 3;</span><br><span class="line">        int position &#x3D; number &amp; 0x07;</span><br><span class="line">        return (bytes[index] &amp; (1 &lt;&lt; position)) !&#x3D; 0;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        MyBitMap myBitMap &#x3D; new MyBitMap(32);</span><br><span class="line">        myBitMap.set(30);</span><br><span class="line">        myBitMap.set(13);</span><br><span class="line">        myBitMap.set(24);</span><br><span class="line">        System.out.println(myBitMap.contain(2));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们明确这是一个一亿以内，但是数量级只有10的集合，我们使用bitmap，同样需要开销12M的数据，如果是10亿以内的数据，开销就会涨到120M，bitmap的空间开销永远是和他的数据取值范围挂钩的，只有在海量数据下，他才能够大显身手。</p>
<p>再说说刚刚提到的那个极端case，假设这个数据量在一千万，但是取值范围就在十个亿以内，<!--其实就是数据分布不均匀--> 那我们不可避免还是要面对120M的开销，有方法应对么？</p>
<h3 id="布隆过滤器"><a href="#布隆过滤器" class="headerlink" title="布隆过滤器"></a>布隆过滤器</h3><!--为了解决bitMap面对的数据分布离散极端情况，使用hash使数据分布均匀-->

<p>如果面对笔者说的以上问题，我们结合一下常规的解决方案，譬如说hash一下，我将十亿以内的某个数据，hash成一亿内的某个值，再去bitmap中查怎么样，如下图，布隆过滤器就是这么干的：</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/eQPyBffYbufmAhxIclpyoY9iaVZD7j1g9GOs2rd4B2QlOOZBOXEG2L7lsOzgm2UqBjMx4LKWHIuP8YqlSNcUCEA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image">利用多个hash算法得到的值，减小hash碰撞的概率</p>
<p>像上面的图注所说，我们可以利用多个hash算法减小碰撞概率，但只要存在碰撞，就一定会有错误判断，我们无法百分百确定一个值是否真的存在，但是我可以确定你是否真的不存在，这也就是以上的实现为什么称之“过滤器”的原因了。</p>
<h2 id="高并发缓存设计策略"><a href="#高并发缓存设计策略" class="headerlink" title="高并发缓存设计策略"></a>高并发缓存设计策略</h2><h3 id="why-cache"><a href="#why-cache" class="headerlink" title="why cache??"></a><strong>why cache??</strong></h3><p>在计算机体系中，cache是介于cpu以及内存之间，用来缓和cpu和内存处理速度差距的那么一个和事佬；在OS中，page cache又是内存和IO之间的和事佬。</p>
<p>即使是在软件层，我们同样需要这么一个和事老，从最简单的服务架构开始，通常我们在服务端发起请求，然后CURD某个关系型数据库例如Mysql。但是，类似这样的架构都需要有一个磁盘作为终端持久化，即使增加索引，使用B+树的这种数据结构进行优化查询，效率还是会卡在需要频繁寻道的IO上。这个时候，一个和事老的作用就十分明显了，我们会添加一些内存操作，来缓和IO处理速度慢带来的压力。cache is not a problem，how to use it is actually a problem。</p>
<h3 id="缓存一致性问题"><a href="#缓存一致性问题" class="headerlink" title="缓存一致性问题"></a>缓存一致性问题</h3><p>缓存处理的机制有以下几种：</p>
<ul>
<li>cache aside；</li>
<li>read through；</li>
<li>write through；</li>
<li>write behind caching；</li>
</ul>
<h3 id="缓存穿透问题"><a href="#缓存穿透问题" class="headerlink" title="缓存穿透问题"></a>缓存穿透问题</h3><p>所谓的缓存击穿，就是当请求发出，而无法在缓存中读到数据时，请求还是会作用到database，这样的话，缓存减压的效果就不复存在了。</p>
<p>设想这么一个场景，如果一个用户，使用大流量恶意频繁地去查询一条数据库中没有的记录，一直击穿缓存，势必会把database打死，如何避免缓存击穿，这就是一个问题了。</p>
<p>有两种方案，第一种，在缓存中添加空值，如果在database中查询无果，我们大可以把值设置为null，防止下次再次访问数据库，这样做简单便捷，但是多少有些浪费空间。</p>
<p>第二种方案，就是使用布隆过滤器（点题），在cache与web服务器中间加一层布隆过滤器，对访问的key做记录，如此以来，同样可以解决缓存击穿的问题。</p>
<h3 id="缓存雪崩问题"><a href="#缓存雪崩问题" class="headerlink" title="缓存雪崩问题"></a>缓存雪崩问题</h3><p>缓存雪崩发生于在某个时间点，缓存同时失效，例如缓存设置了失效时间，这会联动的导致大量缓存击穿问题。</p>
<p>加分布式锁是一种解决方案，只有拿到锁的请求才能访问database。但是这样治标不治本，当请求量过多时，大量的线程阻塞，也会把内存撑坏的。</p>
<p>预热数据，分散地设置失效时间，这样可以减少缓存雪崩发生的概率。</p>
<p>提高缓存可用性，cache的单点一样是会是缓存雪崩的隐患，大部分缓存中间件都提供高可用架构，如redis的主从+哨兵架构。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/07/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/jdk/JDK-%E7%BA%BF%E7%A8%8B%E4%B8%8D%E5%AE%89%E5%85%A8%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/07/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/jdk/JDK-%E7%BA%BF%E7%A8%8B%E4%B8%8D%E5%AE%89%E5%85%A8%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">JDK-线程不安全案例分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-04-07 09:07:02 / Modified: 12:49:46" itemprop="dateCreated datePublished" datetime="2021-04-07T09:07:02+08:00">2021-04-07</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="StringBuilder类线程不安全"><a href="#StringBuilder类线程不安全" class="headerlink" title="StringBuilder类线程不安全"></a>StringBuilder类线程不安全</h2><h3 id="不安全的使用"><a href="#不安全的使用" class="headerlink" title="不安全的使用"></a>不安全的使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Safe</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringBuilderDemo</span> </span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;  </span><br><span class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();  </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)&#123;  </span><br><span class="line">            <span class="keyword">new</span> Thread(()-&#123;</span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">1000</span>; j++)&#123;  </span><br><span class="line">                stringBuilder.append(<span class="string">&quot;a&quot;</span>);  </span><br><span class="line">              &#125;   </span><br><span class="line">            &#125;).start();  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        Thread.sleep(<span class="number">100</span>);  </span><br><span class="line">        System.out.println(stringBuilder.length());  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>我们看到输出了“9326”，小于预期的10000，并且还抛出了一个ArrayIndexOutOfBoundsException异常（异常不是必现）。</p>
<h3 id="从类结构入手分析"><a href="#从类结构入手分析" class="headerlink" title="从类结构入手分析"></a>从类结构入手分析</h3><p>StringBuilder和StringBuffer的内部实现跟String类一样，都是通过一个char数组存储字符串的，不同的是String类里面的char数组是final修饰的，是不可变的，而StringBuilder和StringBuffer的char数组是可变的。</p>
<h4 id="父类AbstractStringBuilder"><a href="#父类AbstractStringBuilder" class="headerlink" title="父类AbstractStringBuilder"></a>父类AbstractStringBuilder</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractStringBuilder</span> <span class="keyword">implements</span> <span class="title">Appendable</span>, <span class="title">CharSequence</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">char</span>[] value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> count;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> AbstractStringBuilder <span class="title">append</span><span class="params">(String str)</span> </span>&#123;  </span><br><span class="line">      <span class="keyword">if</span> (str == <span class="keyword">null</span>)  </span><br><span class="line">        <span class="keyword">return</span> appendNull();  </span><br><span class="line">      <span class="keyword">int</span> len = str.length();  </span><br><span class="line">      ensureCapacityInternal(count + len);  </span><br><span class="line">      str.getChars(<span class="number">0</span>, len, value, count);  </span><br><span class="line">      count += len;  </span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="返回结果小于预期的原因"><a href="#返回结果小于预期的原因" class="headerlink" title="返回结果小于预期的原因"></a>返回结果小于预期的原因</h4><p><font color="red">注意：count +=len不是一个原子操作！！！线程不安全，线程读取的是失效数据，属于“先读取，后更新”的错误</font></p>
<p>这就是为什么<a href="">“我们看到输出了“9326”，小于预期的10000”</a></p>
<h4 id="抛出异常原因"><a href="#抛出异常原因" class="headerlink" title="抛出异常原因"></a>抛出异常原因</h4><h5 id="ensureCapacityInternal-方法"><a href="#ensureCapacityInternal-方法" class="headerlink" title="ensureCapacityInternal()方法"></a>ensureCapacityInternal()方法</h5><p>检查StringBuilder对象的原char数组的容量是否充足，如果不充足调用expandCapacity()方法对char数组进行扩容。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureCapacityInternal</span><span class="params">(<span class="keyword">int</span> minimumCapacity)</span> </span>&#123;  </span><br><span class="line">        <span class="comment">// overflow-conscious code  </span></span><br><span class="line">    <span class="keyword">if</span> (minimumCapacity - value.length &gt; <span class="number">0</span>)  </span><br><span class="line">        expandCapacity(minimumCapacity);  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>扩容的逻辑就是new一个2倍容量的新char数组，再通过System.arryCopy()函数将原数组的内容复制到新数组，最后将指针指向新的char数组。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">expandCapacity</span><span class="params">(<span class="keyword">int</span> minimumCapacity)</span> </span>&#123;  </span><br><span class="line">    <span class="comment">//计算新的容量  </span></span><br><span class="line">    <span class="keyword">int</span> newCapacity = value.length * <span class="number">2</span> + <span class="number">2</span>;  </span><br><span class="line">    <span class="comment">//中间省略了一些检查逻辑  </span></span><br><span class="line">    ...  </span><br><span class="line">    value = Arrays.copyOf(value, newCapacity);  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>Arrys.copyOf()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">char</span>[] copyOf(<span class="keyword">char</span>[] original, <span class="keyword">int</span> newLength) &#123;  </span><br><span class="line">    <span class="keyword">char</span>[] copy = <span class="keyword">new</span> <span class="keyword">char</span>[newLength];  </span><br><span class="line">    <span class="comment">//拷贝数组  </span></span><br><span class="line">    System.arraycopy(original, <span class="number">0</span>, copy, <span class="number">0</span>, Math.min(original.length, newLength));  </span><br><span class="line">    <span class="keyword">return</span> copy;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<h5 id="str-getChars-方法"><a href="#str-getChars-方法" class="headerlink" title="str.getChars()方法"></a>str.getChars()方法</h5><p>是将String对象里面char数组里面的内容拷贝到StringBuilder对象的char数组里面，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">str.getChars(0, len, value, count);  </span><br></pre></td></tr></table></figure>

<p>getChars()方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getChars</span><span class="params">(<span class="keyword">int</span> srcBegin, <span class="keyword">int</span> srcEnd, <span class="keyword">char</span> dst[], <span class="keyword">int</span> dstBegin)</span> </span>&#123;  </span><br><span class="line">    <span class="comment">//中间省略了一些检查</span></span><br><span class="line">    ...     </span><br><span class="line">    System.arraycopy(value, srcBegin, dst, dstBegin, srcEnd - srcBegin);  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>拷贝流程见下图</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/eQPyBffYbueq8rlWFnejuWibbkDsLW8SfkgV2icp12NDicCaAd0xklug4S51nyQCLicn9Lo9KospQpaKTfxmgAzEmQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image"></p>
<p>假设现在有两个线程同时执行了StringBuilder的append()方法，两个线程都执行完了第五行的ensureCapacityInternal()方法，此刻count=5。</p>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eQPyBffYbueq8rlWFnejuWibbkDsLW8SfpC8jY6vIae2mn71v3LgR2nriavOj2aH8mueIibv2pRN3DbZ5zz6MrzOA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image" style="zoom:50%;" />

<p>这个时候线程1的cpu时间片用完了，线程2继续执行。线程2执行完整个append()方法后count变成6了</p>
<img src="https://mmbiz.qpic.cn/mmbiz_png/eQPyBffYbueq8rlWFnejuWibbkDsLW8Sfh5uSy474qdNlYw4GwotlRoAqgsPOgHAicYlLOPZLeXtdWvJtMUfp5VA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image" style="zoom:50%;" />

<p>线程1继续执行第六行的str.getChars()方法的时候拿到的count值就是6了，执行char数组拷贝的时候就会抛出ArrayIndexOutOfBoundsException异常。</p>
<h3 id="改造为线程安全"><a href="#改造为线程安全" class="headerlink" title="改造为线程安全"></a>改造为线程安全</h3><p>那么StringBuffer用什么手段保证线程安全的？StringBuffer的append()方法都使用synchronized关键词修饰了，阻塞其他线程。</p>
<h2 id="HashMap线程不安全"><a href="#HashMap线程不安全" class="headerlink" title="HashMap线程不安全"></a>HashMap线程不安全</h2><h3 id="不安全的使用-1"><a href="#不安全的使用-1" class="headerlink" title="不安全的使用"></a>不安全的使用</h3><h3 id="从类结构入手"><a href="#从类结构入手" class="headerlink" title="从类结构入手"></a>从类结构入手</h3><h4 id="resize方法扩容"><a href="#resize方法扩容" class="headerlink" title="resize方法扩容"></a>resize方法扩容</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">addEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;  </span><br><span class="line">Entry&lt;K,V&gt; e = table[bucketIndex];  </span><br><span class="line">       table[bucketIndex] = <span class="keyword">new</span> Entry&lt;K,V&gt;(hash, key, value, e);  </span><br><span class="line">       <span class="keyword">if</span> (size++ &gt;= threshold)  </span><br><span class="line">           resize(<span class="number">2</span> * table.length);  </span><br><span class="line">   &#125;  </span><br><span class="line">  </span><br><span class="line">   <span class="comment">/** </span></span><br><span class="line"><span class="comment">    * resize()方法如下，重要的是transfer方法，把旧表中的元素添加到新表中</span></span><br><span class="line"><span class="comment">    */</span>  </span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">resize</span><span class="params">(<span class="keyword">int</span> newCapacity)</span> </span>&#123;  </span><br><span class="line">       Entry[] oldTable = table;  </span><br><span class="line">       <span class="keyword">int</span> oldCapacity = oldTable.length;  </span><br><span class="line">       <span class="keyword">if</span> (oldCapacity == MAXIMUM_CAPACITY) &#123;  </span><br><span class="line">           threshold = Integer.MAX_VALUE;  </span><br><span class="line">           <span class="keyword">return</span>;  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       Entry[] newTable = <span class="keyword">new</span> Entry[newCapacity];  </span><br><span class="line">       transfer(newTable);  </span><br><span class="line">       table = newTable;  </span><br><span class="line">       threshold = (<span class="keyword">int</span>)(newCapacity * loadFactor);  </span><br><span class="line">   &#125;  </span><br></pre></td></tr></table></figure>

<h4 id="transfer方法复制"><a href="#transfer方法复制" class="headerlink" title="transfer方法复制"></a>transfer方法复制</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Entry[] newTable, <span class="keyword">boolean</span> rehash)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> newCapacity = newTable.length;</span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;K,V&gt; e : table) &#123;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">null</span> != e) &#123;</span><br><span class="line">                Entry&lt;K,V&gt; next = e.next;            ---------------------(<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">if</span> (rehash) &#123;</span><br><span class="line">                    e.hash = <span class="keyword">null</span> == e.key ? <span class="number">0</span> : hash(e.key);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">int</span> i = indexFor(e.hash, newCapacity); </span><br><span class="line">                e.next = newTable[i];</span><br><span class="line">                newTable[i] = e;</span><br><span class="line">                e = next;</span><br><span class="line">            &#125; <span class="comment">// while</span></span><br><span class="line"> </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h4 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Integer&gt; map &#x3D; new HashMap&lt;Integer&gt;(2); </span><br><span class="line">&#x2F;&#x2F; 只能放置两个元素，其中的threshold为1（表中只填充一个元素时），即插入元素为1时就扩容（由addEntry方法中得知）</span><br><span class="line">&#x2F;&#x2F;放置2个元素 3 和 7，若要再放置元素8（经hash映射后不等于1）时，会引起扩容*</span><br></pre></td></tr></table></figure>

<p>假设放置结果图如下：</p>
<img src="https://mmbiz.qpic.cn/mmbiz_png/JfTPiahTHJhpORt79k2Xjw9lfLfpaEMyayjAgqSwlIbWQmFWo49679E9eaIfbBA8XbB5lezKWHiapRm5ETKiarrEQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image" style="zoom: 50%;" />

<p>现在有两个线程A和B，都要执行put操作，即向表中添加元素，即线程A和线程B都会看到上面图的状态快照</p>
<h5 id="执行一："><a href="#执行一：" class="headerlink" title="执行一："></a>执行一：</h5><p> 线程A执行到transfer函数中（1）处挂起（transfer函数代码中有标注）。此时在线程A的栈中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">e &#x3D; 3</span><br><span class="line">next &#x3D; 7</span><br></pre></td></tr></table></figure>

<h5 id="执行二："><a href="#执行二：" class="headerlink" title="执行二："></a>执行二：</h5><p>线程B执行 transfer函数中的while循环，即会把原来的table变成另一个newtable（线程B自己的栈中），再写入到内存中。如下图（假设两个元素在新的hash函数下也会映射到同一个位置）</p>
<img src="https://mmbiz.qpic.cn/mmbiz_png/JfTPiahTHJhpORt79k2Xjw9lfLfpaEMyaeadia5Ot4Hdribw9G8hUicTmiaZ0crEiaAvT8qAsBChMib07rBYHvqJKFialw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image" style="zoom:50%;" />

<h5 id="执行三："><a href="#执行三：" class="headerlink" title="执行三："></a>执行三：</h5><p>线程A解挂，接着执行（看到的仍是旧表），即从transfer代码（1）处接着执行，当前的 e = 3, next = 7, 上面已经描述。</p>
<p>处理元素 3 ， 将 3 放入 线程A自己栈的newtable中（newtable是处于线程A自己栈中，是线程私有的，不被线程2的影响），处理3后的图如下：</p>
<img src="https://mmbiz.qpic.cn/mmbiz_png/JfTPiahTHJhpORt79k2Xjw9lfLfpaEMyakr99ePzoWDjVjPmPBRliawVx9iaUsRk701RpYOs7zN3B6YRLzNLVEXFA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image" style="zoom:50%;" />

<p>线程A再复制元素 7 ，当前 e = 7 ,而next值由于线程 B 修改了它的引用，所以next 为 3 ，处理后的新表如下图</p>
<img src="https://mmbiz.qpic.cn/mmbiz_png/JfTPiahTHJhpORt79k2Xjw9lfLfpaEMyaW5v0XSY8pQV1BWaQh64N4s6P0OKyRPIKp3GaHWvInicayqegp5qxCZQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image" style="zoom:50%;" />

<p>由于上面取到的next = 3, 接着while循环，即当前处理的结点为3， next就为null ，退出while循环，执行完while循环后，新表中的内容如下图：</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/JfTPiahTHJhpORt79k2Xjw9lfLfpaEMyaDc6BmPWluwcOWj88ZEAkkXIOFiaplMKYA8PRwWcbuxcqicmr9gm3d5Sw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image"></p>
<p>当操作完成，执行查找时，会陷入死循环！</p>
<h3 id="改造为线程安全-1"><a href="#改造为线程安全-1" class="headerlink" title="改造为线程安全"></a>改造为线程安全</h3><p>ConcurrentHashMap对于put()中的核心代码加了synchronize</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/07/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/%E5%85%B6%E4%BB%96%E5%B7%A5%E5%85%B7%E7%B1%BBjar%E5%8C%85/apache-csv-upload%E5%B9%B6%E8%AF%BB%E5%86%99csc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/07/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/%E5%85%B6%E4%BB%96%E5%B7%A5%E5%85%B7%E7%B1%BBjar%E5%8C%85/apache-csv-upload%E5%B9%B6%E8%AF%BB%E5%86%99csc/" class="post-title-link" itemprop="url">apache-poi-upload并读写xlsx等文件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-04-07 08:46:02" itemprop="dateCreated datePublished" datetime="2021-04-07T08:46:02+08:00">2021-04-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-04-12 11:36:44" itemprop="dateModified" datetime="2021-04-12T11:36:44+08:00">2021-04-12</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="spring-boot上传CSV文件"><a href="#spring-boot上传CSV文件" class="headerlink" title="spring boot上传CSV文件"></a>spring boot上传CSV文件</h2><h3 id="pom文件"><a href="#pom文件" class="headerlink" title="pom文件"></a>pom文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.apache.commons&lt;&#x2F;groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;commons-csv&lt;&#x2F;artifactId&gt;</span><br><span class="line">	&lt;version&gt;1.8&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Spring-boot上传xlsx文件"><a href="#Spring-boot上传xlsx文件" class="headerlink" title="Spring boot上传xlsx文件"></a>Spring boot上传xlsx文件</h2><h3 id="pom文件-1"><a href="#pom文件-1" class="headerlink" title="pom文件"></a>pom文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.apache.commons&lt;&#x2F;groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;commons-csv&lt;&#x2F;artifactId&gt;</span><br><span class="line">	&lt;version&gt;1.8&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="读写逻辑类"><a href="#读写逻辑类" class="headerlink" title="读写逻辑类"></a>读写逻辑类</h3><ul>
<li>如果想从指定line读取， CSVParser csvParser的构造方法可以传入lineNum参数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.csv.CSVFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.csv.CSVParser;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.csv.CSVRecord;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.bezkoder.spring.files.csv.model.Tutorial;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CSVHelper</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> String TYPE = <span class="string">&quot;text/csv&quot;</span>;</span><br><span class="line">  <span class="keyword">static</span> String[] HEADERs = &#123; <span class="string">&quot;Id&quot;</span>, <span class="string">&quot;Title&quot;</span>, <span class="string">&quot;Description&quot;</span>, <span class="string">&quot;Published&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">hasCSVFormat</span><span class="params">(MultipartFile file)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!TYPE.equals(file.getContentType())) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Tutorial&gt; <span class="title">csvToTutorials</span><span class="params">(InputStream is)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      BufferedReader fileReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(is, <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">        </span><br><span class="line">      CSVParser csvParser = <span class="keyword">new</span> CSVParser(fileReader, CSVFormat.DEFAULT.withFirstRecordAsHeader().withIgnoreHeaderCase().withTrim());</span><br><span class="line">    </span><br><span class="line">      List&lt;Tutorial&gt; tutorials = <span class="keyword">new</span> ArrayList&lt;Tutorial&gt;();</span><br><span class="line"></span><br><span class="line">      Iterable&lt;CSVRecord&gt; csvRecords = csvParser.getRecords();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (CSVRecord csvRecord : csvRecords) &#123;</span><br><span class="line">        Tutorial tutorial = <span class="keyword">new</span> Tutorial(</span><br><span class="line">              Long.parseLong(csvRecord.get(<span class="string">&quot;Id&quot;</span>)),</span><br><span class="line">              csvRecord.get(<span class="string">&quot;Title&quot;</span>),</span><br><span class="line">              csvRecord.get(<span class="string">&quot;Description&quot;</span>),</span><br><span class="line">              Boolean.parseBoolean(csvRecord.get(<span class="string">&quot;Published&quot;</span>))</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">        tutorials.add(tutorial);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> tutorials;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;fail to parse CSV file: &quot;</span> + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="MVC架构"><a href="#MVC架构" class="headerlink" title="MVC架构"></a>MVC架构</h2><h3 id="service类"><a href="#service类" class="headerlink" title="service类"></a>service类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CSVService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(MultipartFile file)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      List&lt;Tutorial&gt; tutorials = CSVHelper.csvToTutorials(file.getInputStream());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;fail to store csv data: &quot;</span> + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="上传csv文件"><a href="#上传csv文件" class="headerlink" title="上传csv文件"></a>上传csv文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/csv&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CSVController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  CSVService fileService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">uploadFile</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file)</span> </span>&#123;</span><br><span class="line">    String message = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (CSVHelper.hasCSVFormat(file)) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        fileService.save(file);</span><br><span class="line">        message = <span class="string">&quot;Uploaded the file successfully: &quot;</span> + file.getOriginalFilename();</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        message = <span class="string">&quot;Could not upload the file: &quot;</span> + file.getOriginalFilename() + <span class="string">&quot;!&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> message</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    message = <span class="string">&quot;Please upload a csv file!&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> message;</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/07/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/%E5%85%B6%E4%BB%96%E5%B7%A5%E5%85%B7%E7%B1%BBjar%E5%8C%85/apache-poi-upload%E5%B9%B6%E8%AF%BB%E5%86%99xlsx/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/07/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/%E5%85%B6%E4%BB%96%E5%B7%A5%E5%85%B7%E7%B1%BBjar%E5%8C%85/apache-poi-upload%E5%B9%B6%E8%AF%BB%E5%86%99xlsx/" class="post-title-link" itemprop="url">apache-poi-upload并读写xlsx等文件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-04-07 08:46:02" itemprop="dateCreated datePublished" datetime="2021-04-07T08:46:02+08:00">2021-04-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-04-12 11:42:14" itemprop="dateModified" datetime="2021-04-12T11:42:14+08:00">2021-04-12</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="spring-boot上传CSV文件"><a href="#spring-boot上传CSV文件" class="headerlink" title="spring boot上传CSV文件"></a>spring boot上传CSV文件</h2><h3 id="pom文件"><a href="#pom文件" class="headerlink" title="pom文件"></a>pom文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.apache.commons&lt;&#x2F;groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;commons-csv&lt;&#x2F;artifactId&gt;</span><br><span class="line">	&lt;version&gt;1.8&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Spring-boot上传xlsx文件"><a href="#Spring-boot上传xlsx文件" class="headerlink" title="Spring boot上传xlsx文件"></a>Spring boot上传xlsx文件</h2><h3 id="pom文件-1"><a href="#pom文件-1" class="headerlink" title="pom文件"></a>pom文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.apache.poi&lt;&#x2F;groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;poi-ooxml&lt;&#x2F;artifactId&gt;</span><br><span class="line">	&lt;version&gt;4.1.2&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="读写逻辑类"><a href="#读写逻辑类" class="headerlink" title="读写逻辑类"></a>读写逻辑类</h3><ul>
<li>如果想从指定line读取， Iterator<Row> rows可以循环Line次，把iterator指向Line</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Cell;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Row;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Sheet;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Workbook;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFWorkbook;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExcelHelper</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> String TYPE = <span class="string">&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;</span>;</span><br><span class="line">  <span class="keyword">static</span> String[] HEADERs = &#123; <span class="string">&quot;Id&quot;</span>, <span class="string">&quot;Title&quot;</span>, <span class="string">&quot;Description&quot;</span>, <span class="string">&quot;Published&quot;</span> &#125;;</span><br><span class="line">  <span class="keyword">static</span> String SHEET = <span class="string">&quot;Tutorials&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">hasExcelFormat</span><span class="params">(MultipartFile file)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!TYPE.equals(file.getContentType())) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Tutorial&gt; <span class="title">excelToTutorials</span><span class="params">(InputStream is)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Workbook workbook = <span class="keyword">new</span> XSSFWorkbook(is);</span><br><span class="line"></span><br><span class="line">      Sheet sheet = workbook.getSheet(SHEET);</span><br><span class="line">      Iterator&lt;Row&gt; rows = sheet.iterator();</span><br><span class="line"></span><br><span class="line">      List&lt;Tutorial&gt; tutorials = <span class="keyword">new</span> ArrayList&lt;Tutorial&gt;();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">int</span> rowNumber = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> (rows.hasNext()) &#123;</span><br><span class="line">        Row currentRow = rows.next();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// skip header</span></span><br><span class="line">        <span class="keyword">if</span> (rowNumber == <span class="number">0</span>) &#123;</span><br><span class="line">          rowNumber++;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Iterator&lt;Cell&gt; cellsInRow = currentRow.iterator();</span><br><span class="line"></span><br><span class="line">        Tutorial tutorial = <span class="keyword">new</span> Tutorial();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> cellIdx = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (cellsInRow.hasNext()) &#123;</span><br><span class="line">          Cell currentCell = cellsInRow.next();</span><br><span class="line"></span><br><span class="line">          <span class="comment">//最好用CellType进行判断</span></span><br><span class="line">          <span class="keyword">if</span>(MytempCell.getCellType() == CellType.CELL_TYPE_NUMERIC)</span><br><span class="line">           your code ...</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span>(MytempCell.getCellType() == CellType.CELL_TYPE_STRING)</span><br><span class="line">           your code ...</span><br><span class="line">            </span><br><span class="line">          <span class="comment">//类型转换，防止手机号读成其他格式</span></span><br><span class="line">          <span class="keyword">if</span>(cell.getCellType() != Cell.CELL_TYPE_STRING)&#123;</span><br><span class="line">              cell.setCellType(Cell.CELL_TYPE_STRING);</span><br><span class="line">          &#125;</span><br><span class="line">           </span><br><span class="line">          <span class="keyword">switch</span> (cellIdx) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">              tutorial.setId((<span class="keyword">long</span>) currentCell.getNumericCellValue());</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">              tutorial.setTitle(currentCell.getStringCellValue());</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          cellIdx++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        tutorials.add(tutorial);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      workbook.close();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> tutorials;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;fail to parse Excel file: &quot;</span> + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="MVC架构"><a href="#MVC架构" class="headerlink" title="MVC架构"></a>MVC架构</h2><h3 id="service类"><a href="#service类" class="headerlink" title="service类"></a>service类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExcelService</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  TutorialRepository repository;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(MultipartFile file)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      List&lt;Tutorial&gt; tutorials = ExcelHelper.excelToTutorials(file.getInputStream());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;fail to store excel data: &quot;</span> + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="上传xlsx文件"><a href="#上传xlsx文件" class="headerlink" title="上传xlsx文件"></a>上传xlsx文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/excel&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExcelController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  ExcelService fileService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">uploadFile</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file)</span> </span>&#123;</span><br><span class="line">    String message = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ExcelHelper.hasExcelFormat(file)) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        fileService.save(file);</span><br><span class="line"></span><br><span class="line">        message = <span class="string">&quot;Uploaded the file successfully: &quot;</span> + file.getOriginalFilename();</span><br><span class="line">        <span class="keyword">return</span> message</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        message = <span class="string">&quot;Could not upload the file: &quot;</span> + file.getOriginalFilename() + <span class="string">&quot;!&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> message</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    message = <span class="string">&quot;Please upload an excel file!&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> message;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/http/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E9%A1%B5%E9%9D%A2%E5%8F%98%E6%9B%B4%E6%8E%A8%E9%80%81-%E6%8F%90%E9%86%92%E7%B3%BB%E7%BB%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/03/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/http/%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E9%A1%B5%E9%9D%A2%E5%8F%98%E6%9B%B4%E6%8E%A8%E9%80%81-%E6%8F%90%E9%86%92%E7%B3%BB%E7%BB%9F/" class="post-title-link" itemprop="url">如何设计页面变更推送/提醒系统</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-04-03 16:26:07 / Modified: 16:27:09" itemprop="dateCreated datePublished" datetime="2021-04-03T16:26:07+08:00">2021-04-03</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>判断是否更新过，这个现实世界里是这么做的：<br>HTTP请求里面带一个header叫If-Modified-Since，如果内容没变化，正经服务器应该返回304</p>
<p><strong><code>If-Modified-Since</code></strong> 是一个条件式请求首部，服务器只在所请求的资源在给定的日期时间之后对内容进行过修改的情况下才会将资源返回，状态码为 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/200"><code>200</code></a> 。如果请求的资源从那时起未经修改，那么返回一个不带有消息主体的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/304"><code>304</code></a> 响应，而在 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Last-Modified"><code>Last-Modified</code></a> 首部中会带有上次修改时间。 不同于  <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/If-Unmodified-Since"><code>If-Unmodified-Since</code></a>, <code>If-Modified-Since</code> 只可以用在 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/GET"><code>GET</code></a> 或 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/HEAD"><code>HEAD</code></a> 请求中。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/02/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/springcloud/Ribbon%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5%E5%8F%8A%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/02/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/springcloud/Ribbon%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5%E5%8F%8A%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">Ribbon的负载均衡策略及原理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-04-02 12:50:59 / Modified: 13:01:38" itemprop="dateCreated datePublished" datetime="2021-04-02T12:50:59+08:00">2021-04-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="ILoadBalance-负载均衡器"><a href="#ILoadBalance-负载均衡器" class="headerlink" title="ILoadBalance 负载均衡器"></a>ILoadBalance 负载均衡器</h2><p><a href="">ribbon是一个为客户端提供负载均衡功能的服务(客户端从Eureka下载提供者列表，ribbo负责选择提供者)</a>，它内部提供了一个叫做ILoadBalance的接口代表负载均衡器的操作，比如有添加服务器操作、选择服务器操作、获取所有的服务器列表、获取可用的服务器列表等等。</p>
<h3 id="ILoadBalance的继承关系"><a href="#ILoadBalance的继承关系" class="headerlink" title="ILoadBalance的继承关系"></a>ILoadBalance的继承关系</h3><p><img src="https://mmbiz.qpic.cn/mmbiz_png/JfTPiahTHJhoejcjMf928HTQuV66ZKynjvROr20CAwaIlF6OydDt3vWUF5fEhRkDjztiazZmnJhOs0e2bIvrqjUw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image"></p>
<p>负载均衡器是从EurekaClient（EurekaClient的实现类为DiscoveryClient）获取服务信息，根据IRule去路由，并且根据IPing判断服务的可用性。</p>
<h3 id="从Eureka获取注册信息"><a href="#从Eureka获取注册信息" class="headerlink" title="从Eureka获取注册信息"></a>从Eureka获取注册信息</h3><p>负载均衡器多久一次去获取一次从Eureka Client获取注册信息呢？在BaseLoadBalancer类下，BaseLoadBalancer的构造函数，该构造函数开启了一个PingTask任务setupPingTask();，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public BaseLoadBalancer(String name, IRule rule, LoadBalancerStats stats,</span><br><span class="line">        IPing ping, IPingStrategy pingStrategy) &#123;</span><br><span class="line">    if (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(&quot;LoadBalancer:  initialized&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    this.name &#x3D; name;</span><br><span class="line">    this.ping &#x3D; ping;</span><br><span class="line">    this.pingStrategy &#x3D; pingStrategy;</span><br><span class="line">    setRule(rule);</span><br><span class="line">    setupPingTask();</span><br><span class="line">    lbStats &#x3D; stats;</span><br><span class="line">    init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>setupPingTask()的具体代码逻辑，它开启了ShutdownEnabledTimer执行PingTask任务，在默认情况下pingIntervalSeconds为10，即每10秒钟，向EurekaClient发送一次”ping”。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">void setupPingTask() &#123;</span><br><span class="line">      if (canSkipPing()) &#123;</span><br><span class="line">          return;</span><br><span class="line">      &#125;</span><br><span class="line">      if (lbTimer !&#x3D; null) &#123;</span><br><span class="line">          lbTimer.cancel();</span><br><span class="line">      &#125;</span><br><span class="line">      lbTimer &#x3D; new ShutdownEnabledTimer(&quot;NFLoadBalancer-PingTimer-&quot; + name,</span><br><span class="line">              true);</span><br><span class="line">      lbTimer.schedule(new PingTask(), 0, pingIntervalSeconds * 1000);</span><br><span class="line">      forceQuickPing();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>PingTask源码，即new一个Pinger对象，并执行runPinger()方法。</p>
<p>查看Pinger的runPinger()方法，最终根据 pingerStrategy.pingServers(ping, allServers)来获取服务的可用性，如果该返回结果，如之前相同，则不去向EurekaClient获取注册列表，如果不同则通知ServerStatusChangeListener或者changeListeners发生了改变，进行更新或者重新拉取。</p>
<p><strong>完整过程是：</strong></p>
<p>LoadBalancerClient（RibbonLoadBalancerClient是实现类）在初始化的时候（execute方法），会通过ILoadBalance（BaseLoadBalancer是实现类）向Eureka注册中心获取服务注册列表，并且每10s一次向EurekaClient发送“ping”，来判断服务的可用性，如果服务的可用性发生了改变或者服务数量和之前的不一致，则从注册中心更新或者重新拉取。LoadBalancerClient有了这些服务注册列表，就可以根据具体的IRule来进行负载均衡。</p>
<h2 id="IRule-路由"><a href="#IRule-路由" class="headerlink" title="IRule 路由"></a>IRule 路由</h2><p>IRule接口代表负载均衡策略：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public interface IRule&#123;</span><br><span class="line">    public Server choose(Object key);</span><br><span class="line">    public void setLoadBalancer(ILoadBalancer lb);</span><br><span class="line">    public ILoadBalancer getLoadBalancer();    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>IRule接口的实现类有以下几种：</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/JfTPiahTHJhoejcjMf928HTQuV66ZKynjNJYRSuCAy0WiaP8JEeIxtHQ2q7Ss7pbArUibIwMhcJMrBumqxVuWON9g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image"></p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/JfTPiahTHJhoejcjMf928HTQuV66ZKynjiagxZ2sFxP5m0JBhLJXJLdNY8hia1FtLSz7iaFLR7jqdm8RQSiamPHl2zA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image"></p>
<p>其中RandomRule表示随机策略、RoundRobinRule表示轮询策略、WeightedResponseTimeRule表示加权策略、BestAvailableRule表示请求数最少策略等等。</p>
<p>随机策略很简单，就是从服务器中随机选择一个服务器，RandomRule的实现代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">public Server choose(ILoadBalancer lb, Object key) &#123;</span><br><span class="line">    if (lb &#x3D;&#x3D; null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    Server server &#x3D; null;</span><br><span class="line"> </span><br><span class="line">    while (server &#x3D;&#x3D; null) &#123;</span><br><span class="line">        if (Thread.interrupted()) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;Server&gt; upList &#x3D; lb.getReachableServers();</span><br><span class="line">        List&lt;Server&gt; allList &#x3D; lb.getAllServers();</span><br><span class="line">        int serverCount &#x3D; allList.size();</span><br><span class="line">        if (serverCount &#x3D;&#x3D; 0) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        int index &#x3D; rand.nextInt(serverCount); &#x2F;&#x2F; 使用jdk内部的Random类随机获取索引值index</span><br><span class="line">        server &#x3D; upList.get(index); &#x2F;&#x2F; 得到服务器实例</span><br><span class="line"> </span><br><span class="line">        if (server &#x3D;&#x3D; null) &#123;</span><br><span class="line">            Thread.yield();</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        if (server.isAlive()) &#123;</span><br><span class="line">            return (server);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        server &#x3D; null;</span><br><span class="line">        Thread.yield();</span><br><span class="line">    &#125;</span><br><span class="line">    return server;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RoundRobinRule轮询策略表示每次都取下一个服务器，比如一共有5台服务器，第1次取第1台，第2次取第2台，第3次取第3台，以此类推：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">public Server choose(ILoadBalancer lb, Object key) &#123;</span><br><span class="line">    if (lb &#x3D;&#x3D; null) &#123;</span><br><span class="line">        log.warn(&quot;no load balancer&quot;);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    Server server &#x3D; null;</span><br><span class="line">    int count &#x3D; 0;</span><br><span class="line">    while (server &#x3D;&#x3D; null &amp;&amp; count++ &lt; 10) &#123;</span><br><span class="line">        List&lt;Server&gt; reachableServers &#x3D; lb.getReachableServers();</span><br><span class="line">        List&lt;Server&gt; allServers &#x3D; lb.getAllServers();</span><br><span class="line">        int upCount &#x3D; reachableServers.size();</span><br><span class="line">        int serverCount &#x3D; allServers.size();</span><br><span class="line"> </span><br><span class="line">        if ((upCount &#x3D;&#x3D; 0) || (serverCount &#x3D;&#x3D; 0)) &#123;</span><br><span class="line">            log.warn(&quot;No up servers available from load balancer: &quot; + lb);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        int nextServerIndex &#x3D; incrementAndGetModulo(serverCount);</span><br><span class="line">        server &#x3D; allServers.get(nextServerIndex);</span><br><span class="line"> </span><br><span class="line">        if (server &#x3D;&#x3D; null) &#123;</span><br><span class="line">            &#x2F;* Transient. *&#x2F;</span><br><span class="line">            Thread.yield();</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        if (server.isAlive() &amp;&amp; (server.isReadyToServe())) &#123;</span><br><span class="line">            return (server);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F; Next.</span><br><span class="line">        server &#x3D; null;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    if (count &gt;&#x3D; 10) &#123;</span><br><span class="line">        log.warn(&quot;No available alive servers after 10 tries from load balancer: &quot;</span><br><span class="line">                + lb);</span><br><span class="line">    &#125;</span><br><span class="line">    return server;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">&#x2F;**</span><br><span class="line"> * Inspired by the implementation of &#123;@link AtomicInteger#incrementAndGet()&#125;.</span><br><span class="line"> *</span><br><span class="line"> * @param modulo The modulo to bound the value of the counter.</span><br><span class="line"> * @return The next value.</span><br><span class="line"> *&#x2F;</span><br><span class="line">private int incrementAndGetModulo(int modulo) &#123;</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        int current &#x3D; nextServerCyclicCounter.get();</span><br><span class="line">        int next &#x3D; (current + 1) % modulo;</span><br><span class="line">        if (nextServerCyclicCounter.compareAndSet(current, next))</span><br><span class="line">            return next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WeightedResponseTimeRule继承了RoundRobinRule，开始的时候还没有权重列表，采用父类的轮询方式，有一个默认每30秒更新一次权重列表的定时任务，该定时任务会根据实例的响应时间来更新权重列表，choose方法做的事情就是，用一个(0,1)的随机double数乘以最大的权重得到randomWeight，然后遍历权重列表，找出第一个比randomWeight大的实例下标，然后返回该实例，代码略。</p>
<p>BestAvailableRule策略用来选取最少并发量请求的服务器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public Server choose(Object key) &#123;</span><br><span class="line">    if (loadBalancerStats &#x3D;&#x3D; null) &#123;</span><br><span class="line">        return super.choose(key);</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;Server&gt; serverList &#x3D; getLoadBalancer().getAllServers(); &#x2F;&#x2F; 获取所有的服务器列表</span><br><span class="line">    int minimalConcurrentConnections &#x3D; Integer.MAX_VALUE;</span><br><span class="line">    long currentTime &#x3D; System.currentTimeMillis();</span><br><span class="line">    Server chosen &#x3D; null;</span><br><span class="line">    for (Server server: serverList) &#123; &#x2F;&#x2F; 遍历每个服务器</span><br><span class="line">        ServerStats serverStats &#x3D; loadBalancerStats.getSingleServerStat(server); &#x2F;&#x2F; 获取各个服务器的状态</span><br><span class="line">        if (!serverStats.isCircuitBreakerTripped(currentTime)) &#123; &#x2F;&#x2F; 没有触发断路器的话继续执行</span><br><span class="line">            int concurrentConnections &#x3D; serverStats.getActiveRequestsCount(currentTime); &#x2F;&#x2F; 获取当前服务器的请求个数</span><br><span class="line">            if (concurrentConnections &lt; minimalConcurrentConnections) &#123; &#x2F;&#x2F; 比较各个服务器之间的请求数，然后选取请求数最少的服务器并放到chosen变量中</span><br><span class="line">                minimalConcurrentConnections &#x3D; concurrentConnections;</span><br><span class="line">                chosen &#x3D; server;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (chosen &#x3D;&#x3D; null) &#123; &#x2F;&#x2F; 如果没有选上，调用父类ClientConfigEnabledRoundRobinRule的choose方法，也就是使用RoundRobinRule轮询的方式进行负载均衡        </span><br><span class="line">        return super.choose(key);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return chosen;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="验证并使用"><a href="#验证并使用" class="headerlink" title="验证并使用"></a>验证并使用</h2><p>使用Ribbon提供的负载均衡策略很简单，只需以下几部：</p>
<p><strong>1、创建具有负载均衡功能的RestTemplate实例</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">@LoadBalanced</span><br><span class="line">RestTemplate restTemplate() &#123;</span><br><span class="line">    return new RestTemplate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用RestTemplate进行rest操作的时候，会自动使用负载均衡策略，它内部会在RestTemplate中加入LoadBalancerInterceptor这个拦截器，<!--可以看到，注解的实现就是通过拦截--> 这个拦截器的作用就是使用负载均衡。</p>
<p>默认情况下会采用轮询策略，如果希望采用其它策略，则指定IRule实现，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public IRule ribbonRule() &#123;</span><br><span class="line">    return new BestAvailableRule();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种方式对Feign也有效。</p>
<p>我们也可以参考ribbon，自己写一个负载均衡实现类。</p>
<p>可以通过下面方法获取负载均衡策略最终选择了哪个服务实例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Autowired</span><br><span class="line">LoadBalancerClient loadBalancerClient; </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;测试负载均衡最终选中哪个实例</span><br><span class="line">public String getChoosedService() &#123;</span><br><span class="line">    ServiceInstance serviceInstance &#x3D; loadBalancerClient.choose(&quot;USERINFO-SERVICE&quot;);</span><br><span class="line">    StringBuilder sb &#x3D; new StringBuilder();</span><br><span class="line">    sb.append(&quot;host: &quot;).append(serviceInstance.getHost()).append(&quot;, &quot;);</span><br><span class="line">    sb.append(&quot;port: &quot;).append(serviceInstance.getPort()).append(&quot;, &quot;);</span><br><span class="line">    sb.append(&quot;uri: &quot;).append(serviceInstance.getUri());</span><br><span class="line">    return sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/02/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/springboot/Springboot-03-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%9D%E5%A7%8B%E5%8C%96%E9%92%A9%E5%AD%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/02/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/springboot/Springboot-03-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%9D%E5%A7%8B%E5%8C%96%E9%92%A9%E5%AD%90/" class="post-title-link" itemprop="url">springboot初始化时添加钩子</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-04-02 08:42:51" itemprop="dateCreated datePublished" datetime="2021-04-02T08:42:51+08:00">2021-04-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-04-12 19:24:07" itemprop="dateModified" datetime="2021-04-12T19:24:07+08:00">2021-04-12</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>我们经常需要在容器启动的时候做一些钩子动作，比如注册消息消费者，监听配置等，今天就总结下<code>SpringBoot</code>留给开发者的7个启动扩展点。</p>
<h2 id="容器刷新完成扩展点"><a href="#容器刷新完成扩展点" class="headerlink" title="容器刷新完成扩展点"></a>容器刷新完成扩展点</h2><h3 id="监听容器刷新完成扩展点ApplicationListener-lt-ContextRefreshedEvent-gt"><a href="#监听容器刷新完成扩展点ApplicationListener-lt-ContextRefreshedEvent-gt" class="headerlink" title="监听容器刷新完成扩展点ApplicationListener&lt;ContextRefreshedEvent&gt;"></a>监听容器刷新完成扩展点<code>ApplicationListener&lt;ContextRefreshedEvent&gt;</code></h3><h4 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h4><p>熟悉<code>Spring</code>的同学一定知道，容器刷新成功意味着所有的<code>Bean</code>初始化已经完成，当容器刷新之后<code>Spring</code>将会调用容器内所有实现了<code>ApplicationListener&lt;ContextRefreshedEvent&gt;</code>的<code>Bean</code>的<code>onApplicationEvent</code>方法，应用程序可以以此达到监听容器初始化完成事件的目的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StartupApplicationListenerExample</span> <span class="keyword">implements</span> </span></span><br><span class="line"><span class="class">  <span class="title">ApplicationListener</span>&lt;<span class="title">ContextRefreshedEvent</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG </span><br><span class="line">      = Logger.getLogger(StartupApplicationListenerExample.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> counter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ContextRefreshedEvent event)</span> </span>&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;Increment counter&quot;</span>);</span><br><span class="line">        counter++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="易错的点"><a href="#易错的点" class="headerlink" title="易错的点"></a>易错的点</h4><p>这个扩展点用在<code>web</code>容器中的时候需要额外注意，在web 项目中（例如<code>spring mvc</code>），系统会存在两个容器，一个是<code>root application context</code>,另一个就是我们自己的<code>context</code>（作为<code>root application context</code>的子容器）。如果按照上面这种写法，就会造成<code>onApplicationEvent</code>方法被执行两次。解决此问题的方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StartupApplicationListenerExample</span> <span class="keyword">implements</span> </span></span><br><span class="line"><span class="class">  <span class="title">ApplicationListener</span>&lt;<span class="title">ContextRefreshedEvent</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG </span><br><span class="line">      = Logger.getLogger(StartupApplicationListenerExample.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> counter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ContextRefreshedEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (event.getApplicationContext().getParent() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// root application context 没有parent</span></span><br><span class="line">            LOG.info(<span class="string">&quot;Increment counter&quot;</span>);</span><br><span class="line">            counter++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="高阶玩法"><a href="#高阶玩法" class="headerlink" title="高阶玩法"></a>高阶玩法</h4><p>当然这个扩展还可以有更高阶的玩法：<strong>自定义事件</strong>，可以借助<code>Spring</code>以最小成本实现一个观察者模式：</p>
<ul>
<li>先自定义一个事件：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class NotifyEvent extends ApplicationEvent &#123;</span><br><span class="line">    private String email;</span><br><span class="line">    private String content;</span><br><span class="line">    public NotifyEvent(Object source) &#123;</span><br><span class="line">        super(source);</span><br><span class="line">    &#125;</span><br><span class="line">    public NotifyEvent(Object source, String email, String content) &#123;</span><br><span class="line">        super(source);</span><br><span class="line">        this.email &#x3D; email;</span><br><span class="line">        this.content &#x3D; content;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 省略getter&#x2F;setter方法</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>注册一个事件监听器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class NotifyListener implements ApplicationListener&lt;NotifyEvent&gt; &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onApplicationEvent(NotifyEvent event) &#123;</span><br><span class="line">        System.out.println(&quot;邮件地址：&quot; + event.getEmail());</span><br><span class="line">        System.out.println(&quot;邮件内容：&quot; + event.getContent());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>发布事件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@RunWith(SpringRunner.class)</span><br><span class="line">@SpringBootTest</span><br><span class="line">public class ListenerTest &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    private WebApplicationContext webApplicationContext;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testListener() &#123;</span><br><span class="line">        NotifyEvent event &#x3D; new NotifyEvent(&quot;object&quot;, &quot;abc@qq.com&quot;, &quot;This is the content&quot;);</span><br><span class="line">        webApplicationContext.publishEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>执行单元测试可以看到邮件的地址和内容都被打印出来了</li>
</ul>
<h3 id="SpringBoot的CommandLineRunner接口"><a href="#SpringBoot的CommandLineRunner接口" class="headerlink" title="SpringBoot的CommandLineRunner接口"></a><code>SpringBoot</code>的<code>CommandLineRunner</code>接口</h3><p>当容器上下文初始化完成之后，<code>SpringBoot</code>也会调用所有实现了<code>CommandLineRunner</code>接口的<code>run</code>方法，下面这段代码可起到和上文同样的作用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class CommandLineAppStartupRunner implements CommandLineRunner &#123;</span><br><span class="line">    private static final Logger LOG &#x3D;</span><br><span class="line">      LoggerFactory.getLogger(CommandLineAppStartupRunner.class);</span><br><span class="line"></span><br><span class="line">    public static int counter;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run(String...args) throws Exception &#123;</span><br><span class="line">        LOG.info(&quot;Increment counter&quot;);</span><br><span class="line">        counter++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于这个扩展点的使用有额外两点需要注意：</p>
<ul>
<li>多个实现了<code>CommandLineRunner</code>的<code>Bean</code>的执行顺序可以根据<code>Bean</code>上的<code>@Order</code>注解调整</li>
<li>其<code>run</code>方法可以接受从控制台输入的参数，跟<code>ApplicationListener&lt;ContextRefreshedEvent&gt;</code>这种扩展相比，更加灵活</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 从控制台输入参数示例</span><br><span class="line">java -jar CommandLineAppStartupRunner.jar abc abcd</span><br></pre></td></tr></table></figure>

<h3 id="SpringBoot的ApplicationRunner接口"><a href="#SpringBoot的ApplicationRunner接口" class="headerlink" title="SpringBoot的ApplicationRunner接口"></a><code>SpringBoot</code>的<code>ApplicationRunner</code>接口</h3><p>这个扩展和<code>SpringBoot</code>的<code>CommandLineRunner</code>接口的扩展类似，只不过接受的参数是一个<code>ApplicationArguments</code>类，对控制台输入的参数提供了更好的封装，以<code>--</code>开头的被视为带选项的参数，否则是普通的参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class AppStartupRunner implements ApplicationRunner &#123;</span><br><span class="line">    private static final Logger LOG &#x3D;</span><br><span class="line">      LoggerFactory.getLogger(AppStartupRunner.class);</span><br><span class="line"></span><br><span class="line">    public static int counter;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run(ApplicationArguments args) throws Exception &#123;</span><br><span class="line">        LOG.info(&quot;Application started with option names : &#123;&#125;&quot;, </span><br><span class="line">          args.getOptionNames());</span><br><span class="line">        LOG.info(&quot;Increment counter&quot;);</span><br><span class="line">        counter++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar CommandLineAppStartupRunner.jar abc abcd --autho&#x3D;mark verbose</span><br></pre></td></tr></table></figure>

<h2 id="Bean初始化完成扩展点"><a href="#Bean初始化完成扩展点" class="headerlink" title="Bean初始化完成扩展点"></a><code>Bean</code>初始化完成扩展点</h2><p>前面的内容总结了针对容器初始化的扩展点，在有些场景，比如监听消息的时候，我们希望<code>Bean</code>初始化完成之后立刻注册监听器，而不是等到整个容器刷新完成，<code>Spring</code>针对这种场景同样留足了扩展点：</p>
<h3 id="1、-PostConstruct注解"><a href="#1、-PostConstruct注解" class="headerlink" title="1、@PostConstruct注解"></a>1、<code>@PostConstruct</code>注解</h3><p><code>@PostConstruct</code>注解一般放在<code>Bean</code>的方法上，被<code>@PostConstruct</code>修饰的方法会在<code>Bean</code>初始化后马上调用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class PostConstructExampleBean &#123;</span><br><span class="line">    private static final Logger LOG </span><br><span class="line">      &#x3D; Logger.getLogger(PostConstructExampleBean.class);</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private Environment environment;</span><br><span class="line"></span><br><span class="line">    @PostConstruct</span><br><span class="line">    public void init() &#123;</span><br><span class="line">        LOG.info(Arrays.asList(environment.getDefaultProfiles()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2、-InitializingBean接口"><a href="#2、-InitializingBean接口" class="headerlink" title="2、 InitializingBean接口"></a>2、 <code>InitializingBean</code>接口</h3><p><code>InitializingBean</code>的用法基本上与<code>@PostConstruct</code>一致，只不过相应的<code>Bean</code>需要实现<code>afterPropertiesSet</code>方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class InitializingBeanExampleBean implements InitializingBean &#123;</span><br><span class="line"></span><br><span class="line">    private static final Logger LOG </span><br><span class="line">      &#x3D; Logger.getLogger(InitializingBeanExampleBean.class);</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private Environment environment;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void afterPropertiesSet() throws Exception &#123;</span><br><span class="line">        LOG.info(Arrays.asList(environment.getDefaultProfiles()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3、-Bean注解的初始化方法"><a href="#3、-Bean注解的初始化方法" class="headerlink" title="3、@Bean注解的初始化方法"></a>3、<code>@Bean</code>注解的初始化方法</h3><p>通过<code>@Bean</code>注入<code>Bean</code>的时候可以指定初始化方法：</p>
<p><strong><code>Bean</code>的定义</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class InitMethodExampleBean &#123;</span><br><span class="line"></span><br><span class="line">    private static final Logger LOG &#x3D; Logger.getLogger(InitMethodExampleBean.class);</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private Environment environment;</span><br><span class="line"></span><br><span class="line">    public void init() &#123;</span><br><span class="line">        LOG.info(Arrays.asList(environment.getDefaultProfiles()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>Bean</code>注入</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Bean(initMethod&#x3D;&quot;init&quot;)</span><br><span class="line">public InitMethodExampleBean initMethodExampleBean() &#123;</span><br><span class="line">    return new InitMethodExampleBean();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="通过构造函数注入"><a href="#通过构造函数注入" class="headerlink" title="通过构造函数注入"></a>通过构造函数注入</h3><p><code>Spring</code>也支持通过构造函数注入，我们可以把搞事情的代码写在构造函数中，同样能达到目的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Component </span><br><span class="line">public class LogicInConstructorExampleBean &#123;</span><br><span class="line"></span><br><span class="line">    private static final Logger LOG </span><br><span class="line">      &#x3D; Logger.getLogger(LogicInConstructorExampleBean.class);</span><br><span class="line"></span><br><span class="line">    private final Environment environment;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    public LogicInConstructorExampleBean(Environment environment) &#123;</span><br><span class="line">        this.environment &#x3D; environment;</span><br><span class="line">        LOG.info(Arrays.asList(environment.getDefaultProfiles()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="验证：Bean初始化完成扩展点执行顺序？"><a href="#验证：Bean初始化完成扩展点执行顺序？" class="headerlink" title="验证：Bean初始化完成扩展点执行顺序？"></a>验证：<code>Bean</code>初始化完成扩展点执行顺序？</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Scope(value = &quot;prototype&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AllStrategiesExampleBean</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG </span><br><span class="line">      = Logger.getLogger(AllStrategiesExampleBean.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AllStrategiesExampleBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;Constructor&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//与implements InitializingBean联合使用</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;InitializingBean&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postConstruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;PostConstruct&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;init-method&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实例化这个<code>Bean</code>后输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[main] INFO o.b.startup.AllStrategiesExampleBean - Constructor</span><br><span class="line">[main] INFO o.b.startup.AllStrategiesExampleBean - PostConstruct</span><br><span class="line">[main] INFO o.b.startup.AllStrategiesExampleBean - InitializingBean</span><br><span class="line">[main] INFO o.b.startup.AllStrategiesExampleBean - init-method</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/01/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/Distributed%20Streaming%20Platform/Kafka/%E7%94%B1kakfa%E5%BC%95%E6%B7%B1%E7%9A%84%E9%9B%B6copy%E6%8A%80%E6%9C%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/01/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/Distributed%20Streaming%20Platform/Kafka/%E7%94%B1kakfa%E5%BC%95%E6%B7%B1%E7%9A%84%E9%9B%B6copy%E6%8A%80%E6%9C%AF/" class="post-title-link" itemprop="url">由kakfa引深的零copy技术</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-04-01 12:36:24 / Modified: 12:49:01" itemprop="dateCreated datePublished" datetime="2021-04-01T12:36:24+08:00">2021-04-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="传统IO"><a href="#传统IO" class="headerlink" title="传统IO"></a>传统IO</h1><p>在开始谈零拷贝之前，首先要对传统的IO方式有一个概念。</p>
<p>基于传统的IO方式，底层实际上通过调用<code>read()</code>和<code>write()</code>来实现。</p>
<p>通过<code>read()</code>把数据从硬盘读取到内核缓冲区，再复制到用户缓冲区；然后再通过<code>write()</code>写入到<code>socket缓冲区</code>，最后写入网卡设备。</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/ibBMVuDfkZUnVmOVDTlSicmTLLZ82HtKeZxMVCAtvqB7vjPIJneciauiaqibxcMblRMQoDmgMWB1dEVuNI4URSIbKUA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image"></p>
<p>整个过程发生了<strong>4次用户态和内核态的上下文切换</strong>和<strong>4次拷贝</strong>，具体流程如下：</p>
<ol>
<li>用户进程通过<code>read()</code>方法向操作系统发起调用，此时上下文从用户态转向内核态</li>
<li>DMA控制器把数据从硬盘中拷贝到读缓冲区</li>
<li>CPU把读缓冲区数据拷贝到应用缓冲区，上下文从内核态转为用户态，<code>read()</code>返回</li>
<li>用户进程通过<code>write()</code>方法发起调用，上下文从用户态转为内核态</li>
<li>CPU将应用缓冲区中数据拷贝到socket缓冲区</li>
<li>DMA控制器把数据从socket缓冲区拷贝到网卡，上下文从内核态切换回用户态，<code>write()</code>返回</li>
</ol>
<p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/ibBMVuDfkZUnVmOVDTlSicmTLLZ82HtKeZxcm1fbqD965WCQRm9yiayVyMheVyRFHXo19M0pfeomCaH8O2OBicpicgA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image"></p>
<p>那么什么又是<strong>DMA</strong>拷贝呢？</p>
<p>因为对于一个IO操作而言，都是通过CPU发出对应的指令来完成，但是相比CPU来说，IO的速度太慢了，CPU有大量的时间处于等待IO的状态。因此就产生了DMA（Direct Memory Access）直接内存访问技术，本质上来说他就是一块主板上独立的芯片，通过它来进行内存和IO设备的数据传输，从而减少CPU的等待时间。</p>
<h1 id="零拷贝"><a href="#零拷贝" class="headerlink" title="零拷贝"></a>零拷贝</h1><blockquote>
<p>零拷贝技术是指计算机执行操作时，CPU不需要先将数据从某处内存复制到另一个特定区域，这种技术通常用于通过网络传输文件时节省CPU周期和内存带宽。</p>
</blockquote>
<p>那么对于零拷贝而言，并非真的是完全没有数据拷贝的过程，只不过是减少用户态和内核态的切换次数以及CPU拷贝的次数。</p>
<p>这里，仅仅有针对性的来谈谈几种常见的零拷贝技术。</p>
<h3 id="mmap-write"><a href="#mmap-write" class="headerlink" title="mmap+write"></a>mmap+write</h3><p>mmap+write简单来说就是使用<code>mmap</code>替换了read+write中的read操作，减少了一次CPU的拷贝。</p>
<p><code>mmap</code>主要实现方式是将读缓冲区的地址和用户缓冲区的地址进行映射，内核缓冲区和应用缓冲区共享，从而减少了从读缓冲区到用户缓冲区的一次CPU拷贝。</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/ibBMVuDfkZUnVmOVDTlSicmTLLZ82HtKeZ9veTtLOR5gXvOpfiaf5P2SS40KOOm3rKvAsdzRSnHOKVpia2iaeNdO8KA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image"></p>
<p>整个过程发生了<strong>4次用户态和内核态的上下文切换</strong>和<strong>3次拷贝</strong>，具体流程如下：</p>
<ol>
<li>用户进程通过<code>mmap()</code>方法向操作系统发起调用，上下文从用户态转向内核态</li>
<li>DMA控制器把数据从硬盘中拷贝到读缓冲区</li>
<li><strong>上下文从内核态转为用户态，mmap调用返回</strong></li>
<li>用户进程通过<code>write()</code>方法发起调用，上下文从用户态转为内核态</li>
<li><strong>CPU将读缓冲区中数据拷贝到socket缓冲区</strong></li>
<li>DMA控制器把数据从socket缓冲区拷贝到网卡，上下文从内核态切换回用户态，<code>write()</code>返回</li>
</ol>
<p><code>mmap</code>的方式节省了一次CPU拷贝，同时由于用户进程中的内存是虚拟的，只是映射到内核的读缓冲区，所以可以节省一半的内存空间，比较适合大文件的传输。</p>
<h3 id="sendfile"><a href="#sendfile" class="headerlink" title="sendfile"></a>sendfile</h3><p>相比<code>mmap</code>来说，<code>sendfile</code>同样减少了一次CPU拷贝，而且还减少了2次上下文切换。</p>
<p><code>sendfile</code>是Linux2.1内核版本后引入的一个系统调用函数，通过使用<code>sendfile</code>数据可以直接在内核空间进行传输，因此避免了用户空间和内核空间的拷贝，同时由于使用<code>sendfile</code>替代了<code>read+write</code>从而节省了一次系统调用，也就是2次上下文切换。</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/ibBMVuDfkZUnVmOVDTlSicmTLLZ82HtKeZibzJ5E3HGYYh1MYJp2Qog7fyXwYjXkqNKkDWO94rZMbAp2MOSPpUj1g/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image"></p>
<p>整个过程发生了<strong>2次用户态和内核态的上下文切换</strong>和<strong>3次拷贝</strong>，具体流程如下：</p>
<ol>
<li>用户进程通过<code>sendfile()</code>方法向操作系统发起调用，上下文从用户态转向内核态</li>
<li>DMA控制器把数据从硬盘中拷贝到读缓冲区</li>
<li>CPU将读缓冲区中数据拷贝到socket缓冲区</li>
<li>DMA控制器把数据从socket缓冲区拷贝到网卡，上下文从内核态切换回用户态，<code>sendfile</code>调用返回</li>
</ol>
<p><code>sendfile</code>方法IO数据对用户空间完全不可见，所以只能适用于完全不需要用户空间处理的情况，比如静态文件服务器。</p>
<h3 id="sendfile-DMA-Scatter-Gather"><a href="#sendfile-DMA-Scatter-Gather" class="headerlink" title="sendfile+DMA Scatter/Gather"></a>sendfile+DMA Scatter/Gather</h3><p>Linux2.4内核版本之后对<code>sendfile</code>做了进一步优化，通过引入新的硬件支持，这个方式叫做DMA Scatter/Gather 分散/收集功能。</p>
<p>它将读缓冲区中的数据描述信息–内存地址和偏移量记录到socket缓冲区，由 DMA 根据这些将数据从读缓冲区拷贝到网卡，相比之前版本减少了一次CPU拷贝的过程</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/ibBMVuDfkZUnVmOVDTlSicmTLLZ82HtKeZmMb5P3kcAF4oa244rgSpks8tSLKicDE5U0v7Kice2aLxQUUm1dCyCvxg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image"></p>
<p>整个过程发生了<strong>2次用户态和内核态的上下文切换</strong>和<strong>2次拷贝</strong>，其中更重要的是完全没有CPU拷贝，具体流程如下：</p>
<ol>
<li>用户进程通过<code>sendfile()</code>方法向操作系统发起调用，上下文从用户态转向内核态</li>
<li>DMA控制器利用scatter把数据从硬盘中拷贝到读缓冲区离散存储</li>
<li>CPU把读缓冲区中的文件描述符和数据长度发送到socket缓冲区</li>
<li>DMA控制器根据文件描述符和数据长度，使用scatter/gather把数据从内核缓冲区拷贝到网卡</li>
<li><code>sendfile()</code>调用返回，上下文从内核态切换回用户态</li>
</ol>
<p><code>DMA gather</code>和<code>sendfile</code>一样数据对用户空间不可见，而且需要硬件支持，同时输入文件描述符只能是文件，但是过程中完全没有CPU拷贝过程，极大提升了性能。</p>
<h1 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h1><p>对于文章开头说的两个场景：RocketMQ和Kafka都使用到了零拷贝的技术。</p>
<p>对于MQ而言，无非就是生产者发送数据到MQ然后持久化到磁盘，之后消费者从MQ读取数据。</p>
<p>对于RocketMQ来说这两个步骤使用的是<code>mmap+write</code>，而Kafka则是使用<code>mmap+write</code>持久化数据，发送数据使用<code>sendfile</code>。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>由于CPU和IO速度的差异问题，产生了DMA技术，通过DMA搬运来减少CPU的等待时间。</p>
<p>传统的IO<code>read+write</code>方式会产生2次DMA拷贝+2次CPU拷贝，同时有4次上下文切换。</p>
<p>而通过<code>mmap+write</code>方式则产生2次DMA拷贝+1次CPU拷贝，4次上下文切换，通过内存映射减少了一次CPU拷贝，可以减少内存使用，适合大文件的传输。</p>
<p><code>sendfile</code>方式是新增的一个系统调用函数，产生2次DMA拷贝+1次CPU拷贝，但是只有2次上下文切换。因为只有一次调用，减少了上下文的切换，但是用户空间对IO数据不可见，适用于静态文件服务器。</p>
<p><code>sendfile+DMA gather</code>方式产生2次DMA拷贝，没有CPU拷贝，而且也只有2次上下文切换。虽然极大地提升了性能，但是需要依赖新的硬件设备支持。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/01/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/jdk/JDK-%E6%97%B6%E9%97%B4%E6%97%A5%E6%9C%9F%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/01/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/jdk/JDK-%E6%97%B6%E9%97%B4%E6%97%A5%E6%9C%9F%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">jdk时间日期常用命令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-04-01 12:17:47" itemprop="dateCreated datePublished" datetime="2021-04-01T12:17:47+08:00">2021-04-01</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-04-15 20:21:31" itemprop="dateModified" datetime="2021-04-15T20:21:31+08:00">2021-04-15</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="JAVA"><a href="#JAVA" class="headerlink" title="JAVA"></a>JAVA</h1><h2 id="获取当前时间"><a href="#获取当前时间" class="headerlink" title="获取当前时间"></a>获取当前时间</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">   SimpleDateFormat formatter= <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">Date date = <span class="keyword">new</span> Date(System.currentTimeMillis());</span><br><span class="line">&#125; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="时间加减"><a href="#时间加减" class="headerlink" title="时间加减"></a>时间加减</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addDays</span><span class="params">(Date d, <span class="keyword">int</span> days)</span></span>&#123;</span><br><span class="line">    Calendar c = Calendar.getInstance();</span><br><span class="line">    c.setTime(d);</span><br><span class="line">    c.add(Calendar.DATE, days);</span><br><span class="line">    d.setTime( c.getTime().getTime() );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="时间比较"><a href="#时间比较" class="headerlink" title="时间比较"></a>时间比较</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Date d1 = sdformat.parse(<span class="string">&quot;2019-04-15&quot;</span>);</span><br><span class="line">   Date d2 = sdformat.parse(<span class="string">&quot;2019-08-10&quot;</span>);</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">if</span>(d1.compareTo(d2) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;Date 1 occurs after Date 2&quot;</span>);</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span>(d1.compareTo(d2) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;Date 1 occurs before Date 2&quot;</span>);</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span>(d1.compareTo(d2) == <span class="number">0</span>) &#123;</span><br><span class="line">      System.out.println(<span class="string">&quot;Both dates are equal&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h2 id="string与java-util-Date互转"><a href="#string与java-util-Date互转" class="headerlink" title="string与java.util.Date互转"></a>string与java.util.Date互转</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;string-&gt;date	</span><br><span class="line">	public static void testStringConvertToDate()&#123;</span><br><span class="line">        String stringDate &#x3D; &quot;2008-10-05&quot;;</span><br><span class="line">        &#x2F;*yyyy-MM-dd格式一定要与stringDate的格式一致*&#x2F;</span><br><span class="line">        SimpleDateFormat sdf &#x3D; new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span><br><span class="line">        try &#123;</span><br><span class="line">            Date date &#x3D; sdf.parse(stringDate);</span><br><span class="line">        &#125; catch (ParseException e) &#123;           </span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;date-&gt;string    </span><br><span class="line">   public static void testDateConvertToString()&#123;</span><br><span class="line">        Date date &#x3D; new Date();</span><br><span class="line">        SimpleDateFormat sdf &#x3D; new SimpleDateFormat(&quot;yyyy年MM月dd日&quot;);</span><br><span class="line">        String stringDate &#x3D; sdf.format(date);</span><br><span class="line">   &#125;</span><br><span class="line">    </span><br><span class="line">&#x2F;&#x2F;将给定的日期格式的字符串转化为想要的格式字符串显示，中间通过Date类型转换</span><br><span class="line">    public static void stringToString()&#123;</span><br><span class="line"></span><br><span class="line">        String stringDate &#x3D; &quot;2008年10月01日10时50分&quot;;</span><br><span class="line"></span><br><span class="line">        SimpleDateFormat sdf1 &#x3D; new SimpleDateFormat(&quot;yyyy年MM月dd日&quot;);</span><br><span class="line">        SimpleDateFormat sdf2 &#x3D; new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span><br><span class="line">        Date date &#x3D; null;</span><br><span class="line">        String stringDate2 &#x3D; null;</span><br><span class="line">        try &#123;</span><br><span class="line">            date &#x3D; sdf1.parse(stringDate);</span><br><span class="line">            stringDate2 &#x3D; sdf2.format(date);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="timestamp与java-util-Date互转"><a href="#timestamp与java-util-Date互转" class="headerlink" title="timestamp与java.util.Date互转"></a>timestamp与java.util.Date互转</h2><h2 id="milliseconds与java-util-Date互转"><a href="#milliseconds与java-util-Date互转" class="headerlink" title="milliseconds与java.util.Date互转"></a>milliseconds与java.util.Date互转</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String myDate &#x3D; &quot;2014&#x2F;10&#x2F;29 18:10:45&quot;;</span><br><span class="line">SimpleDateFormat sdf &#x3D; new SimpleDateFormat(&quot;yyyy&#x2F;MM&#x2F;dd HH:mm:ss&quot;);</span><br><span class="line">Date date &#x3D; sdf.parse(myDate);</span><br><span class="line">long millis &#x3D; date.getTime();</span><br></pre></td></tr></table></figure>



<h2 id="string与java-sql-Date互转"><a href="#string与java-sql-Date互转" class="headerlink" title="string与java.sql.Date互转"></a>string与java.sql.Date互转</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.sql.date.formate(String date)</span><br></pre></td></tr></table></figure>









<h1 id="MYSQL"><a href="#MYSQL" class="headerlink" title="MYSQL"></a>MYSQL</h1><h2 id="MySQL-int-10-时间戳转日期"><a href="#MySQL-int-10-时间戳转日期" class="headerlink" title="MySQL int(10)时间戳转日期"></a>MySQL int(10)时间戳转日期</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;</span><br><span class="line">mysql&gt; SELECT FROM_UNIXTIME(1255033470);</span><br><span class="line">+---------------------------+</span><br><span class="line">| FROM_UNIXTIME(1255033470) |</span><br><span class="line">+---------------------------+</span><br><span class="line">| 2009-10-08 13:24:30       | </span><br><span class="line">+---------------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure>



<h2 id="MYSQL比较日期"><a href="#MYSQL比较日期" class="headerlink" title="MYSQL比较日期"></a>MYSQL比较日期</h2><p>DATE_FORMAT入参必须是date类型，不能是字符串类型；比较的对象是字符串</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DATE_FORMAT(datetime类型&#x2F;date类型,&quot;%Y-%m-%d&quot;) &lt;&#x3D; &quot;2021-04-31&quot;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/01/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/jdk/JDK-JUC-CAS%E4%B8%8E%E8%87%AA%E6%97%8B%E9%94%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/01/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/jdk/JDK-JUC-CAS%E4%B8%8E%E8%87%AA%E6%97%8B%E9%94%81/" class="post-title-link" itemprop="url">JDK-juc-CAS与自旋锁</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-04-01 09:21:03" itemprop="dateCreated datePublished" datetime="2021-04-01T09:21:03+08:00">2021-04-01</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-04-14 12:51:34" itemprop="dateModified" datetime="2021-04-14T12:51:34+08:00">2021-04-14</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="C-A-S基本概念"><a href="#C-A-S基本概念" class="headerlink" title="C A S基本概念"></a>C A S基本概念</h1><p><code>C A S（compareAndSwap）</code>也叫比较交换，是一种无锁原子算法，映射到操作系统就是一条<code>cmpxchg</code>硬件汇编指令（<strong>保证原子性</strong>），其作用是让<code>C P U</code>将内存值更新为新值，但是有个条件，内存值必须与期望值相同，并且<code>C A S</code>操作无需用户态与内核态切换，直接在用户态对内存进行读写操作（<strong>意味着不会阻塞/线程上下文切换</strong>）。</p>
<p>它包含<code>3</code>个参数<code>C A S（V，E，N）</code>，<code>V</code>表示待更新的内存值，<code>E</code>表示预期值，<code>N</code>表示新值，当 <code>V</code>值等于<code>E</code>值时，才会将<code>V</code>值更新成<code>N</code>值，如果<code>V</code>值和<code>E</code>值不等，不做更新，这就是一次<code>C A S</code>的操作。</p>
<img src="https://mmbiz.qpic.cn/mmbiz_png/23OQmC1ia8ny1VNcSscicjAax5qNibFxqiabHujbJoOdS8SRxegxFTHuoKHLwjkVahNbPibZP6rhYkYtuX8RQkK2Cbw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image" style="zoom:50%;" />

<p>简单说，<code>C A S</code>需要你额外给出一个期望值，也就是你认为这个变量现在应该是什么样子的，如果变量不是你想象的那样，说明它已经被别人修改过了，你只需要重新读取，设置新期望值，再次尝试修改就好了。</p>
<h1 id="C-A-S如何保证原子性"><a href="#C-A-S如何保证原子性" class="headerlink" title="C A S如何保证原子性"></a>C A S如何保证原子性</h1><p>原子性是指一个或者多个操作在<code>C P U</code>执行的过程中不被中断的特性，要么执行，要不执行，不能执行到一半（<strong>不可被中断的一个或一系列操作</strong>）。</p>
<p>为了保证<code>C A S</code>的原子性，<code>C P U</code>提供了下面两种方式</p>
<ul>
<li><strong>总线锁定</strong></li>
<li><strong>缓存锁定</strong></li>
</ul>
<h2 id="总线锁定"><a href="#总线锁定" class="headerlink" title="总线锁定"></a>总线锁定</h2><p>总线（<code>B U S</code>）是计算机组件间的传输数据方式，也就是说<code>C P U</code>与其他组件连接传输数据，就是靠总线完成的，比如<code>C P U</code>对内存的读写。</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/23OQmC1ia8ny1VNcSscicjAax5qNibFxqiab1UEcNV0VfpBkR7icdiazr27wBlcCa8QaMvdHoDWuZTe3HqaLHAiaB3cXQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image"></p>
<p><strong>总线锁定</strong>是指<code>C P U</code>使用了总线锁，所谓总线锁就是使用<code>C P U</code>提供的<code>LOCK#</code>信号，当<code>C P U</code>在总线上输出<code>LOCK#</code>信号时，其他<code>C P U</code>的总线请求将被阻塞。</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/23OQmC1ia8ny1VNcSscicjAax5qNibFxqiab183RLQ5wiaWzgiaiblQpR7JQP0HHdZxzHlXJgcrhB5VZXSFqBnYNblfsg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image"></p>
<h2 id="缓存锁定"><a href="#缓存锁定" class="headerlink" title="缓存锁定"></a>缓存锁定</h2><p>总线锁定方式虽然保证了原子性，但是在锁定期间，会导致大量阻塞，增加系统的性能开销，所以现代<code>C P U</code>为了提升性能，通过锁定范围缩小的思想设计出了缓存行锁定（<strong>缓存行是<code>C P U</code>高速缓存存储的最小单位</strong>）。</p>
<p>所谓<strong>缓存锁定</strong>是指<code>C P U</code>对<strong>缓存行</strong>进行锁定，当缓存行中的共享变量回写到内存时，其他<code>C P U</code>会通过总线嗅探机制感知该共享变量是否发生变化，如果发生变化，让自己对应的共享变量缓存行失效，重新从内存读取最新的数据，缓存锁定是基于缓存一致性机制来实现的，因为缓存一致性机制会阻止两个以上<code>C P U</code>同时修改同一个共享变量（<strong>现代<code>C P U</code>基本都支持和使用缓存锁定机制</strong>）。</p>
<h1 id="C-A-S的问题"><a href="#C-A-S的问题" class="headerlink" title="C A S的问题"></a>C A S的问题</h1><p><code>C A S</code>和锁都解决了原子性问题，和锁相比没有阻塞、线程上下文你切换、死锁，所以<code>C A S</code>要比锁拥有更优越的性能，但是<code>C A S</code>同样存在缺点。</p>
<p><code>C A S</code>的问题如下</p>
<ul>
<li><strong>只能保证一个共享变量的原子操作</strong></li>
<li><strong>自旋时间太长（建立在自旋锁的基础上）</strong></li>
<li><strong><code>ABA</code>问题</strong></li>
</ul>
<h2 id="只能保证一个共享变量原子操作"><a href="#只能保证一个共享变量原子操作" class="headerlink" title="只能保证一个共享变量原子操作"></a>只能保证一个共享变量原子操作</h2><p><code>C A S</code>只能针对一个共享变量使用，如果多个共享变量就只能使用锁了，当然如果你有办法把多个变量整成一个变量，利用<code>C A S</code>也不错，例如读写锁中<code>state</code>的高低位。</p>
<h2 id="ABA问题"><a href="#ABA问题" class="headerlink" title="ABA问题"></a>ABA问题</h2><p><code>C A S</code>需要检查待更新的内存值有没有被修改，如果没有则更新，但是存在这样一种情况，如果一个值原来是<code>A</code>，变成了<code>B</code>，然后又变成了<code>A</code>，在<code>C A S</code>检查的时候会发现没有被修改。</p>
<p>假设有两个线程，线程<code>1</code>读取到内存值<code>A</code>，线程<code>1</code>时间片用完，切换到线程<code>2</code>，线程<code>2</code>也读取到了内存值<code>A</code>，并把它修改为<code>B</code>值，然后再把<code>B</code>值还原到<code>A</code>值，简单说，修改次序是<code>A-&gt;B-&gt;A</code>，接着线程<code>1</code>恢复运行，它发现内存值还是<code>A</code>，然后执行<code>C A S</code>操作，这就是著名的<code>ABA</code>问题，但是好像又看不出什么问题。</p>
<p>只是简单的数据结构，确实不会有什么问题，如果是复杂的数据结构可能就会有问题了（<strong>使用<code>AtomicReference</code>可以把<code>C A S</code>使用在对象上</strong>），以链表数据结构为例，两个线程通过<code>C A S</code>去删除头节点，假设现在链表有<code>A-&gt;B</code>节点</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/23OQmC1ia8ny1VNcSscicjAax5qNibFxqiabJLQZYt6OMXoBHbMIlLoNjgVt85LZlT0FGAoWB09ScvI5KITMSr9qxg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image"></p>
<ul>
<li>线程<code>1</code>删除<code>A</code>节点，<code>B</code>节点成为头节点，正要执行<code>C A S(A,A,B)</code>时，时间片用完，切换到线程<code>2</code></li>
<li>线程<code>2</code>删除<code>A、B</code>节点</li>
<li>线程<code>2</code>加入<code>C、A</code>节点，链表节点变成<code>A-&gt;C</code></li>
<li>线程<code>1</code>重新获取时间片，执行<code>C A S(A,A,B)</code></li>
<li>丢失<code>C</code>节点</li>
</ul>
<p>要解决<code>A B A</code>问题也非常简单，只要追加版本号即可，每次改变时加<code>1</code>，即<code>A —&gt; B —&gt; A</code>，变成<code>1A —&gt; 2B —&gt; 3A</code>，在<code>Java</code>中提供了<code>AtomicStampedRdference</code>可以实现这个方案</p>
<h1 id="自旋锁"><a href="#自旋锁" class="headerlink" title="自旋锁"></a>自旋锁</h1><h2 id="CAS自旋时间太长"><a href="#CAS自旋时间太长" class="headerlink" title="CAS自旋时间太长"></a>CAS自旋时间太长</h2><p>当一个线程获取锁时失败，不进行阻塞挂起，而是间隔一段时间再次尝试获取，直到成功为止，这种循环获取的机制被称为自旋锁(<strong><code>spinlock</code></strong>)。</p>
<p>自旋锁好处是，持有锁的线程在短时间内释放锁，那些等待竞争锁的线程就不需进入阻塞状态（<strong>无需线程上下文切换/无需用户态与内核态切换</strong>），它们只需要等一等（<strong>自旋</strong>），等到持有锁的线程释放锁之后即可获取，这样就避免了用户态和内核态的切换消耗。</p>
<p>自旋锁坏处显而易见，线程在长时间内持有锁，等待竞争锁的线程一直自旋，即CPU一直空转，资源浪费在毫无意义的地方，所以一般会限制自旋次数。</p>
<h2 id="自旋锁基于CAS实现"><a href="#自旋锁基于CAS实现" class="headerlink" title="自旋锁基于CAS实现"></a>自旋锁基于CAS实现</h2><p>最后来说自旋锁的实现，实现自旋锁可以基于<code>C A S</code>实现，先定义<code>lockValue</code>对象默认值<code>1</code>，<code>1</code>代表锁资源空闲，<code>0</code>代表锁资源被占用，代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpinLock</span> </span>&#123;   </span><br><span class="line">    <span class="comment">//lockValue 默认值1</span></span><br><span class="line">    <span class="keyword">private</span> AtomicInteger lockValue = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//自旋获取锁</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 循环检测尝试获取锁</span></span><br><span class="line">        <span class="keyword">while</span> (!tryLock())&#123;</span><br><span class="line">            <span class="comment">// 空转</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取锁</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 期望值1，更新值0，更新成功返回true，更新失败返回false</span></span><br><span class="line">        <span class="keyword">return</span> lockValue.compareAndSet(<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//释放锁</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unLock</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!lockValue.compareAndSet(<span class="number">0</span>,<span class="number">1</span>))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;释放锁失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面定义了<code>AtomicInteger</code>类型的<code>lockValue</code>变量，<code>AtomicInteger</code>是<code>Java</code>基于<code>C A S</code>实现的<code>Integer</code>原子操作类，还定义了3个函数<code>lock、tryLock、unLock</code></p>
<p>tryLock函数-获取锁</p>
<ul>
<li><strong>期望值1，更新值0</strong></li>
<li><strong><code>C A S</code>更新</strong></li>
<li><strong>如果期望值与<code>lockValue</code>值相等，则<code>lockValue</code>值更新为<code>0</code>，返回<code>true</code>，否则执行下面逻辑</strong></li>
<li><strong>如果期望值与<code>lockValue</code>值不相等，不做任何更新，返回<code>false</code></strong></li>
</ul>
<p>unLock函数-释放锁</p>
<ul>
<li><strong>期望值<code>0</code>，更新值<code>1</code></strong></li>
<li><strong><code>C A S</code>更新</strong></li>
<li><strong>如果期望值与<code>lockValue</code>值相等，则<code>lockValue</code>值更新为<code>1</code>，返回<code>true</code>，否则执行下面逻辑</strong></li>
<li><strong>如果期望值与<code>lockValue</code>值不相等，不做任何更新，返回<code>false</code></strong></li>
</ul>
<p>lock函数-自旋获取锁</p>
<ul>
<li><strong>执行<code>tryLock</code>函数，返回<code>true</code>停止，否则一直循环</strong></li>
</ul>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/23OQmC1ia8ny1VNcSscicjAax5qNibFxqiabQHKscYW1MI87ic7kFeJjDqKWIqRl72I4nPTwJ8OBaUBz7L0sN4FFBqA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image"></p>
<p>从上图可以看出，只有<code>tryLock</code>成功的线程（<strong>把<code>lockValue</code>更新为<code>0</code>**），才会执行代码块，其他线程个<code>tryLock</code>自旋等待<code>lockValue</code>被更新成<code>1</code>，<code>tryLock</code>成功的线程执行<code>unLock</code>（</strong>把<code>lockValue</code>更新为<code>1</code>**），自旋的线程才会<code>tryLock</code>成功。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Fei Qi</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  


















  








  

  

</body>
</html>
