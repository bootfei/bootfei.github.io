<!DOCTYPE html>
<html lang="en,cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Mist","version":"8.0.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>

  <meta name="description" content="learn more, forget more; practice more, get more.">
<meta property="og:type" content="website">
<meta property="og:title" content="BootFei&#39;s Blog">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="BootFei&#39;s Blog">
<meta property="og:description" content="learn more, forget more; practice more, get more.">
<meta property="og:locale">
<meta property="article:author" content="Fei Qi">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/2/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en,cn'
  };
</script>

  <title>BootFei's Blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">BootFei's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">敬畏耶和华是智慧的开端，认识至圣者就是聪明</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Fei Qi</p>
  <div class="site-description" itemprop="description">learn more, forget more; practice more, get more.</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">177</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">
      

      
    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/05/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/Java%E8%B0%83%E4%BC%98%E5%92%8C%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7/%E8%A7%A3%E5%86%B3Jar%E5%8C%85%E4%BE%9D%E8%B5%96%E5%86%B2%E7%AA%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/05/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/Java%E8%B0%83%E4%BC%98%E5%92%8C%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7/%E8%A7%A3%E5%86%B3Jar%E5%8C%85%E4%BE%9D%E8%B5%96%E5%86%B2%E7%AA%81/" class="post-title-link" itemprop="url">解决Jar包依赖冲突</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-05-05 19:10:53 / Modified: 19:20:32" itemprop="dateCreated datePublished" datetime="2021-05-05T19:10:53+08:00">2021-05-05</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://www.sevenyuan.cn/">https://www.sevenyuan.cn/</a></p>
<h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>应用从 jdk7 升级到 jdk8，终于可以用上新特性的语法进行代码编写，通过几轮开发、测试和验证后，在上预发环境时，应用突然无法启动，查看 tomcat 报错原因，发现是 <strong>类转换失败 <code>ClassCastException</code></strong></p>
<h3 id="报错原因"><a href="#报错原因" class="headerlink" title="报错原因"></a>报错原因</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Class path contains multiple SLF4J binding</span><br><span class="line">23-May-2019 16:04:25.300 INFO [localhost-startStop-1] org.apache.jasper.servlet.TldScanner.scanJars At least one JAR was scanned for TLDs yet contained no TLDs. Enable debug logging for this logger for a complete list of JARs that were scanned but no TLDs were found in them. Skipping unneeded JARs during scanning can improve startup time and JSP compilation time.</span><br><span class="line">SLF4J: Class path contains multiple SLF4J bindings.</span><br><span class="line">SLF4J: Found binding in [jar:file:&#x2F;home&#x2F;admin&#x2F;xxx&#x2F;WEB-INF&#x2F;lib&#x2F;slf4j-log4j12-1.6.1.jar!&#x2F;org&#x2F;slf4j&#x2F;impl&#x2F;StaticLoggerBinder.class]</span><br><span class="line">SLF4J: Found binding in [jar:file:&#x2F;home&#x2F;admin&#x2F;xxx&#x2F;WEB-INF&#x2F;lib&#x2F;logback-classic-1.1.3.jar!&#x2F;org&#x2F;slf4j&#x2F;impl&#x2F;StaticLoggerBinder.class]</span><br><span class="line">SLF4J: See http:&#x2F;&#x2F;www.slf4j.org&#x2F;codes.html#multiple_bindings for an explanation.</span><br><span class="line">SLF4J: Actual binding is of type [org.slf4j.impl.Log4jLoggerFactory]</span><br></pre></td></tr></table></figure>

<h3 id="报错原因-1"><a href="#报错原因-1" class="headerlink" title="报错原因"></a>报错原因</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">org.slf4j.impl.Log4jLoggerFactory cannot be cast to ch.qos.logback.classic.LoggerContext</span><br><span class="line">org.springframework.beans.factory.BeanCreationException: Error creating bean with name &#39;cn.com.xxx.framework.log.integration.LogbackInitializer#0&#39; defined in class path resource [spring&#x2F;spring-log-init.xml]: Invocation of init method failed; nested exception is java.lang.ClassCastException: org.slf4j.impl.Log4jLoggerFactory cannot be cast to ch.qos.logback.classic.LoggerContext</span><br><span class="line">    ...    </span><br><span class="line">Caused by: java.lang.ClassCastException: org.slf4j.impl.Log4jLoggerFactory cannot be cast to ch.qos.logback.classic.LoggerContext</span><br><span class="line">    # 出问题的加载地方</span><br><span class="line"> at ch.qos.logback.ext.spring.LogbackConfigurer.initLogging(LogbackConfigurer.java:72)</span><br><span class="line"> at cn.com.xxx.framework.log.integration.LogbackInitializer.init(LogbackInitializer.java:49)</span><br><span class="line"> at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line"> at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line"> at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line"> at java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class="line"> at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeCustomInitMethod(AbstractAutowireCapableBeanFactory.java:1706)</span><br><span class="line"> at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeInitMethods(AbstractAutowireCapableBeanFactory.java:1645)</span><br><span class="line"> at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1574)</span><br><span class="line"> ... 26 more</span><br><span class="line">23-May-2019 15:59:12.398 SEVERE [localhost-startStop-1] org.apache.catalina.core.StandardContext.startInternal One or more listeners failed to start. Full details will be found in the appropriate container log file</span><br></pre></td></tr></table></figure>

<h3 id="查看报错代码"><a href="#查看报错代码" class="headerlink" title="查看报错代码"></a>查看报错代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public static void initLogging(String location) throws FileNotFoundException, JoranException &#123;</span><br><span class="line">   String resolvedLocation &#x3D; SystemPropertyUtils.resolvePlaceholders(location);</span><br><span class="line">   URL url &#x3D; ResourceUtils.getURL(resolvedLocation);</span><br><span class="line">   LoggerContext loggerContext &#x3D; (LoggerContext)StaticLoggerBinder.getSingleton().getLoggerFactory();</span><br><span class="line">   loggerContext.reset();</span><br><span class="line">   new ContextInitializer(loggerContext).configureByResource(url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，通过 <code>StaticLoggerBinder.getSingleton().getLoggerFactory()</code> 获取 logger 上下文这段代码报错了，通过仔细定位，发现了有两个 <code>StaticLoggerBinder</code> 类</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/eQPyBffYbucAM1dSp7ycZAXYI5C2Do953p5wHIylj4Owbjn4dxhRFlKac8xbQ1JU4GYfMnqAibw68ulsq2W0ggQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image"></p>
<p><strong>更重要的是，他们两兄弟竟然虽然不是同一个 jar 包，但是包路径和名称都一模一样！！！</strong></p>
<p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="Image"></p>
<p>由于我们需要的是 <code>logback</code> 包，而不是 <code>slf4j-log4j12</code> 包，所以需要排除掉 <code>slf4j-log4j12</code> 依赖。</p>
<hr>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a><strong>解决方法</strong></h2><p>① 通过 POM 文件排查包冲突</p>
<p>② 安装 IDEA 的插件 <code>Maven Helper</code></p>
<p>③ 定位到编译 WAR 包的 POM 文件（我们框架定义的在 Deploy 模块中）</p>
<p>④ 在搜索框中，输入搜索内容，点击右键可以看到选项框</p>
<ul>
<li>Jump To Source（跳转到源文件处）</li>
<li>Exclude（排除掉）</li>
</ul>
<p>例如我点击了 <code>Exclude</code> ，就能看到 pom 文件中，这个依赖就被排除掉了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;cn.com.xxx&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;framework-conf-client&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;xqy.framework.version&#125;&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;exclusions&gt;</span><br><span class="line">        &lt;exclusion&gt;</span><br><span class="line">            &lt;artifactId&gt;slf4j-log4j12&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;groupId&gt;org.slf4j&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;&#x2F;exclusion&gt;</span><br><span class="line">    &lt;&#x2F;exclusions&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<p>排除依赖后，提交代码，重新打包，部署一条龙，顺利启动~</p>
<hr>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a><strong>思考</strong></h2><p>包冲突解决是简单的，通过 maven 插件可以精确找到依赖，然后进行 Exclude，可是在本地开发、测试环境都没有出现的问题，却在预发环境出现了，所以排除了业务逻辑代码的原因，简单考虑了几个因素和原因：</p>
<ul>
<li>jdk 版本</li>
<li>tomcat 版本</li>
<li>类加载机制</li>
<li>第三方 jar 互相依赖</li>
</ul>
<p>由于 jdk 和 tomcat 这两者没有明显的报错原因，所以先去排查类的加载机制</p>
<hr>
<h3 id="类加载机制"><a href="#类加载机制" class="headerlink" title="类加载机制"></a>类加载机制</h3><p>我们写的 Java 应用代码，一般是通过 <code>App ClassLoader</code> 应用加载器进行加载，它不会自己先去加载它，而是通过 <code>Extension ClassLoader</code> 扩展类加载器进行加载（其中扩展类加载器又会去找 <code>Bootstrap ClassLoader</code> 启动类加载器进行加载），只有父加载器无法加载情况下，才会让下级加载器进行加载。</p>
<hr>
<h3 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h3><p>Java 使用的是双亲委派加载机制，通过查看 <code>ClassLoader</code> 类，可以对此有所了解。</p>
<p>类被成功加载后，将被放入到内存中，内存中存放 Class 实例对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">protected Class&lt;?&gt; loadClass(String name, boolean resolve)</span><br><span class="line">    throws ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    synchronized (getClassLoadingLock(name)) &#123;</span><br><span class="line">        &#x2F;&#x2F; First, check if the class has already been loaded</span><br><span class="line">        &#x2F;&#x2F; 首先，检查 class 是否已经被加载</span><br><span class="line">        Class&lt;?&gt; c &#x3D; findLoadedClass(name);</span><br><span class="line">        if (c &#x3D;&#x3D; null) &#123;</span><br><span class="line">            &#x2F;&#x2F; 如果没有被加载</span><br><span class="line">            long t0 &#x3D; System.nanoTime();</span><br><span class="line">            try &#123;</span><br><span class="line">                if (parent !&#x3D; null) &#123;</span><br><span class="line">                    &#x2F;&#x2F; 寻找 parent 加载器</span><br><span class="line">                    c &#x3D; parent.loadClass(name, false);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    &#x2F;&#x2F; 如果父加载器不存在，则委托给启动类加载器加载</span><br><span class="line">                    c &#x3D; findBootstrapClassOrNull(name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">                &#x2F;&#x2F; ClassNotFoundException thrown if class not found</span><br><span class="line">                &#x2F;&#x2F; from the non-null parent class loader</span><br><span class="line">            &#125;</span><br><span class="line">            if (c &#x3D;&#x3D; null) &#123;</span><br><span class="line">                &#x2F;&#x2F; If still not found, then invoke findClass in order</span><br><span class="line">                &#x2F;&#x2F; to find the class.</span><br><span class="line">                &#x2F;&#x2F; 如果仍然无法加载，才会尝试自身加载</span><br><span class="line">                long t1 &#x3D; System.nanoTime();</span><br><span class="line">                c &#x3D; findClass(name);</span><br><span class="line">                &#x2F;&#x2F; this is the defining class loader; record the stats</span><br><span class="line">                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br><span class="line">                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class="line">                sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (resolve) &#123;</span><br><span class="line">            resolveClass(c);</span><br><span class="line">        &#125;</span><br><span class="line">        return c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="类加载顺序"><a href="#类加载顺序" class="headerlink" title="类加载顺序"></a>类加载顺序</h3><p>从代码中了解到，如果某个名字的类 <!--名字 = 类路径+类名称--> 被加载后，类加载器是不会再重新加载，所以我们的问题根本原因可以是出现在：</p>
<p><strong>先加载了 <code>org.slf4j</code> 包的 <code>org.slf4j.impl.StaticLoggerBinder</code>，同名的 <code>ch.qos.logback</code> 包下的 <code>StaticLoggerBinder</code> 类没有被加载</strong></p>
<blockquote>
<p>跟JAR文件的文件名有关。按照字母的顺序加载JAR文件。有了这个类以后，后面的类则不会加载了。</p>
<p>jvm 加载包名和类名相同的类时，先加载classpath中jar路径放在前面的，包名类名都相同，那jvm没法区分了，如果使用ide一般情况下是会提示发生冲突而报错，若不报错，只有第一个包被引入（在classpath路径下排在前面的包），第二个包会在classloader加载类时判断重复而忽略。</p>
</blockquote>
<hr>
<h3 id="查看加载顺序"><a href="#查看加载顺序" class="headerlink" title="查看加载顺序"></a>查看加载顺序</h3><p>在 jvm 启动脚本中，添加 <code>-verbose</code> 参数或者 <code>-XX:+TraceClassLoading</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Loaded java.lang.CloneNotSupportedException from &#x2F;Users&#x2F;jingqi&#x2F;.jrebel&#x2F;bootcache&#x2F;jrebel-bootstrap-89f567048120ef32b965233b5ba2f7ca.jar]</span><br><span class="line">[Loaded java.lang.Thread$State from &#x2F;Users&#x2F;jingqi&#x2F;.jrebel&#x2F;bootcache&#x2F;jrebel-bootstrap-89f567048120ef32b965233b5ba2f7ca.jar]</span><br><span class="line">[Loaded java.util.TreeMap$NavigableSubMap from &#x2F;Users&#x2F;jingqi&#x2F;.jrebel&#x2F;bootcache&#x2F;jrebel-bootstrap-89f567048120ef32b965233b5ba2f7ca.jar]</span><br><span class="line">[Loaded java.util.TreeMap$AscendingSubMap from &#x2F;Users&#x2F;jingqi&#x2F;.jrebel&#x2F;bootcache&#x2F;jrebel-bootstrap-89f567048120ef32b965233b5ba2f7ca.jar]</span><br><span class="line">[Loaded java.util.TreeMap$NavigableSubMap$EntrySetView from &#x2F;Users&#x2F;jingqi&#x2F;.jrebel&#x2F;bootcache&#x2F;jrebel-bootstrap-89f567048120ef32b965233b5ba2f7ca.jar]</span><br><span class="line">[Loaded java.util.TreeMap$AscendingSubMap$AscendingEntrySetView from &#x2F;Users&#x2F;jingqi&#x2F;.jrebel&#x2F;bootcache&#x2F;jrebel-bootstrap-89f567048120ef32b965233b5ba2f7ca.jar]</span><br><span class="line">[Loaded java.util.TreeMap$NavigableSubMap$SubMapIterator from &#x2F;Users&#x2F;jingqi&#x2F;.jrebel&#x2F;bootcache&#x2F;jrebel-bootstrap-89f567048120ef32b965233b5ba2f7ca.jar]</span><br><span class="line">[Loaded java.util.TreeMap$NavigableSubMap$SubMapEntryIterator from &#x2F;Users&#x2F;jingqi&#x2F;.jrebel&#x2F;bootcache&#x2F;jrebel-bootstrap-89f567048120ef32b965233b5ba2f7ca.jar]</span><br></pre></td></tr></table></figure>

<p>之前在本地开发中，IDEA 优化先加载了 <code>ch.qos.logback</code> 的 <code>StaticLoggerBinder</code> 类，然后后面的 <code>org.slf4j</code> 包下的同名类就没有被加载。</p>
<p>但这样也有个不明白，按理说加载顺序按照<strong>字母顺序</strong>加载，预发环境还是能够跟本地开发一样，加载到我们需要的类。实际上，加载器加载到的是另一个类，导致应用无法启动。</p>
<blockquote>
<p>问题就是jar的加载顺序问题，而这个顺序实际上是由文件系统决定的，linux内部是用inode来指示文件的。</p>
<p>这种储存文件元信息的区域就叫做inode，中文译名为”索引节点”。每一个文件都有对应的inode，里面包含了与该文件有关的一些信息。</p>
<p>Unix/linux系统内部不使用文件名，而使用inode号码来识别文件。对于系统来说，文件名只是inode号码便于识别的别称或者绰号。</p>
</blockquote>
<p>为了验证 <code>inode</code> 是否是问题的原因，我做了以下测试：</p>
<hr>
<h3 id="inode-测试加载顺序"><a href="#inode-测试加载顺序" class="headerlink" title="inode 测试加载顺序"></a>inode 测试加载顺序</h3><h4 id="本地-Tomcat8-测试（正常启动）"><a href="#本地-Tomcat8-测试（正常启动）" class="headerlink" title="本地 Tomcat8 测试（正常启动）"></a>本地 Tomcat8 测试（正常启动）</h4><p>将之前在 uat 环境有问题的代码版本重新打包，不使用 idea 工具，直接用 tomcat8 启动，并且在 <code>catalina.sh</code> 脚本中加入类加载打印参数 <code>-XX:+TraceClassLoading</code></p>
<p>catalina.sh</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Register custom URL handlers</span><br><span class="line"># Do this here so custom URL handles (specifically &#39;war:...&#39;) can be used in the security policy</span><br><span class="line">JAVA_OPTS&#x3D;&quot;$JAVA_OPTS -XX:+TraceClassLoading&quot;</span><br></pre></td></tr></table></figure>

<p>查看 <code>catalina.out</code> 输入日志，发现先加载的是 logback 包中 <code>StaticLoggerBinder</code></p>
<p>在 <code>WEB-INF/lib</code> 下比较 inode 大小（正常解压和启动 logback &lt; slf4j)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ll -i logback-classic-1.1.3.jar slf4j-log4j12-1.6.1.jar</span><br><span class="line">34153162 -rw-r-----  1 jingqi  staff   274K  8  1  2018 logback-classic-1.1.3.jar</span><br><span class="line">34153180 -rw-r-----  1 jingqi  staff   9.5K 10 17  2018 slf4j-log4j12-1.6.1.jar</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="本地-Tomcat8-测试（删包，先添加-slf4j，后添加-logback）"><a href="#本地-Tomcat8-测试（删包，先添加-slf4j，后添加-logback）" class="headerlink" title="本地 Tomcat8 测试（删包，先添加 slf4j，后添加 logback）"></a>本地 Tomcat8 测试（删包，先添加 slf4j，后添加 logback）</h4><ul>
<li>清理掉 catalina.out</li>
<li>重新上传包</li>
<li>比较 inode 大小</li>
<li>重新启动，查看类加载日志</li>
</ul>
<p><strong>比较 inode 大小（发现 slf4j &lt; logback)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># ll -i logback-classic-1.1.3.jar slf4j-log4j12-1.6.1.jar</span><br><span class="line">34162396 -rw-r--r--  1 jingqi  staff   274K  8  1  2018 logback-classic-1.1.3.jar</span><br><span class="line">34162361 -rw-r--r--  1 jingqi  staff   9.5K 10 17  2018 slf4j-log4j12-1.6.1.jar</span><br></pre></td></tr></table></figure>

<p>重新启动后，查看 <code>catalina.out</code> 日志，发现类加载顺序与之前的一致，应用也能正常启动，所以本地开发无法复现 =-=</p>
<hr>
<h4 id="在-uat-环境服务器测试"><a href="#在-uat-环境服务器测试" class="headerlink" title="在 uat 环境服务器测试"></a>在 uat 环境服务器测试</h4><p>在 <code>WEB-INF/lib</code> 路径下，先将这两个包删掉，尝试有不同的上传顺序，模拟 tomcat 解压 war 包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[admin@uat-96-0-248 lib]$ rm logback-classic-1.1.3.jar  slf4j-log4j12-1.6.1.jar</span><br><span class="line">[admin@uat-96-0-248 lib]$ rz</span><br><span class="line">[admin@uat-96-0-248 lib]$ # Received &#x2F;Users&#x2F;jingqi&#x2F;Downloads&#x2F;slf4j-log4j12-1.6.1.jar</span><br><span class="line">[admin@uat-96-0-248 lib]$ rz</span><br><span class="line">[admin@uat-96-0-248 lib]$ # Received &#x2F;Users&#x2F;jingqi&#x2F;Downloads&#x2F;logback-classic-1.1.3.jar</span><br><span class="line"># 第一次上传顺序 1、slf4j-log4j12-1.6.1.jar 2、logback-classic-1.1.3.jar</span><br><span class="line"># inode 比较：slf4j &lt; logback</span><br><span class="line">[admin@uat-96-0-248 lib]$ ll -i logback-classic-1.1.3.jar slf4j-log4j12-1.6.1.jar</span><br><span class="line">396731 -rw-r--r-- 1 admin admin 280928 8月   1 2018 logback-classic-1.1.3.jar</span><br><span class="line">394075 -rw-r--r-- 1 admin admin   9753 10月 17 2018 slf4j-log4j12-1.6.1.jar</span><br><span class="line">[admin@uat-96-0-248 lib]$ rm logback-classic-1.1.3.jar  slf4j-log4j12-1.6.1.jar</span><br><span class="line">[admin@uat-96-0-248 lib]$ rz</span><br><span class="line">[admin@uat-96-0-248 lib]$ # Received &#x2F;Users&#x2F;jingqi&#x2F;Downloads&#x2F;logback-classic-1.1.3.jar</span><br><span class="line">[admin@uat-96-0-248 lib]$ rz</span><br><span class="line">[admin@uat-96-0-248 lib]$ # Received &#x2F;Users&#x2F;jingqi&#x2F;Downloads&#x2F;slf4j-log4j12-1.6.1.jar</span><br><span class="line"># 第二次上传顺序 1、logback-classic-1.1.3.jar 2、slf4j-log4j12-1.6.1.jar</span><br><span class="line"># inode 比较：logback &lt; slf4j</span><br><span class="line">[admin@uat-96-0-248 lib]$ ll -i logback-classic-1.1.3.jar slf4j-log4j12-1.6.1.jar</span><br><span class="line">394075 -rw-r--r-- 1 admin admin 280928 8月   1 2018 logback-classic-1.1.3.jar</span><br><span class="line">396731 -rw-r--r-- 1 admin admin   9753 10月 17 2018 slf4j-log4j12-1.6.1.jar</span><br></pre></td></tr></table></figure>

<p>分别测试了两种场景，发现只要这两个包都存在的情况下，无论 <code>inode</code> 两者的大小，都是先加载了 <code>slf4j</code> 包的类，导致启动报错</p>
<p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="Image"></p>
<hr>
<h3 id="测试结束"><a href="#测试结束" class="headerlink" title="测试结束"></a>测试结束</h3><p>通过多种测试场景，发现本地开发、测试环境都无法复现的问题，在 uat 环境下，只要这两个包同时存在，都会启动报错</p>
<p>最后在官方文档发现这个：</p>
<blockquote>
<p>The order in which the JAR files in a directory are enumerated in the expanded class path is not specified and may vary from platform to platform and even from moment to moment on the same machine. A well-constructed application should not depend upon any particular order. If a specific order is required, then the JAR files can be enumerated explicitly in the class path.</p>
</blockquote>
<p>大意为：同一个目录下，jvm加载jar包顺序是无法保证的，每个系统的都不一样，甚至同一个系统不同的时刻加载都不一样。</p>
<p>于是乎，我也不纠结某台服务器上的类加载顺序，在开发阶段就先将这个包冲突的情况，给提前解决掉~</p>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h2><h3 id="冲突提示信息"><a href="#冲突提示信息" class="headerlink" title="冲突提示信息"></a>冲突提示信息</h3><ul>
<li><strong>java.lang.ClassNotFoundException</strong>：类型转换错误，这个报错跟我这次遇到的一样，本应该引入的是 <code>logback</code> 包的类，但是实际引入的是 <code>slf4j</code> 下的同名类，导致类型转换错误</li>
<li><strong>java.lang.NoSuchMethodError</strong>：找不到特定方法，如果有两个同名的包但是不同版本，例如 xxx-1.1和 xxx-1.2包同时存在，先加载了 1.1 版本的类，但是 1.2 版本中才提供了新方法，导致提示找不到特定方法</li>
<li><strong>java.lang.NoClassDefFoundError，java.lang.LinkageError</strong></li>
</ul>
<h3 id="排查思路"><a href="#排查思路" class="headerlink" title="排查思路"></a>排查思路</h3><p>1、查看 <code>catalina.sh</code> 堆栈信息，找到有问题的类</p>
<p>2、通过 IDEA ，在打包的 POM 文件中，使用 <code>Maven Helper</code> 插件找出冲突的依赖，确定项目需要的 jar 包，<code>Exclude</code> 掉不需要的依赖。</p>
<h3 id="提前预防"><a href="#提前预防" class="headerlink" title="提前预防"></a>提前预防</h3><p><strong>1、使用工具检查依赖冲突</strong></p>
<p>冲突检测插件 ：<code>maven-enforcer-plugin</code></p>
<p>引用新的第三方依赖（工具包或者框架包），通过 Maven 插件检查一下 conflict 依赖，提前进行 Exclude</p>
<p><strong>2、统一服务器版本</strong></p>
<p>在测试阶段，准备好和生产环境一样的服务器，提前进行测试，避免依赖冲突的 <code>WAR</code> 包上传到生产环境，例如我们有一台 UAT 服务器，与生产环境一样配置，提前测试</p>
<hr>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/28/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E5%B9%82%E7%AD%89%E6%80%A7/%E9%AB%98%E5%B9%B6%E5%8F%91%E4%B8%8B%E4%BF%9D%E8%AF%81%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%B9%82%E7%AD%89%E6%80%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/28/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E5%B9%82%E7%AD%89%E6%80%A7/%E9%AB%98%E5%B9%B6%E5%8F%91%E4%B8%8B%E4%BF%9D%E8%AF%81%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%B9%82%E7%AD%89%E6%80%A7/" class="post-title-link" itemprop="url">高并发下保证接口的幂等性</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-04-28 12:12:34 / Modified: 13:34:05" itemprop="dateCreated datePublished" datetime="2021-04-28T12:12:34+08:00">2021-04-28</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="高并发下如何保证接口的幂等性？"><a href="#高并发下如何保证接口的幂等性？" class="headerlink" title="高并发下如何保证接口的幂等性？"></a>高并发下如何保证接口的幂等性？</h1><ul>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect">前言</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect">1. insert前先select</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect">2. 加悲观锁</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect">3. 加乐观锁</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect">4. 加唯一索引</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect">5. 建防重表</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect">6. 根据状态机</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect">7. 加分布式锁</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&chksm=fa496f8ecd3ee698f4954c00efb80fe955ec9198fff3ef4011e331aa37f55a6a17bc8c0335a8&scene=21&token=899450012&lang=zh_CN#wechat_redirect">8. 获取token</a></li>
</ul>
<hr>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect">前言</a></h1><p><code>接口幂等性</code>问题，对于开发人员来说，是一个跟语言无关的公共问题</p>
<p>不知道你有没有遇到过这些场景：</p>
<ol>
<li>有时我们在填写某些<code>form表单</code>时，保存按钮不小心快速点了两次，表中竟然产生了两条重复的数据，只是id不一样。</li>
<li>我们在项目中为了解决<code>接口超时</code>问题，通常会引入了<code>重试机制</code>。第一次请求接口超时了，请求方没能及时获取返回结果（此时有可能已经成功了），为了避免返回错误的结果（这种情况不可能直接返回失败吧？），于是会对该请求重试几次，这样也会产生重复的数据。</li>
<li>mq消费者在读取消息时，有时候会读取到<code>重复消息</code>，如果处理不好，也会产生重复的数据。</li>
</ol>
<p><code>接口幂等性</code>是指用户对于同一操作发起的一次请求或者多次请求的结果是一致的，不会因为多次点击而产生了副作用。</p>
<p>这类问题多发于接口的：</p>
<ul>
<li><code>insert</code>操作，这种情况下多次请求，可能会产生重复数据。</li>
<li><code>update</code>操作，如果只是单纯的更新数据，比如：<code>update user set status=1 where id=1</code>，是没有问题的。如果还有计算，比如：<code>update user set status=status+1 where id=1</code>，这种情况下多次请求，可能会导致数据错误。</li>
</ul>
<h1 id="加悲观锁"><a href="#加悲观锁" class="headerlink" title="加悲观锁"></a>加悲观锁</h1><p>使用悲观锁实现幂等性，一般是配合事务一起来实现，在没有使用悲观锁时，我们通常的执行过程是这样的，首先来判断数据的状态，执行 SQL 如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select status from table_name where id&#x3D;&#39;xxx&#39;;</span><br></pre></td></tr></table></figure>

<p>然后再进行添加操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into table_name (id) values (&#39;xxx&#39;);</span><br></pre></td></tr></table></figure>

<p>最后再进行状态的修改：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update table_name set status&#x3D;&#39;xxx&#39;;</span><br></pre></td></tr></table></figure>

<p><a href="">但这种情况因为是非原子操作，所以在高并发环境下可能会造成一个业务被执行两次的问题</a>，当一个程序在执行中时，而另一个程序也开始状态判断的操作。因为第一个程序还未来得及更改状态，所以第二个程序也能执行成功，这就导致一个业务被执行了两次。</p>
<p>在这种情况下我们就可以使用悲观锁来避免问题的产生，实现 SQL 如下所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;  <span class="comment"># 1.开始事务</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> table_name <span class="keyword">where</span> <span class="keyword">id</span>=<span class="string">&#x27;xxx&#x27;</span> <span class="keyword">for</span> <span class="keyword">update</span>; <span class="comment"># 2.查询状态</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> table_name (<span class="keyword">id</span>) <span class="keyword">values</span> (<span class="string">&#x27;xxx&#x27;</span>); <span class="comment"># 3.添加操作</span></span><br><span class="line"><span class="keyword">update</span> table_name <span class="keyword">set</span> <span class="keyword">status</span>=<span class="string">&#x27;xxx&#x27;</span>; <span class="comment"># 4.更改操作</span></span><br><span class="line"><span class="keyword">commit</span>; <span class="comment"># 5.提交事务</span></span><br></pre></td></tr></table></figure>

<p>在实现的过程中需要注意以下两个问题：</p>
<ul>
<li>如果使用的是 MySQL 数据库，必须选用 innodb 存储引擎，因为 innodb 支持事务；</li>
<li>id 字段一定要是主键或者是唯一索引，不然会锁表，影响其他业务执行。</li>
</ul>
<h1 id="加乐观锁"><a href="#加乐观锁" class="headerlink" title="加乐观锁"></a>加乐观锁</h1><p>既然悲观锁有性能问题，为了提升接口性能，我们可以使用乐观锁。需要在表中增加一个<code>timestamp</code>或者<code>version</code>字段，这里以<code>version</code>字段为例。</p>
<p>由于第一次请求<code>version</code>等于<code>1</code>是可以成功的，操作成功后<code>version</code>变成<code>2</code>了。这时如果并发的请求过来，再执行相同的sql：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update user set amount&#x3D;amount+100,version&#x3D;version+1where id&#x3D;123 and version&#x3D;1;</span><br></pre></td></tr></table></figure>

<p>该<code>update</code>操作不会真正更新数据，最终sql的执行结果影响行数是<code>0</code>，因为<code>version</code>已经变成<code>2</code>了，<code>where</code>中的<code>version=1</code>肯定无法满足条件。但为了保证接口幂等性，接口可以直接返回成功，因为<code>version</code>值已经修改了，那么前面必定已经成功过一次，后面都是重复的请求</p>
<h1 id="加唯一索引"><a href="#加唯一索引" class="headerlink" title="加唯一索引"></a>加唯一索引</h1><p>我们可以创建一个唯一索引的表来实现幂等性，在每次执行业务之前，先执行插入操作，因为唯一字段就是业务的 ID，因此如果重复插入的话会触发唯一约束而导致插入失败。在这种情况下（插入失败）我们就可以判定它为重复提交的请求。</p>
<p>唯一索引表的创建示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;table_name&#96; (</span><br><span class="line">  &#96;id&#96; int NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;orderid&#96; varchar(32) NOT NULL DEFAULT &#39;&#39; COMMENT &#39;唯一id&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;),</span><br><span class="line">  UNIQUE KEY &#96;uq_orderid&#96; (&#96;orderid&#96;) COMMENT &#39;唯一约束&#39;</span><br><span class="line">) ENGINE&#x3D;InnoDB;</span><br></pre></td></tr></table></figure>

<p>虽说抛异常对数据来说没有影响，不会造成错误数据。但是为了保证接口幂等性，我们需要对该异常进行捕获，然后返回成功。</p>
<p>如果是<code>java</code>程序需要捕获：<code>DuplicateKeyException</code>异常，如果使用了<code>spring</code>框架还需要捕获：<code>MySQLIntegrityConstraintViolationException</code>异常。</p>
<h1 id="根据状态机-和乐观锁原理一样"><a href="#根据状态机-和乐观锁原理一样" class="headerlink" title="根据状态机(和乐观锁原理一样)"></a>根据状态机(和乐观锁原理一样)</h1><p>很多时候业务表是有状态的，比如订单表中有：1-下单、2-已支付、3-完成、4-撤销等状态。如果这些状态的值是有规律的，按照业务节点正好是从小到大，我们就能通过它来保证接口的幂等性。</p>
<p>假如id=123的订单状态是<code>已支付</code>，现在要变成<code>完成</code>状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update &#96;order&#96; set status&#x3D;3 where id&#x3D;123 and status&#x3D;2;</span><br></pre></td></tr></table></figure>

<p>第一次请求时，该订单的状态是<code>已支付</code>，值是<code>2</code>，所以该<code>update</code>语句可以正常更新数据，sql执行结果的影响行数是<code>1</code>，订单状态变成了<code>3</code>。</p>
<p>后面有相同的请求过来，再执行相同的sql时，由于订单状态变成了<code>3</code>，再用<code>status=2</code>作为条件，无法查询出需要更新的数据，所以最终sql执行结果的影响行数是<code>0</code>，即不会真正的更新数据。但为了保证接口幂等性，影响行数是<code>0</code>时，接口也可以直接返回成功。</p>
<h1 id="加分布式锁"><a href="#加分布式锁" class="headerlink" title="加分布式锁"></a>加分布式锁</h1><p>由于<code>数据库分布式锁</code>的性能不太好，我们可以改用：<code>redis</code>或<code>zookeeper</code>。</p>
<p>鉴于现在很多公司分布式配置中心改用<code>apollo</code>或<code>nacos</code>，已经很少用<code>zookeeper</code>了，我们以<code>redis</code>为例介绍分布式锁。</p>
<p>目前主要有三种方式实现redis的分布式锁：</p>
<ol>
<li>setNx命令</li>
<li>set命令</li>
<li>Redission框架</li>
</ol>
<blockquote>
<p>需要特别注意的是：分布式锁一定要设置一个合理的过期时间，如果设置过短，无法有效的防止重复请求。如果设置过长，可能会浪费<code>redis</code>的存储空间，需要根据实际业务情况而定。</p>
</blockquote>
<h1 id="获取token-太逗比的方法了"><a href="#获取token-太逗比的方法了" class="headerlink" title="获取token(太逗比的方法了)"></a>获取token(太逗比的方法了)</h1><p>除了上述方案之外，还有最后一种使用<code>token</code>的方案。该方案跟之前的所有方案都有点不一样，需要两次请求才能完成一次业务操作。</p>
<ol>
<li>第一次请求获取<code>token</code></li>
<li>第二次请求带着这个<code>token</code>，完成业务操作。</li>
</ol>
<blockquote>
<p>需要特别注意的是：token必须是全局唯一的。</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/28/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/Java%E8%B0%83%E4%BC%98%E5%92%8C%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7/%E6%9F%A5%E6%89%BEOOM%E5%8E%9F%E5%9B%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/28/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/Java%E8%B0%83%E4%BC%98%E5%92%8C%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7/%E6%9F%A5%E6%89%BEOOM%E5%8E%9F%E5%9B%A0/" class="post-title-link" itemprop="url">查找OOM原因</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-04-28 12:01:43 / Modified: 12:08:52" itemprop="dateCreated datePublished" datetime="2021-04-28T12:01:43+08:00">2021-04-28</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>当前的 OOM 进行归因，主要分为下面几类：</p>
<ul>
<li>JAVA堆内存超过限制<ul>
<li>堆内存，单次分配内存过大</li>
<li>堆内存，多次分配累计过大，如StringBuilder或者Array</li>
<li>堆内存累计分配触顶</li>
</ul>
</li>
<li>文件描述符(fd)数目超过限制</li>
<li>pthread_create<ul>
<li>线程数超过限制</li>
<li>虚拟内存不足</li>
</ul>
</li>
</ul>
<p>其中 <code>pthread_create</code> 问题占到了总比例大约在百分之 50，Java 堆内存超限为百分之 40 多，剩下是少量的 fd 数量超限。其中 <code>pthread_create</code> 和 fd 数量不足均为 native 内存限制导致的 Java 层崩溃，我们对这部分的内存问题也做了针对性优化，主要包括：</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/27/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E7%BD%91%E5%85%B3/%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/27/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E7%BD%91%E5%85%B3/%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3/" class="post-title-link" itemprop="url">为什么需要服务网关</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-04-27 13:35:50 / Modified: 13:36:14" itemprop="dateCreated datePublished" datetime="2021-04-27T13:35:50+08:00">2021-04-27</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="一、什么是服务网关"><a href="#一、什么是服务网关" class="headerlink" title="一、什么是服务网关"></a>一、什么是服务网关</h2><p>服务网关 = 路由转发 + 过滤器</p>
<p>1、<strong>路由转发：</strong>接收一切外界请求，转发到后端的微服务上去；</p>
<p>2、<strong>过滤器：</strong>在服务网关中可以完成一系列的横切功能，例如权限校验、限流以及监控等，这些都可以通过过滤器完成（其实路由转发也是通过过滤器实现的）。</p>
<h2 id="二、为什么需要服务网关"><a href="#二、为什么需要服务网关" class="headerlink" title="二、为什么需要服务网关"></a>二、为什么需要服务网关</h2><p>上述所说的横切功能（以权限校验为例）可以写在三个位置：</p>
<ul>
<li>每个服务自己实现一遍</li>
<li>写到一个公共的服务中，然后其他所有服务都依赖这个服务</li>
<li>写到服务网关的前置过滤器中，所有请求过来进行权限校验</li>
</ul>
<p>第一种，缺点太明显，基本不用；</p>
<p>第二种，相较于第一点好很多，代码开发不会冗余，但是有两个缺点：</p>
<ul>
<li>由于每个服务引入了这个公共服务，那么相当于在每个服务中都引入了相同的权限校验的代码，使得每个服务的jar包大小无故增加了一些，尤其是对于使用docker镜像进行部署的场景，jar越小越好；</li>
<li>由于每个服务都引入了这个公共服务，那么我们后续升级这个服务可能就比较困难，而且公共服务的功能越多，升级就越难，而且假设我们改变了公共服务中的权限校验的方式，想让所有的服务都去使用新的权限校验方式，我们就需要将之前所有的服务都重新引包，编译部署。</li>
</ul>
<p><strong>而服务网关恰好可以解决这样的问题：</strong></p>
<ul>
<li>将权限校验的逻辑写在网关的过滤器中，后端服务不需要关注权限校验的代码，所以服务的jar包中也不会引入权限校验的逻辑，不会增加jar包大小；</li>
<li>如果想修改权限校验的逻辑，只需要修改网关中的权限校验过滤器即可，而不需要升级所有已存在的微服务。</li>
</ul>
<p>所以，需要服务网关！！！</p>
<h2 id="三、服务网关技术选型"><a href="#三、服务网关技术选型" class="headerlink" title="三、服务网关技术选型"></a>三、<a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MzI4Njc5NjM1NQ==&mid=2247490615&idx=1&sn=1a8c7126bf46a3cf1add60119803f220&chksm=ebd6231bdca1aa0d71508d01024fd639000fb556b67593a4c4a31a1f701b95a5adc112c858c6&scene=21#wechat_redirect">服务网关技术选型</a></h2><p><img src="https://mmbiz.qpic.cn/mmbiz_png/eQPyBffYbucguqG86ia9ZKsJrkpgzSb5TtqOF5YU4p7qKlgSgjrwFu1oicJQsibjhnLeS4yQUQuau8icCHUAmmFEibQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image"></p>
<p>引入服务网关后的微服务架构如上，总体包含三部分：<a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MzI4Njc5NjM1NQ==&mid=2247499813&idx=2&sn=b99a6b64dbb96fb9f7c74d50eb59cb79&chksm=ebd5ff09dca2761f3f5e5ec146837c5721feeae48c9443f2345a93b4cc519128b6792d6a96e2&scene=21#wechat_redirect">服务网关</a>、open-service和service。</p>
<h3 id="1、总体流程："><a href="#1、总体流程：" class="headerlink" title="1、总体流程："></a>1、总体流程：</h3><ul>
<li>服务网关、open-service和service启动时注册到注册中心上去；</li>
<li>用户请求时直接请求网关，网关做智能路由转发（包括服务发现，负载均衡）到open-service，这其中包含权限校验、监控、限流等操作</li>
<li>open-service聚合内部service响应，返回给网关，网关再返回给用户</li>
</ul>
<h3 id="2、引入网关的注意点"><a href="#2、引入网关的注意点" class="headerlink" title="2、引入网关的注意点"></a>2、引入网关的注意点</h3><ul>
<li>增加了网关，多了一层转发（原本用户请求直接访问open-service即可），性能会下降一些（但是下降不大，通常，网关机器性能会很好，而且网关与open-service的访问通常是内网访问，速度很快）；</li>
<li>网关的单点问题：在整个网络调用过程中，一定会有一个单点，可能是网关、nginx、dns服务器等。防止网关单点，可以在网关层前边再挂一台nginx，nginx的性能极高，基本不会挂，这样之后，网关服务就可以不断的添加机器。但是这样一个请求就转发了两次，所以最好的方式是网关单点服务部署在一台牛逼的机器上（通过压测来估算机器的配置），而且nginx与zuul的性能比较，根据国外的一个哥们儿做的实验来看，其实相差不大，zuul是netflix开源的一个用来做网关的开源框架；</li>
<li>网关要尽量轻。</li>
</ul>
<h3 id="3、服务网关基本功能"><a href="#3、服务网关基本功能" class="headerlink" title="3、服务网关基本功能"></a>3、服务网关基本功能</h3><ul>
<li><p><strong>智能路由：</strong>接收外部一切请求，并转发到后端的对外服务open-service上去；</p>
</li>
<li><ul>
<li>注意：我们只转发外部请求，服务之间的请求不走网关，这就表示全链路追踪、内部服务API监控、内部服务之间调用的容错、智能路由不能在网关完成；当然，也可以将所有的服务调用都走网关，那么几乎所有的功能都可以集成到网关中，但是这样的话，网关的压力会很大，不堪重负。</li>
</ul>
</li>
<li><p><strong>权限校验：</strong>只校验用户向open-service服务的请求，不校验服务内部的请求。服务内部的请求有必要校验吗？</p>
</li>
<li><p><strong>API监控：</strong>只监控经过网关的请求，以及网关本身的一些性能指标（例如，gc等）；</p>
</li>
<li><p><strong>限流：</strong>与监控配合，进行限流操作；</p>
</li>
<li><p>API<a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MzI4Njc5NjM1NQ==&mid=2247502455&idx=1&sn=846469197b743a1156c4563853a1b83b&chksm=ebd5f55bdca27c4d17974290fecd2a055c5cecf431959f628582d347a5edfe694e2a8bd96632&scene=21#wechat_redirect">日志统一收集</a>：类似于一个aspect切面，记录接口的进入和出去时的相关日志</p>
</li>
<li><p>。。。后续补充</p>
</li>
</ul>
<p>上述功能是网关的基本功能，网关还可以实现以下功能：</p>
<ul>
<li>A|B测试：A|B测试时一块比较大的东西，包含后台实验配置、数据埋点（看转化率）以及分流引擎，在服务网关中，可以实现分流引擎，但是实际上分流引擎会调用内部服务，所以如果是按照上图的架构，分流引擎最好做在open-service中，不要做在服务网关中。</li>
<li>。。。后续补充</li>
</ul>
<h3 id="4、技术选型"><a href="#4、技术选型" class="headerlink" title="4、技术选型"></a>4、技术选型</h3><p>笔者准备自建一个轻量级的服务网关，技术选型如下：</p>
<ul>
<li>开发语言：java + groovy，groovy的好处是网关服务不需要重启就可以动态的添加filter来实现一些功能；</li>
<li>微服务基础框架：springboot；</li>
<li>网关基础组件：netflix zuul；</li>
<li>服务注册中心：consul；</li>
<li>权限校验：jwt；</li>
<li>API监控：prometheus + grafana；</li>
<li>API统一日志收集：logback + ELK；</li>
<li>压力测试：Jmeter；</li>
<li>。。。后续补充</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/26/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E7%BD%91%E5%85%B3/%E7%BD%91%E5%85%B3%E5%AE%9E%E8%B7%B5-%E5%96%9C%E9%A9%AC%E6%8B%89%E9%9B%85%E8%87%AA%E7%A0%94API%E7%BD%91%E5%85%B3%E6%9E%B6%E6%9E%84%E5%AE%9E%E8%B7%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/26/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E7%BD%91%E5%85%B3/%E7%BD%91%E5%85%B3%E5%AE%9E%E8%B7%B5-%E5%96%9C%E9%A9%AC%E6%8B%89%E9%9B%85%E8%87%AA%E7%A0%94API%E7%BD%91%E5%85%B3%E6%9E%B6%E6%9E%84%E5%AE%9E%E8%B7%B5/" class="post-title-link" itemprop="url">网关实践-喜马拉雅自研API网关架构实践</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-04-26 09:13:56 / Modified: 13:32:53" itemprop="dateCreated datePublished" datetime="2021-04-26T09:13:56+08:00">2021-04-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>网关是一个比较成熟了的产品，基本上各大互联网公司都会有网关这个中间件，来解决一些公有业务的上浮，而且能快速的更新迭代，如果没有网关，要更新一个公有特性，就要推动所有业务方都更新和发布，那是效率极低的事，有网关后，这一切都变得不是问题，喜马拉雅也是一样，用户数增长达到6亿多的级别，Web服务个数达到500+，目前我们网关日处理200亿加次调用，单机QPS高峰达到4w+。</p>
<p>网关除了要实现最基本的功能反向代理外，还有公有特性，比如黑白名单，流控，鉴权，熔断，API发布，监控和报警等，我们还根据业务方的需求实现了流量调度，流量Copy，预发布，智能化升降级，流量预热等相关功能，下面就我们网关在这些方便的一些实践经验以及发展历程，下面是喜马拉雅网关的演化过程：</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/8Jeic82Or04nz126TrHT3iaXq3d9BcbIAkdrxoAFbbumvZ6QJGL643vt6PPUDjzM5B3sqerfSlI7pZUb475KwZVw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image"></p>
<h2 id="第一版-Tomcat-nio-AsyncServlet"><a href="#第一版-Tomcat-nio-AsyncServlet" class="headerlink" title="第一版 Tomcat nio + AsyncServlet"></a>第一版 Tomcat nio + AsyncServlet</h2><blockquote>
<p>网关在架构设计时最为关键点，就是网关在接收到请求，调用后端服务时不能阻塞Block，否则网关的吞吐量很难上去，因为最耗时的就是调用后端服务这个远程调用过程，如果这里是阻塞的，那你的tomcat的工作线程都block了，在等待后端服务响应的过程中，不能去处理其他的请求,这个地方一定要异步 <!--这个地方需要明确下：tomcat工作线程的工作时间 = 调用服务应用的时间 + 处理流量控制的时间 + 处理白名单的时间 + 其他的网关功能时间，这些因素中，调用服务应用的时间是可以通过异步减少等待时间的--></p>
</blockquote>
<p>架构图如下：</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/8Jeic82Or04nz126TrHT3iaXq3d9BcbIAkdtBCWGS0ibVeQxAftuwtZox6fc8wmqDtwibjTaicQMAz1OgboYahYuXYg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image"></p>
<p>这版我们实现单独的Push层，作为网关收到响应后，响应客户端时，通过这层实现，和后端服务的通信是HttpNioClient，对业务的支持黑白名单，流控，鉴权，API发布等功能，这版只是功能上达到网关的邀请。</p>
<ul>
<li><p>问题：但是处理能力很快就成了瓶颈，单机qps到5k的时候，就会不停的full gc</p>
</li>
<li><p>原因：后面通过dump 线上的堆分析，发现全是tomcat缓存了很多http的请求，因为tomcat默认会缓存200个requestProcessor，每个processor都关联了一个request，<!--可以配置缓存的requestProcessor数量，而且我觉得缓存并不是full gc的决定因素，缓存减少了对象的创建，使reqeustProcessor对象进入老年代，导致老年代容量增加，可用的老年代容量减少，才导致full gc。所以说任何一个工具使用缓存，在不改变jvm大小的情况下，都会有full gc的问题-->  还有就是servlet3.0 tomcat的异步实现会出现内存泄漏，后面通过减少这个配置，效果明显。但性能肯定就下降了，</p>
</li>
</ul>
<p>总结了下，基于tomcat做为接入端，有如下几个问题：</p>
<ul>
<li><p>Tomcat自身的问题</p>
<ul>
<li>缓存太多，tomcat用了很多对象池技术，内存有限的情况下，流量一高很容易触发gc。</li>
<li>内存copy，tomcat的默认是用堆内存，所以数据需要读到堆内，而我们后端服务是netty，有堆外内存，需要通过数次copy。</li>
<li>tomcat 还有个问题是读body是阻塞的,tomcat 的nio模型和reactor模型不一样，读body是block的。</li>
</ul>
</li>
<li><p>HttpNioClient的问题</p>
<ul>
<li>获取和释放链接都需要加锁，对应网关这样的代理服务场景，会频繁的建链和关闭链接，势必会影响性能。</li>
</ul>
</li>
</ul>
<h2 id="第二版-Netty-全异步"><a href="#第二版-Netty-全异步" class="headerlink" title="第二版 Netty + 全异步"></a>第二版 Netty + 全异步</h2><p>tomcat 划分为 Netty接入层 + Netty服务调用层</p>
<blockquote>
<p>基于Netty的优势，我们实现了全异步，无锁，分层的架构</p>
</blockquote>
<p>先看下我们基于Netty做接入端的架构图</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/8Jeic82Or04nz126TrHT3iaXq3d9BcbIAkqCz6mht3J4iaY8t1owyF0ymt3qwHPm9djwczAK9iaaEhPXx1jXYIsQpA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image"></p>
<h3 id="接入层（协议层，IO线程）"><a href="#接入层（协议层，IO线程）" class="headerlink" title="接入层（协议层，IO线程）"></a>接入层（协议层，IO线程）</h3><blockquote>
<p>Netty的io线程，负责http协议的编解码工作，同时对协议层面的异常做监控报警</p>
</blockquote>
<p>，</p>
<ul>
<li><strong>对http协议的编解码做了优化</strong>: http的请求行和请求头大小是有限制的，tomcat是请求行和请求加在一起，不超过8k，netty是分别有大小限制，假如客户端发送了超过阀值的请求，带cookie的请求很容易超过，正常情况下，netty就直接响应400给客户端，经过改造后，我们只取正常大小的部分，同时标记协议解析失败，到业务层后，就可以判断出是那个服务出现这类问题</li>
<li><strong>对异常/攻击性请求监控可视化</strong>: 比如只发请求头，不发body/或者发部分这些都需要监控和报警。</li>
</ul>
<h3 id="业务逻辑层（Worker线程）"><a href="#业务逻辑层（Worker线程）" class="headerlink" title="业务逻辑层（Worker线程）"></a>业务逻辑层（Worker线程）</h3><blockquote>
<p>负责对API路由，流量调度等一序列的支持业务的公有逻辑，都在这层实现，采样责任链模式，这层不会有io操作。<!--很重要，没有IO操作会极大提升吞吐量和响应能力--></p>
</blockquote>
<p>在业界和一些大厂的网关设计中，业务逻辑层基本都是设计成责任链模式，公有的业务逻辑也在这层实现，我们在这层也是相同的套路，支持了：</p>
<ul>
<li>用户鉴权和登陆校验 ，支持接口级别配置</li>
<li>黑白明单 ，分全局和应用，以及ip维度，参数级别</li>
<li>流量控制 ，支持自动和手动，自动是对超大流量自动拦截，通过令牌桶算法实现</li>
<li>智能熔断 ，在histrix的基础上做了改进，支持自动升降级，我们是全部自动的，也支持手动配置立即熔断，就是发现服务异常比例达到阀值，就自动触发熔断</li>
<li>灰度发布 ，我对新启动的机器的流量支持类似tcp的慢启动机制，给 机器一个预热的时间窗口</li>
<li>统一降级 ，我们对所有转发失败的请求都会找统一降级的逻辑，只要业务方配了降级规则，都会降级，我们对降级规则是支持到参数级别的，包含请求头里的值，是非常细粒度的，另外我们还会和varnish打通，支持varish的优雅降级</li>
<li>流量调度 ，支持业务根据筛选规则，对流量筛选到对应的机器，也支持只让筛选的流量访问这台机器，这在查问题/新功能发布验证时非常用，可以先通过小部分流量验证再大面积发布上线。</li>
<li>流量copy ，我们支持对线上的原始请求根据规则copy一份，写入到mq或者其他的upstream，来做线上跨机房验证和压力测试。</li>
<li>请求日志采样 ，我们对所有的失败的请求都会采样落盘，提供业务方排查问题支持，也支持业务方根据规则进行个性化采样，我们采样了整个生命周期的数据，包含请求和响应相关的所有数据。</li>
</ul>
<p>上面提到的这么多都是对流量的治理，我们每个功能都是一个filter，处理失败都不影响转发流程，而且所有的这些规则的元数据在网关启动时就会全部初始化好，在执行的过程中，不会有IO操作，目前有些设计会对多个filter做并发执行，由于我们的都是内存操作，开销并不大，所以我们目前并没有支持并发执行，还有个就是规则会修改，我们修改规则时，会通知网关服务，做实时刷新，我们对内部自己的这种元数据更新的请求，通过独立的线程处理，防止io在操作时影响业务线程。</p>
<h3 id="服务调用层"><a href="#服务调用层" class="headerlink" title="服务调用层"></a>服务调用层</h3><blockquote>
<p>服务调用对于代理网关服务是关键的地方，一定需要异步，我们通过netty实现,同时也很好的利用了netty提供的链接池，做到了获取和释放都是无锁操作</p>
</blockquote>
<h4 id="异步Push"><a href="#异步Push" class="headerlink" title="异步Push"></a>异步Push</h4><p>网关在发起服务调用后，让工作线程继续处理其他的请求，而不需要等待服务端返回，这里的设计是我们为每个请求都会创建一个上下文，我们在发完请求后，把该请求的context 绑定到对应的链接上，等netty收到服务端响应时，就会在给链接上执行read操作，解码完后，再从给链接上获取对应的context，通过context可以获取到接入端的session，这样push就通过session把响应写回客户端了，这样设计也是基于http的链接是独占的，即链接可以和请求上下文绑定。</p>
<h4 id="链接池"><a href="#链接池" class="headerlink" title="链接池"></a>链接池</h4><p>链接池的原理如下图：</p>
<img src="https://mmbiz.qpic.cn/mmbiz_png/8Jeic82Or04nz126TrHT3iaXq3d9BcbIAkhAuM89Q7l3S7KRdn3o3RfAEZXFDNoP2XWFEZyGCRS3viaZ3rTU71KCQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image" style="zoom: 67%;" />

<p>服务调用层除了异步发起远程调用外，还需要对后端服务的链接进行管理，http不同于rpc，http的链接是独占的，所以在释放的时候要特别小心，一定要等服务端响应完了才能释放，还有就是链接关闭的处理也要小心，总结如下几点：</p>
<ul>
<li>Connection:close</li>
<li>空闲超时，关闭链接</li>
<li>读超时关闭链接</li>
<li>写超时，关闭链接</li>
<li>Fin,Reset</li>
</ul>
<p>上面几种需要关闭链接的场景，下面主要说下Connection:close和空闲写超时两种，其他的应该是比较常见的比如读超时，链接空闲超时，收到fin，reset码这几个。</p>
<h4 id="Connection-close"><a href="#Connection-close" class="headerlink" title="Connection:close"></a>Connection:close</h4><p>后端服务是tomcat，tomcat对链接重用的次数是有限制的，默认是100次，当达到100次后，tomcat会通过在响应头里添加Connection:close，让客户端关闭该链接，否则如果再用该链接发送的话，会出现400。</p>
<p>还有就是如果端上的请求带了connection:close,那tomcat就不等这个链接重用到100次，即一次就关闭，通过在响应头里添加Connection:close，即成了短链接， 这个在和tomcat保持长链接时，需要注意的，如果要利用，就要主动remove掉这个close头。</p>
<h4 id="写超时"><a href="#写超时" class="headerlink" title="写超时"></a>写超时</h4><p>首先网关什么时候开始计算服务的超时时间，如果从调用writeAndFlush开始就计算，这其实是包含了netty对http的encode时间和从队列里把请求发出去即flush的时间，这样是对后端服务不公平的，所以需要在真正flush成功后开始计时，这样是和服务端最接近的，当然还包含了网络往返时间和内核协议栈处理的时间，这个不可避免，但基本不变。</p>
<p>所以我们是flush成功回调后开始启动超时任务，这里就有个注意的地方，如果flush不能快速回调，比如来了一个大的post请求，body部分比较大，而netty发送的时候第一次默认是发1k的大小，如果还没有发完，则增大发送的大小继续发，如果在netty在16次后还没有发送完成，则不会再继续发送，而是提交一个flushTask到任务队列，待下次执行到后再发送，这时flush回调的时间就比较大，导致这样的请求不能及时关闭，而且后端服务tomcat会一直阻塞在读body的地方，基于上面的分析，所以我们需要一个写超时，对大的body请求，通过写超时来及时关闭。</p>
<h3 id="全链路超时机制"><a href="#全链路超时机制" class="headerlink" title="全链路超时机制"></a>全链路超时机制</h3><p>下面是我们在整个链路中加一个超时处理的机制。</p>
<img src="https://mmbiz.qpic.cn/mmbiz_png/8Jeic82Or04nz126TrHT3iaXq3d9BcbIAk1yreIiadB5sRJqF5lFFiaM4ooullE2AUsDutnMbKsCVJwJwccPOHKpeg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image" style="zoom:80%;" />

<ul>
<li>协议解析超时</li>
<li>等待队列超时</li>
<li>建链超时</li>
<li>等待链接超时</li>
<li>写前检查是否超时</li>
<li>写超时</li>
<li>响应超时</li>
</ul>
<h2 id="监控报警"><a href="#监控报警" class="headerlink" title="监控报警"></a>监控报警</h2><blockquote>
<p>网关业务方能看到的是监控和报警，我们是实现秒级别报警和秒级别的监控，监控数据定时上报给我们的管理系统，由管理系统负责聚合统计，落盘到influxdb</p>
</blockquote>
<p>我们对http协议做了全面的监控和报警，无论是协议层的还是服务层的</p>
<h3 id="协议层"><a href="#协议层" class="headerlink" title="协议层"></a>协议层</h3><ul>
<li>攻击性请求，只发头，不发/发部分body，采样落盘，还原现场，并报警</li>
<li>Line or Head or Body过大的请求，采样落盘，还原现场，并报警</li>
</ul>
<h3 id="应用层"><a href="#应用层" class="headerlink" title="应用层"></a>应用层</h3><ul>
<li>耗时监控，有慢请求，超时请求，以及tp99，tp999等</li>
<li>qps监控和报警</li>
<li>带宽监控和报警，支持对请求和响应的行，头，body单独监控。</li>
<li>响应码监控，特别是400，和404</li>
<li>链接监控,我们对接入端的链接，以及和后端服务的链接，后端服务链接上待发送字节大小也都做了监控</li>
<li>失败请求监控</li>
<li>流量抖动报警，这是非常有必要的，流量抖动要么是出了问题，要么就是出问题的前兆。</li>
</ul>
<h2 id="总体架构"><a href="#总体架构" class="headerlink" title="总体架构"></a>总体架构</h2><p><img src="https://mmbiz.qpic.cn/mmbiz_png/8Jeic82Or04nz126TrHT3iaXq3d9BcbIAkSawVeDxMQFELDSuQSR5HJhzJ3EtE9AicMibtmpdU0a6kv5Q1FJIM1RJg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image"></p>
<h2 id="性能优化实践"><a href="#性能优化实践" class="headerlink" title="性能优化实践"></a>性能优化实践</h2><h3 id="对象池技术"><a href="#对象池技术" class="headerlink" title="对象池技术"></a>对象池技术</h3><p>对于高并发系统，频繁的创建对象不仅有分配内存的开销外，还有对gc会造成压力，我们在实现时会对频繁使用的比如线程池的任务task，StringBuffer等会做写重用，减少频繁的申请内存的开销。</p>
<h3 id="上下文切换"><a href="#上下文切换" class="headerlink" title="上下文切换"></a>上下文切换</h3><p>高并发系统，通常都采用异步设计，异步化后，不得不考虑线程上下文切换的问题，我们的线程模型如下：</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/8Jeic82Or04nz126TrHT3iaXq3d9BcbIAk1pHtcHPsr7IrLddIPAK7N8rbPaiabY8JnUzu998Gg8undRfPqqIwM4Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="Image"></p>
<p>我们整个网关没有涉及到io操作，但我们在业务逻辑这块还是和netty的io编解码线程异步，是有两个原因，1是防止开发写的代码有阻塞，2是业务逻辑打日志可能会比较多，在突发的情况下，但是我们在push线程时，支持用netty的io线程替代，这里做的工作比较少，这里有异步修改为同步后(通过修改配置调整)，cpu的上下文切换减少20%，进而提高了整体的吞吐量，就是不能为了异步而异步，zull2的设计和我们的类似</p>
<h3 id="GC优化"><a href="#GC优化" class="headerlink" title="GC优化"></a>GC优化</h3><p>在高并发系统，gc的优化不可避免，我们在用了对象池技术和堆外内存时，对象很少进入老年代，另外我们年轻代会设置的比较大，而且SurvivorRatio=2，晋升年龄设置最大15，<!--这是一个优化点，需要根据日志，确认晋升年龄=x的时候，新生代的对象几乎不进入老年代了，15太大了，太过保守了--> 尽量对象在年轻代就回收掉， 但监控发现老年代的内存还是会缓慢增长，通过dump分析，我们每个后端服务创建一个链接，都时有一个socket，socket的AbstractPlainSocketImpl，而AbstractPlainSocketImpl就重写了Object类的finalize方法，实现如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Cleans up if the user forgets to close it.</span><br><span class="line"> *&#x2F;</span><br><span class="line">protected void finalize() throws IOException &#123;</span><br><span class="line">    close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>是为了我们没有主动关闭链接，做的一个兜底，在gc回收的时候，先把对应的链接资源给释放了,由于finalize的机制是通过jvm的Finalizer线程来处理的，而且Finalizer线程的优先级不高，默认是8，需要等到Finalizer线程把ReferenceQueue的对象对于的finalize方法执行完，还要等到下次gc时，才能把该对象回收，导致创建链接的这些对象在年轻代不能立即回收，从而进入了老年代，这也是为啥老年代会一直缓慢增长的问题。</p>
<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><p>高并发下，特别是netty的io线程除了要执行该线程上的io读写操作，还有执行异步任务和定时任务，如果io线程处理不过来队列里的任务，很有可能导致新进来异步任务出现被拒绝的情况，那什么情况下可能呢，io是异步读写的问题不大，就是多耗点cpu，最有可能block住io线程的是我们打的日志，目前log4j的ConsoleAppender日志immediateFlush属性默认为true,即每次打log都是同步写flush到磁盘的 <!--我认为，这其实是和mysql的redo log一样，确保每次的日志(mysql是事务日志)都能持久化，这里不应该牺牲数据的持久性--> ，这个对于内存操作来说，慢了很多，同时AsyncAppender的日志队列满了也会block住线程,log4j默认的buffer大小是128，而且是block的，即如果buffer的大小达到128，就阻塞了写日志的线程，在并发写日志量大的的情况下，特别是堆栈很多时，log4j的Dispatcher线程会出现变慢要刷盘，这样buffer就不能快速消费，很容易写满日志事件，导致netty io线程block住，所以我们在打日志时，也要注意精简。</p>
<h2 id="未来规划"><a href="#未来规划" class="headerlink" title="未来规划"></a>未来规划</h2><p>现在我们都是基于http1，现在http2相对于http1关键实现了在链接层面的服务，即一个链接上可以发送多个http请求，即http的链接也能和rpc的链接一样，建几个链接就可以了，彻底解决了http1链接不能复用导致每次都建链和慢启动的开销，我们也在基于netty升级到http2,除了技术升级外，我们对监控报警也一直在持续优化，怎么提供给业务方准确无误的报警，也是一直在努力，还有一个就是降级，作为统一接入网关，和业务方做好全方位的降级措施，也是一直在完善的点，保证全站任何故障都能通过网关第一时间降级，也是我们的重点。                              </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/25/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/springboot/springboot-%E4%BA%8B%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/25/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/Java/springboot/springboot-%E4%BA%8B%E5%8A%A1/" class="post-title-link" itemprop="url">spring-事务</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-04-25 08:31:31 / Modified: 12:30:08" itemprop="dateCreated datePublished" datetime="2021-04-25T08:31:31+08:00">2021-04-25</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="数据库的事务"><a href="#数据库的事务" class="headerlink" title="数据库的事务"></a>数据库的事务</h2><blockquote>
<p>数据库事务（Transaction，简写为 TX）是数据库管理系统执行过程中的一个逻辑单位，是可以提交或回滚的工作的原子单元。当事务对数据库进行多次更改时，要么在提交事务时所有更改都成功，要么在回滚事务时所有更改都被撤消。</p>
</blockquote>
<h2 id="Mysql-中的事务"><a href="#Mysql-中的事务" class="headerlink" title="Mysql 中的事务"></a>Mysql 中的事务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">START TRANSACTION</span><br><span class="line">    [transaction_characteristic [, transaction_characteristic] ...]</span><br><span class="line"></span><br><span class="line">transaction_characteristic: &#123;</span><br><span class="line">    WITH CONSISTENT SNAPSHOT</span><br><span class="line">  | READ WRITE</span><br><span class="line">  | READ ONLY</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BEGIN [WORK]</span><br><span class="line">COMMIT [WORK] [AND [NO] CHAIN] [[NO] RELEASE]</span><br><span class="line">ROLLBACK [WORK] [AND [NO] CHAIN] [[NO] RELEASE]</span><br><span class="line">SET autocommit &#x3D; &#123;0 | 1&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>START TRANSACTION</code>或 <code>BEGIN</code>开始新事务。</li>
<li><code>COMMIT</code> 提交当前事务。</li>
<li><code>ROLLBACK</code> 回滚当前事务。</li>
<li><code>SET autocommit</code> 禁用或启用当前会话的默认自动提交模式。</li>
</ul>
<p><strong>默认情况下，Mysql 是自动提交的模式，所有语句会立即提交</strong></p>
<h2 id="JDBC-中的事务"><a href="#JDBC-中的事务" class="headerlink" title="JDBC 中的事务"></a>JDBC 中的事务</h2><p><strong>JDBC</strong> 是 Java 语言中用来规范客户端程序如何来访问数据库的应用程序接口，提供了查询和更新数据库中数据的方法。JDBC 也是 Sun Microsystems 的商标（现在属于 Oracle），是面向关系型数据库的。</p>
<p>上面说到，Mysql 是默认自动提交的，所以 JDBC 中事务事务的第一步，需要<strong>禁用自动提交：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">con.setAutoCommit(false);</span><br></pre></td></tr></table></figure>

<p><strong>提交事务：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">con.commit();</span><br></pre></td></tr></table></figure>

<p><strong>回滚事务：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">con.rollback();</span><br></pre></td></tr></table></figure>

<p><strong>一个完整流程的例子（摘自 Oracle JDBC 文档）：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateCoffeeSales</span><span class="params">(HashMap&lt;String, Integer&gt; salesForWeek)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"></span><br><span class="line">    PreparedStatement updateSales = <span class="keyword">null</span>;</span><br><span class="line">    PreparedStatement updateTotal = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    String updateString =</span><br><span class="line">        <span class="string">&quot;update &quot;</span> + dbName + <span class="string">&quot;.COFFEES &quot;</span> +</span><br><span class="line">        <span class="string">&quot;set SALES = ? where COF_NAME = ?&quot;</span>;</span><br><span class="line"></span><br><span class="line">    String updateStatement =</span><br><span class="line">        <span class="string">&quot;update &quot;</span> + dbName + <span class="string">&quot;.COFFEES &quot;</span> +</span><br><span class="line">        <span class="string">&quot;set TOTAL = TOTAL + ? &quot;</span> +</span><br><span class="line">        <span class="string">&quot;where COF_NAME = ?&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        con.setAutoCommit(<span class="keyword">false</span>); <span class="comment">//第一步</span></span><br><span class="line">        updateSales = con.prepareStatement(updateString);</span><br><span class="line">        updateTotal = con.prepareStatement(updateStatement);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; e : salesForWeek.entrySet()) &#123;</span><br><span class="line">            updateSales.setInt(<span class="number">1</span>, e.getValue().intValue());</span><br><span class="line">            updateSales.setString(<span class="number">2</span>, e.getKey());</span><br><span class="line">            updateSales.executeUpdate();</span><br><span class="line">            updateTotal.setInt(<span class="number">1</span>, e.getValue().intValue());</span><br><span class="line">            updateTotal.setString(<span class="number">2</span>, e.getKey());</span><br><span class="line">            updateTotal.executeUpdate();</span><br><span class="line">            con.commit(); <span class="comment">//第二步</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e ) &#123;</span><br><span class="line">        JDBCTutorialUtilities.printSQLException(e);</span><br><span class="line">        <span class="keyword">if</span> (con != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.err.print(<span class="string">&quot;Transaction is being rolled back&quot;</span>);</span><br><span class="line">                con.rollback(); <span class="comment">//第三步</span></span><br><span class="line">            &#125; <span class="keyword">catch</span>(SQLException excep) &#123;</span><br><span class="line">                JDBCTutorialUtilities.printSQLException(excep);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (updateSales != <span class="keyword">null</span>) &#123;</span><br><span class="line">            updateSales.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (updateTotal != <span class="keyword">null</span>) &#123;</span><br><span class="line">            updateTotal.close();</span><br><span class="line">        &#125;</span><br><span class="line">        con.setAutoCommit(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Spring-事务管理器（Transaction-Manager）简介"><a href="#Spring-事务管理器（Transaction-Manager）简介" class="headerlink" title="Spring 事务管理器（Transaction Manager）简介"></a>Spring 事务管理器（Transaction Manager）简介</h2><p>Spring 为事务管理提供了统一的抽象，有以下优点：<!--注意：Spring只提供抽象，不提供实现--></p>
<ul>
<li>跨不同事务 API（例如 Java 事务 API（JTA），JDBC，Hibernate，Java 持久性 API（JPA）和 Java 数据对象（JDO））的一致编程模型。</li>
<li>支持声明式事务管理（注解形式）</li>
<li>与 JTA 之类的复杂事务 API 相比， 用于程序化事务管理的 API 更简单</li>
<li>和 Spring 的 Data 层抽象集成方便（比如 Spring - Hibernate/Jdbc/Mybatis/Jpa…）</li>
</ul>
<p><a href="">Spring 的事务管理器只是一个接口 / 抽象，不同的 DB 层框架（其实不光是 DB 类框架，支持事务模型的理论上都可以使用这套抽象） 可能都需要实现此标准才可以更好的工作</a>， </p>
<p>核心接口是<code>org.springframework.transaction.support.AbstractPlatformTransactionManager</code>，其代码位于<code>spring-tx</code>模块中，比如 Hibernate 中的实现为：<code>org.springframework.orm.hibernate4.HibernateTransactionManager</code></p>
<h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><p>事务，自然是控制业务的，在一个业务流程内，往往希望保证原子性，要么全成功要么全失败。</p>
<p>所以事务一般是加载<code>@Service</code>层，一个 Service 内调用了多个数据库操作（比如 Dao），在 Service 结束后事务自动提交，如有异常抛出则事务回滚。</p>
<p>这也是 Spring 事务管理的基本使用原则。</p>
<h4 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h4><p>在被 Spring 管理的类头上增加<code>@Transactional</code>注解，即可对该类下的所有方法开启事务管理。事务开启后，方法内的操作无需手动开启 / 提交 / 回滚事务，一切交给 Spring 管理即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TxTestService</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderRepo orderRepo;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submit</span><span class="params">(Order order)</span></span>&#123;</span><br><span class="line">        orderRepo.save(order);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以只在方法上配置，方法配置的优先级是大于类的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TxTestService</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderRepo orderRepo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submit</span><span class="params">(Order order)</span></span>&#123;</span><br><span class="line">        orderRepo.save(order);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="TransactionTemplate"><a href="#TransactionTemplate" class="headerlink" title="TransactionTemplate"></a>TransactionTemplate</h4><p>TransactionTemplate 这中方式，其实和使用注解形式的区别不大，其核心功能也是由 TransactionManager 实现的，这里只是换了个入口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">execute</span><span class="params">(TransactionCallback&lt;T&gt; action)</span> <span class="keyword">throws</span> TransactionException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.transactionManager <span class="keyword">instanceof</span> CallbackPreferringPlatformTransactionManager) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((CallbackPreferringPlatformTransactionManager) <span class="keyword">this</span>.transactionManager).execute(<span class="keyword">this</span>, action);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//获取事务信息</span></span><br><span class="line">        TransactionStatus status = <span class="keyword">this</span>.transactionManager.getTransaction(<span class="keyword">this</span>);</span><br><span class="line">        T result;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//执行业务代码</span></span><br><span class="line">            result = action.doInTransaction(status);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//处理异常回滚</span></span><br><span class="line">        <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">            <span class="comment">// Transactional code threw application exception -&gt; rollback</span></span><br><span class="line">            rollbackOnException(status, ex);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Error err) &#123;</span><br><span class="line">            <span class="comment">// Transactional code threw error -&gt; rollback</span></span><br><span class="line">            rollbackOnException(status, err);</span><br><span class="line">            <span class="keyword">throw</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="comment">// Transactional code threw unexpected exception -&gt; rollback</span></span><br><span class="line">            rollbackOnException(status, ex);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(ex, <span class="string">&quot;TransactionCallback threw undeclared checked exception&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//提交事务</span></span><br><span class="line">        <span class="keyword">this</span>.transactionManager.commit(status);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="XML-配置-tx-advice"><a href="#XML-配置-tx-advice" class="headerlink" title="XML 配置 tx:advice"></a>XML 配置 tx:advice</h4><p>过于古老，不做解释</p>
<h3 id="隔离级别-Isolation-Level"><a href="#隔离级别-Isolation-Level" class="headerlink" title="隔离级别 (Isolation Level)"></a>隔离级别 (Isolation Level)</h3><p>事务隔离级别是数据库最重要的特性之一，他保证了脏读 / 幻读等问题不会发生。作为一个事务管理框架自然也是支持此配置的，在 @Transactional 注解中有一个 isolation 配置，可以很方便的配置各个事务的隔离级别，等同于<code>connection.setTransactionIsolation()</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Isolation &#123;</span><br><span class="line">    DEFAULT(-1),</span><br><span class="line">    READ_UNCOMMITTED(1),</span><br><span class="line">    READ_COMMITTED(2),</span><br><span class="line">    REPEATABLE_READ(4),</span><br><span class="line">    SERIALIZABLE(8);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="传播行为-Propagation-behavior"><a href="#传播行为-Propagation-behavior" class="headerlink" title="传播行为 (Propagation behavior)"></a>传播行为 (Propagation behavior)</h3><p>传播行为和数据库功能无关，只是事务管理器为了处理复杂业务而设计的一个机制。</p>
<p>比如现在有这样一个调用场景，<code>A Service -&gt; B Service -&gt; C Service</code>，但是希望 A/B 在一个事务内，C 是一个独立的事务，同时 C 如果出错，不影响 AB 所在的事务。</p>
<p>此时，就可以通过传播行为来处理；将 C Service 的事务配置为<code>@Transactional(propagation = Propagation.REQUIRES_NEW)</code>即可</p>
<p>Spring 支持以下几种传播行为：</p>
<ul>
<li>REQUIRED：默认策略，优先使用当前事务（及当前线程绑定的事务资源），如果不存在事务，则开启新事务</li>
<li>SUPPORTS：优先使用当前的事务（及当前线程绑定的事务资源），如果不存在事务，则以无事务方式运行</li>
<li>MANDATORY：优先使用当前的事务，如果不存在事务，则抛出异常</li>
<li>REQUIRES_NEW：创建一个新事务，如果存在当前事务，则挂起（Suspend）</li>
<li>NOT_SUPPORTED：以非事务方式执行，如果当前事务存在，则挂起当前事务。</li>
<li>NEVER：以非事务方式执行，如果当前事务存在，则抛出异常</li>
</ul>
<h3 id="回滚策略"><a href="#回滚策略" class="headerlink" title="回滚策略"></a>回滚策略</h3><p>@Transactional 中有 4 个配置回滚策略的属性，分为 Rollback 策略，和 NoRollback 策略</p>
<p><strong>默认情况下，RuntimeException 和 Error 这两种异常会导致事务回滚，普通的 Exception（需要 Catch 的）异常不会回滚。</strong></p>
<h4 id="Rollback"><a href="#Rollback" class="headerlink" title="Rollback"></a>Rollback</h4><p>配置需要回滚的异常类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 异常类Class</span><br><span class="line">Class&lt;? extends Throwable&gt;[] rollbackFor() default &#123;&#125;;</span><br><span class="line"># 异常类ClassName，可以是FullName&#x2F;SimpleName</span><br><span class="line">String[] rollbackForClassName() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<h4 id="NoRollback"><a href="#NoRollback" class="headerlink" title="NoRollback"></a>NoRollback</h4><p>针对一些要特殊处理的业务逻辑，比如插一些日志表，或者不重要的业务流程，希望就算出错也不影响事务的提交。</p>
<p>可以通过配置 NoRollbackFor 来实现，让某些异常不影响事务的状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 异常类Class</span><br><span class="line">Class&lt;? extends Throwable&gt;[] noRollbackFor() default &#123;&#125;;</span><br><span class="line"># 异常类ClassName，可以是FullName&#x2F;SimpleName</span><br><span class="line">String[] noRollbackForClassName() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<h3 id="只读控制"><a href="#只读控制" class="headerlink" title="只读控制"></a>只读控制</h3><p>设置当时事务的只读标示，等同于<code>connection.setReadOnly()</code></p>
<h3 id="关键名词解释"><a href="#关键名词解释" class="headerlink" title="关键名词解释"></a>关键名词解释</h3><table>
<thead>
<tr>
<th>名词</th>
<th>概念</th>
</tr>
</thead>
<tbody><tr>
<td>PlatformTransactionManager</td>
<td>事务管理器，管理事务的各生命周期方法，简称 TxMgr</td>
</tr>
<tr>
<td>TransactionAttribute</td>
<td>事务属性, 包含隔离级别，传播行为, 是否只读等信息，简称 TxAttr</td>
</tr>
<tr>
<td>TransactionStatus</td>
<td>事务状态，包含当前事务、挂起等信息，简称 TxStatus</td>
</tr>
<tr>
<td>TransactionInfo</td>
<td>事务信息，内含 TxMgr, TxAttr, TxStatus 等信息，简称 TxInfo</td>
</tr>
<tr>
<td>TransactionSynchronization</td>
<td>事务同步回调，内含多个钩子方法，简称 TxSync / transaction synchronization</td>
</tr>
<tr>
<td>TransactionSynchronizationManager</td>
<td>事务同步管理器，维护当前线程事务资源，信息以及 TxSync 集合</td>
</tr>
</tbody></table>
<h3 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public void execute(TxCallback txCallback)&#123;</span><br><span class="line">    &#x2F;&#x2F;获取连接</span><br><span class="line">    Connection connection &#x3D; acquireConnection();</span><br><span class="line">    try&#123;</span><br><span class="line">        &#x2F;&#x2F;执行业务代码</span><br><span class="line">        doInService();</span><br><span class="line">        &#x2F;&#x2F;提交事务</span><br><span class="line">        connection.commit();</span><br><span class="line">    &#125;catch (Exception e)&#123;</span><br><span class="line">        &#x2F;&#x2F;回滚事务</span><br><span class="line">        rollback(connection);</span><br><span class="line">    &#125;finally &#123;</span><br><span class="line">        &#x2F;&#x2F;释放连接</span><br><span class="line">        releaseConnection(connection);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Spring 事务管理的基本原理就是以上代码，获取连接 -&gt; 执行代码 -&gt; 提交 / 回滚事务。Spring 只是将这个流程给抽象出来了，所有事务相关的操作都交由 TransactionManager 去实现，然后封装一个<strong>模板形式的入口</strong>来执行</p>
<p>比如<code>org.springframework.transaction.support.TransactionTemplate</code>的实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">  public &lt;T&gt; T execute(TransactionCallback&lt;T&gt; action) throws TransactionException &#123;</span><br><span class="line">      if (this.transactionManager instanceof CallbackPreferringPlatformTransactionManager) &#123;</span><br><span class="line">          return ((CallbackPreferringPlatformTransactionManager) this.transactionManager).execute(this, action);</span><br><span class="line">      &#125;</span><br><span class="line">      else &#123;</span><br><span class="line">          &#x2F;&#x2F;通过事务管理器获取事务</span><br><span class="line">          TransactionStatus status &#x3D; this.transactionManager.getTransaction(this);</span><br><span class="line">          T result;</span><br><span class="line">          try &#123;</span><br><span class="line">              &#x2F;&#x2F;执行业务代码</span><br><span class="line">              result &#x3D; action.doInTransaction(status);</span><br><span class="line">          &#125;</span><br><span class="line">          &#x2F;&#x2F;处理异常回滚</span><br><span class="line">          catch (RuntimeException ex) &#123;</span><br><span class="line">              &#x2F;&#x2F; Transactional code threw application exception -&gt; rollback</span><br><span class="line">              rollbackOnException(status, ex);</span><br><span class="line">              throw ex;</span><br><span class="line">          &#125;</span><br><span class="line">          catch (Error err) &#123;</span><br><span class="line">              &#x2F;&#x2F; Transactional code threw error -&gt; rollback</span><br><span class="line">              rollbackOnException(status, err);</span><br><span class="line">              throw err;</span><br><span class="line">          &#125;</span><br><span class="line">          catch (Exception ex) &#123;</span><br><span class="line">              &#x2F;&#x2F; Transactional code threw unexpected exception -&gt; rollback</span><br><span class="line">              rollbackOnException(status, ex);</span><br><span class="line">              throw new UndeclaredThrowableException(ex, &quot;TransactionCallback threw undeclared checked exception&quot;);</span><br><span class="line">          &#125;</span><br><span class="line">          &#x2F;&#x2F;提交事务</span><br><span class="line">          this.transactionManager.commit(status);</span><br><span class="line">          return result;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>注解形式的事务（@Transactional），实现机制也是一样，基于 Spring 的 AOP，将上面 Template 的模式换成了自动的 AOP，在 AOP 的 Interceptor（<code>org.springframework.transaction.interceptor.TransactionInterceptor</code>）中来执行这套流程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">protected Object invokeWithinTransaction(Method method, Class&lt;?&gt; targetClass, final InvocationCallback invocation)</span><br><span class="line">            throws Throwable &#123;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; If the transaction attribute is null, the method is non-transactional.</span><br><span class="line">        final TransactionAttribute txAttr &#x3D; getTransactionAttributeSource().getTransactionAttribute(method, targetClass);</span><br><span class="line">        &#x2F;&#x2F;获取事务管理器</span><br><span class="line">        final PlatformTransactionManager tm &#x3D; determineTransactionManager(txAttr);</span><br><span class="line">        final String joinpointIdentification &#x3D; methodIdentification(method, targetClass);</span><br><span class="line"></span><br><span class="line">        if (txAttr &#x3D;&#x3D; null || !(tm instanceof CallbackPreferringPlatformTransactionManager)) &#123;</span><br><span class="line">            &#x2F;&#x2F; Standard transaction demarcation with getTransaction and commit&#x2F;rollback calls.</span><br><span class="line">            &#x2F;&#x2F;创建事务</span><br><span class="line">            TransactionInfo txInfo &#x3D; createTransactionIfNecessary(tm, txAttr, joinpointIdentification);</span><br><span class="line">            Object retVal &#x3D; null;</span><br><span class="line">            try &#123;</span><br><span class="line">                &#x2F;&#x2F; This is an around advice: Invoke the next interceptor in the chain.</span><br><span class="line">                &#x2F;&#x2F; This will normally result in a target object being invoked.</span><br><span class="line">                &#x2F;&#x2F;执行被“AOP”的代码</span><br><span class="line">                retVal &#x3D; invocation.proceedWithInvocation();</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Throwable ex) &#123;</span><br><span class="line">                &#x2F;&#x2F; target invocation exception</span><br><span class="line">                &#x2F;&#x2F;处理异常回滚</span><br><span class="line">                completeTransactionAfterThrowing(txInfo, ex);</span><br><span class="line">                throw ex;</span><br><span class="line">            &#125;</span><br><span class="line">            finally &#123;</span><br><span class="line">                &#x2F;&#x2F;清除资源</span><br><span class="line">                cleanupTransactionInfo(txInfo);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            &#x2F;&#x2F;提交事务</span><br><span class="line">            commitTransactionAfterReturning(txInfo);</span><br><span class="line">            return retVal;</span><br><span class="line">        &#125;</span><br><span class="line">   ....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<h3 id="复杂流程下的事务传播-保持相同事务的关键："><a href="#复杂流程下的事务传播-保持相同事务的关键：" class="headerlink" title="复杂流程下的事务传播 / 保持相同事务的关键："></a>复杂流程下的事务传播 / 保持相同事务的关键：</h3><ul>
<li>对于复杂一些的业务流程，会出现各种类之间的调用，Spring 是如何做到保持同一个事务的？<ul>
<li>其实基本原理很简单，只需要将当前事务（Connection）隐式的保存至事务管理器内，后续方法在执行 JDBC 操作前，从事务管理器内获取即可：</li>
<li>比如<code>HibernateTemplate</code>中的<code>SessionFactory</code>中的<code>getCurrentSession</code>，这里的<code>getCurrentSession</code>就是从（可能是间接的）Spring 事务管理器中获取的</li>
<li><strong>Spring 事务管理器将处理事务时的相关临时资源（Connection 等）存在<code>org.springframework.transaction.support.TransactionSynchronizationManager</code>中，通过 ThreadLocal 维护</strong></li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionSynchronizationManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(TransactionSynchronizationManager.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Map&lt;Object, Object&gt;&gt; resources =</span><br><span class="line">            <span class="keyword">new</span> NamedThreadLocal&lt;Map&lt;Object, Object&gt;&gt;(<span class="string">&quot;Transactional resources&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Set&lt;TransactionSynchronization&gt;&gt; synchronizations =</span><br><span class="line">            <span class="keyword">new</span> NamedThreadLocal&lt;Set&lt;TransactionSynchronization&gt;&gt;(<span class="string">&quot;Transaction synchronizations&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; currentTransactionName =</span><br><span class="line">            <span class="keyword">new</span> NamedThreadLocal&lt;String&gt;(<span class="string">&quot;Current transaction name&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Boolean&gt; currentTransactionReadOnly =</span><br><span class="line">            <span class="keyword">new</span> NamedThreadLocal&lt;Boolean&gt;(<span class="string">&quot;Current transaction read-only status&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Integer&gt; currentTransactionIsolationLevel =</span><br><span class="line">            <span class="keyword">new</span> NamedThreadLocal&lt;Integer&gt;(<span class="string">&quot;Current transaction isolation level&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Boolean&gt; actualTransactionActive =</span><br><span class="line">            <span class="keyword">new</span> NamedThreadLocal&lt;Boolean&gt;(<span class="string">&quot;Actual transaction active&quot;</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>针对一些复杂场景，嵌套事务 + 独立事务，涉及到挂起（suspend），恢复（resume）的情况，相关资源也是存储在**<code>TransactionSynchronizationManager</code>** 中的，方便嵌套事务的处理。</p>
<p>比如 A-&gt;B 时，A 方法已经开启了事务，并将当前事务资源绑定在**<code>TransactionSynchronizationManager</code>，<strong>那么执行 B 之前，会检测当前是否已经存在事务；检测方式就是从</strong><code>TransactionSynchronizationManager</code>**查找并检测状态，如果已经在事务内，那么就根据不同的传播行为配置来执行不同的逻辑，对于 REQUIRES_NEW 等传播行为的处理会麻烦一些，会涉及到 “挂起（suspend）” 和恢复 (resume) 的操作。</p>
<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><h4 id="事务没生效"><a href="#事务没生效" class="headerlink" title="事务没生效"></a>事务没生效</h4><p>有下列代码，入口为 test 方法，在 testTx 方法中配置了 @Transactional 注解，同时在插入数据后抛出 RuntimeException 异常，但是方法执行后插入的数据并没有回滚，竟然插入成功了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public void test()&#123;</span><br><span class="line">    testTx();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Transactional</span><br><span class="line">public void testTx()&#123;</span><br><span class="line">    UrlMappingEntity urlMappingEntity &#x3D; new UrlMappingEntity();</span><br><span class="line">    urlMappingEntity.setUrl(&quot;http:&#x2F;&#x2F;www.baidu.com&quot;);</span><br><span class="line">    urlMappingEntity.setExpireIn(777l);</span><br><span class="line">    urlMappingEntity.setCreateTime(new Date());</span><br><span class="line">    urlMappingRepository.save(urlMappingEntity);</span><br><span class="line">    if(true)&#123;</span><br><span class="line">        throw new RuntimeException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里不生效的原因是因为入口的方法 / 类没有增加 @Transaction 注解，由于 Spring 的事务管理器也是基于 AOP 实现的，不管是 Cglib(ASM) 还是 Jdk 的动态代理，本质上也都是子类机制；在同类之间的方法调用会直接调用本类代码，不会执行动态代理曾的代码；所以在这个例子中，由于入口方法<code>test</code>没有增加代理注解，所以<code>textTx</code>方法上增加的事务注解并不会生效</p>
<h4 id="异步后事务失效"><a href="#异步后事务失效" class="headerlink" title="异步后事务失效"></a>异步后事务失效</h4><p>比如在一个事务方法中，开启了子线程操作库，那么此时子线程的事务和主线程事务是不同的。</p>
<p>因为在 Spring 的事务管理器中，事务相关的资源（连接，session，事务状态之类）都是存放在 TransactionSynchronizationManager 中的，通过 ThreadLocal 存放，如果跨线程的话就无法保证一个事务了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># TransactionSynchronizationManager.java</span><br><span class="line">private static final ThreadLocal&lt;Map&lt;Object, Object&gt;&gt; resources &#x3D;</span><br><span class="line">        new NamedThreadLocal&lt;&gt;(&quot;Transactional resources&quot;);</span><br><span class="line">private static final ThreadLocal&lt;Set&lt;TransactionSynchronization&gt;&gt; synchronizations &#x3D;</span><br><span class="line">        new NamedThreadLocal&lt;&gt;(&quot;Transaction synchronizations&quot;);</span><br><span class="line">private static final ThreadLocal&lt;String&gt; currentTransactionName &#x3D;</span><br><span class="line">        new NamedThreadLocal&lt;&gt;(&quot;Current transaction name&quot;);</span><br><span class="line">private static final ThreadLocal&lt;Boolean&gt; currentTransactionReadOnly &#x3D;</span><br><span class="line">        new NamedThreadLocal&lt;&gt;(&quot;Current transaction read-only status&quot;);</span><br><span class="line">private static final ThreadLocal&lt;Integer&gt; currentTransactionIsolationLevel &#x3D;</span><br><span class="line">        new NamedThreadLocal&lt;&gt;(&quot;Current transaction isolation level&quot;);</span><br><span class="line">private static final ThreadLocal&lt;Boolean&gt; actualTransactionActive &#x3D;</span><br><span class="line">        new NamedThreadLocal&lt;&gt;(&quot;Actual transaction active&quot;);</span><br><span class="line"></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<h4 id="事务提交失败"><a href="#事务提交失败" class="headerlink" title="事务提交失败"></a>事务提交失败</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.transaction.UnexpectedRollbackException: </span><br><span class="line">Transaction silently rolled back because it has been marked as rollback-only</span><br><span class="line"></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>这个异常是由于在同一个事务内，多个事务方法之间调用，子方法抛出异常，但又被父方法忽略了导致的。</p>
<p>因为子方法抛出了异常，Spring 事务管理器会将当前事务标为失败状态，准备进行回滚，可是当子方法执行完毕出栈后，父方法又忽略了此异常，待方法执行完毕后正常提交时，事务管理器会检查回滚状态，若有回滚标示则抛出此异常。具体可以参考<code>org.springframework.transaction.support.AbstractPlatformTransactionManager#processCommit</code></p>
<p>示例代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">A -&gt; B</span><br><span class="line"># A Service(@Transactional):</span><br><span class="line">public void testTx()&#123;</span><br><span class="line">    urlMappingRepo.deleteById(98l);</span><br><span class="line">    try&#123;</span><br><span class="line">        txSubService.testSubTx();</span><br><span class="line">    &#125;catch (Exception e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># B Service(@Transactional)</span><br><span class="line">public void testSubTx()&#123;</span><br><span class="line">    if(true)&#123;</span><br><span class="line">        throw new RuntimeException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/23/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81/shiro%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-02-shiro%E5%85%A5%E5%8F%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/23/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81/shiro%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-02-shiro%E5%85%A5%E5%8F%A3/" class="post-title-link" itemprop="url">shiro框架</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-04-23 08:04:48" itemprop="dateCreated datePublished" datetime="2021-04-23T08:04:48+08:00">2021-04-23</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-05-07 09:11:54" itemprop="dateModified" datetime="2021-05-07T09:11:54+08:00">2021-05-07</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><h3 id="shiro入口"><a href="#shiro入口" class="headerlink" title="shiro入口"></a>shiro入口</h3><p>我们打算将 Shiro 放在 Web 应用中使用，只需在 web.xml 中做如下配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;3.0&quot;</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.apache.shiro.web.env.EnvironmentLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>ShiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.apache.shiro.web.servlet.ShiroFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>ShiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p> web.xml 才是整个 Web 应用的核心所在，Web 容器（例如：Tomcat）会提供一些监听器，用于监听 Web 应用的生命周期事件，有两个重要的点可以监听，一个是出生，另一个是死亡，具备这类特性的监听器就是 ServletContextListener。</p>
<p>Shiro 的 EnvironmentLoaderListener 就是一个典型的 ServletContextListener，它也是整个 Shiro Web 应用的入口，不妨先来看看它的静态结构吧：</p>
<p><img src="http://static.oschina.net/uploads/space/2014/0318/162859_TEXh_223750.png" alt="img"></p>
<ol>
<li><p>EventListener 是一个标志接口，里面没有任何的方法，Servlet 容器中所有的 Listener 都要继承这个接口<!--这是 Servlet 规范--></p>
</li>
<li><p>ServletContextListener 是一个 ServletContext 的监听器，用于监听容器的启动与关闭事件，包括如下两个方法：<br>  - void contextInitialized(ServletContextEvent sce); // 当容器启动时调用<br>  - void contextDestroyed(ServletContextEvent sce); // 当容器关闭时调用<br>  可以从 ServletContextEvent 中直接获取 ServletContext 对象。</p>
</li>
<li><p>EnvironmentLoaderListener 不仅实现了 ServletContextListener 接口，也扩展了 EnvironmentLoader 类，是为了在 Servlet 容器中调用 EnvironmentLoader 对象的生命周期方法。</p>
</li>
</ol>
<h4 id="EnvironmentLoader"><a href="#EnvironmentLoader" class="headerlink" title="EnvironmentLoader"></a>EnvironmentLoader</h4><p>EnvironmentLoaderListener 开始：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class EnvironmentLoaderListener extends EnvironmentLoader implements ServletContextListener &#123;</span><br><span class="line"> </span><br><span class="line">    &#x2F;&#x2F; 容器启动时调用</span><br><span class="line">    public void contextInitialized(ServletContextEvent sce) &#123;</span><br><span class="line">        initEnvironment(sce.getServletContext());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    &#x2F;&#x2F; 当容器关闭时调用</span><br><span class="line">    public void contextDestroyed(ServletContextEvent sce) &#123;</span><br><span class="line">        destroyEnvironment(sce.getServletContext());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看来 EnvironmentLoaderListener 只是一个空架子而已，真正干活的人是它“爹”（EnvironmentLoader）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnvironmentLoader</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 可在 web.xml 的 context-param 中定义 WebEnvironment 接口的实现类（默认为 IniWebEnvironment）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ENVIRONMENT_CLASS_PARAM = <span class="string">&quot;shiroEnvironmentClass&quot;</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 可在 web.xml 的 context-param 中定义 Shiro 配置文件的位置</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONFIG_LOCATIONS_PARAM = <span class="string">&quot;shiroConfigLocations&quot;</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 在 ServletContext 中存放 WebEnvironment 的 key</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ENVIRONMENT_ATTRIBUTE_KEY = EnvironmentLoader.class.getName() + <span class="string">&quot;.ENVIRONMENT_ATTRIBUTE_KEY&quot;</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 从 ServletContext 中获取相关信息，并创建 WebEnvironment 实例</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WebEnvironment <span class="title">initEnvironment</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line">        <span class="comment">// 确保 WebEnvironment 只能创建一次</span></span><br><span class="line">        <span class="keyword">if</span> (servletContext.getAttribute(ENVIRONMENT_ATTRIBUTE_KEY) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建 WebEnvironment 实例</span></span><br><span class="line">            WebEnvironment environment = createEnvironment(servletContext);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 将 WebEnvironment 实例放入 ServletContext 中</span></span><br><span class="line">            servletContext.setAttribute(ENVIRONMENT_ATTRIBUTE_KEY, environment);</span><br><span class="line">            <span class="keyword">return</span> environment;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">            <span class="comment">// 将异常对象放入 ServletContext 中</span></span><br><span class="line">            servletContext.setAttribute(ENVIRONMENT_ATTRIBUTE_KEY, ex);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Error err) &#123;</span><br><span class="line">            <span class="comment">// 将错误对象放入 ServletContext 中</span></span><br><span class="line">            servletContext.setAttribute(ENVIRONMENT_ATTRIBUTE_KEY, err);</span><br><span class="line">            <span class="keyword">throw</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> WebEnvironment <span class="title">createEnvironment</span><span class="params">(ServletContext sc)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 确定 WebEnvironment 接口的实现类</span></span><br><span class="line">        Class&lt;?&gt; clazz = determineWebEnvironmentClass(sc);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 确保该实现类实现了 MutableWebEnvironment 接口</span></span><br><span class="line">        <span class="keyword">if</span> (!MutableWebEnvironment.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 从 ServletContext 中获取 Shiro 配置文件的位置参数，并判断该参数是否已定义</span></span><br><span class="line">        String configLocations = sc.getInitParameter(CONFIG_LOCATIONS_PARAM);</span><br><span class="line">        <span class="keyword">boolean</span> configSpecified = StringUtils.hasText(configLocations);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 若配置文件位置参数已定义，则需确保该实现类实现了 ResourceConfigurable 接口</span></span><br><span class="line">        <span class="keyword">if</span> (configSpecified &amp;&amp; !(ResourceConfigurable.class.isAssignableFrom(clazz))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 通过反射创建 WebEnvironment 实例，将其转型为 MutableWebEnvironment 类型，并将 ServletContext 放入该实例中</span></span><br><span class="line">        MutableWebEnvironment environment = (MutableWebEnvironment) ClassUtils.newInstance(clazz);</span><br><span class="line">        environment.setServletContext(sc);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 若配置文件位置参数已定义，且该实例是 ResourceConfigurable 接口的实例（实现了该接口），则将此参数放入该实例中</span></span><br><span class="line">        <span class="keyword">if</span> (configSpecified &amp;&amp; (environment <span class="keyword">instanceof</span> ResourceConfigurable)) &#123;</span><br><span class="line">            ((ResourceConfigurable) environment).setConfigLocations(configLocations);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 可进一步定制 WebEnvironment 实例（在子类中扩展）</span></span><br><span class="line">        customizeEnvironment(environment);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 调用 WebEnvironment 实例的 init 方法</span></span><br><span class="line">        LifecycleUtils.init(environment);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 返回 WebEnvironment 实例</span></span><br><span class="line">        <span class="keyword">return</span> environment;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; determineWebEnvironmentClass(ServletContext servletContext) &#123;</span><br><span class="line">        <span class="comment">// 从初始化参数（context-param）中获取 WebEnvironment 接口的实现类</span></span><br><span class="line">        String className = servletContext.getInitParameter(ENVIRONMENT_CLASS_PARAM);</span><br><span class="line">        <span class="comment">// 若该参数已定义，则加载该实现类</span></span><br><span class="line">        <span class="keyword">if</span> (className != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> ClassUtils.forName(className);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnknownClassException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException(ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 否则使用默认的实现类</span></span><br><span class="line">            <span class="keyword">return</span> IniWebEnvironment.class;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">customizeEnvironment</span><span class="params">(WebEnvironment environment)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 销毁 WebEnvironment 实例</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroyEnvironment</span><span class="params">(ServletContext servletContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 从 ServletContext 中获取 WebEnvironment 实例</span></span><br><span class="line">            Object environment = servletContext.getAttribute(ENVIRONMENT_ATTRIBUTE_KEY);</span><br><span class="line">            <span class="comment">// 调用 WebEnvironment 实例的 destroy 方法</span></span><br><span class="line">            LifecycleUtils.destroy(environment);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 移除 ServletContext 中存放的 WebEnvironment 实例</span></span><br><span class="line">            servletContext.removeAttribute(ENVIRONMENT_ATTRIBUTE_KEY);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看来 EnvironmentLoader 就是为了：</p>
<ol>
<li><p>当容器启动时，读取 web.xml 文件，从中获取 WebEnvironment 接口的实现类（默认是 IniWebEnvironment），初始化该实例，并将其加载到 ServletContext 中。</p>
</li>
<li><p>当容器关闭时，销毁 WebEnvironment 实例，并从 ServletContext 将其移除。</p>
</li>
</ol>
<p>这里有两个配置项可以在 web.xml 中进行配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>shiroEnvironmentClass<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>WebEnvironment 接口的实现类<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>shiroConfigLocations<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>shiro.ini 配置文件的位置<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 EnvironmentLoader 中仅用于创建 WebEnvironment 接口的实现类，随后将由这个实现类来加载并解析 shiro.ini 配置文件。</p>
<h4 id="WebEnvironment"><a href="#WebEnvironment" class="headerlink" title="WebEnvironment"></a>WebEnvironment</h4><p>既然 WebEnvironment 如此重要，那么很有必要了解一下它的静态结构：</p>
<p><img src="http://static.oschina.net/uploads/space/2014/0318/163231_w73G_223750.png" alt="img"></p>
<ol>
<li><p>最底层的 IniWebEnvironment 是 WebEnvironment 接口的默认实现类，它将读取 ini 配置文件，并创建 WebEnvironment 实例。</p>
</li>
<li><p>可以断言，如果需要将 Shiro 配置定义在 XML 或 Properties 配置文件中，那就需要自定义一些WebEnvironment 实现类了。</p>
</li>
<li><p>WebEnvironment 的实现类不仅需要实现最顶层的 Environment 接口，还需要实现具有生命周期功能的 Initializable 与 Destroyable 接口。</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IniWebEnvironment</span> <span class="keyword">extends</span> <span class="title">ResourceBasedWebEnvironment</span> <span class="keyword">implements</span> <span class="title">Initializable</span>, <span class="title">Destroyable</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 默认 shiro.ini 路径</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_WEB_INI_RESOURCE_PATH = <span class="string">&quot;/WEB-INF/shiro.ini&quot;</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 定义一个 Ini 对象，用于封装 ini 配置项</span></span><br><span class="line">    <span class="keyword">private</span> Ini ini;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Ini <span class="title">getIni</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.ini;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIni</span><span class="params">(Ini ini)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.ini = ini;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 当初始化时调用</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 从成员变量中获取 Ini 对象</span></span><br><span class="line">        Ini ini = getIni();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 从 web.xml 中获取配置文件位置（在 EnvironmentLoader 中已设置）</span></span><br><span class="line">        String[] configLocations = getConfigLocations();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 若成员变量中不存在，则从已定义的配置文件位置获取</span></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(ini)) &#123;</span><br><span class="line">            ini = getSpecifiedIni(configLocations);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 若已定义的配置文件中仍然不存在，则从默认的位置获取</span></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(ini)) &#123;</span><br><span class="line">            ini = getDefaultIni();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 若还不存在，则抛出异常</span></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(ini)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 初始化成员变量</span></span><br><span class="line">        setIni(ini);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 解析配置文件，完成初始化工作</span></span><br><span class="line">        configure();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Ini <span class="title">getSpecifiedIni</span><span class="params">(String[] configLocations)</span> <span class="keyword">throws</span> ConfigurationException </span>&#123;</span><br><span class="line">        Ini ini = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (configLocations != <span class="keyword">null</span> &amp;&amp; configLocations.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 只能通过第一个配置文件的位置来创建 Ini 对象，且必须有一个配置文件，否则就会报错</span></span><br><span class="line">            ini = createIni(configLocations[<span class="number">0</span>], <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ini;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Ini <span class="title">createIni</span><span class="params">(String configLocation, <span class="keyword">boolean</span> required)</span> <span class="keyword">throws</span> ConfigurationException </span>&#123;</span><br><span class="line">        Ini ini = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (configLocation != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 从指定路径下读取配置文件</span></span><br><span class="line">            ini = convertPathToIni(configLocation, required);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (required &amp;&amp; CollectionUtils.isEmpty(ini)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ini;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> Ini <span class="title">convertPathToIni</span><span class="params">(String path, <span class="keyword">boolean</span> required)</span> </span>&#123;</span><br><span class="line">        Ini ini = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(path)) &#123;</span><br><span class="line">            InputStream is = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">// 若路径不包括资源前缀（classpath:、url:、file:），则从 ServletContext 中读取，否则从这些资源路径下读取</span></span><br><span class="line">            <span class="keyword">if</span> (!ResourceUtils.hasResourcePrefix(path)) &#123;</span><br><span class="line">                is = getServletContextResourceStream(path);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    is = ResourceUtils.getInputStreamForPath(path);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (required) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将流中的数据加载到 Ini 对象中</span></span><br><span class="line">            <span class="keyword">if</span> (is != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ini = <span class="keyword">new</span> Ini();</span><br><span class="line">                ini.load(is);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (required) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ini;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> InputStream <span class="title">getServletContextResourceStream</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        InputStream is = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 需要将路径进行标准化</span></span><br><span class="line">        path = WebUtils.normalize(path);</span><br><span class="line">        ServletContext sc = getServletContext();</span><br><span class="line">        <span class="keyword">if</span> (sc != <span class="keyword">null</span>) &#123;</span><br><span class="line">            is = sc.getResourceAsStream(path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> is;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Ini <span class="title">getDefaultIni</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Ini ini = <span class="keyword">null</span>;</span><br><span class="line">        String[] configLocations = getDefaultConfigLocations();</span><br><span class="line">        <span class="keyword">if</span> (configLocations != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 先找到的先使用，后面的无需使用</span></span><br><span class="line">            <span class="keyword">for</span> (String location : configLocations) &#123;</span><br><span class="line">                ini = createIni(location, <span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">if</span> (!CollectionUtils.isEmpty(ini)) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ini;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">protected</span> String[] getDefaultConfigLocations() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[]&#123;</span><br><span class="line">            DEFAULT_WEB_INI_RESOURCE_PATH,              <span class="comment">// /WEB-INF/shiro.ini</span></span><br><span class="line">            IniFactorySupport.DEFAULT_INI_RESOURCE_PATH <span class="comment">// classpath:shiro.ini</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 清空这个 Bean 容器（一个 Map&lt;String, Object&gt; 对象，在 DefaultEnvironment 中定义）</span></span><br><span class="line">        <span class="keyword">this</span>.objects.clear();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 创建基于 Web 的 SecurityManager 对象（WebSecurityManager）</span></span><br><span class="line">        WebSecurityManager securityManager = createWebSecurityManager();</span><br><span class="line">        setWebSecurityManager(securityManager);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 初始化 Filter Chain 解析器（用于解析 Filter 规则）</span></span><br><span class="line">        FilterChainResolver resolver = createFilterChainResolver();</span><br><span class="line">        <span class="keyword">if</span> (resolver != <span class="keyword">null</span>) &#123;</span><br><span class="line">            setFilterChainResolver(resolver);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> WebSecurityManager <span class="title">createWebSecurityManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 通过工厂对象来创建 WebSecurityManager 实例</span></span><br><span class="line">        WebIniSecurityManagerFactory factory;</span><br><span class="line">        Ini ini = getIni();</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(ini)) &#123;</span><br><span class="line">            factory = <span class="keyword">new</span> WebIniSecurityManagerFactory();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            factory = <span class="keyword">new</span> WebIniSecurityManagerFactory(ini);</span><br><span class="line">        &#125;</span><br><span class="line">        WebSecurityManager wsm = (WebSecurityManager) factory.getInstance();</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 从工厂中获取 Bean Map 并将其放入 Bean 容器中</span></span><br><span class="line">        Map&lt;String, ?&gt; beans = factory.getBeans();</span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(beans)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.objects.putAll(beans);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> wsm;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> FilterChainResolver <span class="title">createFilterChainResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        FilterChainResolver resolver = <span class="keyword">null</span>;</span><br><span class="line">        Ini ini = getIni();</span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(ini)) &#123;</span><br><span class="line">            <span class="comment">// Filter 可以从 [urls] 或 [filters] 片段中读取</span></span><br><span class="line">            Ini.Section urls = ini.getSection(IniFilterChainResolverFactory.URLS);</span><br><span class="line">            Ini.Section filters = ini.getSection(IniFilterChainResolverFactory.FILTERS);</span><br><span class="line">            <span class="keyword">if</span> (!CollectionUtils.isEmpty(urls) || !CollectionUtils.isEmpty(filters)) &#123;</span><br><span class="line">                <span class="comment">// 通过工厂对象创建 FilterChainResolver 实例</span></span><br><span class="line">                IniFilterChainResolverFactory factory = <span class="keyword">new</span> IniFilterChainResolverFactory(ini, <span class="keyword">this</span>.objects);</span><br><span class="line">                resolver = factory.getInstance();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resolver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看来 IniWebEnvironment 就是为了：</p>
<ol>
<li><p>查找并加载 shiro.ini 配置文件，首先从自身成员变量里查找，然后从 web.xml 中查找，然后从 /WEB-INF 下查找，然后从 classpath 下查找，若均未找到，则直接报错。</p>
</li>
<li><p>当找到了 ini 配置文件后就开始解析，此时构造了一个 Bean 容器（相当于一个轻量级的 IOC 容器），最终的目标是为了创建 WebSecurityManager 对象与 FilterChainResolver 对象，创建过程使用了 Abstract Factory 模式</p>
</li>
</ol>
<h4 id="Abstract-Factory"><a href="#Abstract-Factory" class="headerlink" title="Abstract Factory"></a>Abstract Factory</h4><p><img src="http://static.oschina.net/uploads/space/2014/0318/163354_8Zjs_223750.png" alt="img"></p>
<p>其中有两个 Factory 需要关注：<br>- WebIniSecurityManagerFactory 用于创建 WebSecurityManager。<br>- IniFilterChainResolverFactory 用于创建 FilterChainResolver。</p>
<p>通过以上分析，相信 EnvironmentLoaderListener 已经不再神秘了，无非就是在容器启动时创建 WebEnvironment 对象，并由该对象来读取 Shiro 配置文件，创建WebSecurityManager 与 FilterChainResolver 对象，它们都在后面将要出现的 ShiroFilter 中起到了重要作用。</p>
<p>从 web.xml 中同样可以得知，ShiroFilter 是整个 Shiro 框架的门面，因为它拦截了所有的请求，后面是需要 Authentication（认证）还是需要 Authorization（授权）都由它说了算。</p>
<h3 id="shiro-filter"><a href="#shiro-filter" class="headerlink" title="shiro filter"></a>shiro filter</h3><p>在上一篇中，我们分析了 Shiro Web 应用的入口 —— EnvironmentLoaderListener，它是一个 ServletContextListener，在 Web 容器启动的时候，它为我们创建了两个非常重要的对象：</p>
<ul>
<li><p>WebSecurityManager：它是用于 Web 环境的 SecurityManager 对象，通过读取 shiro.ini 中 [main] 片段生成的，我们可以通过 SecurityUtils.getSecurityManager 方法获取该对象。</p>
</li>
<li><p>FilterChainResolver：它是 shiro.ini 中 [urls] 片段所配置的 Filter Chain 的解析器，可对一个 URL 配置一个或多个 Filter（用逗号分隔），Shiro 也为我们提供了几个默认的 Filter。</p>
<p>Shiro Web 的第二个核心对象 —— ShiroFilter，它是在整个 Shiro Web 应用中请求的门户，也就是说，所有的请求都会被 ShiroFilter 拦截并进行相应的链式处理。</p>
</li>
</ul>
<p><img src="http://static.oschina.net/uploads/space/2014/0321/154813_mpy9_223750.png" alt="img"></p>
<h4 id="filter接口"><a href="#filter接口" class="headerlink" title="filter接口"></a>filter接口</h4><p>上图可见，ShiroFilter 往上竟然有五层，最上层是 Filter（即 javax.servlet.Filter），它是 Servlet 规范中的 Filter 接口，代码如下：<!--只有实现的sevlet的filter接口，才能被web容器识别和加载为filter--></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public interface Filter &#123;</span><br><span class="line"></span><br><span class="line">    void init(FilterConfig filterConfig) throws ServletException;</span><br><span class="line"></span><br><span class="line">    void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException;</span><br><span class="line"></span><br><span class="line">    void destroy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Filter 接口中的三个方法分别在 Filter 生命周期的三个时期内由 Web 容器来调用，分别是：初始化、执行、销毁。</p>
<p>但与 Filter 接口同一级别下竟然还有一个名为 ServletContextSupport 的类，它又是起什么作用的呢？</p>
<h4 id="封装ServletContext"><a href="#封装ServletContext" class="headerlink" title="封装ServletContext"></a>封装ServletContext</h4><p>打开 ServletContextSupport 的源码便知，它是 Shiro 为了封装 ServletContext 的而提供的一个类，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 封装 ServletContext</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class ServletContextSupport &#123;</span><br><span class="line"></span><br><span class="line">    private ServletContext servletContext;</span><br><span class="line"></span><br><span class="line">    public ServletContext getServletContext() &#123;</span><br><span class="line">        return servletContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setServletContext(ServletContext servletContext) &#123;</span><br><span class="line">        this.servletContext &#x3D; servletContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(&#123;&quot;UnusedDeclaration&quot;&#125;)</span><br><span class="line">    protected String getContextInitParam(String paramName) &#123;</span><br><span class="line">        return getServletContext().getInitParameter(paramName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private ServletContext getRequiredServletContext() &#123;</span><br><span class="line">        ServletContext servletContext &#x3D; getServletContext();</span><br><span class="line">        if (servletContext &#x3D;&#x3D; null) &#123;</span><br><span class="line">            throw new IllegalStateException();</span><br><span class="line">        &#125;</span><br><span class="line">        return servletContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(&#123;&quot;UnusedDeclaration&quot;&#125;)</span><br><span class="line">    protected void setContextAttribute(String key, Object value) &#123;</span><br><span class="line">        if (value &#x3D;&#x3D; null) &#123;</span><br><span class="line">            removeContextAttribute(key);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            getRequiredServletContext().setAttribute(key, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(&#123;&quot;UnusedDeclaration&quot;&#125;)</span><br><span class="line">    protected Object getContextAttribute(String key) &#123;</span><br><span class="line">        return getRequiredServletContext().getAttribute(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void removeContextAttribute(String key) &#123;</span><br><span class="line">        getRequiredServletContext().removeAttribute(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return toStringBuilder().toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected StringBuilder toStringBuilder() &#123;</span><br><span class="line">        return new StringBuilder(super.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>通过这个类，我们可以方便的操纵 ServletContext 对象（使用其中的属性），那么这个 ServletContext 对象又是如何来初始化的呢？</p>
<p>不妨看看 Filter 与 ServletContextSupport 的子类 AbstractFilter 吧，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 初始化 ServletContext 并封装 FilterConfig</span><br><span class="line"> *&#x2F;</span><br><span class="line">public abstract class AbstractFilter extends ServletContextSupport implements Filter &#123;</span><br><span class="line"></span><br><span class="line">    protected FilterConfig filterConfig;</span><br><span class="line"></span><br><span class="line">    public FilterConfig getFilterConfig() &#123;</span><br><span class="line">        return filterConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setFilterConfig(FilterConfig filterConfig) &#123;</span><br><span class="line">        &#x2F;&#x2F; 初始化 FilterConfig 与 ServletContext</span><br><span class="line">        this.filterConfig &#x3D; filterConfig;</span><br><span class="line">        setServletContext(filterConfig.getServletContext());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected String getInitParam(String paramName) &#123;</span><br><span class="line">        &#x2F;&#x2F; 从 FilterConfig 中获取初始参数</span><br><span class="line">        FilterConfig config &#x3D; getFilterConfig();</span><br><span class="line">        if (config !&#x3D; null) &#123;</span><br><span class="line">            return StringUtils.clean(config.getInitParameter(paramName));</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final void init(FilterConfig filterConfig) throws ServletException &#123;</span><br><span class="line">        &#x2F;&#x2F; 初始化 FilterConfig</span><br><span class="line">        setFilterConfig(filterConfig);</span><br><span class="line">        try &#123;</span><br><span class="line">            &#x2F;&#x2F; 在子类中实现该模板方法</span><br><span class="line">            onFilterConfigSet();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            if (e instanceof ServletException) &#123;</span><br><span class="line">                throw (ServletException) e;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                throw new ServletException(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void onFilterConfigSet() throws Exception &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void destroy() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>看到这个类的第一感觉就是，它对 FilterConfig 进行了封装，为什么要封装 FilterConfig 呢？就是想通过它来获取 ServletContext。可见，在 init 方法中完成了 FilterConfig 的初始化，并提供了一个名为 onFilterConfigSet 的模板方法，让它的子类去实现其中的细节。</p>
<p>在阅读 AbstractFilter 的子类 NameableFilter 的源码之前，不妨先看看 NameableFilter 实现了一个很有意思的接口 Nameable，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 确保实现该接口的类可进行命名（具有唯一的名称）</span><br><span class="line"> *&#x2F;</span><br><span class="line">public interface Nameable &#123;</span><br><span class="line"></span><br><span class="line">    void setName(String name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>仅提供了一个 setName 的方法，目的就是为了让其子类能够提供一个唯一的 Filter Name，如果子类不提供怎么办呢？</p>
<p>相信 Nameable 的实现类也就是 AbstractFilter 的子类 NameableFilter 会告诉我们想要的答案，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 提供 Filter Name 的 get&#x2F;set 方法</span><br><span class="line"> *&#x2F;</span><br><span class="line">public abstract class NameableFilter extends AbstractFilter implements Nameable &#123;</span><br><span class="line"></span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">    protected String getName() &#123;</span><br><span class="line">        &#x2F;&#x2F; 若成员变量 name 为空，则从 FilterConfig 中获取 Filter Name</span><br><span class="line">        if (this.name &#x3D;&#x3D; null) &#123;</span><br><span class="line">            FilterConfig config &#x3D; getFilterConfig();</span><br><span class="line">            if (config !&#x3D; null) &#123;</span><br><span class="line">                this.name &#x3D; config.getFilterName();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return this.name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setName(String name) &#123;</span><br><span class="line">        this.name &#x3D; name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected StringBuilder toStringBuilder() &#123;</span><br><span class="line">        String name &#x3D; getName();</span><br><span class="line">        if (name &#x3D;&#x3D; null) &#123;</span><br><span class="line">            return super.toStringBuilder();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            StringBuilder sb &#x3D; new StringBuilder();</span><br><span class="line">            sb.append(name);</span><br><span class="line">            return sb;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>看到了 NameableFilter 中的 getName 方法，我们应该清楚了，每个 Filter 必须有一个名字，可通过 setName 方法设置的，如果不设置就取该 Filter 默认的名字，也就是在 web.xml 中配置的 filter-name 了。此外，这里还通过一个 toStringBuilder 方法完成了类似 toString 方法，不过暂时还没什么用途，可能以后会有用。</p>
<p>以上这一切都是为了让每个 Filter 有一个名字，而且这个名字最好是唯一的（这一点在 Shiro 源码中没有得到控制）。此外，在 shiro.ini 的 [urls] 片段的配置满足一定规则的，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[urls]</span><br><span class="line">&#x2F;foo &#x3D; ssl, authc</span><br></pre></td></tr></table></figure>



<p>等号左边的是 URL，右边的是 Filter Chian，一个或多个 Filter，每个 Filter 用逗号进行分隔。</p>
<p>对于 /foo 这个 URL 而言，可先后通过 ssl 与 authc 这两个 Filter。如果我们同时配置了两个 ssl，这个 URL 会被 ssl 拦截两次吗？答案是否定的，因为 Shiro 为我们提供了一个“一次性 Filter”的原则，也就是保证了每个请求只能被同一个 Filter 拦截一次，而且仅此一次。</p>
<p>这样的机制是如何实现的呢？我们不妨看看 NameableFilter 的子类 OncePerRequestFilter 吧，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 确保每个请求只能被 Filter 过滤一次</span><br><span class="line"> *&#x2F;</span><br><span class="line">public abstract class OncePerRequestFilter extends NameableFilter &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 已过滤属性的后缀名</span><br><span class="line">    public static final String ALREADY_FILTERED_SUFFIX &#x3D; &quot;.FILTERED&quot;;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 是否开启过滤功能</span><br><span class="line">    private boolean enabled &#x3D; true;</span><br><span class="line"></span><br><span class="line">    public boolean isEnabled() &#123;</span><br><span class="line">        return enabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setEnabled(boolean enabled) &#123;</span><br><span class="line">        this.enabled &#x3D; enabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public final void doFilter(ServletRequest request, ServletResponse response, FilterChain filterChain) throws ServletException, IOException &#123;</span><br><span class="line">        &#x2F;&#x2F; 获取 Filter 已过滤的属性名</span><br><span class="line">        String alreadyFilteredAttributeName &#x3D; getAlreadyFilteredAttributeName();</span><br><span class="line">        &#x2F;&#x2F; 判断是否已过滤</span><br><span class="line">        if (request.getAttribute(alreadyFilteredAttributeName) !&#x3D; null) &#123;</span><br><span class="line">            &#x2F;&#x2F; 若已过滤，则进入 FilterChain 中下一个 Filter</span><br><span class="line">            filterChain.doFilter(request, response);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            &#x2F;&#x2F; 若未过滤，则判断是否未开启过滤功能（其中 shouldNotFilter 方法将被废弃，由 isEnabled 方法取代）</span><br><span class="line">            if (!isEnabled(request, response) || shouldNotFilter(request)) &#123;</span><br><span class="line">                &#x2F;&#x2F; 若未开启，则进入 FilterChain 中下一个 Filter</span><br><span class="line">                filterChain.doFilter(request, response);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                &#x2F;&#x2F; 若已开启，则将已过滤属性设置为 true（只要保证 Request 中有这个属性即可）</span><br><span class="line">                request.setAttribute(alreadyFilteredAttributeName, Boolean.TRUE);</span><br><span class="line">                try &#123;</span><br><span class="line">                    &#x2F;&#x2F; 在子类中执行具体的过滤操作</span><br><span class="line">                    doFilterInternal(request, response, filterChain);</span><br><span class="line">                &#125; finally &#123;</span><br><span class="line">                    &#x2F;&#x2F; 当前 Filter 执行结束需移除 Request 中的已过滤属性</span><br><span class="line">                    request.removeAttribute(alreadyFilteredAttributeName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected String getAlreadyFilteredAttributeName() &#123;</span><br><span class="line">        String name &#x3D; getName();</span><br><span class="line">        if (name &#x3D;&#x3D; null) &#123;</span><br><span class="line">            name &#x3D; getClass().getName();</span><br><span class="line">        &#125;</span><br><span class="line">        return name + ALREADY_FILTERED_SUFFIX;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(&#123;&quot;UnusedParameters&quot;&#125;)</span><br><span class="line">    protected boolean isEnabled(ServletRequest request, ServletResponse response) throws ServletException, IOException &#123;</span><br><span class="line">        return isEnabled();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Deprecated</span><br><span class="line">    @SuppressWarnings(&#123;&quot;UnusedDeclaration&quot;&#125;)</span><br><span class="line">    protected boolean shouldNotFilter(ServletRequest request) throws ServletException &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected abstract void doFilterInternal(ServletRequest request, ServletResponse response, FilterChain chain) throws ServletException, IOException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>如何确保每个请求只会被同一个 Filter 拦截一次呢？Shiro 提供了一个超简单的解决方案：在 Requet 中放置一个后缀为 .FILTERED 的属性，在执行具体拦截操作（即 doFilterInternal 方法）之前放入该属性，执行完毕后移除该属性。</p>
<p>在 Shiro 的 Filter Chian 配置中，如果我们想禁用某个 Filter，如何实现呢？OncePerRequestFilter 也为我们提供了一个 enabled 的属性，方便我们可以在 shiro.ini 中随时禁用某个 Filter，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[main]</span><br><span class="line">ssl.enabled &#x3D; false</span><br><span class="line"></span><br><span class="line">[urls]</span><br><span class="line">&#x2F;foo &#x3D; ssl, authc</span><br></pre></td></tr></table></figure>



<p>这样一来 ssl 这个 Filter 就被我们给禁用了，以后想开启 ssl 的话，完全不需要在 urls 配置中一个个手工来添加，只需把 ssl.enabled 设置为 true，或注释掉该行，或直接删除该行即可。</p>
<p>可见，OncePerRequestFilter 给我们提供了一个模板方法 doFilterInternal，在其子类中我们需要实现该方法的具体细节，那么谁来实现呢？不妨继续看下面的 AbstractShiroFilter 吧，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 确保可通过 SecurityUtils 获取 SecurityManager，并执行过滤器操作</span><br><span class="line"> *&#x2F;</span><br><span class="line">public abstract class AbstractShiroFilter extends OncePerRequestFilter &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 是否可以通过 SecurityUtils 获取 SecurityManager</span><br><span class="line">    private static final String STATIC_INIT_PARAM_NAME &#x3D; &quot;staticSecurityManagerEnabled&quot;;</span><br><span class="line"></span><br><span class="line">    private WebSecurityManager securityManager;</span><br><span class="line">    private FilterChainResolver filterChainResolver;</span><br><span class="line">    private boolean staticSecurityManagerEnabled;</span><br><span class="line"></span><br><span class="line">    protected AbstractShiroFilter() &#123;</span><br><span class="line">        this.staticSecurityManagerEnabled &#x3D; false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public WebSecurityManager getSecurityManager() &#123;</span><br><span class="line">        return securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setSecurityManager(WebSecurityManager sm) &#123;</span><br><span class="line">        this.securityManager &#x3D; sm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public FilterChainResolver getFilterChainResolver() &#123;</span><br><span class="line">        return filterChainResolver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setFilterChainResolver(FilterChainResolver filterChainResolver) &#123;</span><br><span class="line">        this.filterChainResolver &#x3D; filterChainResolver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean isStaticSecurityManagerEnabled() &#123;</span><br><span class="line">        return staticSecurityManagerEnabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setStaticSecurityManagerEnabled(boolean staticSecurityManagerEnabled) &#123;</span><br><span class="line">        this.staticSecurityManagerEnabled &#x3D; staticSecurityManagerEnabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 这是 AbstractFilter 提供的在 init 时需要执行的方法</span><br><span class="line">    protected final void onFilterConfigSet() throws Exception &#123;</span><br><span class="line">        &#x2F;&#x2F; 从 web.xml 中读取 staticSecurityManagerEnabled 参数（默认为 false）</span><br><span class="line">        applyStaticSecurityManagerEnabledConfig();</span><br><span class="line">        &#x2F;&#x2F; 初始化（在子类中实现）</span><br><span class="line">        init();</span><br><span class="line">        &#x2F;&#x2F; 确保 SecurityManager 必须存在</span><br><span class="line">        ensureSecurityManager();</span><br><span class="line">        &#x2F;&#x2F; 若已开启 static 标志，则将当前的 SecurityManager 放入 SecurityUtils 中，以后可以随时获取</span><br><span class="line">        if (isStaticSecurityManagerEnabled()) &#123;</span><br><span class="line">            SecurityUtils.setSecurityManager(getSecurityManager());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void applyStaticSecurityManagerEnabledConfig() &#123;</span><br><span class="line">        String value &#x3D; getInitParam(STATIC_INIT_PARAM_NAME);</span><br><span class="line">        if (value !&#x3D; null) &#123;</span><br><span class="line">            Boolean b &#x3D; Boolean.valueOf(value);</span><br><span class="line">            if (b !&#x3D; null) &#123;</span><br><span class="line">                setStaticSecurityManagerEnabled(b);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void init() throws Exception &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void ensureSecurityManager() &#123;</span><br><span class="line">        &#x2F;&#x2F; 首先获取当前的 SecurityManager，若不存在，则创建默认的 SecurityManager（即 DefaultWebSecurityManager）</span><br><span class="line">        WebSecurityManager securityManager &#x3D; getSecurityManager();</span><br><span class="line">        if (securityManager &#x3D;&#x3D; null) &#123;</span><br><span class="line">            securityManager &#x3D; createDefaultSecurityManager();</span><br><span class="line">            setSecurityManager(securityManager);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected WebSecurityManager createDefaultSecurityManager() &#123;</span><br><span class="line">        return new DefaultWebSecurityManager();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 这是 OncePerRequestFilter 提供的在 doFilter 时需要执行的方法</span><br><span class="line">    protected void doFilterInternal(ServletRequest servletRequest, ServletResponse servletResponse, final FilterChain chain) throws ServletException, IOException &#123;</span><br><span class="line">        Throwable t &#x3D; null;</span><br><span class="line">        try &#123;</span><br><span class="line">            &#x2F;&#x2F; 返回被 Shiro 包装过的 Request 与 Response 对象</span><br><span class="line">            final ServletRequest request &#x3D; prepareServletRequest(servletRequest, servletResponse, chain);</span><br><span class="line">            final ServletResponse response &#x3D; prepareServletResponse(request, servletResponse, chain);</span><br><span class="line">            &#x2F;&#x2F; 创建 Shiro 的 Subject 对象</span><br><span class="line">            final Subject subject &#x3D; createSubject(request, response);</span><br><span class="line">            &#x2F;&#x2F; 使用异步的方式执行相关操作</span><br><span class="line">            subject.execute(new Callable() &#123;</span><br><span class="line">                public Object call() throws Exception &#123;</span><br><span class="line">                    &#x2F;&#x2F; 更新 Session 的最后访问时间</span><br><span class="line">                    updateSessionLastAccessTime(request, response);</span><br><span class="line">                    &#x2F;&#x2F; 执行 Shiro 的 Filter Chain</span><br><span class="line">                    executeChain(request, response, chain);</span><br><span class="line">                    return null;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; catch (ExecutionException ex) &#123;</span><br><span class="line">            t &#x3D; ex.getCause();</span><br><span class="line">        &#125; catch (Throwable throwable) &#123;</span><br><span class="line">            t &#x3D; throwable;</span><br><span class="line">        &#125;</span><br><span class="line">        if (t !&#x3D; null) &#123;</span><br><span class="line">            if (t instanceof ServletException) &#123;</span><br><span class="line">                throw (ServletException) t;</span><br><span class="line">            &#125;</span><br><span class="line">            if (t instanceof IOException) &#123;</span><br><span class="line">                throw (IOException) t;</span><br><span class="line">            &#125;</span><br><span class="line">            throw new ServletException(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(&#123;&quot;UnusedDeclaration&quot;&#125;)</span><br><span class="line">    protected ServletRequest prepareServletRequest(ServletRequest request, ServletResponse response, FilterChain chain) &#123;</span><br><span class="line">        ServletRequest toUse &#x3D; request;</span><br><span class="line">        if (request instanceof HttpServletRequest) &#123;</span><br><span class="line">            &#x2F;&#x2F; 获取包装后的 Request 对象（使用 ShiroHttpServletRequest 进行包装）</span><br><span class="line">            HttpServletRequest http &#x3D; (HttpServletRequest) request;</span><br><span class="line">            toUse &#x3D; wrapServletRequest(http);</span><br><span class="line">        &#125;</span><br><span class="line">        return toUse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected ServletRequest wrapServletRequest(HttpServletRequest orig) &#123;</span><br><span class="line">        return new ShiroHttpServletRequest(orig, getServletContext(), isHttpSessions());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected boolean isHttpSessions() &#123;</span><br><span class="line">        return getSecurityManager().isHttpSessionMode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(&#123;&quot;UnusedDeclaration&quot;&#125;)</span><br><span class="line">    protected ServletResponse prepareServletResponse(ServletRequest request, ServletResponse response, FilterChain chain) &#123;</span><br><span class="line">        ServletResponse toUse &#x3D; response;</span><br><span class="line">        if (!isHttpSessions() &amp;&amp; (request instanceof ShiroHttpServletRequest) &amp;&amp; (response instanceof HttpServletResponse)) &#123;</span><br><span class="line">            &#x2F;&#x2F; 获取包装后的 Response 对象（使用 ShiroHttpServletResponse 进行包装）</span><br><span class="line">            toUse &#x3D; wrapServletResponse((HttpServletResponse) response, (ShiroHttpServletRequest) request);</span><br><span class="line">        &#125;</span><br><span class="line">        return toUse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected ServletResponse wrapServletResponse(HttpServletResponse orig, ShiroHttpServletRequest request) &#123;</span><br><span class="line">        return new ShiroHttpServletResponse(orig, getServletContext(), request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected WebSubject createSubject(ServletRequest request, ServletResponse response) &#123;</span><br><span class="line">        return new WebSubject.Builder(getSecurityManager(), request, response).buildWebSubject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @SuppressWarnings(&#123;&quot;UnusedDeclaration&quot;&#125;)</span><br><span class="line">    protected void updateSessionLastAccessTime(ServletRequest request, ServletResponse response) &#123;</span><br><span class="line">        &#x2F;&#x2F; 仅对本地 Session 做如下操作</span><br><span class="line">        if (!isHttpSessions()) &#123;</span><br><span class="line">            &#x2F;&#x2F; 获取 Subject（实际上是从 ThreadLocal 中获取的）</span><br><span class="line">            Subject subject &#x3D; SecurityUtils.getSubject();</span><br><span class="line">            if (subject !&#x3D; null) &#123;</span><br><span class="line">                &#x2F;&#x2F; 从 Subject 中获取 Session</span><br><span class="line">                Session session &#x3D; subject.getSession(false);</span><br><span class="line">                if (session !&#x3D; null) &#123;</span><br><span class="line">                    &#x2F;&#x2F; 更新 Session 对象的 lastAccessTime 属性</span><br><span class="line">                    session.touch();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void executeChain(ServletRequest request, ServletResponse response, FilterChain origChain) throws IOException, ServletException &#123;</span><br><span class="line">        &#x2F;&#x2F; 获取 Shiro 代理后的 FilterChain 对象，并进行链式处理</span><br><span class="line">        FilterChain chain &#x3D; getExecutionChain(request, response, origChain);</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected FilterChain getExecutionChain(ServletRequest request, ServletResponse response, FilterChain origChain) &#123;</span><br><span class="line">        FilterChain chain &#x3D; origChain;</span><br><span class="line">        &#x2F;&#x2F; 获取 FilterChainResolver，若不存在，则返回原始的 FilterChain</span><br><span class="line">        FilterChainResolver resolver &#x3D; getFilterChainResolver();</span><br><span class="line">        if (resolver &#x3D;&#x3D; null) &#123;</span><br><span class="line">            return origChain;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 通过 FilterChainResolver 获取 ProxiedFilterChain</span><br><span class="line">        FilterChain resolved &#x3D; resolver.getChain(request, response, origChain);</span><br><span class="line">        if (resolved !&#x3D; null) &#123;</span><br><span class="line">            chain &#x3D; resolved;</span><br><span class="line">        &#125;</span><br><span class="line">        return chain;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这个 AbstractShiroFilter 类代码稍微有点长，因为它干了许多的事情，主要实现了两个模板方法：onFilterConfigSet 与 doFilterInternal，以上代码中均已对它们做了详细的注释。</p>
<p>其中，在 onFilterConfigSet 中实际上提供了一个框架，只是将 SecurityManager 放入 SecurityUtils 这个工具类中，至于具体行为还是放在子类的 init 方法中去实现，而这个子类就是 ShiroFilter，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 初始化过滤器</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class ShiroFilter extends AbstractShiroFilter &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void init() throws Exception &#123;</span><br><span class="line">        &#x2F;&#x2F; 从 ServletContext 中获取 WebEnvironment（该对象已通过 EnvironmentLoader 创建）</span><br><span class="line">        WebEnvironment env &#x3D; WebUtils.getRequiredWebEnvironment(getServletContext());</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 将 WebEnvironment 中的 WebSecurityManager 放入 AbstractShiroFilter 中</span><br><span class="line">        setSecurityManager(env.getWebSecurityManager());</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 将 WebEnvironment 中的 FilterChainResolver 放入 AbstractShiroFilter 中</span><br><span class="line">        FilterChainResolver resolver &#x3D; env.getFilterChainResolver();</span><br><span class="line">        if (resolver !&#x3D; null) &#123;</span><br><span class="line">            setFilterChainResolver(resolver);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在 ShiroFilter 中只用做初始化的行为，就是从 WebEnvironment 中分别获取 WebSecurityManager 与 FilterChainResolver，其它的事情都由它的父类去实现了。</p>
<p>到此为止，ShiroFilter 的源码已基本分析完毕，当然还有些非常有意思的代码，这里没有进行分析，例如：</p>
<ul>
<li>通过 ShiroHttpServletRequest 来包装 Request</li>
<li>通过 ShiroHttpServletResponse 来包装 Response</li>
<li>通过 Session 来代理 HttpSession</li>
<li>提供 FilterChain 的代理机制</li>
<li>使用 ThreadContext 来保证线程安全</li>
</ul>
<p>这些有意思的代码，我就不继续分析了，留点滋味让大家去慢慢品尝吧！</p>
<p>最后需要补充说明的是，Shiro 的 Filter 架构体系是非常庞大的，这里仅对 ShiroFilter 进行了分析，整个 Filter 静态结构看起来是这样的：</p>
<p><img src="http://static.oschina.net/uploads/space/2014/0321/172903_VINL_223750.png" alt="img"></p>
<p>可见，在 OncePerRequestFilter 下有两个分支，本文只分析了 ShiroFilter 这个分支，另外还有一个 AdviceFilter 分支，它提供了 AOP 功能的 Filter，这些 Filter 就是 Shiro 为我们提供的默认 Filter：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>类名</th>
</tr>
</thead>
<tbody><tr>
<td>anon</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authc/AnonymousFilter.html">org.apache.shiro.web.filter.authc.AnonymousFilter</a></td>
</tr>
<tr>
<td>authc</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authc/FormAuthenticationFilter.html">org.apache.shiro.web.filter.authc.FormAuthenticationFilter</a></td>
</tr>
<tr>
<td>authcBasic</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authc/BasicHttpAuthenticationFilter.html">org.apache.shiro.web.filter.authc.BasicHttpAuthenticationFilter</a></td>
</tr>
<tr>
<td>logout</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authc/LogoutFilter.html">org.apache.shiro.web.filter.authc.LogoutFilter</a></td>
</tr>
<tr>
<td>noSessionCreation</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/session/NoSessionCreationFilter.html">org.apache.shiro.web.filter.session.NoSessionCreationFilter</a></td>
</tr>
<tr>
<td>perms</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authz/PermissionsAuthorizationFilter.html">org.apache.shiro.web.filter.authz.PermissionsAuthorizationFilter</a></td>
</tr>
<tr>
<td>port</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authz/PortFilter.html">org.apache.shiro.web.filter.authz.PortFilter</a></td>
</tr>
<tr>
<td>rest</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authz/HttpMethodPermissionFilter.html">org.apache.shiro.web.filter.authz.HttpMethodPermissionFilter</a></td>
</tr>
<tr>
<td>roles</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authz/RolesAuthorizationFilter.html">org.apache.shiro.web.filter.authz.RolesAuthorizationFilter</a></td>
</tr>
<tr>
<td>ssl</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authz/SslFilter.html">org.apache.shiro.web.filter.authz.SslFilter</a></td>
</tr>
<tr>
<td>user</td>
<td><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authc/UserFilter.html">org.apache.shiro.web.filter.authc.UserFilter</a></td>
</tr>
</tbody></table>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><h3 id="前后端分离"><a href="#前后端分离" class="headerlink" title="前后端分离"></a>前后端分离</h3><p>to determine the identity of the user is through the sessionId, and the sessionId is stored in the cookie, we can return the sessionId as the response header to the front end after login, each request is accompanied by this information, then we customize a SessionManager, overwrite His getSessionId method can be:<br>Return the sessionId to the frontend after logging in:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@PostMapping(<span class="string">&quot;login&quot;</span>)</span><br><span class="line">@Responebody</span><br><span class="line">    public Result login(<span class="built_in">String</span> username, <span class="built_in">String</span> password, HttpServletResponse response)&#123;</span><br><span class="line">        Result result = <span class="literal">null</span>;</span><br><span class="line">        UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(username,password);</span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            subject.login(token);</span><br><span class="line">            Serializable id = subject.getSession().getId();</span><br><span class="line">            response.setHeader(<span class="string">&quot;token&quot;</span>,id.toString());<span class="regexp">/ /</span> Get the state <span class="keyword">of</span> the sessionId, <span class="keyword">return</span> to the front end</span><br><span class="line">            result = ResultGenerator.getSuucessResult();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            result = ResultGenerator.getFailResult(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Custom sessionManager, the way to get the sessionId is no longer a heavy cookie but in the requsetHeader:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MyWebSessionManager</span> <span class="keyword">extends</span> <span class="title">DefaultWebSessionManager</span> </span>&#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected Serializable getSessionId(ServletRequest request, ServletResponse response) &#123;</span><br><span class="line">        HttpServletRequest httpServletRequest = WebUtils.toHttp(request);</span><br><span class="line">        <span class="built_in">String</span> token = httpServletRequest.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;token：&quot;</span>+token);</span><br><span class="line">        request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID_SOURCE, <span class="string">&quot;token&quot;</span>);</span><br><span class="line">        request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID, token);</span><br><span class="line">        request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID_IS_VALID, <span class="built_in">Boolean</span>.TRUE);</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Set to use the change sessionManager, generic can also use ioc injection without new:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">    public DefaultWebSecurityManager webSecurityManager(MyRealm myRealm)&#123;</span><br><span class="line">        DefaultWebSecurityManager webSecurityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">        MyWebSessionManager webSessionManager = <span class="keyword">new</span> MyWebSessionManager();<span class="regexp">/ /</span> Use a custom sessionManager</span><br><span class="line">        webSessionManager.setGlobalSessionTimeout(<span class="number">360000</span>l);<span class="regexp">/ /</span> <span class="built_in">Set</span> the session expiration time <span class="number">1</span> hour</span><br><span class="line">        webSecurityManager.setSessionManager(webSessionManager);</span><br><span class="line">        webSecurityManager.setRealm(myRealm);</span><br><span class="line">        <span class="keyword">return</span> webSecurityManager;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>With such a simple configuration, most of the rights management of shiro can be realized by separating the front and back ends.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/22/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81/subject-login-%E7%99%BB%E9%99%86%E8%AE%A4%E8%AF%81%E6%88%90%E5%8A%9F%E5%90%8E%EF%BC%8C%E4%B8%8B%E4%B8%80%E6%AC%A1%E8%AF%B7%E6%B1%82%E5%A6%82%E4%BD%95%E7%9F%A5%E9%81%93%E6%98%AF%E9%82%A3%E4%B8%AA%E7%94%A8%E6%88%B7%E7%9A%84%E8%AF%B7%E6%B1%82%E5%91%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/22/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81/subject-login-%E7%99%BB%E9%99%86%E8%AE%A4%E8%AF%81%E6%88%90%E5%8A%9F%E5%90%8E%EF%BC%8C%E4%B8%8B%E4%B8%80%E6%AC%A1%E8%AF%B7%E6%B1%82%E5%A6%82%E4%BD%95%E7%9F%A5%E9%81%93%E6%98%AF%E9%82%A3%E4%B8%AA%E7%94%A8%E6%88%B7%E7%9A%84%E8%AF%B7%E6%B1%82%E5%91%A2/" class="post-title-link" itemprop="url">subject.login()登陆认证成功后，下一次请求如何知道是那个用户的请求呢</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-04-22 11:38:42 / Modified: 13:35:59" itemprop="dateCreated datePublished" datetime="2021-04-22T11:38:42+08:00">2021-04-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>总的来说，SecurityUtils.getSubject()是每个请求创建一个Subject, 并保存到ThreadContext的resources（ThreadLocal&lt;Map&lt;Object, Object&gt;&gt;）变量中，也就是一个http请求一个subject,并绑定到当前线程。 </p>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>问题来了：.subject.login()登陆认证成功后，下一次请求如何知道是那个用户的请求呢？ </p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>首先给出内部原理：1个请求1个Subject原理:由于ShiroFilterFactoryBean本质是个AbstractShiroFilter过滤器，所以每次请求都会执行doFilterInternal里面的createSubject方法。 </p>
<h4 id="猜想：因为subject是绑定到当前线程-这肯定需要一个中介存储状态"><a href="#猜想：因为subject是绑定到当前线程-这肯定需要一个中介存储状态" class="headerlink" title="猜想：因为subject是绑定到当前线程,这肯定需要一个中介存储状态"></a>猜想：因为subject是绑定到当前线程,这肯定需要一个中介存储状态</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Subject <span class="title">getSubject</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">    Subject subject = ThreadContext.getSubject();  </span><br><span class="line">    <span class="keyword">if</span> (subject == <span class="keyword">null</span>) &#123;  </span><br><span class="line">        subject = (<span class="keyword">new</span> Builder()).buildSubject();  </span><br><span class="line">        ThreadContext.bind(subject);  </span><br><span class="line">   &#125;  </span><br><span class="line">    <span class="keyword">return</span> subject;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadContext</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(ThreadContext.class);  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SECURITY_MANAGER_KEY = ThreadContext.class.getName() + <span class="string">&quot;_SECURITY_MANAGER_KEY&quot;</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SUBJECT_KEY = ThreadContext.class.getName() + <span class="string">&quot;_SUBJECT_KEY&quot;</span>;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Map&lt;Object, Object&gt;&gt; resources = <span class="keyword">new</span> ThreadContext.InheritableThreadLocalMap();  </span><br><span class="line">  </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h4 id="subject登陆成功后，下一次请求如何知道是那个用户的请求呢？"><a href="#subject登陆成功后，下一次请求如何知道是那个用户的请求呢？" class="headerlink" title="subject登陆成功后，下一次请求如何知道是那个用户的请求呢？"></a>subject登陆成功后，下一次请求如何知道是那个用户的请求呢？</h4><p>经过源码分析，核心实现如下DefaultSecurityManager类中： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Subject <span class="title">createSubject</span><span class="params">(SubjectContext subjectContext)</span> </span>&#123;  </span><br><span class="line">    SubjectContext context = <span class="keyword">this</span>.copy(subjectContext);  </span><br><span class="line">    context = <span class="keyword">this</span>.ensureSecurityManager(context);  </span><br><span class="line">    context = <span class="keyword">this</span>.resolveSession(context);  </span><br><span class="line">    context = <span class="keyword">this</span>.resolvePrincipals(context);  </span><br><span class="line">    Subject subject = <span class="keyword">this</span>.doCreateSubject(context);  </span><br><span class="line">    <span class="keyword">this</span>.save(subject);  </span><br><span class="line">    <span class="keyword">return</span> subject;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每次请求都会重新设置Session和Principals,看到这里大概就能猜到：如果是web工程，直接从web容器获取httpSession，然后再从httpSession获取Principals，本质就是从cookie获取用户信息，然后每次都设置Principal，这样就知道是哪个用户的请求，并知道这个用户有没有认证成功，–本质：依赖于浏览器的cookie来维护session的 </p>
<h3 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h3><h4 id="如果不是web容器的app-如何实现实现无状态的会话"><a href="#如果不是web容器的app-如何实现实现无状态的会话" class="headerlink" title="如果不是web容器的app,如何实现实现无状态的会话"></a>如果不是web容器的app,如何实现实现无状态的会话</h4><p>1.一般的作法会在header中带有一个token，或者是在参数中，后台根据这个token来进行校验这个用户的身份，但是这个时候，servlet中的session就无法保存，我们在这个时候，就要实现自己的会话创建，普通的作法就是重写session与request的接口，然后在过滤器在把它替换成自己的request,所以得到的session也是自己的session，然后根据token来创建和维护会话 </p>
<p>2.shiro实现： </p>
<p>重写shiro的sessionManage </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StatelessSessionManager</span> <span class="keyword">extends</span> <span class="title">DefaultWebSessionManager</span> </span>&#123;  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 这个是服务端要返回给客户端， </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String TOKEN_NAME = <span class="string">&quot;TOKEN&quot;</span>;  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 这个是客户端请求给服务端带的header </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String HEADER_TOKEN_NAME = <span class="string">&quot;token&quot;</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger LOG =         LoggerFactory.getLogger(StatelessSessionManager.class);  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Serializable <span class="title">getSessionId</span><span class="params">(SessionKey key)</span> </span>&#123;  </span><br><span class="line">        Serializable sessionId = key.getSessionId();  </span><br><span class="line">        <span class="keyword">if</span>(sessionId == <span class="keyword">null</span>)&#123;  </span><br><span class="line">            HttpServletRequest request = WebUtils.getHttpRequest(key);  </span><br><span class="line">            HttpServletResponse response = WebUtils.getHttpResponse(key);  </span><br><span class="line">            sessionId = <span class="keyword">this</span>.getSessionId(request,response);  </span><br><span class="line">        &#125;  </span><br><span class="line">        HttpServletRequest request = WebUtils.getHttpRequest(key);  </span><br><span class="line">        request.setAttribute(TOKEN_NAME,sessionId.toString());  </span><br><span class="line">        <span class="keyword">return</span> sessionId;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Serializable <span class="title">getSessionId</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> </span>&#123;  </span><br><span class="line">        HttpServletRequest request = (HttpServletRequest) servletRequest;  </span><br><span class="line">        String token = request.getHeader(HEADER_TOKEN_NAME);  </span><br><span class="line">        <span class="keyword">if</span>(token == <span class="keyword">null</span>)&#123;  </span><br><span class="line">            token = UUID.randomUUID().toString();  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//这段代码还没有去查看其作用，但是这是其父类中所拥有的代码，重写完后我复制了过来...开始  </span></span><br><span class="line">        request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID_SOURCE,  </span><br><span class="line">                ShiroHttpServletRequest.COOKIE_SESSION_ID_SOURCE);  </span><br><span class="line">        request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID, token);  </span><br><span class="line">        request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID_IS_VALID, Boolean.TRUE);  </span><br><span class="line">        request.setAttribute(ShiroHttpServletRequest.SESSION_ID_URL_REWRITING_ENABLED, isSessionIdUrlRewritingEnabled());  </span><br><span class="line">        <span class="comment">//这段代码还没有去查看其作用，但是这是其父类中所拥有的代码，重写完后我复制了过来...结束  </span></span><br><span class="line">        <span class="keyword">return</span> token;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p> 登录接口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@RequestMapping(&quot;&#x2F;&quot;)  </span><br><span class="line">public void login(@RequestParam(&quot;code&quot;)String code, HttpServletRequest request)&#123;  </span><br><span class="line">    Map&lt;String,Object&gt; data &#x3D; new HashMap&lt;&gt;();  </span><br><span class="line">    if(SecurityUtils.getSubject().isAuthenticated())&#123;  </span><br><span class="line">　　　　　　　　&#x2F;&#x2F;这里代码着已经登陆成功，所以自然不用再次认证，直接从rquest中取出就行了，  </span><br><span class="line">        data.put(StatelessSessionManager.HEADER_TOKEN_NAME,getServerToken());  </span><br><span class="line">        data.put(BIND,ShiroKit.getUser().getTel() !&#x3D; null);  </span><br><span class="line">        response(data);  </span><br><span class="line">    &#125;  </span><br><span class="line">    LOG.info(&quot;授权码为:&quot; + code);  </span><br><span class="line">    AuthorizationService authorizationService &#x3D; authorizationFactory.getAuthorizationService(Constant.clientType);  </span><br><span class="line">    UserDetail authorization &#x3D; authorizationService.authorization(code);  </span><br><span class="line">  </span><br><span class="line">    Oauth2UserDetail userDetail &#x3D; (Oauth2UserDetail) authorization;  </span><br><span class="line">  </span><br><span class="line">    loginService.login(userDetail);  </span><br><span class="line">    User user &#x3D; userService.saveUser(userDetail,Constant.clientType.toString());  </span><br><span class="line">    ShiroKit.getSession().setAttribute(ShiroKit.USER_DETAIL_KEY,userDetail);  </span><br><span class="line">    ShiroKit.getSession().setAttribute(ShiroKit.USER_KEY,user);  </span><br><span class="line">    data.put(BIND,user.getTel() !&#x3D; null);  </span><br><span class="line">　　　　&#x2F;&#x2F;这里的代码，必须放到login之执行，因为login后，才会创建session，才会得到最新的token咯  </span><br><span class="line">    data.put(StatelessSessionManager.HEADER_TOKEN_NAME,getServerToken());  </span><br><span class="line">    response(data);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfiguration</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> LifecycleBeanPostProcessor <span class="title">lifecycleBeanPostProcessor</span><span class="params">()</span></span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LifecycleBeanPostProcessor();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 此处注入一个realm </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> realm </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> SecurityManager <span class="title">securityManager</span><span class="params">(Realm realm)</span></span>&#123;  </span><br><span class="line">        DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();  </span><br><span class="line">        securityManager.setSessionManager(<span class="keyword">new</span> StatelessSessionManager());  </span><br><span class="line">        securityManager.setRealm(realm);  </span><br><span class="line">        <span class="keyword">return</span> securityManager;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">shiroFilterFactoryBean</span><span class="params">(SecurityManager securityManager)</span></span>&#123;  </span><br><span class="line">        ShiroFilterFactoryBean bean = <span class="keyword">new</span> ShiroFilterFactoryBean();  </span><br><span class="line">        bean.setSecurityManager(securityManager);  </span><br><span class="line">  </span><br><span class="line">        Map&lt;String,String&gt; map = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();  </span><br><span class="line">        map.put(<span class="string">&quot;/public/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);  </span><br><span class="line">        map.put(<span class="string">&quot;/login/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);  </span><br><span class="line">        map.put(<span class="string">&quot;/**&quot;</span>,<span class="string">&quot;user&quot;</span>);  </span><br><span class="line">        bean.setFilterChainDefinitionMap(map);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> bean;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/21/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81/shiro%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-03/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/21/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81/shiro%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-03/" class="post-title-link" itemprop="url">shiro源码解析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-04-21 20:19:54" itemprop="dateCreated datePublished" datetime="2021-04-21T20:19:54+08:00">2021-04-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-05-07 09:12:28" itemprop="dateModified" datetime="2021-05-07T09:12:28+08:00">2021-05-07</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>10. </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en,cn">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/21/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81/springboot-shiro%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fei Qi">
      <meta itemprop="description" content="learn more, forget more; practice more, get more.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BootFei's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/21/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81/springboot-shiro%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81/" class="post-title-link" itemprop="url">springboot+shiro用户认证</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-04-21 10:44:46" itemprop="dateCreated datePublished" datetime="2021-04-21T10:44:46+08:00">2021-04-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-05-07 13:23:33" itemprop="dateModified" datetime="2021-05-07T13:23:33+08:00">2021-05-07</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="spring-boot-2-0-0-shiro-redis实现前后端分离的项目"><a href="#spring-boot-2-0-0-shiro-redis实现前后端分离的项目" class="headerlink" title="spring boot 2.0.0 + shiro + redis实现前后端分离的项目"></a><a target="_blank" rel="noopener" href="https://www.cnblogs.com/deityjian/p/12485134.html">spring boot 2.0.0 + shiro + redis实现前后端分离的项目</a></h2><p>本文主要实现shiro的以下几个功能：</p>
<p>​    1.当用户没有登陆时只能访问登录接口，访问其他接口会返回无效的授权码</p>
<p>　　2.当用户登陆成功后，只能访问该用户权限下的接口，其他接口会返回无权限访问</p>
<p>　　3.一个用户不能两个人同时在线，后登录的会自动踢出先登录的用户</p>
<p>本文使用框架如下：</p>
<p>核心框架：spring boot 2.0.0, spring<br>mvc框架：spring mvc<br>持久层框架：mybatis<br>数据库连接池：alibaba druid<br>安全框架：apache shiro<br>缓存框架：redis<br>日志框架：logback<br>数据库设计：</p>
<p>数据库主要分为5个表，分别是：用户表，角色表，权限表，角色权限表，用户角色表</p>
<p> <img src="https://img2020.cnblogs.com/i-beta/1645290/202003/1645290-20200313105558942-123715741.png" alt="img"></p>
<p>由于数据表结构我直接拷贝的以前的项目，所以上表中很多字段该文不会用到，各位请根据自己的实际情况修改。</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot; xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">    xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"> </span><br><span class="line">    &lt;groupId&gt;com.alex&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;springboot&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;packaging&gt;jar&lt;&#x2F;packaging&gt;</span><br><span class="line"> </span><br><span class="line">    &lt;name&gt;springboot&lt;&#x2F;name&gt;</span><br><span class="line">    &lt;description&gt;Demo project for Spring Boot&lt;&#x2F;description&gt;</span><br><span class="line"> </span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.0.0.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;relativePath&#x2F;&gt; &lt;!-- lookup parent from repository --&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line"> </span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;&#x2F;project.build.sourceEncoding&gt;</span><br><span class="line">        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;&#x2F;project.reporting.outputEncoding&gt;</span><br><span class="line">        &lt;java.version&gt;1.8&lt;&#x2F;java.version&gt;</span><br><span class="line">        &lt;shiro.version&gt;1.4.0&lt;&#x2F;shiro.version&gt;</span><br><span class="line">        &lt;shiro-redis.version&gt;3.1.0&lt;&#x2F;shiro-redis.version&gt;</span><br><span class="line">    &lt;&#x2F;properties&gt;</span><br><span class="line"> </span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-jdbc&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.mybatis.spring.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mybatis-spring-boot-starter&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.3.2&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-aop&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;!-- 访问静态资源 --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"> </span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;scope&gt;runtime&lt;&#x2F;scope&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"> </span><br><span class="line">        &lt;!-- 分页插件 --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.github.pagehelper&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;pagehelper-spring-boot-starter&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.2.5&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;!-- alibaba的druid数据库连接池 --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;druid&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.1.0&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        &lt;!--@Slf4j自动化日志对象-log--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.projectlombok&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lombok&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.16.16&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"> </span><br><span class="line">        &lt;!-- shiro spring. --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.shiro&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;shiro-core&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;shiro.version&#125;&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.shiro&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;shiro-spring&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;shiro.version&#125;&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;!-- shiro ehcache --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.shiro&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;shiro-ehcache&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;shiro.version&#125;&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"> </span><br><span class="line">        &lt;!-- shiro+redis缓存插件 --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.crazycake&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;shiro-redis&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;shiro-redis.version&#125;&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"> </span><br><span class="line">        &lt;!--工具类--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.commons&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-lang3&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.4&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"> </span><br><span class="line">        &lt;!-- fastjson阿里巴巴jSON处理器 --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;fastjson&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.2.13&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line"> </span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;&#x2F;plugin&gt;</span><br><span class="line">        &lt;&#x2F;plugins&gt;</span><br><span class="line">    &lt;&#x2F;build&gt;</span><br><span class="line"> </span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>



<p>编辑application.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8080</span><br><span class="line"> </span><br><span class="line">spring:</span><br><span class="line">    datasource:</span><br><span class="line">        name: test</span><br><span class="line">        url: jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;springboot</span><br><span class="line">        username: admin</span><br><span class="line">        password: 123456</span><br><span class="line">        # 使用druid数据源</span><br><span class="line">        type: com.alibaba.druid.pool.DruidDataSource</span><br><span class="line">        driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">        #初始化大小，最小，最大</span><br><span class="line">        initialSize: 5</span><br><span class="line">        minIdle: 5</span><br><span class="line">        maxActive: 20</span><br><span class="line">        # 配置获取连接等待超时的时间</span><br><span class="line">        maxWait: 60000</span><br><span class="line">        # 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒</span><br><span class="line">        timeBetweenEvictionRunsMillis: 60000</span><br><span class="line">        # 配置一个连接在池中最小生存的时间，单位是毫秒</span><br><span class="line">        minEvictableIdleTimeMillis: 300000</span><br><span class="line">        # 校验SQL，Oracle配置 spring.datasource.validationQuery&#x3D;SELECT 1 FROM DUAL，如果不配validationQuery项，则下面三项配置无用</span><br><span class="line">        validationQuery: select &#39;x&#39;</span><br><span class="line">        testWhileIdle: true</span><br><span class="line">        testOnBorrow: false</span><br><span class="line">        testOnReturn: false</span><br><span class="line">        # 打开PSCache，并且指定每个连接上PSCache的大小</span><br><span class="line">        poolPreparedStatements: true</span><br><span class="line">        maxPoolPreparedStatementPerConnectionSize : 20</span><br><span class="line">        # 配置监控统计拦截的filters，去掉后监控界面sql无法统计，&#39;wall&#39;用于防火墙</span><br><span class="line">        filters: stat, wall, logback</span><br><span class="line">        connectionProperties : druid.stat.mergeSql&#x3D;true;druid.stat.slowSqlMillis&#x3D;5000</span><br><span class="line">    redis:</span><br><span class="line">      host: 127.0.0.1</span><br><span class="line">      port: 6379</span><br><span class="line">      password : 123456</span><br><span class="line">      timeout: 0</span><br><span class="line">      jedis:</span><br><span class="line">        pool:</span><br><span class="line">          max-active: 8</span><br><span class="line">          max-idle: 8</span><br><span class="line">          min-idle: 0</span><br><span class="line">          max-wait: -1ms</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">## 该配置节点为独立的节点，有很多同学容易将这个配置放在spring的节点下，导致配置无法被识别</span><br><span class="line">mybatis:</span><br><span class="line">  mapper-locations: classpath:mapping&#x2F;*.xml  #注意：一定要对应mapper映射xml文件的所在路径</span><br><span class="line">  type-aliases-package: com.alex.springboot.model  # 注意：对应实体类的路径</span><br><span class="line">#pagehelper分页插件</span><br><span class="line">pagehelper:</span><br><span class="line">    helperDialect: mysql</span><br><span class="line">    reasonable: true</span><br><span class="line">    supportMethodsArguments: true</span><br><span class="line">    params: count&#x3D;countSql</span><br></pre></td></tr></table></figure>



<p>创建ShiroConfig</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br></pre></td><td class="code"><pre><span class="line">package com.alex.springboot.system.config;</span><br><span class="line"> </span><br><span class="line">import com.alex.springboot.system.shiro.CredentialsMatcher;</span><br><span class="line">import com.alex.springboot.system.shiro.SessionControlFilter;</span><br><span class="line">import com.alex.springboot.system.shiro.SessionManager;</span><br><span class="line">import com.alex.springboot.system.shiro.ShiroRealm;</span><br><span class="line">import org.apache.shiro.mgt.SecurityManager;</span><br><span class="line">import org.apache.shiro.spring.LifecycleBeanPostProcessor;</span><br><span class="line">import org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor;</span><br><span class="line">import org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line">import org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line">import org.apache.shiro.web.servlet.SimpleCookie;</span><br><span class="line">import org.crazycake.shiro.RedisCacheManager;</span><br><span class="line">import org.crazycake.shiro.RedisManager;</span><br><span class="line">import org.crazycake.shiro.RedisSessionDAO;</span><br><span class="line">import org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line"> </span><br><span class="line">import javax.servlet.Filter;</span><br><span class="line">import java.util.LinkedHashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"> </span><br><span class="line">@Configuration</span><br><span class="line">public class ShiroConfig &#123;</span><br><span class="line"> </span><br><span class="line">    @Value(&quot;$&#123;spring.redis.host&#125;&quot;)</span><br><span class="line">    private String redisHost;</span><br><span class="line"> </span><br><span class="line">    @Value(&quot;$&#123;spring.redis.port&#125;&quot;)</span><br><span class="line">    private int redisPort;</span><br><span class="line"> </span><br><span class="line">    @Value(&quot;$&#123;spring.redis.password&#125;&quot;)</span><br><span class="line">    private String redisPassword;</span><br><span class="line"> </span><br><span class="line">    @Bean</span><br><span class="line">    public ShiroFilterFactoryBean shiroFilter(SecurityManager securityManager) &#123;</span><br><span class="line">        ShiroFilterFactoryBean shiroFilterFactoryBean &#x3D; new ShiroFilterFactoryBean();</span><br><span class="line">        shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line">        &#x2F;&#x2F; 没有登陆的用户只能访问登陆页面，前后端分离中登录界面跳转应由前端路由控制，后台仅返回json数据</span><br><span class="line">        shiroFilterFactoryBean.setLoginUrl(&quot;&#x2F;common&#x2F;unauth&quot;);</span><br><span class="line">        &#x2F;&#x2F; 登录成功后要跳转的链接</span><br><span class="line">        &#x2F;&#x2F;shiroFilterFactoryBean.setSuccessUrl(&quot;&#x2F;auth&#x2F;index&quot;);</span><br><span class="line">        &#x2F;&#x2F; 未授权界面;</span><br><span class="line">        shiroFilterFactoryBean.setUnauthorizedUrl(&quot;common&#x2F;unauth&quot;);</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;自定义拦截器</span><br><span class="line">        Map&lt;String, Filter&gt; filtersMap &#x3D; new LinkedHashMap&lt;String, Filter&gt;();</span><br><span class="line">        &#x2F;&#x2F;限制同一帐号同时在线的个数。</span><br><span class="line">        filtersMap.put(&quot;kickout&quot;, kickoutSessionControlFilter());</span><br><span class="line">        shiroFilterFactoryBean.setFilters(filtersMap);</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F; 权限控制map.</span><br><span class="line">        Map&lt;String, String&gt; filterChainDefinitionMap &#x3D; new LinkedHashMap&lt;String, String&gt;();</span><br><span class="line">        &#x2F;&#x2F; 公共请求</span><br><span class="line">        filterChainDefinitionMap.put(&quot;&#x2F;common&#x2F;**&quot;, &quot;anon&quot;);</span><br><span class="line">        &#x2F;&#x2F; 静态资源</span><br><span class="line">        filterChainDefinitionMap.put(&quot;&#x2F;static&#x2F;**&quot;, &quot;anon&quot;);</span><br><span class="line">        &#x2F;&#x2F; 登录方法</span><br><span class="line">        filterChainDefinitionMap.put(&quot;&#x2F;admin&#x2F;login*&quot;, &quot;anon&quot;); &#x2F;&#x2F; 表示可以匿名访问</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;此处需要添加一个kickout，上面添加的自定义拦截器才能生效</span><br><span class="line">        filterChainDefinitionMap.put(&quot;&#x2F;admin&#x2F;**&quot;, &quot;authc,kickout&quot;);&#x2F;&#x2F; 表示需要认证才可以访问</span><br><span class="line">        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</span><br><span class="line">        return shiroFilterFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @Bean</span><br><span class="line">    public SecurityManager securityManager() &#123;</span><br><span class="line">        DefaultWebSecurityManager securityManager &#x3D; new DefaultWebSecurityManager();</span><br><span class="line">        &#x2F;&#x2F; 设置realm.</span><br><span class="line">        securityManager.setRealm(myShiroRealm());</span><br><span class="line">        &#x2F;&#x2F; 自定义缓存实现 使用redis</span><br><span class="line">        securityManager.setCacheManager(cacheManager());</span><br><span class="line">        &#x2F;&#x2F; 自定义session管理 使用redis</span><br><span class="line">        securityManager.setSessionManager(sessionManager());</span><br><span class="line">        return securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 身份认证realm; (这个需要自己写，账号密码校验；权限等)</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Bean</span><br><span class="line">    public ShiroRealm myShiroRealm() &#123;</span><br><span class="line">        ShiroRealm myShiroRealm &#x3D; new ShiroRealm();</span><br><span class="line">        myShiroRealm.setCredentialsMatcher(credentialsMatcher());</span><br><span class="line">        return myShiroRealm;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @Bean</span><br><span class="line">    public CredentialsMatcher credentialsMatcher() &#123;</span><br><span class="line">        return new CredentialsMatcher();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * cacheManager 缓存 redis实现</span><br><span class="line">     * 使用的是shiro-redis开源插件</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public RedisCacheManager cacheManager() &#123;</span><br><span class="line">        RedisCacheManager redisCacheManager &#x3D; new RedisCacheManager();</span><br><span class="line">        redisCacheManager.setRedisManager(redisManager());</span><br><span class="line">        redisCacheManager.setKeyPrefix(&quot;SPRINGBOOT_CACHE:&quot;);   &#x2F;&#x2F;设置前缀</span><br><span class="line">        return redisCacheManager;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * RedisSessionDAO shiro sessionDao层的实现 通过redis</span><br><span class="line">     * 使用的是shiro-redis开源插件</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Bean</span><br><span class="line">    public RedisSessionDAO redisSessionDAO() &#123;</span><br><span class="line">        RedisSessionDAO redisSessionDAO &#x3D; new RedisSessionDAO();</span><br><span class="line">        redisSessionDAO.setRedisManager(redisManager());</span><br><span class="line">        redisSessionDAO.setKeyPrefix(&quot;SPRINGBOOT_SESSION:&quot;);</span><br><span class="line">        return redisSessionDAO;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Session Manager</span><br><span class="line">     * 使用的是shiro-redis开源插件</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Bean</span><br><span class="line">    public SessionManager sessionManager() &#123;</span><br><span class="line">        SimpleCookie simpleCookie &#x3D; new SimpleCookie(&quot;Token&quot;);</span><br><span class="line">        simpleCookie.setPath(&quot;&#x2F;&quot;);</span><br><span class="line">        simpleCookie.setHttpOnly(false);</span><br><span class="line"> </span><br><span class="line">        SessionManager sessionManager &#x3D; new SessionManager();</span><br><span class="line">        sessionManager.setSessionDAO(redisSessionDAO());</span><br><span class="line">        sessionManager.setSessionIdCookieEnabled(false);</span><br><span class="line">        sessionManager.setSessionIdUrlRewritingEnabled(false);</span><br><span class="line">        sessionManager.setDeleteInvalidSessions(true);</span><br><span class="line">        sessionManager.setSessionIdCookie(simpleCookie);</span><br><span class="line">        return sessionManager;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 配置shiro redisManager</span><br><span class="line">     * 使用的是shiro-redis开源插件</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public RedisManager redisManager() &#123;</span><br><span class="line">        RedisManager redisManager &#x3D; new RedisManager();</span><br><span class="line">        redisManager.setHost(redisHost);</span><br><span class="line">        redisManager.setPort(redisPort);</span><br><span class="line">        redisManager.setTimeout(1800); &#x2F;&#x2F;设置过期时间</span><br><span class="line">        redisManager.setPassword(redisPassword);</span><br><span class="line">        return redisManager;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 限制同一账号登录同时登录人数控制</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Bean</span><br><span class="line">    public SessionControlFilter kickoutSessionControlFilter() &#123;</span><br><span class="line">        SessionControlFilter kickoutSessionControlFilter &#x3D; new SessionControlFilter();</span><br><span class="line">        kickoutSessionControlFilter.setCache(cacheManager());</span><br><span class="line">        kickoutSessionControlFilter.setSessionManager(sessionManager());</span><br><span class="line">        kickoutSessionControlFilter.setKickoutAfter(false);</span><br><span class="line">        kickoutSessionControlFilter.setMaxSession(1);</span><br><span class="line">        kickoutSessionControlFilter.setKickoutUrl(&quot;&#x2F;common&#x2F;kickout&quot;);</span><br><span class="line">        return kickoutSessionControlFilter;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    &#x2F;***</span><br><span class="line">     * 授权所用配置</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Bean</span><br><span class="line">    public DefaultAdvisorAutoProxyCreator getDefaultAdvisorAutoProxyCreator() &#123;</span><br><span class="line">        DefaultAdvisorAutoProxyCreator defaultAdvisorAutoProxyCreator &#x3D; new DefaultAdvisorAutoProxyCreator();</span><br><span class="line">        defaultAdvisorAutoProxyCreator.setProxyTargetClass(true);</span><br><span class="line">        return defaultAdvisorAutoProxyCreator;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    &#x2F;***</span><br><span class="line">     * 使授权注解起作用不如不想配置可以在pom文件中加入</span><br><span class="line">     * &lt;dependency&gt;</span><br><span class="line">     *&lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">     *&lt;artifactId&gt;spring-boot-starter-aop&lt;&#x2F;artifactId&gt;</span><br><span class="line">     *&lt;&#x2F;dependency&gt;</span><br><span class="line">     * @param securityManager</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Bean</span><br><span class="line">    public AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor(SecurityManager securityManager)&#123;</span><br><span class="line">        AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor &#x3D; new AuthorizationAttributeSourceAdvisor();</span><br><span class="line">        authorizationAttributeSourceAdvisor.setSecurityManager(securityManager);</span><br><span class="line">        return authorizationAttributeSourceAdvisor;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * Shiro生命周期处理器</span><br><span class="line">     * 此方法需要用static作为修饰词，否则无法通过@Value()注解的方式获取配置文件的值</span><br><span class="line">     *</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Bean</span><br><span class="line">    public static LifecycleBeanPostProcessor getLifecycleBeanPostProcessor() &#123;</span><br><span class="line">        return new LifecycleBeanPostProcessor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>自定义Realm</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">package com.alex.springboot.system.shiro;</span><br><span class="line"> </span><br><span class="line">import com.alex.springboot.model.Menu;</span><br><span class="line">import com.alex.springboot.model.Role;</span><br><span class="line">import com.alex.springboot.model.User;</span><br><span class="line">import com.alex.springboot.service.MenuService;</span><br><span class="line">import com.alex.springboot.service.RoleService;</span><br><span class="line">import com.alex.springboot.service.UserService;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.apache.commons.collections.CollectionUtils;</span><br><span class="line">import org.apache.commons.lang3.StringUtils;</span><br><span class="line">import org.apache.shiro.authc.*;</span><br><span class="line">import org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line">import org.apache.shiro.authz.SimpleAuthorizationInfo;</span><br><span class="line">import org.apache.shiro.realm.AuthorizingRealm;</span><br><span class="line">import org.apache.shiro.subject.PrincipalCollection;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"> </span><br><span class="line">import java.util.List;</span><br><span class="line"> </span><br><span class="line">@Slf4j</span><br><span class="line">public class ShiroRealm extends AuthorizingRealm &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    private UserService userService;</span><br><span class="line">    @Autowired</span><br><span class="line">    private RoleService roleService;</span><br><span class="line">    @Autowired</span><br><span class="line">    private MenuService menuService;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 认证信息.(身份验证) : Authentication 是用来验证用户身份</span><br><span class="line">     *</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Override</span><br><span class="line">    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authcToken) throws AuthenticationException &#123;</span><br><span class="line">        log.info(&quot;---------------- 执行 Shiro 凭证认证 ----------------------&quot;);</span><br><span class="line">        UsernamePasswordToken token &#x3D; (UsernamePasswordToken) authcToken;</span><br><span class="line">        String name &#x3D; token.getUsername();</span><br><span class="line">        &#x2F;&#x2F; 从数据库获取对应用户名密码的用户</span><br><span class="line">        User user &#x3D; userService.getUserByName(name);</span><br><span class="line">        if (user !&#x3D; null) &#123;</span><br><span class="line">            &#x2F;&#x2F; 用户为禁用状态</span><br><span class="line">            if (!user.getLoginFlag().equals(&quot;1&quot;)) &#123;</span><br><span class="line">                throw new DisabledAccountException();</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(&quot;---------------- Shiro 凭证认证成功 ----------------------&quot;);</span><br><span class="line">            SimpleAuthenticationInfo authenticationInfo &#x3D; new SimpleAuthenticationInfo(</span><br><span class="line">                    user, &#x2F;&#x2F;用户</span><br><span class="line">                    user.getPassword(), &#x2F;&#x2F;密码</span><br><span class="line">                    getName()  &#x2F;&#x2F;realm name</span><br><span class="line">            );</span><br><span class="line">            return authenticationInfo;</span><br><span class="line">        &#125;</span><br><span class="line">        throw new UnknownAccountException();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 授权</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Override</span><br><span class="line">    protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) &#123;</span><br><span class="line">        log.info(&quot;---------------- 执行 Shiro 权限获取 ---------------------&quot;);</span><br><span class="line">        Object principal &#x3D; principals.getPrimaryPrincipal();</span><br><span class="line">        SimpleAuthorizationInfo info &#x3D; new SimpleAuthorizationInfo();</span><br><span class="line">        if (principal instanceof User) &#123;</span><br><span class="line">            User userLogin &#x3D; (User) principal;</span><br><span class="line">            if(userLogin !&#x3D; null)&#123;</span><br><span class="line">                List&lt;Role&gt; roleList &#x3D; roleService.findByUserid(userLogin.getId());</span><br><span class="line">                if(CollectionUtils.isNotEmpty(roleList))&#123;</span><br><span class="line">                    for(Role role : roleList)&#123;</span><br><span class="line">                        info.addRole(role.getEnname());</span><br><span class="line"> </span><br><span class="line">                        List&lt;Menu&gt; menuList &#x3D; menuService.getAllMenuByRoleId(role.getId());</span><br><span class="line">                        if(CollectionUtils.isNotEmpty(menuList))&#123;</span><br><span class="line">                            for (Menu menu : menuList)&#123;</span><br><span class="line">                                if(StringUtils.isNoneBlank(menu.getPermission()))&#123;</span><br><span class="line">                                    info.addStringPermission(menu.getPermission());</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(&quot;---------------- 获取到以下权限 ----------------&quot;);</span><br><span class="line">        log.info(info.getStringPermissions().toString());</span><br><span class="line">        log.info(&quot;---------------- Shiro 权限获取成功 ----------------------&quot;);</span><br><span class="line">        return info;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>自定义密码校验器</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">package com.alex.springboot.system.shiro;</span><br><span class="line"> </span><br><span class="line">import com.alex.springboot.utils.MD5Util;</span><br><span class="line">import org.apache.shiro.authc.AuthenticationInfo;</span><br><span class="line">import org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line">import org.apache.shiro.authc.UsernamePasswordToken;</span><br><span class="line">import org.apache.shiro.authc.credential.SimpleCredentialsMatcher;</span><br><span class="line"> </span><br><span class="line">public class CredentialsMatcher extends SimpleCredentialsMatcher &#123;</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    public boolean doCredentialsMatch(AuthenticationToken token, AuthenticationInfo info) &#123;</span><br><span class="line">        UsernamePasswordToken utoken &#x3D; (UsernamePasswordToken) token;</span><br><span class="line">        &#x2F;&#x2F; 获得用户输入的密码:(可以采用加盐(salt)的方式去检验)</span><br><span class="line">        String inPassword &#x3D; new String(utoken.getPassword());</span><br><span class="line">        &#x2F;&#x2F; 获得数据库中的密码</span><br><span class="line">        String dbPassword &#x3D; (String) info.getCredentials();</span><br><span class="line">        &#x2F;&#x2F; 进行密码的比对</span><br><span class="line">        return this.equals(MD5Util.encrypt(inPassword), dbPassword);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>自定义session容器，用于实现前后端分离，前端请求接口时将Token放在请求Header中，即可获取到用户的session信息（建议前端是将Token放在Header中，而不是放到body请求参数中，这样可以统一做封装处理，下面的代码中是获取Header中或者body中Token，建议直接获取Header中Token即可）</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">package com.alex.springboot.system.shiro;</span><br><span class="line"> </span><br><span class="line">import org.apache.commons.lang3.StringUtils;</span><br><span class="line">import org.apache.shiro.session.Session;</span><br><span class="line">import org.apache.shiro.session.UnknownSessionException;</span><br><span class="line">import org.apache.shiro.session.mgt.SessionKey;</span><br><span class="line">import org.apache.shiro.web.servlet.ShiroHttpServletRequest;</span><br><span class="line">import org.apache.shiro.web.session.mgt.DefaultWebSessionManager;</span><br><span class="line">import org.apache.shiro.web.session.mgt.WebSessionKey;</span><br><span class="line">import org.apache.shiro.web.util.WebUtils;</span><br><span class="line"> </span><br><span class="line">import javax.servlet.ServletRequest;</span><br><span class="line">import javax.servlet.ServletResponse;</span><br><span class="line">import java.io.Serializable;</span><br><span class="line"> </span><br><span class="line">public class SessionManager extends DefaultWebSessionManager &#123;</span><br><span class="line">    private static final String AUTHORIZATION &#x3D; &quot;Token&quot;;</span><br><span class="line"> </span><br><span class="line">    private static final String REFERENCED_SESSION_ID_SOURCE &#x3D; &quot;Stateless request&quot;;</span><br><span class="line"> </span><br><span class="line">    public SessionManager() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    protected Serializable getSessionId(ServletRequest request, ServletResponse response) &#123;</span><br><span class="line">        &#x2F;&#x2F;获取请求头，或者请求参数中的Token</span><br><span class="line">        String id &#x3D; StringUtils.isEmpty(WebUtils.toHttp(request).getHeader(AUTHORIZATION))</span><br><span class="line">                ? request.getParameter(AUTHORIZATION) : WebUtils.toHttp(request).getHeader(AUTHORIZATION);</span><br><span class="line">        &#x2F;&#x2F; 如果请求头中有 Token 则其值为sessionId</span><br><span class="line">        if (StringUtils.isNotEmpty(id)) &#123;</span><br><span class="line">            request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID_SOURCE, REFERENCED_SESSION_ID_SOURCE);</span><br><span class="line">            request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID, id);</span><br><span class="line">            request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID_IS_VALID, Boolean.TRUE);</span><br><span class="line"> </span><br><span class="line">            return id;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            &#x2F;&#x2F; 否则按默认规则从cookie取sessionId</span><br><span class="line">            return super.getSessionId(request, response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 获取session 优化单次请求需要多次访问redis的问题</span><br><span class="line">     *</span><br><span class="line">     * @param sessionKey</span><br><span class="line">     * @return</span><br><span class="line">     * @throws UnknownSessionException</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @Override</span><br><span class="line">    protected Session retrieveSession(SessionKey sessionKey) throws UnknownSessionException &#123;</span><br><span class="line">        Serializable sessionId &#x3D; getSessionId(sessionKey);</span><br><span class="line"> </span><br><span class="line">        ServletRequest request &#x3D; null;</span><br><span class="line">        if (sessionKey instanceof WebSessionKey) &#123;</span><br><span class="line">            request &#x3D; ((WebSessionKey) sessionKey).getServletRequest();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        if (request !&#x3D; null &amp;&amp; null !&#x3D; sessionId) &#123;</span><br><span class="line">            Object sessionObj &#x3D; request.getAttribute(sessionId.toString());</span><br><span class="line">            if (sessionObj !&#x3D; null) &#123;</span><br><span class="line">                return (Session) sessionObj;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        Session session &#x3D; super.retrieveSession(sessionKey);</span><br><span class="line">        if (request !&#x3D; null &amp;&amp; null !&#x3D; sessionId) &#123;</span><br><span class="line">            request.setAttribute(sessionId.toString(), session);</span><br><span class="line">        &#125;</span><br><span class="line">        return session;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>自定义拦截器，用于限制用户登录人数</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line">package com.alex.springboot.system.shiro;</span><br><span class="line"> </span><br><span class="line">import com.alex.springboot.model.User;</span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import org.apache.shiro.cache.Cache;</span><br><span class="line">import org.apache.shiro.cache.CacheManager;</span><br><span class="line">import org.apache.shiro.session.Session;</span><br><span class="line">import org.apache.shiro.session.mgt.DefaultSessionKey;</span><br><span class="line">import org.apache.shiro.session.mgt.SessionManager;</span><br><span class="line">import org.apache.shiro.subject.Subject;</span><br><span class="line">import org.apache.shiro.web.filter.AccessControlFilter;</span><br><span class="line">import org.apache.shiro.web.util.WebUtils;</span><br><span class="line"> </span><br><span class="line">import javax.servlet.ServletRequest;</span><br><span class="line">import javax.servlet.ServletResponse;</span><br><span class="line">import javax.servlet.http.HttpServletRequest;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.PrintWriter;</span><br><span class="line">import java.io.Serializable;</span><br><span class="line">import java.util.Deque;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.LinkedList;</span><br><span class="line">import java.util.Map;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">public class SessionControlFilter extends AccessControlFilter &#123;</span><br><span class="line">    private String kickoutUrl; &#x2F;&#x2F;踢出后到的地址</span><br><span class="line">    private boolean kickoutAfter &#x3D; false; &#x2F;&#x2F;踢出之前登录的&#x2F;之后登录的用户 默认踢出之前登录的用户</span><br><span class="line">    private int maxSession &#x3D; 1; &#x2F;&#x2F;同一个帐号最大会话数 默认1</span><br><span class="line"> </span><br><span class="line">    private SessionManager sessionManager;</span><br><span class="line">    private Cache&lt;String, Deque&lt;Serializable&gt;&gt; cache;</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    protected boolean isAccessAllowed(ServletRequest request, ServletResponse response, Object mappedValue) throws Exception &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    @Override</span><br><span class="line">    protected boolean onAccessDenied(ServletRequest request, ServletResponse response) throws Exception &#123;</span><br><span class="line">        Subject subject &#x3D; getSubject(request, response);</span><br><span class="line">        if(!subject.isAuthenticated() &amp;&amp; !subject.isRemembered()) &#123;</span><br><span class="line">            &#x2F;&#x2F;如果没有登录，直接进行之后的流程</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        Session session &#x3D; subject.getSession();</span><br><span class="line">        User user &#x3D; (User) subject.getPrincipal();</span><br><span class="line">        String username &#x3D; user.getLoginName();</span><br><span class="line">        Serializable sessionId &#x3D; session.getId();</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;读取缓存   没有就存入</span><br><span class="line">        Deque&lt;Serializable&gt; deque &#x3D; cache.get(username);</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;如果此用户没有session队列，也就是还没有登录过，缓存中没有</span><br><span class="line">        &#x2F;&#x2F;就new一个空队列，不然deque对象为空，会报空指针</span><br><span class="line">        if(deque &#x3D;&#x3D; null)&#123;</span><br><span class="line">            deque &#x3D; new LinkedList&lt;Serializable&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;如果队列里没有此sessionId，且用户没有被踢出；放入队列</span><br><span class="line">        if(!deque.contains(sessionId) &amp;&amp; session.getAttribute(&quot;kickout&quot;) &#x3D;&#x3D; null) &#123;</span><br><span class="line">            &#x2F;&#x2F;将sessionId存入队列</span><br><span class="line">            deque.push(sessionId);</span><br><span class="line">            &#x2F;&#x2F;将用户的sessionId队列缓存</span><br><span class="line">            cache.put(username, deque);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;如果队列里的sessionId数超出最大会话数，开始踢人</span><br><span class="line">        while(deque.size() &gt; maxSession) &#123;</span><br><span class="line">            Serializable kickoutSessionId &#x3D; null;</span><br><span class="line">            if(kickoutAfter) &#123; &#x2F;&#x2F;如果踢出后者</span><br><span class="line">                kickoutSessionId &#x3D; deque.removeFirst();</span><br><span class="line">                &#x2F;&#x2F;踢出后再更新下缓存队列</span><br><span class="line">                cache.put(username, deque);</span><br><span class="line">            &#125; else &#123; &#x2F;&#x2F;否则踢出前者</span><br><span class="line">                kickoutSessionId &#x3D; deque.removeLast();</span><br><span class="line">                &#x2F;&#x2F;踢出后再更新下缓存队列</span><br><span class="line">                cache.put(username, deque);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            try &#123;</span><br><span class="line">                &#x2F;&#x2F;获取被踢出的sessionId的session对象</span><br><span class="line">                Session kickoutSession &#x3D; sessionManager.getSession(new DefaultSessionKey(kickoutSessionId));</span><br><span class="line">                if(kickoutSession !&#x3D; null) &#123;</span><br><span class="line">                    &#x2F;&#x2F;设置会话的kickout属性表示踢出了</span><br><span class="line">                    kickoutSession.setAttribute(&quot;kickout&quot;, true);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Exception e) &#123;&#x2F;&#x2F;ignore exception</span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        &#x2F;&#x2F;如果被踢出了，直接退出，重定向到踢出后的地址</span><br><span class="line">        if (session.getAttribute(&quot;kickout&quot;) !&#x3D; null) &#123;</span><br><span class="line">            &#x2F;&#x2F;会话被踢出了</span><br><span class="line">            try &#123;</span><br><span class="line">                &#x2F;&#x2F;退出登录</span><br><span class="line">                subject.logout();</span><br><span class="line">            &#125; catch (Exception e) &#123; &#x2F;&#x2F;ignore</span><br><span class="line">            &#125;</span><br><span class="line">            saveRequest(request);</span><br><span class="line"> </span><br><span class="line">            Map&lt;String, String&gt; resultMap &#x3D; new HashMap&lt;String, String&gt;();</span><br><span class="line">            &#x2F;&#x2F;判断是不是Ajax请求</span><br><span class="line">            if (&quot;XMLHttpRequest&quot;.equalsIgnoreCase(((HttpServletRequest) request).getHeader(&quot;X-Requested-With&quot;))) &#123;</span><br><span class="line">                resultMap.put(&quot;user_status&quot;, &quot;300&quot;);</span><br><span class="line">                resultMap.put(&quot;message&quot;, &quot;您已经在其他地方登录，请重新登录！&quot;);</span><br><span class="line">                &#x2F;&#x2F;输出json串</span><br><span class="line">                out(response, resultMap);</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                &#x2F;&#x2F;重定向</span><br><span class="line">                WebUtils.issueRedirect(request, response, kickoutUrl);</span><br><span class="line">            &#125;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    private void out(ServletResponse hresponse, Map&lt;String, String&gt; resultMap)</span><br><span class="line">            throws IOException &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            hresponse.setCharacterEncoding(&quot;UTF-8&quot;);</span><br><span class="line">            PrintWriter out &#x3D; hresponse.getWriter();</span><br><span class="line">            out.println(JSON.toJSONString(resultMap));</span><br><span class="line">            out.flush();</span><br><span class="line">            out.close();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            System.err.println(&quot;KickoutSessionFilter.class 输出JSON异常，可以忽略。&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public String getKickoutUrl() &#123;</span><br><span class="line">        return kickoutUrl;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public void setKickoutUrl(String kickoutUrl) &#123;</span><br><span class="line">        this.kickoutUrl &#x3D; kickoutUrl;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public boolean isKickoutAfter() &#123;</span><br><span class="line">        return kickoutAfter;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public void setKickoutAfter(boolean kickoutAfter) &#123;</span><br><span class="line">        this.kickoutAfter &#x3D; kickoutAfter;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public int getMaxSession() &#123;</span><br><span class="line">        return maxSession;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public void setMaxSession(int maxSession) &#123;</span><br><span class="line">        this.maxSession &#x3D; maxSession;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public SessionManager getSessionManager() &#123;</span><br><span class="line">        return sessionManager;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public void setSessionManager(SessionManager sessionManager) &#123;</span><br><span class="line">        this.sessionManager &#x3D; sessionManager;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public Cache&lt;String, Deque&lt;Serializable&gt;&gt; getCache() &#123;</span><br><span class="line">        return cache;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public void setCache(CacheManager cacheManager) &#123;</span><br><span class="line">        this.cache &#x3D; cacheManager.getCache(&quot;shiro_redis_cache&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>全局异常拦截</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">package com.alex.springboot.system.handler;</span><br><span class="line"> </span><br><span class="line">import com.alex.springboot.system.enums.ResultStatusCode;</span><br><span class="line">import com.alex.springboot.system.vo.Result;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.apache.shiro.authz.UnauthorizedException;</span><br><span class="line">import org.springframework.http.HttpStatus;</span><br><span class="line">import org.springframework.http.converter.HttpMessageNotReadableException;</span><br><span class="line">import org.springframework.validation.BindException;</span><br><span class="line">import org.springframework.web.HttpRequestMethodNotSupportedException;</span><br><span class="line">import org.springframework.web.bind.MethodArgumentNotValidException;</span><br><span class="line">import org.springframework.web.bind.MissingServletRequestParameterException;</span><br><span class="line">import org.springframework.web.bind.ServletRequestBindingException;</span><br><span class="line">import org.springframework.web.bind.annotation.ControllerAdvice;</span><br><span class="line">import org.springframework.web.bind.annotation.ExceptionHandler;</span><br><span class="line">import org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line">import org.springframework.web.bind.annotation.ResponseStatus;</span><br><span class="line"> </span><br><span class="line">import javax.validation.ConstraintViolationException;</span><br><span class="line"> </span><br><span class="line">@Slf4j</span><br><span class="line">@ControllerAdvice</span><br><span class="line">@ResponseBody</span><br><span class="line">public class ExceptionAdvice &#123;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 400 - Bad Request</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @ResponseStatus(HttpStatus.BAD_REQUEST)</span><br><span class="line">    @ExceptionHandler(&#123;HttpMessageNotReadableException.class, MissingServletRequestParameterException.class, BindException.class,</span><br><span class="line">            ServletRequestBindingException.class, MethodArgumentNotValidException.class, ConstraintViolationException.class&#125;)</span><br><span class="line">    public Result handleHttpMessageNotReadableException(Exception e) &#123;</span><br><span class="line">        log.error(&quot;参数解析失败&quot;, e);</span><br><span class="line">        if (e instanceof BindException)&#123;</span><br><span class="line">            return new Result(ResultStatusCode.BAD_REQUEST.getCode(), ((BindException)e).getAllErrors().get(0).getDefaultMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        return new Result(ResultStatusCode.BAD_REQUEST.getCode(), e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 405 - Method Not Allowed</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @ResponseStatus(HttpStatus.METHOD_NOT_ALLOWED)</span><br><span class="line">    @ExceptionHandler(HttpRequestMethodNotSupportedException.class)</span><br><span class="line">    public Result handleHttpRequestMethodNotSupportedException(HttpRequestMethodNotSupportedException e) &#123;</span><br><span class="line">        log.error(&quot;不支持当前请求方法&quot;, e);</span><br><span class="line">        return new Result(ResultStatusCode.METHOD_NOT_ALLOWED, null);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * shiro权限异常处理</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @ExceptionHandler(UnauthorizedException.class)</span><br><span class="line">    public Result unauthorizedException(UnauthorizedException e)&#123;</span><br><span class="line">        log.error(e.getMessage(), e);</span><br><span class="line"> </span><br><span class="line">        return new Result(ResultStatusCode.UNAUTHO_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 500</span><br><span class="line">     * @param e</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span><br><span class="line">    @ExceptionHandler(Exception.class)</span><br><span class="line">    public Result handleException(Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        log.error(&quot;服务运行异常&quot;, e);</span><br><span class="line">        return new Result(ResultStatusCode.SYSTEM_ERR, null);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>未授权和被踢出后跳转方法</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">package com.alex.springboot.controller;</span><br><span class="line"> </span><br><span class="line">import com.alex.springboot.system.enums.ResultStatusCode;</span><br><span class="line">import com.alex.springboot.system.vo.Result;</span><br><span class="line">import org.apache.shiro.SecurityUtils;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"> </span><br><span class="line">@RequestMapping(&quot;&#x2F;common&quot;)</span><br><span class="line">@RestController</span><br><span class="line">public class CommonController &#123;</span><br><span class="line"> </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 未授权跳转方法</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @RequestMapping(&quot;&#x2F;unauth&quot;)</span><br><span class="line">    public Result unauth()&#123;</span><br><span class="line">        SecurityUtils.getSubject().logout();</span><br><span class="line">        return new Result(ResultStatusCode.UNAUTHO_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 被踢出后跳转方法</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @RequestMapping(&quot;&#x2F;kickout&quot;)</span><br><span class="line">    public Result kickout()&#123;</span><br><span class="line">        return new Result(ResultStatusCode.INVALID_TOKEN);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>登录和退出登录</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">package com.alex.springboot.controller;</span><br><span class="line"> </span><br><span class="line">import com.alex.springboot.system.enums.ResultStatusCode;</span><br><span class="line">import com.alex.springboot.system.vo.Result;</span><br><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line">import com.alibaba.fastjson.JSONObject;</span><br><span class="line">import org.apache.shiro.SecurityUtils;</span><br><span class="line">import org.apache.shiro.authc.IncorrectCredentialsException;</span><br><span class="line">import org.apache.shiro.authc.LockedAccountException;</span><br><span class="line">import org.apache.shiro.authc.UnknownAccountException;</span><br><span class="line">import org.apache.shiro.authc.UsernamePasswordToken;</span><br><span class="line">import org.apache.shiro.subject.Subject;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"> </span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;&#x2F;admin&quot;)</span><br><span class="line">public class LoginController &#123;</span><br><span class="line"> </span><br><span class="line">    @RequestMapping(&quot;&#x2F;login&quot;)</span><br><span class="line">    public Result login(String loginName, String pwd)&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            UsernamePasswordToken token &#x3D; new UsernamePasswordToken(loginName, pwd);</span><br><span class="line">            &#x2F;&#x2F;登录不在该处处理，交由shiro处理</span><br><span class="line">            Subject subject &#x3D; SecurityUtils.getSubject();</span><br><span class="line">            subject.login(token);</span><br><span class="line"> </span><br><span class="line">            if (subject.isAuthenticated()) &#123;</span><br><span class="line">                JSON json &#x3D; new JSONObject();</span><br><span class="line">                ((JSONObject) json).put(&quot;token&quot;, subject.getSession().getId());</span><br><span class="line"> </span><br><span class="line">                return new Result(ResultStatusCode.OK, json);</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                return new Result(ResultStatusCode.SHIRO_ERROR);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;catch (IncorrectCredentialsException | UnknownAccountException e)&#123;</span><br><span class="line">            return new Result(ResultStatusCode.NOT_EXIST_USER_OR_ERROR_PWD);</span><br><span class="line">        &#125;catch (LockedAccountException e)&#123;</span><br><span class="line">            return new Result(ResultStatusCode.USER_FROZEN);</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            return new Result(ResultStatusCode.SYSTEM_ERR);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 退出登录</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @RequestMapping(&quot;&#x2F;logout&quot;)</span><br><span class="line">    public Result logout()&#123;</span><br><span class="line">        SecurityUtils.getSubject().logout();</span><br><span class="line">        return new Result(ResultStatusCode.OK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>测试接口方法</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">package com.alex.springboot.controller;</span><br><span class="line"> </span><br><span class="line">import com.alex.springboot.service.UserService;</span><br><span class="line">import com.alex.springboot.system.vo.Grid;</span><br><span class="line">import org.apache.shiro.authz.annotation.RequiresPermissions;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"> </span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;&#x2F;admin&#x2F;user&quot;)</span><br><span class="line">public class UserController &#123;</span><br><span class="line"> </span><br><span class="line">    @Autowired</span><br><span class="line">    private UserService userService;</span><br><span class="line"> </span><br><span class="line">    @RequiresPermissions(&quot;sys:user:view&quot;)</span><br><span class="line">    @RequestMapping(&quot;findList&quot;)</span><br><span class="line">    public Grid findList()&#123;</span><br><span class="line">        return userService.findList();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> Demo地址：<a target="_blank" rel="noopener" href="https://github.com/DeityJian/springboot-shiro.git">https://github.com/DeityJian/springboot-shiro.git</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Fei Qi</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  


















  








  

  

</body>
</html>
