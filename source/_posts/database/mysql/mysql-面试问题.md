---
title: mysql - 面试问题
date: 2022-03-08 15:59:03
tags: [mysql,transaction]
---

1. MySQL 脏页刷新到磁盘机制？

   - 脏页定义：数据存储的最小单元就是数据页，当内存的数据页与磁盘的数据页不一致时，该数据页就是脏页。

   - 脏页生成的时机：由于Write Ahead Log策略，每次事务提交时，innodb先写磁盘，再写内存

   - 脏页落盘（刷新）的时机：

     - MySQL中，刷新的规则叫checkpoint机制，共2种
     - sharp checkpoint：在数据库关闭时，刷新所有的脏页到磁盘。
     - fuzzy checkpoint：刷新一部分脏页到磁盘中。
       - 定时刷新
       - Flush LRUlist checkpoint ：当LRU中列表中空闲页不足时，强制LRU删除一些末尾的页，如果存在脏页，那么需要checkpoint刷新
       - async/sync checkpoint ：指重做日志文件不可用时，需要强制将脏页列表中的一些页刷新回磁盘。这可以保证重做日志文件可循环使用
       - dirty too much checkpoint：关注系统中的整体脏页比例，如果达到一定比例，强制刷新

     

2. MySQL innodb 引擎的索引结构，B+树一般都多高？ 层高怎么计算？

   - 不超过3层，因为磁盘的IO查询超过3次会影响性能

   - 影响层高的因素（假设一行数据大小为1kb，非叶子节点的指针是14byte）

     - mysql的存储基本单位为数据页，大小=16kb

     - 因为B+树的非叶子节点存储指针，叶子节点存储数据，所以层高与数据行数的关系：
       **数据量=（非叶子节点的存储指针数量）^ (层高-1) * 一个数据页存储的行数**

       - 1层的数据行数最大为: (16kb/1kb)^(1-1) = 16条数据
       - 2层的数据行数最大为: (16kb/14byte)^(2-1) * (16kb/1kb) = 18k 条数据
       - 3层的数据行数最大为: (16kb/14byte)^(3-1) * (16kb/1kb) = 20.89w条数据

       

3. sql join 驱动表如何选择？

   - mysql中的join，底层实现都是用的nested loop

   - 小表驱动大表

     - 当使用left join时，左表是驱动表，右表是被驱动表
     - 当使用right join时，右表是驱动表，左表是被驱动表
     - 当使用inner join时，mysql会选择数据量比较小的表作为驱动表，大表作为被驱动表

     

4. mysql 查询语句执行流程？

   - **连接器：** 身份认证和权限相关
   - **查询缓存:** 执行查询语句的时候，会先查询缓存（MySQL 8.0 版本后移除，因为这个功能不太实用）。
   - **分析器:** 没有命中缓存的话，SQL 语句就会经过分析器，分析器说白了就是要先看你的 SQL 语句要干嘛，再检查你的 SQL 语句语法是否正确。
   - **优化器：** 按照 MySQL 认为最优的方案去执行。
   - **执行器:** 执行语句，然后从存储引擎返回数据。



5. 造成慢sql 常见原因有哪些？
   - 查询条件没有索引，或者索引失效
   - 操作等待锁资源，比如update，select for update
   - 单表数据量过大



6. 如何分析慢查询，慢查询的分析步骤？ explain 返回的列的含义？
   - 使用慢查询定位执行慢的SQL：
     - 慢日志存储路径：show variables like '%query%';
   -  explain 返回的列的含义
     - id:SELECT 查询的标识符. 每个 SELECT 都会自动分配一个唯一的标识符.
     - select_type: SELECT 查询的类型.
     - table: 查询的是哪个表
     - partitions: 匹配的分区
     - type: join 类型
     - possible_keys: 此次查询中可能选用的索引
     - key: 此次查询中确切使用到的索引. ref: 哪个字段或常数与 key 一起被使用
     - rows: 显示此查询一共扫描了多少行. 这个是一个估计值.
     - filtered: 表示此查询条件所过滤的数据的百分比
     - extra: 额外的信息

