---
title: 为什么需要服务网关
date: 2021-04-27 13:35:50
tags:
---

## 服务网关概述

服务网关 = 路由转发 + 过滤器 <!--我细分为前置过滤器-->

1、**路由转发：**接收一切外界请求，转发到后端的微服务上去；

2、**过滤器：**在服务网关中可以完成一系列的横切功能，例如权限校验、限流以及监控等，可以通过过滤器完成（其实路由转发也是通过过滤器实现的）

## 服务网关优点

上述所说的横切功能（以权限校验为例）可以写在三个位置：

- 每个服务自己实现一遍
  - 缺点太明显，基本不用
- 写到一个公共的服务中，然后其他所有服务都依赖这个服务 <!--公共服务在open-service后面-->
  - 由于每个服务引入了公共服务，那么相当于在每个服务中都引入了相同的权限校验的代码，使得每个服务的jar包大小增加了，尤其docker镜像进行部署的场景，jar越小越好；
  - 由于每个服务引入了公共服务，那么后续升级这个服务可能就比较困难：公共服务的功能越多，升级就越难，而且假设我们改变了公共服务中的权限校验的方式，所有的服务都去使用新的权限校验方式，我们就需要将之前所有的服务都重新引包，编译部署。
- 写到服务网关的前置过滤器中，所有请求过来进行权限校验 <!--公共服务在open-service前面-->

  - 将权限校验的逻辑写在网关的过滤器中，后端服务不需要关注权限校验的代码，所以服务的jar包中也不会引入权限校验的逻辑，不会增加jar包大小；
  - 如果想修改权限校验的逻辑，只需要修改网关中的权限校验过滤器即可，而不需要升级所有已依赖的open-service。

## [服务网关技术选型](http://mp.weixin.qq.com/s?__biz=MzI4Njc5NjM1NQ==&mid=2247490615&idx=1&sn=1a8c7126bf46a3cf1add60119803f220&chksm=ebd6231bdca1aa0d71508d01024fd639000fb556b67593a4c4a31a1f701b95a5adc112c858c6&scene=21#wechat_redirect)

![Image](https://mmbiz.qpic.cn/mmbiz_png/eQPyBffYbucguqG86ia9ZKsJrkpgzSb5TtqOF5YU4p7qKlgSgjrwFu1oicJQsibjhnLeS4yQUQuau8icCHUAmmFEibQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

引入服务网关后的微服务架构如上，总体包含三部分：[服务网关](http://mp.weixin.qq.com/s?__biz=MzI4Njc5NjM1NQ==&mid=2247499813&idx=2&sn=b99a6b64dbb96fb9f7c74d50eb59cb79&chksm=ebd5ff09dca2761f3f5e5ec146837c5721feeae48c9443f2345a93b4cc519128b6792d6a96e2&scene=21#wechat_redirect)、open-service和service。

### 总体流程

- 服务网关、open-service和service启动时注册到注册中心上去；
- 用户请求时直接请求网关，网关做智能路由转发（包括服务发现，负载均衡）到open-service，这其中包含权限校验、监控、限流等操作
- open-service聚合内部service响应，返回给网关，网关再返回给用户

> 注意：
>
> - 增加了网关，多了一层转发（原本用户请求直接访问open-service即可），性能会下降一些；
> - 网关的单点问题：[在整个网络调用过程中，一定会有一个单点]()，可能是网关，也可能是nginx、dns服务器等。防止网关单点，可以在网关层前边再挂一台nginx，服务网关就可以是多机了。但是这样一个请求就多经过了一层nginx，调用链路变长，所以最好使用网关单点，网关服务部署在一台高性能的机器上
>

### 服务网关基本功能

- **智能路由：**接收外部一切请求，并转发到后端的对外服务open-service上去；
- 注意：我们只转发外部请求，服务之间的请求不走网关，这就表示全链路追踪、内部服务API监控、内部服务之间调用的容错、智能路由不能在网关完成；当然，也可以将所有的服务调用都走网关，那么几乎所有的功能都可以集成到网关中，但是这样的话，网关的压力会很大，不堪重负。
- **权限校验：**只校验用户向open-service服务的请求，不校验服务内部的请求。服务内部的请求有必要校验吗？
- **API监控：**只监控经过网关的请求，以及网关本身的一些性能指标（例如，gc等）；
- **限流：**与监控配合，进行限流操作；
- **API[日志统一收集](http://mp.weixin.qq.com/s?__biz=MzI4Njc5NjM1NQ==&mid=2247502455&idx=1&sn=846469197b743a1156c4563853a1b83b&chksm=ebd5f55bdca27c4d17974290fecd2a055c5cecf431959f628582d347a5edfe694e2a8bd96632&scene=21#wechat_redirect)**：类似于一个aspect切面，记录接口的进入和出去时的相关日志

上述功能是网关的基本功能，网关还可以实现以下功能：

- A|B测试：A|B测试时一块比较大的东西，包含后台实验配置、数据埋点（看转化率）以及分流引擎，在服务网关中，可以实现分流引擎，但是实际上分流引擎会调用内部服务，所以如果是按照上图的架构，分流引擎最好做在open-service中，不要做在服务网关中。

### 4、技术选型

- 开发语言：java + groovy，groovy的好处是网关服务不需要重启就可以动态的添加filter来实现一些功能；
- 微服务基础框架：springboot；
- 网关基础组件：netflix zuul；
- 服务注册中心：consul；
- 权限校验：jwt；
- API监控：prometheus + grafana；
- API统一日志收集：logback + ELK；

